<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Antony 的學習筆記">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Antony 的學習筆記">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Antony Cehn">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Antony 的學習筆記</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Antony 的學習筆記</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">這個網站將紀錄持續記錄我學習到各種知識的筆記</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes%20Deployment%20(1).html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes%20Deployment%20(1).html" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-08 04:18:18" itemprop="dateCreated datePublished" datetime="2023-02-08T04:18:18+08:00">2023-02-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 16:15:42" itemprop="dateModified" datetime="2023-05-07T16:15:42+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-Deployment"><a href="#Kubernetes-Deployment" class="headerlink" title="Kubernetes Deployment"></a>Kubernetes Deployment</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><strong>透過 Kubernetes Deployment ，將一個網站服務進行進版或退版，且服務不中斷。</strong></p>
<h2 id="操作步驟"><a href="#操作步驟" class="headerlink" title="操作步驟"></a>操作步驟</h2><p>[TOC]</p>
<h1 id="建立與檢視-Depolyment-Object"><a href="#建立與檢視-Depolyment-Object" class="headerlink" title="建立與檢視 Depolyment Object"></a>建立與檢視 Depolyment Object</h1><h2 id="編輯-nginx-網站的-yaml-檔"><a href="#編輯-nginx-網站的-yaml-檔" class="headerlink" title="編輯 nginx 網站的 yaml 檔"></a>編輯 nginx 網站的 yaml 檔</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: depng</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: quay.io/cloudwalker/nginx:1.20</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80 &#x27;&gt; ~/wulin/yaml/depng.yaml</span><br></pre></td></tr></table></figure>

<h2 id="建立與檢視部屬狀態"><a href="#建立與檢視部屬狀態" class="headerlink" title="建立與檢視部屬狀態"></a>建立與檢視部屬狀態</h2><p>建立網站命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f ~/wulin/yaml/depng.yaml</span><br></pre></td></tr></table></figure>

<p>螢幕輸出 : </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deployment.apps/depng created</span><br></pre></td></tr></table></figure>

<p>檢視網站部屬後的狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kg all --selector app=nginx</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/depng-6d7cd45868-5mnmv   1/1     Running   0          6s</span><br><span class="line">pod/depng-6d7cd45868-bzdlg   1/1     Running   0          6s</span><br><span class="line"></span><br><span class="line">NAME                    READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/depng   2/2     2            2           6s</span><br><span class="line"></span><br><span class="line">NAME                               DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/depng-6d7cd45868   2         2         2       6s</span><br></pre></td></tr></table></figure>

<p>檢查事件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe deployments depng</span><br></pre></td></tr></table></figure>

<p>螢幕輸出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...以上忽略</span><br><span class="line">OldReplicaSets:  &lt;none&gt;</span><br><span class="line">NewReplicaSet:   depng-6d7cd45868 (2/2 replicas created)</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason             Age   From                   Message</span><br><span class="line">  ----    ------             ----  ----                   -------</span><br><span class="line">  Normal  ScalingReplicaSet  25s   deployment-controller  Scaled up replica set depng-6d7cd45868 to 2</span><br></pre></td></tr></table></figure>



<h2 id="網站進版"><a href="#網站進版" class="headerlink" title="網站進版"></a>網站進版</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl set image deployment.v1.apps/depng nginx=quay.io/cloudwalker/nginx:1.21 --record </span><br><span class="line">deployment.apps/depng image updated</span><br></pre></td></tr></table></figure>

<ul>
<li>將 image 換裝成新版 1.21</li>
<li><code>--record</code> ，記錄</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout status deployment.v1.apps/depng</span><br><span class="line">Waiting for deployment &quot;depng&quot; rollout to finish: 1 out of 2 new replicas have been updated...</span><br><span class="line">Waiting for deployment &quot;depng&quot; rollout to finish: 1 out of 2 new replicas have been updated...</span><br><span class="line">Waiting for deployment &quot;depng&quot; rollout to finish: 1 out of 2 new replicas have been updated...</span><br><span class="line">Waiting for deployment &quot;depng&quot; rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">Waiting for deployment &quot;depng&quot; rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">deployment &quot;depng&quot; successfully rolled out</span><br></pre></td></tr></table></figure>

<ul>
<li>這命令要再上一個命令做完後趕快執行，不然只會看到最後一行</li>
<li><font color=red><strong>Deplyment 進版時，會先把新的 pod 建立起來，再把舊版本的 pod 刪除</strong></font></li>
</ul>
<p>檢查 image 是不是真的換裝城新版的</p>
<pre>
$ kubectl describe deployments depng
Name:                   dep1
............
Pod Template:
  Labels:  app=nginx
  Containers:
   nginx:
    <font color=red>Image:        quay.io/cloudwalker/nginx:1.21</font>
    Port:         80/TCP
    Host Port:    0/TCP

</pre>

<h3 id="進版流程驗證"><a href="#進版流程驗證" class="headerlink" title="進版流程驗證"></a>進版流程驗證</h3><pre>

OldReplicaSets:  <none>
NewReplicaSet:   depng-59475496dc (2/2 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  71s   deployment-controller  Scaled up replica set depng-6d7cd45868 to 2
  Normal  ScalingReplicaSet  23s   deployment-controller  Scaled up replica set depng-59475496dc to 1
  Normal  ScalingReplicaSet  19s   deployment-controller  Scaled down replica set depng-6d7cd45868 to 1 from 2
  Normal  ScalingReplicaSet  19s   deployment-controller  Scaled up replica set depng-59475496dc to 2 from 1
  Normal  ScalingReplicaSet  18s   deployment-controller  Scaled down replica set depng-6d7cd45868 to 0 from 1
</pre>


<ul>
<li>可以看到<strong>先把新版的網站部屬一個以後，再將舊版的服務停掉一個，再把新版的網站擴充到設定的 2 個，最後舊版的全部退掉。</strong></li>
</ul>
<h2 id="網站退版"><a href="#網站退版" class="headerlink" title="網站退版"></a>網站退版</h2><p>將 Deployment 退回上一個版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout undo deployment.v1.apps/depng --to-revision=1</span><br></pre></td></tr></table></figure>

<p>檢查是否符合預期</p>
<pre>
$ kubectl describe deployment depng
........
  Containers:
   nginx:
    <font color=red>Image:        quay.io/cloudwalker/nginx:1.20</font>
    Port:         80/TCP
    Host Port:    0/TCP
.........
OldReplicaSets:  <none>
NewReplicaSet:   depng-6d7cd45868 (2/2 replicas created)
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  2m23s  deployment-controller  Scaled up replica set depng-6d7cd45868 to 2
  Normal  ScalingReplicaSet  95s    deployment-controller  Scaled up replica set depng-59475496dc to 1
  Normal  ScalingReplicaSet  91s    deployment-controller  Scaled down replica set depng-6d7cd45868 to 1 from 2
  Normal  ScalingReplicaSet  91s    deployment-controller  Scaled up replica set depng-59475496dc to 2 from 1
  Normal  ScalingReplicaSet  90s    deployment-controller  Scaled down replica set depng-6d7cd45868 to 0 from 1
  Normal  ScalingReplicaSet  9s     deployment-controller  Scaled up replica set depng-6d7cd45868 to 1 from 0
  Normal  ScalingReplicaSet  8s     deployment-controller  Scaled down replica set depng-59475496dc to 1 from 2
  Normal  ScalingReplicaSet  8s     deployment-controller  Scaled up replica set depng-6d7cd45868 to 2 from 1
  Normal  ScalingReplicaSet  6s     deployment-controller  Scaled down replica set depng-59475496dc to 0 from 1
</pre>

<ul>
<li>看倒數四筆的事件，要建立的版本會先建立，等要建立的版本會先建立好後，之前的版本才會刪除</li>
</ul>
<h2 id="橫向擴充服務"><a href="#橫向擴充服務" class="headerlink" title="橫向擴充服務"></a>橫向擴充服務</h2><p>將 Deployment 的 pod 擴充為 3 個</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale deployment.v1.apps/depng --replicas=3</span><br></pre></td></tr></table></figure>

<p>檢查是否符合預期</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get deployment depng</span><br><span class="line">NAME   DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">dep1   3         3         3            3           46m</span><br><span class="line"></span><br><span class="line">$ kubectl get pods | grep depng</span><br><span class="line">dep1-66f7f56f56-2rf8p   1/1     Running   0          39s</span><br><span class="line">dep1-66f7f56f56-bggcn   1/1     Running   0          71s</span><br><span class="line">dep1-66f7f56f56-mn589   1/1     Running   0          69s</span><br><span class="line"></span><br><span class="line">$ kubectl delete deployment depng</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes-RBAC-Context.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes-RBAC-Context.html" class="post-title-link" itemprop="url">Kubernetes-RBAC-Context</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-18 08:51:12" itemprop="dateCreated datePublished" datetime="2022-09-18T08:51:12+08:00">2022-09-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 16:15:42" itemprop="dateModified" datetime="2023-05-07T16:15:42+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-RBAC-Context"><a href="#Kubernetes-RBAC-Context" class="headerlink" title="Kubernetes-RBAC-Context"></a>Kubernetes-RBAC-Context</h1><p>:::warning</p>
<p>:::spoiler 目錄</p>
<p>[TOC]</p>
<p>:::</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><img src="https://i.imgur.com/TyAPgJl.png"></p>
<ul>
<li>Linux 系統可以讓多人同時協同作業，使用者登入後，工作目錄會在自己的家目錄。</li>
<li>在 K8S 的系統中，也能夠實現多使用者同時進入 K8S 的叢集做操作，登入 K8S 時，靠的是所在機器(Linux&#x2F;Windows 作業系統)的使用者家目錄下<code>~/.kube/config</code> 這個放憑證的檔案。</li>
<li>這個憑證會決定使用者在 K8S 可以進入哪個 Namespace ，可以”建立”還是”刪除”還是”查詢”物件…等。</li>
</ul>
<h2 id="K8S-Multi-Tenancy-管理套件"><a href="#K8S-Multi-Tenancy-管理套件" class="headerlink" title="K8S Multi-Tenancy 管理套件"></a>K8S Multi-Tenancy 管理套件</h2><p>下載老師準備好的環境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ cd; wget http://www.oc99.org/zip/k8suser.zip; unzip k8suser.zip; cd k8suser</span><br><span class="line"></span><br><span class="line">$ ls -l</span><br><span class="line">total 40</span><br><span class="line">-rw-r--r-- 1 bigred bigred  328 Apr  8 22:03 clusterbind.yaml</span><br><span class="line">-rw-r--r-- 1 bigred bigred  507 Apr  8 22:03 clusterole.yaml</span><br><span class="line">-rw-r--r-- 1 bigred bigred  269 Nov  1  2021 context.temp</span><br><span class="line">-rw-r--r-- 1 bigred bigred  277 Oct 30  2021 csr.yaml</span><br><span class="line">-rwxr-xr-x 1 bigred bigred   74 Apr  6 16:00 deluser.sh</span><br><span class="line">-rwxr-xr-x 1 bigred bigred  975 Apr  8 21:57 mkcontext.sh</span><br><span class="line">-rwxr-xr-x 1 bigred bigred 1045 Apr  6 16:01 mkubeuser.sh</span><br><span class="line">-rw-r--r-- 1 bigred bigred  986 Apr  7 17:30 role.temp</span><br><span class="line">-rw-r--r-- 1 bigred bigred  214 Apr  7 17:20 role.yaml</span><br><span class="line">-rw-r--r-- 1 bigred bigred  302 Oct 27  2021 rolebind.yaml</span><br></pre></td></tr></table></figure>

<h2 id="建立-K8S-User-及-憑証"><a href="#建立-K8S-User-及-憑証" class="headerlink" title="建立 K8S User 及 憑証"></a>建立 K8S User 及 憑証</h2><p>建立 bigboss 使用者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./mkubeuser.sh bigboss</span><br><span class="line">K8S bigboss created</span><br></pre></td></tr></table></figure>

<p>憑證放在 <code>kuser</code> 目錄</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ls -l kuser/</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 bigred bigred 1115 Sep 12 10:13 bigboss.crt</span><br><span class="line">-rw-r--r-- 1 bigred bigred  911 Sep 12 10:13 bigboss.csr</span><br><span class="line">-rw------- 1 bigred bigred 1675 Sep 12 10:13 bigboss.key</span><br></pre></td></tr></table></figure>

<ul>
<li><code>bigboss.key</code>，私鑰</li>
<li><code>bigboss.csr</code>，放的是使用者的資訊，包含私鑰，姓名和服務單位的資料</li>
<li><code>bigboss.crt</code>，K8S 根據你用 <code>bigboss.csr</code> 這個檔案申請認證後，產生的憑證檔<ul>
<li><code>crt</code> stand for <code>certificate</code></li>
</ul>
</li>
</ul>
<p>檢查 K8S 的所有使用者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config view | grep -A 10 -e &#x27;^users&#x27;</span><br><span class="line">users:</span><br><span class="line">- name: bigboss</span><br><span class="line">  user:</span><br><span class="line">    client-certificate: /home/bigred/k8suser/kuser/bigboss.crt</span><br><span class="line">    client-key: /home/bigred/k8suser/kuser/bigboss.key</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: REDACTED</span><br><span class="line">    client-key-data: REDACTED</span><br></pre></td></tr></table></figure>

<ul>
<li><code>REDACTED</code> ，表示沒有自己特別指定目錄將使用者登入資訊放在另一個檔案<ul>
<li>放在 <code>~/.kube/config</code> 這個檔案裡面</li>
</ul>
</li>
</ul>
<p>看 bigred 使用者在 K8S 系統的憑證</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ cat ~/.kube/config</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">  ...</span><br><span class="line">    server: https://192.168.61.4:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: bigboss</span><br><span class="line">  user:</span><br><span class="line">    client-certificate: /home/bigred/k8suser/kuser/bigboss.crt</span><br><span class="line">    client-key: /home/bigred/k8suser/kuser/bigboss.key</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data:</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li><code>clusters</code>，設定 K8S 叢集 (結尾是 s ，代表 K8S 的 Cluster 可以有很多個)<ul>
<li><code>cluster.server</code>，登入 K8S 的 IP 位址 : <code>https://192.168.61.4:6443</code></li>
<li><code>clusters.name</code>，K8S 叢集的名字 : <code>kubernetes</code></li>
</ul>
</li>
<li><code>contexts.</code>，設定 K8S 的入口 (結尾是 s ，代表 K8S 的入口可以有很多個)<ul>
<li><code>context.cluster</code>，入口在哪一個 K8S 叢集 ( 名字就叫 <code>kubernetes</code> )</li>
<li><code>context.user</code>，可以進入入口的使用者 : <code>kubernetes-admin</code></li>
<li><code>name</code>，入口的名字 : <code>kubernetes-admin@kubernetes</code></li>
</ul>
</li>
<li><code>current-context</code>，當前的入口 : <code>kubernetes-admin@kubernetes</code></li>
<li><code>kind: Config</code>，設定使用者登入的資訊</li>
<li>入口憑證檔的重點： <strong>當前的入口名字</strong>、<strong>哪位使用者可以進去</strong>、<strong>進到哪一個 K8S Cluster</strong></li>
</ul>
<h2 id="認識-Role-based-Access-Control"><a href="#認識-Role-based-Access-Control" class="headerlink" title="認識 Role-based Access Control"></a>認識 Role-based Access Control</h2><ol>
<li>Subjects: The set of users and processes that want to access the Kubernetes API.</li>
<li>Resources: The set of Kubernetes API Objects available in the cluster. Examples include Pods, Deployments, Services, Nodes, and PersistentVolumes, among others.</li>
<li>Verbs: The set of operations that can be executed to the resources above. Different verbs are available (examples: get, watch, create, delete, etc.), but ultimately all of them are Create, Read, Update or Delete (CRUD) operations.</li>
</ol>
<ul>
<li><code>Subject</code>，指的是 K8S 的 User (分為 User 和 ServiceAccount)<ul>
<li>Users: These are global, and meant for humans or processes living outside the cluster.<ul>
<li>人和 K8S Cluster <strong>外面</strong>的程序</li>
</ul>
</li>
<li>ServiceAccounts: These are namespaced and meant for intra-cluster processes running inside pods.<ul>
<li>在 K8S Cluster <strong>裡面</strong>的 pod 裡的程序</li>
</ul>
</li>
</ul>
</li>
<li><code>Resources</code>，指的是 K8S 的物件</li>
<li><code>Verbs</code>，指的是可以對 K8S 的物件做什麼動作<ul>
<li>像是可以看 pod 的資訊、新增 pod 或是 刪除 pod …等動作</li>
<li><code>watch</code>，是一直監控物件的狀態</li>
<li><code>get</code>，是看單一物件的狀態</li>
<li><code>list</code>，看單一種物件的狀態</li>
</ul>
</li>
</ul>
<h2 id="產生-Role"><a href="#產生-Role" class="headerlink" title="產生 Role"></a>產生 Role</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 檢視 RBAC 的版本</span><br><span class="line">$ kubectl api-versions | grep rbac</span><br><span class="line">rbac.authorization.k8s.io/v1</span><br><span class="line"></span><br><span class="line"># 建立 finance Namespace</span><br><span class="line">$ kubectl create namespace finance </span><br><span class="line"></span><br><span class="line"># 編輯 Role 的 yaml 檔</span><br><span class="line">$ echo $&#x27;kind: Role</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: finance   </span><br><span class="line">  name: finance-reader</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;] # &quot;&quot; indicates the core API group</span><br><span class="line">  resources: [&quot;pods&quot;, &quot;services&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;] &#x27; &gt; role.yaml</span><br><span class="line"></span><br><span class="line"># 建立 Role</span><br><span class="line">$ kubectl create -f role.yaml </span><br><span class="line">role.rbac.authorization.k8s.io/finance-reader created</span><br><span class="line"></span><br><span class="line"># 檢視 Role 資訊</span><br><span class="line">$ kubectl get roles --namespace=finance</span><br><span class="line">NAME             CREATED AT</span><br><span class="line">finance-reader   2020-10-21T13:48:50Z</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Role</code> ，設定一個 Namespace 裡對什麼物件可以有什麼動作</li>
<li><code>rules.resources</code>，主要設定 <code>pods</code> 和 <code>services</code> 的物件</li>
<li><code>rules.verbs</code>，針對剛剛的物件，設定動作 <code>get</code> 、 <code>watch</code> 和 <code>list</code></li>
</ul>
<h2 id="產生-RoleBinding"><a href="#產生-RoleBinding" class="headerlink" title="產生 RoleBinding"></a>產生 RoleBinding</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 建立 RoleBinding</span><br><span class="line">$ echo $&#x27;kind: RoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: finance-read-access</span><br><span class="line">  namespace: finance </span><br><span class="line">subjects:</span><br><span class="line">- kind: User</span><br><span class="line">  name: bigboss</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">roleRef:</span><br><span class="line">  kind: Role #this must be Role or ClusterRole</span><br><span class="line">  name: finance-reader </span><br><span class="line">  apiGroup: rbac.authorization.k8s.io &#x27; |  kubectl  apply  -f  -</span><br><span class="line"></span><br><span class="line"># 檢視 Rolebinding 資訊</span><br><span class="line">$ kubectl get rolebindings --namespace=finance</span><br><span class="line">NAME                  ROLE                  AGE</span><br><span class="line">finance-read-access   Role/finance-reader   8m13s</span><br></pre></td></tr></table></figure>

<ul>
<li><code>RoleBinding</code>，在單一 Namespace 中，將 Role 跟 K8S 的 User 綁在一起</li>
<li><code>subjects.kind</code>，設定 K8S User<ul>
<li><code>name: bigboss</code>，指定 K8S 的 bigboss User</li>
</ul>
</li>
<li><code>roleRef</code>，設定 Role 或是 ClusterRole<ul>
<li><code>name: finance-reader</code>，設定 <code>finance-reader</code> 這個 Role</li>
</ul>
</li>
</ul>
<h2 id="Create-Cluster-Role"><a href="#Create-Cluster-Role" class="headerlink" title="Create Cluster Role"></a>Create Cluster Role</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 建立 ClusterRole</span><br><span class="line">$ echo  $&#x27;kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  # &quot;namespace&quot; omitted since ClusterRoles are not namespaced</span><br><span class="line">  name: cluster-pods-reader</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;pods&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;] &#x27; | kubectl create -f  -</span><br><span class="line"></span><br><span class="line"># 檢查 ClusterRole 狀態</span><br><span class="line">$ kubectl get clusterroles | grep cluster-pods-reader</span><br><span class="line">NAME                 CREATED AT</span><br><span class="line">cluster-pods-reader  2022-09-12T03:41:26Z</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Cluster Role</code>，設定在全部的 Namespace 中對什麼物件可以有什麼動作</li>
<li><code>apiGroups</code>，有設定這個才能設定要限制 resource<ul>
<li><code>kubectl api-resources</code>，可以看 resources 在哪個 <code>apiGroups</code> 下</li>
</ul>
</li>
</ul>
<h2 id="Cluster-Role-Binding"><a href="#Cluster-Role-Binding" class="headerlink" title="Cluster Role Binding"></a>Cluster Role Binding</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 建立 ClusterRoleBinding</span><br><span class="line">$ echo $&#x27;kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: read-cluster-pods</span><br><span class="line">subjects:</span><br><span class="line">- kind: User</span><br><span class="line">  name: bigboss  </span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-pods-reader</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io &#x27; | kubectl create -f  - </span><br><span class="line"></span><br><span class="line">$ kubectl get clusterrolebindings | grep read-cluster-pods</span><br><span class="line">NAME               ROLE                             AGE</span><br><span class="line">read-cluster-pods  ClusterRole/cluster-pods-reader  16s</span><br><span class="line"></span><br><span class="line">$ kubectl get pods --as=bigboss</span><br><span class="line">No resources found in default namespace</span><br></pre></td></tr></table></figure>

<ul>
<li><code>clusterRolebinding</code>，設定 K8S User (包含 service account)與 role 綁定而擁有存取權限</li>
</ul>
<h1 id="切換-K8S-Namespace"><a href="#切換-K8S-Namespace" class="headerlink" title="切換 K8S Namespace"></a>切換 K8S Namespace</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 執行以下命令, 可知目前使用的 K8S Context 的 namespace 沒有設定</span><br><span class="line"># 用的是預設 default 的 Namespace</span><br><span class="line">$ kubectl config get-contexts</span><br><span class="line">CURRENT   NAME                                CLUSTER      AUTHINFO      NAMESPACE</span><br><span class="line">*  kubernetes-admin@kubernetes   kubernetes   kubernetes-admin  </span><br><span class="line"></span><br><span class="line"># 只要從這個路口登入，Namespace 就會直接切換到 finance namespace</span><br><span class="line">$ kubectl config set-context $(kubectl config current-context) --namespace=finance</span><br><span class="line">Context &quot;kubernetes-admin@kubernetes&quot; modified.</span><br><span class="line"></span><br><span class="line"># 只會顯示 finance namespace 中的 POD</span><br><span class="line">$ kubectl get pods </span><br><span class="line">NAME         READY   STATUS    RESTARTS   AGE</span><br><span class="line">helloworld   1/1       Running   0          13h</span><br><span class="line"></span><br><span class="line"># 因內定為 finance namespace, 所以 bigboss 可以讀取</span><br><span class="line">$ kubectl get pods --as bigboss</span><br><span class="line">NAME         READY   STATUS    RESTARTS   AGE</span><br><span class="line">helloworld   1/1        Running   0         13h</span><br></pre></td></tr></table></figure>


<h2 id="切換回-K8S-Default-Namespace"><a href="#切換回-K8S-Default-Namespace" class="headerlink" title="切換回 K8S Default Namespace"></a>切換回 K8S Default Namespace</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 切換到 default namespace</span><br><span class="line">$ kubectl config set-context $(kubectl config current-context) --namespace=</span><br><span class="line">Context &quot;kubernetes-admin@kubernetes&quot; modified.</span><br><span class="line"></span><br><span class="line">$ kubectl get pods</span><br><span class="line">No resources found in default namespace.</span><br></pre></td></tr></table></figure>

<h1 id="建立-K8S-Context"><a href="#建立-K8S-Context" class="headerlink" title="建立 K8S Context"></a>建立 K8S Context</h1><p>建立 finance-context Context</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config set-context finance-context \</span><br><span class="line">--cluster=kubernetes --namespace=finance --user=bigboss</span><br></pre></td></tr></table></figure>

<ul>
<li><code>set-context  finance-context</code>，建立新的 K8S 的入口，後面接的是入口名稱 <code>finance-context</code></li>
<li><code>--cluster</code>，設定入口所在的 K8S 叢集</li>
<li><code>--namespace</code>，設定進入入口後的 Namespace</li>
<li><code>--user</code>，設定哪一個 K8S 的使用者可以進入新建立的入口</li>
</ul>
<p>檢視新的入口資訊</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config view | grep -A 10 contexts:</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    namespace: finance</span><br><span class="line">    user: bigboss</span><br><span class="line">  name: finance-context</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Contexts</code> 下面成功多了剛剛新建立的 <code>finance-context</code></li>
</ul>
<p>切換至 finance-context</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config use-context finance-context</span><br></pre></td></tr></table></figure>

<ul>
<li><code>use-context</code>，設定當前的入口</li>
</ul>
<p>在 finance-context 入口操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 檢視 nodes 資訊</span><br><span class="line">$ k get nodes</span><br><span class="line">Error from server (Forbidden): nodes is forbidden: User &quot;bigboss&quot; cannot list resource &quot;nodes&quot; in API group &quot;&quot; at the cluster scope</span><br><span class="line"></span><br><span class="line"># 檢視 pods 資訊</span><br><span class="line">$ k get pods</span><br><span class="line">NAME         READY   STATUS    RESTARTS   AGE</span><br><span class="line">helloworld   1/1     Running   0          124m</span><br><span class="line"></span><br><span class="line"># 檢視在 kube-system 中 pods 的資訊</span><br><span class="line">$ k get pods -n kube-system</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-565d847f94-rf5tn     1/1     Running   2          2d2h</span><br><span class="line">coredns-565d847f94-t5px2     1/1     Running   2          2d2h</span><br><span class="line">etcd-m1                      1/1     Running   2          2d2h</span><br><span class="line">kube-apiserver-m1            1/1     Running   2          2d2h</span><br><span class="line">kube-controller-manager-m1   1/1     Running   2          2d2h</span><br><span class="line">kube-proxy-2pgpr             1/1     Running   2          2d2h</span><br><span class="line">kube-proxy-fh9c2             1/1     Running   2          2d2h</span><br><span class="line">kube-proxy-qblhl             1/1     Running   2          2d2h</span><br><span class="line">kube-scheduler-m1            1/1     Running   2          2d2h</span><br></pre></td></tr></table></figure>


<h1 id="K8S-Multi-Tenancy-實作"><a href="#K8S-Multi-Tenancy-實作" class="headerlink" title="K8S Multi-Tenancy 實作"></a>K8S Multi-Tenancy 實作</h1><h2 id="前置動作"><a href="#前置動作" class="headerlink" title="前置動作"></a>前置動作</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir tmp; cd tmp</span><br><span class="line"></span><br><span class="line">$ unzip ~/k8suser.zip</span><br><span class="line"></span><br><span class="line">$ cp k8suser/*.yaml ~/k8suser/</span><br></pre></td></tr></table></figure>


<h2 id="建立-K8S-User-及-憑証-1"><a href="#建立-K8S-User-及-憑証-1" class="headerlink" title="建立 K8S User 及 憑証"></a>建立 K8S User 及 憑証</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ./mkubeuser.sh rbean</span><br><span class="line">K8S rbean created</span><br><span class="line"></span><br><span class="line">$ ls -lt kuser/</span><br><span class="line">total 24</span><br><span class="line">-rw-r--r-- 1 bigred bigred 1111 Sep 12 13:49 rbean.crt</span><br><span class="line">-rw-r--r-- 1 bigred bigred  907 Sep 12 13:49 rbean.csr</span><br><span class="line">-rw------- 1 bigred bigred 1679 Sep 12 13:49 rbean.key</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>檢查是否符合預期</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ k config view | grep -A12 -e &#x27;^users&#x27;</span><br><span class="line">users:</span><br><span class="line">- name: bigboss</span><br><span class="line">  user:</span><br><span class="line">    client-certificate: /home/bigred/k8suser/kuser/bigboss.crt</span><br><span class="line">    client-key: /home/bigred/k8suser/kuser/bigboss.key</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: REDACTED</span><br><span class="line">    client-key-data: REDACTED</span><br><span class="line">- name: rbean</span><br><span class="line">  user:</span><br><span class="line">    client-certificate: /home/bigred/k8suser/kuser/rbean.crt</span><br><span class="line">    client-key: /home/bigred/k8suser/kuser/rbean.key</span><br></pre></td></tr></table></figure>

<p>建立 rbean 使用者的入口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ./mkcontext.sh rbean</span><br><span class="line">namespace/rbean created</span><br><span class="line">- context:</span><br><span class="line">    cluster: default</span><br><span class="line">    namespace: rbean</span><br><span class="line">    user: rbean</span><br><span class="line">  name: rbean-context</span><br><span class="line">Warning: resource roles/finance-reader is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.</span><br><span class="line">role.rbac.authorization.k8s.io/finance-reader configured</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/rbean-rbind created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/rbean-clusterole created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/rbean-clusterbind created</span><br></pre></td></tr></table></figure>

<p>檢查</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.61.4:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">...</span><br><span class="line">- context:</span><br><span class="line">    cluster: default</span><br><span class="line">    namespace: rbean</span><br><span class="line">    user: rbean</span><br><span class="line">  name: rbean-context</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">...</span><br></pre></td></tr></table></figure>


<p>檢視 <code>mkubeuser.sh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> STU=<span class="variable">$&#123;1&#125;</span></span><br><span class="line"><span class="built_in">export</span> DIR_CSR=~/k8suser/kuser</span><br><span class="line"></span><br><span class="line">[ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> != <span class="string">&quot;1&quot;</span> ] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;mkubeuser.sh user&quot;</span> &amp;&amp; <span class="built_in">exit</span> 1</span><br><span class="line">[ ! -d <span class="variable">$&#123;DIR_CSR&#125;</span> ] &amp;&amp; <span class="built_in">mkdir</span> -p <span class="variable">$&#123;DIR_CSR&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">which</span> envsubst &amp;&gt;/dev/null</span><br><span class="line">[ $? = 1 ] &amp;&amp; sudo apk update &amp;&amp; sudo apk add gettext &amp;&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="variable">$&#123;DIR_CSR&#125;</span>/<span class="variable">$&#123;STU&#125;</span>.key ]; <span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;K8S <span class="variable">$&#123;STU&#125;</span> existed&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   openssl genrsa -out <span class="variable">$&#123;DIR_CSR&#125;</span>/<span class="variable">$&#123;STU&#125;</span>.key 2048 &amp;&gt;/dev/null</span><br><span class="line">   openssl req -new -key <span class="variable">$&#123;DIR_CSR&#125;</span>/<span class="variable">$&#123;STU&#125;</span>.key -out <span class="variable">$&#123;DIR_CSR&#125;</span>/<span class="variable">$&#123;STU&#125;</span>.csr -subj <span class="string">&quot;/CN=<span class="variable">$&#123;STU&#125;</span>/O=<span class="variable">$&#123;STU&#125;</span>&quot;</span></span><br><span class="line">   <span class="built_in">export</span> BASE64_CSR=$(<span class="built_in">cat</span> <span class="variable">$&#123;DIR_CSR&#125;</span>/<span class="variable">$&#123;STU&#125;</span>.csr | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">   <span class="built_in">cat</span> ~/k8suser/csr.yaml | envsubst | kubectl apply -f - &amp;&gt;/dev/null</span><br><span class="line">   kubectl certificate approve <span class="variable">$&#123;STU&#125;</span>-csr &amp;&gt;/dev/null</span><br><span class="line">   <span class="built_in">sleep</span> 5</span><br><span class="line">   kubectl get csr <span class="variable">$&#123;STU&#125;</span>-csr -o jsonpath=<span class="string">&#x27;&#123;.status.certificate&#125;&#x27;</span> | <span class="built_in">base64</span> -d &gt; <span class="variable">$&#123;DIR_CSR&#125;</span>/<span class="variable">$&#123;STU&#125;</span>.crt</span><br><span class="line">   kubectl config set-credentials <span class="variable">$&#123;STU&#125;</span> --client-certificate=<span class="variable">$&#123;DIR_CSR&#125;</span>/<span class="variable">$&#123;STU&#125;</span>.crt --client-key=<span class="variable">$&#123;DIR_CSR&#125;</span>/<span class="variable">$&#123;STU&#125;</span>.key &amp;&gt;/dev/null</span><br><span class="line">   kubectl config view | grep <span class="string">&quot;name: <span class="variable">$&#123;STU&#125;</span>&quot;</span> &amp;&gt;/dev/null</span><br><span class="line">   [ <span class="string">&quot;$?&quot;</span> == <span class="string">&quot;0&quot;</span> ] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;K8S <span class="variable">$&#123;STU&#125;</span> created&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h2 id="檢視-K8S-User-Context"><a href="#檢視-K8S-User-Context" class="headerlink" title="檢視 K8S User Context"></a>檢視 K8S User Context</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ cat kuser/rbean.conf</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F</span><br><span class="line">........</span><br><span class="line">    server: https://192.168.61.4:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    namespace: rbean</span><br><span class="line">    user: rbean</span><br><span class="line">  name: rbean-context</span><br><span class="line">current-context: rbean-context</span><br><span class="line">........</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: rbean</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCakNDQWU2Z0F..........</span><br><span class="line">    client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0........</span><br></pre></td></tr></table></figure>

<ul>
<li><code>client-certificate-data</code> 存放 公鑰 的憑証檔</li>
<li><code>client-key-data</code> ，存放使用者的 私鑰</li>
</ul>
<h2 id="檢視-Namespace-RBAC-設定"><a href="#檢視-Namespace-RBAC-設定" class="headerlink" title="檢視 Namespace RBAC 設定"></a>檢視 Namespace RBAC 設定</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get role -n rbean</span><br><span class="line">NAME         CREATED AT</span><br><span class="line">rbean-role   2022-04-08T14:50:29Z</span><br><span class="line"></span><br><span class="line">$ kubectl get clusterrole -n rbean | grep rbean</span><br><span class="line">rbean-clusterole   2022-04-08T14:50:29Z</span><br><span class="line"></span><br><span class="line">$ kubectl describe role rbean-role -n rbean</span><br><span class="line">Name:         rbean-clusterole</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources                         Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------                         -----------------  --------------  -----</span><br><span class="line">  csidrivers.storage.k8s.io         []                 []              [*]</span><br><span class="line">  csinodes.storage.k8s.io           []                 []              [*]</span><br><span class="line">  storageclasses.storage.k8s.io     []                 []              [*]</span><br><span class="line">  volumeattachments.storage.k8s.io  []                 []              [*]</span><br><span class="line">  nodes                             []                 []              [create delete deletecollection get list patch update watch]</span><br><span class="line">  persistentvolumes                 []                 []              [create delete deletecollection get list patch update watch]</span><br></pre></td></tr></table></figure>

<h2 id="建立-Linux-User-及-設定-K8S-憑証"><a href="#建立-Linux-User-及-設定-K8S-憑証" class="headerlink" title="建立 Linux User 及 設定 K8S 憑証"></a>建立 Linux User 及 設定 K8S 憑証</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ echo -e &quot;rbean\nrbean&quot; | sudo adduser rbean</span><br><span class="line"></span><br><span class="line">$ sudo mkdir /home/rbean/.kube; sudo cp ~/k8suser/kuser/rbean.conf /home/rbean/.kube/config; sudo chown -R rbean:rbean /home/rbean/.kube</span><br><span class="line"></span><br><span class="line">$ dir /home/rbean/.kube</span><br><span class="line">total 16K</span><br><span class="line">drwxr-sr-x 2 rbean rbean 4.0K Apr  7 10:00 .</span><br><span class="line">drwxr-sr-x 3 rbean rbean 4.0K Apr  7 10:00 ..</span><br><span class="line">-rw-r--r-- 1 rbean rbean 5.5K Apr  7 10:00 config</span><br><span class="line"></span><br><span class="line">$ exit</span><br></pre></td></tr></table></figure>

<ul>
<li><code>/home/rbean/.kube/config</code>，這個檔案為路口憑證檔</li>
</ul>
<h2 id="檢視-K8S-User-憑証"><a href="#檢視-K8S-User-憑証" class="headerlink" title="檢視 K8S User 憑証"></a>檢視 K8S User 憑証</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">在 Windows 系統的 cmd 視窗, 執行以下命令</span><br><span class="line">$ ssh rbean@&lt;alp.m1 IP&gt;</span><br><span class="line"></span><br><span class="line">$ kubectl config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.61.4:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    namespace: rbean</span><br><span class="line">    user: rbean</span><br><span class="line">  name: rbean-context</span><br><span class="line">current-context: rbean-context</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: rbean</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: REDACTED</span><br><span class="line">    client-key-data: REDACTED</span><br></pre></td></tr></table></figure>

<h2 id="測試-K8S-User-憑証"><a href="#測試-K8S-User-憑証" class="headerlink" title="測試 K8S User 憑証"></a>測試 K8S User 憑証</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ kg all</span><br><span class="line">No resources found in rbean namespace.</span><br><span class="line">$ kg pv</span><br><span class="line">No resources found</span><br><span class="line">$ kg sc</span><br><span class="line">No resources found</span><br><span class="line"></span><br><span class="line">$ kubectl run a1 --rm -it --image=quay.io/cloudwalker/alpine</span><br><span class="line">If you don&#x27;t see a command prompt, try pressing enter.</span><br><span class="line">/ # ping -c 1 www.hinet.net</span><br><span class="line">PING www.hinet.net (163.28.83.113): 56 data bytes</span><br><span class="line">ping: permission denied (are you root?)</span><br><span class="line">/ # exit</span><br><span class="line"></span><br><span class="line">$ exit</span><br></pre></td></tr></table></figure>


<h1 id="bobo-網站應用系統"><a href="#bobo-網站應用系統" class="headerlink" title="bobo 網站應用系統"></a>bobo 網站應用系統</h1><h2 id="佈署-bobo-網站應用系統"><a href="#佈署-bobo-網站應用系統" class="headerlink" title="佈署 bobo 網站應用系統"></a>佈署 bobo 網站應用系統</h2><p>在 bigred 終端機, 執行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://www.oc99.org/zip/bobowas.zip; unzip bobowas.zip</span><br><span class="line"></span><br><span class="line"># 佈署 alp.mysql, alp.goweb 及 alp.myfbs image</span><br><span class="line">$ cd ~/bobowas/k8simg/</span><br><span class="line"></span><br><span class="line">$ ./go-k8s-images.sh</span><br><span class="line">[images build]</span><br><span class="line">alp.myfbs image ok</span><br><span class="line">alp.mysql image ok</span><br><span class="line">alp.goweb image ok</span><br><span class="line"></span><br><span class="line">[images deploy]</span><br><span class="line">w1: localhost/alp.myfbs image ok</span><br><span class="line">w2: localhost/alp.myfbs image ok</span><br><span class="line"></span><br><span class="line">w1: localhost/alp.mysql image ok</span><br><span class="line">w2: localhost/alp.mysql image ok</span><br><span class="line"></span><br><span class="line">w1: localhost/alp.goweb image ok</span><br><span class="line">w2: localhost/alp.goweb image ok</span><br></pre></td></tr></table></figure>

<p>在 rbean 終端機, 執行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://www.oc99.org/zip/bobowas.zip; unzip bobowas.zip</span><br><span class="line"></span><br><span class="line">$ cd /home/bigred/bobowas/k8sobj/</span><br><span class="line"></span><br><span class="line">$ ./go-k8s-object.sh</span><br><span class="line">bobo.fbs(w1) pod created</span><br><span class="line">bobo.mysql(w2) pod created</span><br><span class="line">bobo.goweb(w1) pod created</span><br><span class="line">bobo.gosvc service created</span><br><span class="line"></span><br><span class="line">$ kg all</span><br><span class="line">NAME                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/bobo.fbs         1/1       Running    0               15s</span><br><span class="line">pod/bobo.goweb    1/1       Running    0               15s</span><br><span class="line">pod/bobo.mysql    1/1        Running    0               15s</span><br><span class="line"></span><br><span class="line">NAME                   TYPE        CLUSTER-IP    EXTERNAL-IP    PORT(S)   AGE</span><br><span class="line">service/svc-gosrv   ClusterIP  10.98.0.237  192.168.61.4   80/TCP   15s</span><br></pre></td></tr></table></figure>


<h1 id="K8S-Namespace-Resource-Quota"><a href="#K8S-Namespace-Resource-Quota" class="headerlink" title="K8S Namespace Resource Quota"></a>K8S Namespace Resource Quota</h1><p>在 bigred 終端機, 執行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano ~/bobowas/k8sobj/nsrq.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">compute-quota</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">rbean</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">requests.cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="attr">requests.memory:</span> <span class="string">256Mi</span></span><br><span class="line">    <span class="attr">requests.nvidia.com/gpu:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">limits.cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">limits.memory:</span> <span class="string">1Gi</span></span><br><span class="line">    <span class="attr">limits.nvidia.com/gpu:</span> <span class="number">2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">object-quota</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">rbean</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">    <span class="attr">configmaps:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">persistentvolumeclaims:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">replicationcontrollers:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">secrets:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="attr">services:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="attr">services.loadbalancers:</span> <span class="string">&quot;2&quot;</span></span><br></pre></td></tr></table></figure>

<p>產生 resourcequota</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ka -f nsrq.yaml</span><br></pre></td></tr></table></figure>

<h2 id="檢視-Resource-Quota"><a href="#檢視-Resource-Quota" class="headerlink" title="檢視 Resource Quota"></a>檢視 Resource Quota</h2><p>在 rbean 終端機, 執行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get resourcequotas</span><br><span class="line">NAME            AGE     REQUEST                                                                                                                                            LIMIT</span><br><span class="line">compute-quota   2m36s   requests.cpu: 0/1, requests.memory: 0/256Mi, requests.nvidia.com/gpu: 0/1                                                                          limits.cpu: 0/2, limits.memory: 0/1Gi, limits.nvidia.com/gpu: 0/2</span><br><span class="line">object-quota    2m36s   configmaps: 1/2, persistentvolumeclaims: 0/2, pods: 3/3, replicationcontrollers: 0/2, secrets: 0/10, services: 1/10, services.loadbalancers: 0/2</span><br></pre></td></tr></table></figure>

<ul>
<li>Resource Quota 建立後，並不會限制已經建立的 pod 。</li>
</ul>
<p>產生 a1 的 pod 測試有沒有被限制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run a1 --rm -it --image=quay.io/cloudwalker/alpine</span><br><span class="line">Error from server (Forbidden): pods &quot;a1&quot; is forbidden: failed quota: compute-quota: must specify limits.cpu for: a1; limits.memory for: a1; requests.cpu for: a1; requests.memory for: a1</span><br></pre></td></tr></table></figure>

<ul>
<li>錯誤訊息說明 : 建立 pod 時，要設定使用的資源</li>
</ul>
<p>重新編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run a1 --image=quay.io/cloudwalker/alpine --dry-run=client -o yaml &gt; pod.yaml</span><br></pre></td></tr></table></figure>

<p>編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano pod.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">a1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">a1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/alpine</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">a1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">         <span class="attr">cpu:</span> <span class="number">1.0</span></span><br><span class="line">         <span class="attr">memory:</span> <span class="string">256Mi</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">         <span class="attr">cpu:</span> <span class="number">2.0</span></span><br><span class="line">         <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>再重新產生 pod </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f pod.yaml</span><br><span class="line">Error from server (Forbidden): error when creating &quot;pod.yaml&quot;: pods &quot;a1&quot; is forbidden: exceeded quota: object-quota, requested: pods=1, used: pods=3, limited: pods=3</span><br></pre></td></tr></table></figure>

<ul>
<li>這時候噴的錯誤就是超過 resourcequota 的限制</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes-Resource-CPU-Memory.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes-Resource-CPU-Memory.html" class="post-title-link" itemprop="url">Kubernetes-Resource-CPU-Memory</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-18 05:14:58" itemprop="dateCreated datePublished" datetime="2022-09-18T05:14:58+08:00">2022-09-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 16:15:42" itemprop="dateModified" datetime="2023-05-07T16:15:42+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-Resource-CPU-Memory"><a href="#Kubernetes-Resource-CPU-Memory" class="headerlink" title="Kubernetes-Resource-CPU-Memory"></a>Kubernetes-Resource-CPU-Memory</h1><p>:::warning</p>
<p>:::spoiler 目錄</p>
<p>[TOC]</p>
<p>:::</p>
<h2 id="Assigning-Pods-to-Nodes"><a href="#Assigning-Pods-to-Nodes" class="headerlink" title="Assigning Pods to Nodes"></a>Assigning Pods to Nodes</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"># 檢視所有 node 的 labels</span><br><span class="line">$ kubectl get nodes --show-labels</span><br><span class="line"></span><br><span class="line"># 編輯 nodeselect 的 yaml 檔</span><br><span class="line">$ echo &#x27;apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: p1</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: c1</span><br><span class="line">    image: quay.io/cloudwalker/busybox</span><br><span class="line">    imagePullPolicy: Never</span><br><span class="line">    tty: true</span><br><span class="line">  nodeSelector:</span><br><span class="line">    kubernetes.io/hostname : m1 &#x27;&gt; ~/wulin/yaml/nodeselect.yaml </span><br><span class="line">    </span><br><span class="line"># apply 它</span><br><span class="line">$ kubectl apply -f  ~/wulin/yaml/nodeselect.yaml </span><br><span class="line">pod/p1 created</span><br><span class="line"></span><br><span class="line"># 檢查是否跑在 m1 這台指定的 node 上</span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE   IP           NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">p1     1/1     Running   0          35s   10.233.2.2           m1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># 刪除 p1 pod</span><br><span class="line">$ kubectl delete pods p1</span><br><span class="line">pod &quot;p1&quot; deleted</span><br><span class="line"></span><br><span class="line"># 編輯 depnode 的 yaml 檔</span><br><span class="line">$ nano ~/wulin/yaml/depnode.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: depnode</span><br><span class="line">  labels:</span><br><span class="line">    app: depnode</span><br><span class="line">spec:</span><br><span class="line">  replicas: 4</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: depnode</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: depnode</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: alp</span><br><span class="line">        image: quay.io/cloudwalker/alpine</span><br><span class="line">        tty: true</span><br><span class="line"></span><br><span class="line">$ ka  -f  ~/wulin/yaml/depnode.yaml</span><br><span class="line"></span><br><span class="line">$ kg pods -o wide --selector app=depnode</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE    IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">depnode-7789fd7db7-2h6t5   1/1     Running   0       5m4s   10.244.2.12   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">depnode-7789fd7db7-2vc6s   1/1     Running   0       5m4s   10.244.0.10   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">depnode-7789fd7db7-vl6g2   1/1     Running   0        5m4s   10.244.1.11   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">depnode-7789fd7db7-z4zxr   1/1     Running   0        5m4s   10.244.1.12   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ kd -f ~/wulin/yaml/depnode.yaml</span><br><span class="line"></span><br><span class="line">$ nano ~/wulin/yaml/depnode.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">.......</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: alp</span><br><span class="line">        image: quay.io/cloudwalker/alpine</span><br><span class="line">        tty: true</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">          - labelSelector:</span><br><span class="line">              matchExpressions:</span><br><span class="line">              - key: app</span><br><span class="line">                operator: In</span><br><span class="line">                values:</span><br><span class="line">                - depnode</span><br><span class="line">            topologyKey: kubernetes.io/hostname</span><br><span class="line"></span><br><span class="line">$ ka  -f  ~/wulin/yaml/depnode.yaml</span><br><span class="line"></span><br><span class="line">$ kg pods -o wide --selector app=depnode</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">depnode-7c65d66984-6cplq   1/1     Running   0          25s   10.244.2.13   w2       &lt;none&gt;           &lt;none&gt;</span><br><span class="line">depnode-7c65d66984-hgbs5   1/1     Running   0          25s   10.244.0.11   m1       &lt;none&gt;           &lt;none&gt;</span><br><span class="line">depnode-7c65d66984-pb9f9   0/1     Pending   0          25s   &lt;none&gt;        &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">depnode-7c65d66984-qj7g4   1/1     Running   0          25s   10.244.1.13   w1       &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ kd -f ~/wulin/yaml/depnode.yaml</span><br></pre></td></tr></table></figure>


<h1 id="Metrics-Server"><a href="#Metrics-Server" class="headerlink" title="Metrics Server"></a>Metrics Server</h1><p><strong>安裝 Metrics Server</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span><br><span class="line"></span><br><span class="line">$ nano components.yaml</span><br><span class="line">..........</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - --cert-dir=/tmp</span><br><span class="line">        - --secure-port=4443</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span><br><span class="line">        - --kubelet-use-node-status-port</span><br><span class="line">        - --metric-resolution=15s</span><br><span class="line">        - --kubelet-insecure-tls</span><br><span class="line">        image: k8s.gcr.io/metrics-server/metrics-server:v0.6.1</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f components.yaml</span><br></pre></td></tr></table></figure>

<ul>
<li><code>- --kubelet-insecure-tls</code> ，所有 K8S 在網路上運作傳輸的封包和資料都會進行加密</li>
</ul>
<p>檢視 Worker Node 資源使用狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl top nodes</span><br><span class="line">NAME   CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span><br><span class="line">m1       84m             4%        603Mi                7%</span><br><span class="line">w1       26m             1%        496Mi                6%</span><br><span class="line">w2       27m             1%        459Mi                5%</span><br></pre></td></tr></table></figure>

<ul>
<li>CPU 的單位 : milliCPU</li>
<li>1 core &#x3D; 1000m</li>
<li>m1 node 比較忙的原因是因為它裡面跑的 pod 都是在做系統維運的</li>
</ul>
<p>檢視 pod 的資源使用狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl top pods -n bobo</span><br><span class="line">NAME         CPU(cores)   MEMORY(bytes)</span><br><span class="line">bobo.fbs     0m           3Mi</span><br><span class="line">bobo.goweb   1m           1Mi</span><br><span class="line">bobo.mysql   7m           289Mi</span><br></pre></td></tr></table></figure>

<h3 id="Rsource-Requests-amp-Limits"><a href="#Rsource-Requests-amp-Limits" class="headerlink" title="Rsource Requests &amp; Limits"></a>Rsource Requests &amp; Limits</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: podres</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: podres</span><br><span class="line">    image: quay.io/cloudwalker/alpine</span><br><span class="line">    command: [&quot;/usr/bin/yes&quot;]</span><br><span class="line">    resources:</span><br><span class="line">       requests:</span><br><span class="line">          cpu: 100m</span><br><span class="line">          memory: 640M</span><br><span class="line">       limits:</span><br><span class="line">          cpu: 500m&#x27;&gt; ~/wulin/yaml/resource.yaml </span><br><span class="line"></span><br><span class="line">$ kubectl apply -f  ~/wulin/yaml/resource.yaml</span><br></pre></td></tr></table></figure>


<h1 id="Horizontal-Pod-Autoscaler"><a href="#Horizontal-Pod-Autoscaler" class="headerlink" title="Horizontal Pod Autoscaler"></a>Horizontal Pod Autoscaler</h1><p>The Horizontal Pod Autoscaler is implemented as a control loop, with a period controlled by the controller manager’s –horizontal-pod-autoscaler-sync-period flag (with a default value of 15 seconds)</p>
<ul>
<li>HPA 一定會透過 Metrics Server 來得到 Deployment 的 pod 現在使用資源的狀態</li>
</ul>
<p>建立 Horizontal Pod Autoscaler</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir ~/wulin/hpa; cd ~/wulin/hpa</span><br><span class="line"></span><br><span class="line">$ nano hpa-dep.yaml</span><br></pre></td></tr></table></figure>

<p>編輯 yaml 檔</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hpa-dep</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">hpa.pod</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">hpa.pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alp</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/alpine</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<ul>
<li>單位 m 指的是 milli-cores，每 1000m &#x3D; 1 vCore</li>
<li>設定可以用 m 或分數，例如：</li>
<li>設定 0.5 &#x3D; 500m</li>
<li>設定 300m &#x3D; 0.3</li>
<li>這裡設定的 1 代表的是 1000m，代表 1 個 pod 只能使用一顆 vCore 的運算資源</li>
</ul>
<p>編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano hpa-sp.yml </span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hpa-sp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hpa-dep</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">targetCPUUtilizationPercentage:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>scaleTargetRef:</code>，要監控的對象</li>
<li><code>minReplicas: 2</code>，擴充的 pod 最少會有兩個</li>
<li><code>maxReplicas: 5</code>，擴充的 pod 最多只能有五個</li>
<li><code>targetCPUUtilizationPercentage: 30</code>，設定 30% 代表 HPA 將會維持 Pod 的平均 CPU 使用率為 30 %，只要超出 30%，即會自動擴展</li>
</ul>
<p><strong>建立與檢測 Horizontal Pod Autoscaler</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f  .</span><br><span class="line">deployment.apps/hpa-dep created</span><br><span class="line">horizontalpodautoscaler.autoscaling/hpa-sp created</span><br><span class="line"></span><br><span class="line">$ kubectl get pods</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">hpa-dep-765c997fc8-6vbmd   1/1     Running   0          22s</span><br><span class="line">hpa-dep-765c997fc8-g9kgd   1/1     Running   0          22</span><br><span class="line"></span><br><span class="line">$ kubectl get hpa --watch</span><br><span class="line">NAME     REFERENCE            TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">hpa-sp   Deployment/hpa-dep   0%/30%    2         5         2          4m47s</span><br><span class="line">hpa-sp   Deployment/hpa-dep   0%/30%    2         5         2          5m16s</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 開啟新的 命令提示字元 視窗</span><br><span class="line">$ ssh bigred@&lt;m1 node ip&gt;</span><br><span class="line"></span><br><span class="line">$ kg pod</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">hpa-dep-765c997fc8-6vbmd   1/1     Running   0          7m21s</span><br><span class="line">hpa-dep-765c997fc8-g9kgd   1/1     Running   0          7m21s</span><br><span class="line"></span><br><span class="line">$ kubectl exec hpa-dep-765c997fc8-6vbmd -- timeout 240 yes &gt;/dev/null &amp;</span><br><span class="line">$ kubectl exec hpa-dep-765c997fc8-g9kgd -- timeout 240 yes &gt;/dev/null &amp;</span><br></pre></td></tr></table></figure>

<ul>
<li>利用 <code>yes</code> 命令會霸佔 CPU 的特性，來測試 HPA</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get hpa --watch</span><br><span class="line">NAME     REFERENCE            TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">hpa-sp   Deployment/hpa-dep   0%/30%    2         5         2          25m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   33%/30%   2         5         2          25m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   56%/30%   2         5         3          26m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   56%/30%   2         5         4          26m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   55%/30%   2         5         4          26m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   56%/30%   2         5         4          27m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   56%/30%   2         5         4          27m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   56%/30%   2         5         4          27m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   57%/30%   2         5         4          27m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   57%/30%   2         5         4          28m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   56%/30%   2         5         4          28m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   57%/30%   2         5         4          28m</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到 <code>REPLICAS</code> 擴充為 4</li>
</ul>
<p>檢查 pod 有沒有 running</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">hpa-dep-765c997fc8-6vbmd   1/1     Running   0          26m</span><br><span class="line">hpa-dep-765c997fc8-7rdcm   0/1     Pending   0          38s</span><br><span class="line">hpa-dep-765c997fc8-g9kgd   1/1     Running   0          26m</span><br><span class="line">hpa-dep-765c997fc8-wvvm2   0/1     Pending   0          23s</span><br></pre></td></tr></table></figure>

<p>為何擴充的 pod 都是 pending ?<br>用 <code>kubectl describe</code> 看一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe pods hpa-dep-765c997fc8-7rdcm</span><br><span class="line">Name:           hpa-dep-765c997fc8-7rdcm</span><br><span class="line">...</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age   From               Message</span><br><span class="line">  ----     ------            ----  ----               -------</span><br><span class="line">  Warning  FailedScheduling  53s   default-scheduler  0/5 nodes are available: 2 Insufficient cpu, 3 node(s) had untolerated taint &#123;node-role.kubernetes.io/master: &#125;. preemption: 0/5 nodes are available: 2 No preemption victims found for incoming pod, 3 Preemption is not helpful for scheduling.</span><br></pre></td></tr></table></figure>

<ul>
<li>錯誤訊息說明，已經沒有 node 上有足夠的 CPU 讓 pod run，因為我們是用 VM 來 run K8S ，設定給 VM 用的 CPU 只有 2 Core</li>
<li>雖然 K8S 的 HPA 能自動幫我們橫向擴充 pod ，但是硬體資源 (CPU) 不夠力，擴充出來的 pod 也沒辦法 run，所以要特別注意。</li>
</ul>
<p>可以根據 <code>kubectl top</code>來檢視 node 使用資源狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ k top nodes</span><br><span class="line">NAME   CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span><br><span class="line">m1     1102m        55%    869Mi           11%</span><br><span class="line">m2     270m         13%    803Mi           10%</span><br><span class="line">m3     240m         12%    695Mi           8%</span><br><span class="line">w1     1372m        68%    265Mi           3%</span><br><span class="line">w2     1396m        69%    644Mi           8%</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到 w1 和 w2 node 的 CPU 使用率都飆到將近 70 % ，已經沒有足夠的運算資源，再讓多的 pod run 了，所以才會顯示 pending 的狀態</li>
</ul>
<p>刪除 deployment 和 hpa</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kd -f hpa-dep.yaml</span><br><span class="line">$ kd -f hpa-sp.yml</span><br></pre></td></tr></table></figure>

<p>修改 pod 可以使用的 CPU 運作資源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano hpa-dep.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="string">...</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">400m</span></span><br></pre></td></tr></table></figure>

<ul>
<li>將最後的 CPU 設成 400m</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano hpa-sp.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">  <span class="attr">targetCPUUtilizationPercentage:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<ul>
<li>將 <code>targetCPUUtilizationPercentage</code> 的值改成 10</li>
</ul>
<p>再次產生物件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ka -f .</span><br><span class="line">deployment.apps/hpa-dep created</span><br><span class="line">horizontalpodautoscaler.autoscaling/hpa-sp created</span><br><span class="line"></span><br><span class="line">$ kg hpa --watch</span><br><span class="line">NAME     REFERENCE            TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">hpa-sp   Deployment/hpa-dep   0%/10%    2         5         2          47s</span><br></pre></td></tr></table></figure>

<p>在另一個終端機，檢視</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kg pod</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">hpa-dep-6f5bd9dd57-ggs9b   1/1     Running   0          56s</span><br><span class="line">hpa-dep-6f5bd9dd57-kmxmb   1/1     Running   0          56s</span><br></pre></td></tr></table></figure>

<p>讓 pod 飆 yes</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec hpa-dep-6f5bd9dd57-ggs9b -- timeout 240 yes &gt;/dev/null &amp;</span><br><span class="line">$ kubectl exec hpa-dep-6f5bd9dd57-kmxmb -- timeout 240 yes &gt;/dev/null &amp;</span><br></pre></td></tr></table></figure>

<p>回原來的終端機</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kg hpa --watch</span><br><span class="line">NAME     REFERENCE            TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">hpa-sp   Deployment/hpa-dep   0%/10%    2         5         2          47s</span><br><span class="line">hpa-sp   Deployment/hpa-dep   3%/10%    2         5         2          3m15s</span><br><span class="line">hpa-sp   Deployment/hpa-dep   69%/10%   2         5         2          3m31s</span><br><span class="line">hpa-sp   Deployment/hpa-dep   100%/10%   2         5         4          3m46s</span><br><span class="line">hpa-sp   Deployment/hpa-dep   100%/10%   2         5         5          4m1s</span><br><span class="line">hpa-sp   Deployment/hpa-dep   50%/10%    2         5         5          4m16s</span><br><span class="line">hpa-sp   Deployment/hpa-dep   40%/10%    2         5         5          4m31s</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到 <code>REPLICAS</code> 擴充為 4</li>
</ul>
<p>再到另一個終端機，檢視 pod 有無 runninf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kg po -o wide</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE     IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">hpa-dep-6f5bd9dd57-7tkdp   1/1     Running   0          24s     10.244.3.7   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">hpa-dep-6f5bd9dd57-cntd5   1/1     Running   0          9s      10.244.3.8   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">hpa-dep-6f5bd9dd57-ggs9b   1/1     Running   0          3m55s   10.244.4.6   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">hpa-dep-6f5bd9dd57-kmxmb   1/1     Running   0          3m55s   10.244.3.6   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">hpa-dep-6f5bd9dd57-qlgr6   1/1     Running   0          24s     10.244.4.7   w2     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>通通健康的在跑，因為我們設定一個 pod 只能 run 400m ，且目前單一 node 總共有 2000m 可以用，所以當然可以讓擴充出來的 pod 快樂的 running</li>
</ul>
<p>檢視 node 使用運作資源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ k top nodes</span><br><span class="line">NAME   CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span><br><span class="line">m1     867m         43%    897Mi           11%</span><br><span class="line">m2     241m         12%    807Mi           10%</span><br><span class="line">m3     229m         11%    704Mi           8%</span><br><span class="line">w1     1068m        53%    266Mi           3%</span><br><span class="line">w2     1084m        54%    650Mi           8%</span><br></pre></td></tr></table></figure>

<p>結束測試，刪除物件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kd -f .</span><br></pre></td></tr></table></figure>

<h1 id="Managing-the-Container-Life-Cycle"><a href="#Managing-the-Container-Life-Cycle" class="headerlink" title="Managing the Container Life Cycle"></a>Managing the Container Life Cycle</h1><h2 id="Liveness-and-Readiness-Probes"><a href="#Liveness-and-Readiness-Probes" class="headerlink" title="Liveness and Readiness Probes"></a>Liveness and Readiness Probes</h2><p>(2022&#x2F;09&#x2F;05 10:35)</p>
<ul>
<li>The kubelet uses liveness probes to know when to restart a Container. For example, liveness probes could catch a deadlock, where an application is running, but unable to make progress. Restarting a Container in such a state can help to make the application more available despite bugs.</li>
<li>The kubelet uses readiness probes to know when a Container is ready to start accepting traffic. A Pod is considered ready when all of its Containers are ready. One use of this signal is to control which Pods are used as backends for Services. When a Pod is not ready, it is removed from Service load balancers.</li>
</ul>
<p>共有三種檢測方式，分別是</p>
<ul>
<li>ExecAction: Executes a specified command inside the Container. The diagnostic is considered successful if the command exits with a status code of 0.</li>
<li>TCPSocketAction: Performs a TCP check against the Container’s IP address on a specified port. The diagnostic is considered successful if the port is open.<ul>
<li>像是 Linux 命令的 <code>nc</code> ，檢查 IP 的 port 有沒有開</li>
</ul>
</li>
<li>HTTPGetAction: Performs an HTTP Get request against the Container’s IP address on a specified port and path. The diagnostic is considered successful if the response has a status code greater than or equal to 200 and less than 400.<ul>
<li>像是 Linux 命令的 <code>curl</code> ，</li>
</ul>
</li>
</ul>
<p>Each probe has one of three results:</p>
<ol>
<li>Success: The Container passed the diagnostic.</li>
<li>Failure: The Container failed the diagnostic.</li>
<li>Unknown: The diagnostic failed, so no action should be taken.</li>
</ol>
<ul>
<li>在老師的 K8S Cluster 中，探針會透過 Kubelet 和 CRI-O 監控 Container 的一支程式叫 <code>conmon</code> 來講話，看 Container 的狀態</li>
<li>如果遇到探針無法執行，需檢查 <code>conmon</code> 的版本 <code>conmon --version</code> 是不是 <code>2.1.2</code>，再 K8S <code>1.23</code> 以後的版本，須將 conmon 升級至 <code>2.1.4</code> 版本<ul>
<li>升級命令 : <code>sudo apk upgrade conmon --no-cache --update-cache --allow-untrusted --repository http://dl-cdn.alpinelinux.org/alpine/edge/community</code></li>
</ul>
</li>
</ul>
<h2 id="Liveness-Probe-Exec"><a href="#Liveness-Probe-Exec" class="headerlink" title="Liveness Probe - Exec"></a>Liveness Probe - Exec</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: liveness-exec</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: liveness</span><br><span class="line">    image: k8s.gcr.io/busybox</span><br><span class="line">    command: [/bin/sh]</span><br><span class="line">    args:</span><br><span class="line">    - -c</span><br><span class="line">    - touch /tmp/healthy; sleep 20; rm -rf /tmp/healthy; sleep 300</span><br><span class="line">    livenessProbe:</span><br><span class="line">      exec:</span><br><span class="line">        command:</span><br><span class="line">        - cat</span><br><span class="line">        - /tmp/healthy</span><br><span class="line">      initialDelaySeconds: 5</span><br><span class="line">      periodSeconds: 5 &#x27;&gt;  ~/wulin/yaml/exec-liveness.yml</span><br></pre></td></tr></table></figure>

<ul>
<li>Container 跑的命令是 先建立 <code>/tmp/healthy</code> 這個空檔案，再睡 20 秒，刪除檔案，再睡 300 秒</li>
<li><code>livenessProbe</code> ，liveness 探針<ul>
<li><code>exec</code> ，透過進入 Container 執行命令來健康檢查<ul>
<li>執行的命令是 看 <code>/tmp/healthy</code> 檔案的內容</li>
</ul>
</li>
<li><code>initialDelaySeconds: 5</code>，Container init 後，等 5 秒後，開始健康檢查</li>
<li><code>periodSeconds: 5</code>，每 5 秒檢查一次</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 佈署 exec-liveness.yml</span><br><span class="line">$ kubectl apply -f  ~/wulin/yaml/exec-liveness.yml</span><br><span class="line"></span><br><span class="line"># 檢視 exec-liveness Pod 的 Event</span><br><span class="line">$ kubectl describe pod liveness-exec</span><br><span class="line">.......</span><br><span class="line">  Normal   Pulled     58s                kubelet            Successfully pulled image &quot;k8s.gcr.io/busybox&quot; in 7.253319528s</span><br><span class="line">  Normal   Created    57s                kubelet            Created container liveness</span><br><span class="line">  Normal   Started    56s                kubelet            Started container liveness</span><br><span class="line">  Warning  Unhealthy  25s (x3 over 35s)  kubelet            Liveness probe failed: cat: cant open &#x27;/tmp/healthy&#x27;: No such file or directory</span><br><span class="line">  Normal   Killing    25s                kubelet            Container liveness failed liveness probe, will be restarted</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME              READY   STATUS    RESTARTS   AGE</span><br><span class="line">liveness-exec   1/1     Running    2          2m57s</span><br><span class="line"></span><br><span class="line">移除 Pod</span><br><span class="line">$ kubectl delete -f  ~/wulin/yaml/exec-liveness.yml</span><br></pre></td></tr></table></figure>


<h1 id="K8S-Namespace-LimitRange"><a href="#K8S-Namespace-LimitRange" class="headerlink" title="K8S Namespace LimitRange"></a>K8S Namespace LimitRange</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create namespace memlimit</span><br><span class="line"></span><br><span class="line">$ echo &#x27;apiVersion: v1</span><br><span class="line">kind: LimitRange</span><br><span class="line">metadata:</span><br><span class="line">  name: mem-limit-range</span><br><span class="line">spec:</span><br><span class="line">  limits:</span><br><span class="line">  - default:</span><br><span class="line">      memory: 512Mi</span><br><span class="line">    defaultRequest:</span><br><span class="line">      memory: 256Mi</span><br><span class="line">    max:</span><br><span class="line">      memory: 2Gi</span><br><span class="line">    min:</span><br><span class="line">      memory: 256Mi</span><br><span class="line">    type: Container  &#x27;&gt; ~/wulin/yaml/limitrange.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply  -f  ~/wulin/yaml/limitrange.yaml -n memlimit</span><br></pre></td></tr></table></figure>

<ul>
<li><code>default.memory</code>，</li>
<li><code>LimitRange</code> ，會針對一個 POD 產生限制, 並不是限制所有 POD 的總和</li>
<li>注意 ! 如果 Namespace 在 <code>LimitRange</code> 產生之前的物件，是不會受到</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: memlimit-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: memlimit-pod-nginx</span><br><span class="line">    image: k8s.gcr.io/nginx &#x27; &gt; ~/wulin/yaml/memlimit-pod.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f ~/wulin/yaml/memlimit-pod.yaml -n memlimit</span><br><span class="line">pod/memlimit-pod created</span><br><span class="line"></span><br><span class="line">$ echo &#x27;apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: memlimit-pod1</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: memlimit-pod-nginx</span><br><span class="line">    image: k8s.gcr.io/nginx</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        memory: &quot;2Gi&quot;  &#x27; &gt; ~/wulin/yaml/memlimit-pod1.yaml</span><br><span class="line"></span><br><span class="line"># 以下命令會執行成功</span><br><span class="line">$ kubectl apply -f  ~/wulin/yaml/memlimit-pod1.yaml -n memlimit</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="K8S-Namespace-Resource-Quota"><a href="#K8S-Namespace-Resource-Quota" class="headerlink" title="K8S Namespace Resource Quota"></a>K8S Namespace Resource Quota</h1><p>編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano ~/wulin/yaml/nsrslimit.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mynsrs</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">compute-quota</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">mynsrs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">requests.cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="attr">requests.memory:</span> <span class="string">256Mi</span></span><br><span class="line">    <span class="attr">requests.nvidia.com/gpu:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">limits.cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">limits.memory:</span> <span class="string">1Gi</span></span><br><span class="line">    <span class="attr">limits.nvidia.com/gpu:</span> <span class="number">2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">object-quota</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">mynsrs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">configmaps:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">persistentvolumeclaims:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">replicationcontrollers:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">secrets:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="attr">services:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="attr">services.loadbalancers:</span> <span class="string">&quot;2&quot;</span></span><br></pre></td></tr></table></figure>


<ul>
<li>yaml 檔中，如果要宣告多個物件，物件跟物間中間用 <code>---</code> 區隔</li>
<li>在 <code>ResourceQuota</code> 中，如果有宣告建立物件的數量限制，代表該物件只能被建立幾個，未宣告的物件則不受數量限制。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nsrs-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nsrs-pod-nginx</span><br><span class="line">    image: k8s.gcr.io/nginx &#x27; &gt; ~/wulin/yaml/nsrs-pod.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f ~/wulin/yaml/nsrs-pod.yaml -n mynsrs</span><br><span class="line">Error from server (Forbidden): error when creating &quot;nsrs-pod.yaml&quot;: pods &quot;nsrs-pod&quot; is forbidden: failed quota: compute-quota: must specify limits.cpu,limits.memory,requests.cpu,requests.memory</span><br></pre></td></tr></table></figure>

<ul>
<li>當一個 Namespace 有分配 ResourceQuota 和對應的 Namespace 時，所有在該 Namespace 內使用元件時必須都要詳細指明用量，不然不給用！</li>
</ul>
<p>重新設定運算資源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: nsrs-pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: nsrs-pod-nginx</span></span><br><span class="line"><span class="string">    image: k8s.gcr.io/nginx </span></span><br><span class="line"><span class="string">    resources:</span></span><br><span class="line"><span class="string">      requests:</span></span><br><span class="line"><span class="string">         cpu: 1.0</span></span><br><span class="line"><span class="string">         memory: 256Mi</span></span><br><span class="line"><span class="string">      limits:</span></span><br><span class="line"><span class="string">         cpu: 2.0</span></span><br><span class="line"><span class="string">         memory: 512Mi &#x27;</span> &gt; ~/wulin/yaml/nsrs-pod.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f ~/wulin/yaml/nsrs-pod.yaml -n mynsrs</span><br><span class="line"></span><br><span class="line">$ kg po -n mynsrs</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">nsrs-pod   1/1     Running   0          93s</span><br><span class="line"></span><br><span class="line">$ kg resourcequotas -n mynsrs</span><br><span class="line">NAME            AGE   REQUEST                                                                                                                                 LIMIT</span><br><span class="line">compute-quota   10m   requests.cpu: 1/1, requests.memory: 256Mi/256Mi, requests.nvidia.com/gpu: 0/1                                                           limits.cpu: 2/2, limits.memory: 512Mi/1Gi, limits.nvidia.com/gpu: 0/2</span><br><span class="line">object-quota    10m   configmaps: 1/2, persistentvolumeclaims: 0/2, replicationcontrollers: 0/2, secrets: 0/10, services: 0/10, services.loadbalancers: 0/2</span><br></pre></td></tr></table></figure>

<p>在建立同樣運算資源的 pod 一次</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nsrs-pod1</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nsrs-pod-nginx</span><br><span class="line">    image: k8s.gcr.io/nginx </span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">         cpu: 1.0</span><br><span class="line">         memory: 256Mi</span><br><span class="line">      limits:</span><br><span class="line">         cpu: 2.0</span><br><span class="line">         memory: 512Mi &#x27; &gt; ~/wulin/yaml/nsrs-pod1.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f ~/wulin/yaml/nsrs-pod1.yaml -n mynsrs</span><br><span class="line">Error from server (Forbidden): error when creating &quot;nsrs-pod1.yaml&quot;: pods &quot;nsrs-pod1&quot; is forbidden: exceeded quota: compute-quota, requested: limits.cpu=2,requests.cpu=1,requests.memory=256Mi, used: limits.cpu=2,requests.cpu=1,requests.memory=256Mi, limited: limits.cpu=2,requests.cpu=1,requests.memory=256Mi</span><br></pre></td></tr></table></figure>








      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes%20Resource%20Storage.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes%20Resource%20Storage.html" class="post-title-link" itemprop="url">Kubernetes Resource Storage</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-18 02:45:34" itemprop="dateCreated datePublished" datetime="2022-09-18T02:45:34+08:00">2022-09-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 16:15:42" itemprop="dateModified" datetime="2023-05-07T16:15:42+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-Resource-Storage-NFS"><a href="#Kubernetes-Resource-Storage-NFS" class="headerlink" title="Kubernetes Resource Storage (NFS)"></a>Kubernetes Resource Storage (NFS)</h1><p>:::warning</p>
<p>:::spoiler 目錄</p>
<p>[TOC]</p>
<p>:::</p>
<h1 id="Kubernetes-Volume"><a href="#Kubernetes-Volume" class="headerlink" title="Kubernetes Volume"></a>Kubernetes Volume</h1><ul>
<li>Type of Storage<ul>
<li>Container Filesystem (Overlay2)<ul>
<li>Container 掛點，檔案系統掛點</li>
</ul>
</li>
<li>Volume (emptyDir)<ul>
<li>每個 Container 會共用 pod 的目錄</li>
<li>生命週期與 pod 一樣， pod 裡其中一個 Container 毀損，並不影響到 Volume</li>
</ul>
</li>
<li>Persistent volume. (hostPath, Local,NFS)<ul>
<li>永存的儲存體</li>
<li>生命週期與 K8S Cluster 相同</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="empty-dir-volume"><a href="#empty-dir-volume" class="headerlink" title="empty dir volume"></a>empty dir volume</h2><p><img src="https://i.imgur.com/yfocaAI.png"></p>
<ul>
<li>empty dir 的運作，等同於 Container 的 Volume</li>
<li>empty dir，這個目錄存在於 Linux 系統中，系統會自動幫我們產生這個目錄區（名字很長不是人記得）。</li>
<li>一個 pod 裡的多個 Container 共用同一個 Linux 系統的目錄區</li>
</ul>
<h2 id="Shared-volumes-in-a-Kubernetes-Pod"><a href="#Shared-volumes-in-a-Kubernetes-Pod" class="headerlink" title="Shared volumes in a Kubernetes Pod"></a>Shared volumes in a Kubernetes Pod</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano ~/wulin/yaml/sidecar.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sidecar</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">1st</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/nginx</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">2nd</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/alpine</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/html</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">while</span> <span class="literal">true</span><span class="string">;</span> <span class="string">do</span></span><br><span class="line">          <span class="string">date</span> <span class="string">&gt;&gt;</span> <span class="string">/html/index.html;</span></span><br><span class="line">          <span class="string">sleep</span> <span class="number">1</span><span class="string">;</span></span><br><span class="line">        <span class="string">done</span></span><br></pre></td></tr></table></figure>

<ul>
<li>將 <code>1st</code> 和 <code>2nd</code> 兩台 Container 的目錄</li>
<li><code>spec.volumes.emptyDir: &#123;&#125;</code>，這個目錄等下會被 mount 到 <code>spec.volumes.mountPath: /usr/share/nginx/html</code> 這個目錄</li>
</ul>
<p>建立 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ka -f ~/wulin/yaml/sidecar.yaml</span><br></pre></td></tr></table></figure>

<p>進入 sidecar pod 裡面的 1st Container 看 <code>/usr/share/nginx/html/index.html</code> 檔案的倒數 3 行的內容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec sidecar -c 1st -- /bin/cat  /usr/share/nginx/html/index.html | tail -n 3</span><br><span class="line">Thu Dec 16 13:20:14 UTC 2021</span><br><span class="line">Thu Dec 16 13:20:15 UTC 2021</span><br><span class="line">Thu Dec 16 13:20:16 UTC 2021</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kubectl exec</code>，在 pod 中的 Container 裡面執行命令</li>
<li><code>-c</code> 後面接的是 Container 的名字</li>
<li><code>--</code> 後面放在 Container 裡要執行的命令</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ kg pods -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">sidecar   2/2     Running   0          12m   10.244.0.6   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ kubectl get pod sidecar --template=&#123;&#123;.status.podIP&#125;&#125;; echo</span><br><span class="line">10.244.0.6</span><br><span class="line"></span><br><span class="line">$ podip=$(kubectl get pod sidecar --template=&#123;&#123;.status.podIP&#125;&#125;)</span><br><span class="line"></span><br><span class="line">$ curl -s http://$podip | head -n 5</span><br><span class="line">Thu Dec 16 13:06:28 UTC 2021</span><br><span class="line">Thu Dec 16 13:06:29 UTC 2021</span><br><span class="line">Thu Dec 16 13:06:30 UTC 2021</span><br><span class="line">Thu Dec 16 13:06:31 UTC 2021</span><br><span class="line">Thu Dec 16 13:06:32 UTC 2021</span><br></pre></td></tr></table></figure>

<h2 id="hostPath-Volume-應用範例"><a href="#hostPath-Volume-應用範例" class="headerlink" title="hostPath Volume 應用範例"></a>hostPath Volume 應用範例</h2><p>編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 在 m1 終端機執行</span><br><span class="line">$ nano ~/wulin/yaml/pod-hp.yaml </span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-hp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-hp</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/nginx</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">&quot;http-server&quot;</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/usr/share/nginx/html&quot;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">hp-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hp-volume</span></span><br><span class="line">      <span class="attr">hostPath:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/opt/hostpath</span></span><br></pre></td></tr></table></figure>

<p>產生 pod </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f ~/wulin/yaml/pod-hp.yaml   (不會產生 PV Object)</span><br><span class="line"></span><br><span class="line"># 看 pod IP 位址</span><br><span class="line">$ kg po -o wide</span><br><span class="line">NAME     READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-hp   1/1     Running   0          65s   10.244.4.12   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># 檢查 hostpath 目錄</span><br><span class="line">$ ssh w2 &#x27;ls -l /opt&#x27;</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 3 root root 4096 Dec 25  2021 cni</span><br><span class="line">drwxr-xr-x 2 root root 4096 Sep  4 15:30 hostpath</span><br><span class="line"></span><br><span class="line"># 對照 w1 node 是不會有的</span><br><span class="line">$ ssh w1 &#x27;ls -l /opt&#x27;</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 3 root root 4096 Dec 25  2021 cni</span><br><span class="line">drwxr-xr-x 9 root root 4096 Sep  4 00:23 www</span><br><span class="line"></span><br><span class="line"># 進入 pod 產生 index.html 檔案</span><br><span class="line">$ kubectl exec -it pod-hp -- sh</span><br><span class="line"># echo &quot;&lt;h1&gt;let me go&lt;/h1&gt;&quot; &gt; /usr/share/nginx/html/index.html</span><br><span class="line"># exit</span><br><span class="line"></span><br><span class="line">$ curl http://10.244.2.20</span><br><span class="line">&lt;h1&gt;let me go&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<p>檢查剛剛產生的 index.html 是否產生在 w2 的 <code>/opt/hostpath</code> 目錄</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ssh w2 &#x27;ls -l /opt/hostpath/&#x27;</span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 19 Sep  4 15:34 index.html</span><br></pre></td></tr></table></figure>


<hr>
<h1 id="Persistent-Volumes-運作架構"><a href="#Persistent-Volumes-運作架構" class="headerlink" title="Persistent Volumes 運作架構"></a>Persistent Volumes 運作架構</h1><p><img src="https://i.imgur.com/WaCuRbV.png"></p>
<ul>
<li>管理 storage 一直都是一個不簡單的課題，為了讓 developer 可以更專注在開發上，k8s 中提出了兩個概念(resource object)，分別是 Persistent Volume(PV) &amp; Persistent Volume Claim(PVC)，透過這兩個概念將連結 storage 的過程抽象化，讓使用者不需要了解 storage 在底層是如何運作的，只要了解如何使用即可，大幅降低使用者操作 storage 的困難度。</li>
<li>Persistent Volume(PV) 由 storage 管理者負責產生，在 k8s 中就是一種可用的 storage resource，同樣也是一種 volume plugin，但有自己獨立的 lifecycle，且包含的就是實際與 storage 連結的實作細節。</li>
<li>Persistent Volume Claim(PVC) 則是來自使用者的 storage request，就跟 pod 一樣都是要消耗特定的資源，PVC 消耗 PV 資源(pod 消耗 node 資源)，PVC 指定特定 size or access mode 的 PV(pod 可以指定 CPU, memory … etc)。</li>
<li>由於 PVC 可以允許使用者自行指定所需要 PV 的相關屬性，因此除了 size, access mode 外，可能還會有 performance 的需求。而為了滿足不同的使用目的，cluster administrator 就必須要準備好不同的 PV 來處理不同 PVC 的需求；若是 PVC 數量不多且需求單純，手動產生 PV 可能還可以接受，但若是 PVC 的數量眾多且需求多變，那可能就需要 [StorageClass] 的協助了!</li>
<li><a target="_blank" rel="noopener" href="https://godleon.github.io/blog/Kubernetes/k8s-PersistentVolume-Overview/">Persistent Volume (Claim) Overview Link (必看)</a></li>
</ul>
<h2 id="Local-Persistent-Volumes"><a href="#Local-Persistent-Volumes" class="headerlink" title="Local Persistent Volumes"></a>Local Persistent Volumes</h2><ul>
<li><strong>local PV 的產生一定要用 yaml 檔產生</strong></li>
<li><strong>且一定要需告在哪一台 node</strong></li>
<li><strong>宣告的目錄區，需要事先準備</strong></li>
<li>the Kubernetes scheduler ensures that a pod using a Local Persistent Volume is always scheduled to the same node.</li>
</ul>
<h3 id="建立-Local-PersistentVolume"><a href="#建立-Local-PersistentVolume" class="headerlink" title="建立 Local PersistentVolume"></a><strong>建立 Local PersistentVolume</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: pv-local</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  local:</span><br><span class="line">    path: &quot;/opt/local&quot;</span><br><span class="line">  nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">      - matchExpressions:</span><br><span class="line">        - key: kubernetes.io/hostname</span><br><span class="line">          operator: In</span><br><span class="line">          values:</span><br><span class="line">          - m1 &#x27; &gt; ~/wulin/yaml/pv-local.yaml </span><br></pre></td></tr></table></figure>

<ul>
<li>以上設定的 capacity(儲存空間大小), accessModes(目錄權限) 數據都是參考用的</li>
<li>PV 會產生在 m1 的 node 上，所以以上設定的數據是由 m1 node 上 Linux 系統在管理目錄區的 Quota 做容量控管及權限設定，實際上要求有沒有做到，PV 本身是不會管的</li>
</ul>
<h3 id="產生-PV"><a href="#產生-PV" class="headerlink" title="產生 PV"></a><strong>產生 PV</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f ~/wulin/yaml/pv-local.yaml </span><br><span class="line">persistentvolume/pv-local created</span><br><span class="line"></span><br><span class="line">$ kubectl get pv pv-local</span><br><span class="line">NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">pv-local   10Gi       RWO            Retain           Available                                   102s</span><br></pre></td></tr></table></figure>

<h3 id="建立-Local-PersistentVolumeClaim"><a href="#建立-Local-PersistentVolumeClaim" class="headerlink" title="建立 Local PersistentVolumeClaim"></a>建立 Local PersistentVolumeClaim</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: pvc-local</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  storageClassName: &quot;&quot;  </span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 3Gi &#x27; &gt; ~/wulin/yaml/pvc-local.yaml</span><br></pre></td></tr></table></figure>

<ul>
<li>注意! 在 yaml 檔中的宣告，並未指定要用哪個 PV</li>
<li>PVC 會去尋找滿足 <code>accessModes</code> 和 <code>resources.requests.storage</code> 的 PV 來 Bound 建立連接</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f ~/wulin/yaml/pvc-local.yaml</span><br></pre></td></tr></table></figure>

<p>檢查 pv 與 pvc 狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kg pv</span><br><span class="line">NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM               STORAGECLASS   REASON   AGE</span><br><span class="line">pv-local   10Gi       RWO            Retain           Bound    default/pvc-local                           32m</span><br><span class="line"></span><br><span class="line">$ kg pvc</span><br><span class="line">NAME        STATUS   VOLUME     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">pvc-local   Bound    pv-local   10Gi       RWO                           46s</span><br></pre></td></tr></table></figure>

<h3 id="建立使用-pvc-local-的第一個-Pod"><a href="#建立使用-pvc-local-的第一個-Pod" class="headerlink" title="建立使用 pvc-local 的第一個 Pod"></a>建立使用 pvc-local 的第一個 Pod</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;kind: Pod</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-pvc1</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">    - name: pv-storage</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">       claimName: pvc-local</span><br><span class="line">  containers:</span><br><span class="line">    - name: pod-pvc1</span><br><span class="line">      image: quay.io/cloudwalker/nginx</span><br><span class="line">      imagePullPolicy: IfNotPresent</span><br><span class="line">      ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: &quot;http-server&quot;</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - mountPath: &quot;/usr/share/nginx/html&quot;</span><br><span class="line">          name: pv-storage &#x27; &gt; ~/wulin/yaml/pod-pvc1.yaml </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f ~/wulin/yaml/pod-pvc1.yaml </span><br><span class="line"></span><br><span class="line">$ kg po</span><br><span class="line">NAME       READY   STATUS              RESTARTS   AGE</span><br><span class="line">g1         1/1     Running             0          116m</span><br><span class="line">g2         1/1     Running             0          115m</span><br><span class="line">pod-pvc1   0/1     ContainerCreating   0          12m</span><br><span class="line"></span><br><span class="line">$ kubectl describe pod pod-pvc1</span><br><span class="line">...</span><br><span class="line">... path &quot;/opt/local&quot; does not exist</span><br></pre></td></tr></table></figure>

<ul>
<li>因為沒事先在指定主機 (m1) 建立 &#x2F;opt&#x2F;local 目錄</li>
</ul>
<p>解決</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir /opt/local</span><br></pre></td></tr></table></figure>

<p>檢查</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kg po pod-pvc1</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-pvc1   1/1     Running   0          20m</span><br></pre></td></tr></table></figure>

<h3 id="建立-NGINX-首頁"><a href="#建立-NGINX-首頁" class="headerlink" title="建立 NGINX 首頁"></a>建立 NGINX 首頁</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -it pod-pvc1 -- bash</span><br><span class="line">root@pv-pod:/# echo &quot;&lt;h1&gt;POD-PVC1&lt;/h1&gt;&quot; &gt; /usr/share/nginx/html/index.html</span><br><span class="line">root@pv-pod:/# exit</span><br><span class="line"></span><br><span class="line">$ ls -l /opt/local/</span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 18 Sep  7 15:49 index.html</span><br></pre></td></tr></table></figure>

<p>刪除 pod 與 pvc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod pod-pvc1</span><br><span class="line">pod &quot;pod-pvc1&quot; deleted</span><br><span class="line"></span><br><span class="line">$ kubectl delete pvc pvc-local</span><br><span class="line">persistentvolumeclaim &quot;pvc-local&quot; deleted</span><br><span class="line"></span><br><span class="line">$ kg pvc</span><br><span class="line">No resources found in default namespace.</span><br></pre></td></tr></table></figure>

<p>檢視被刪除 pvc 後的 pv</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kg pv</span><br><span class="line">NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM               STORAGECLASS   REASON   AGE</span><br><span class="line">pv-local   10Gi       RWO            Retain           Released   default/pvc-local                           62m</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到狀態是 <code>Released</code></li>
</ul>
<p>如果再次建立一樣的 pvc 呢?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f pvc-local.yaml</span><br></pre></td></tr></table></figure>

<p>檢視 pvc 的狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kg pvc</span><br><span class="line">NAME        STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">pvc-local   Pending                                                     7s</span><br></pre></td></tr></table></figure>


<h1 id="Helm"><a href="#Helm" class="headerlink" title="Helm"></a>Helm</h1><ul>
<li>像是 Alpine Linux 的 apk ，可以在 K8S 新增套件</li>
<li>要自行安裝，原生的 K8S 沒有 Helm</li>
</ul>
<h2 id="安裝-Helm-3"><a href="#安裝-Helm-3" class="headerlink" title="安裝 Helm 3"></a>安裝 Helm 3</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash</span><br></pre></td></tr></table></figure>

<ul>
<li><code>get-helm-3</code> ，安裝 Helm 的程式</li>
<li>漿螢幕輸出透過水管直接將安裝 Helm 的程式餵給 貝殼程式</li>
</ul>
<h1 id="NFS-Dynamic-Volume-Provision"><a href="#NFS-Dynamic-Volume-Provision" class="headerlink" title="NFS Dynamic Volume Provision"></a>NFS Dynamic Volume Provision</h1><h2 id="安裝-NFS-套件"><a href="#安裝-NFS-套件" class="headerlink" title="安裝 NFS 套件"></a>安裝 NFS 套件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">K8S Master/Worker 都要安裝</span><br><span class="line">$ sudo apk update; sudo apk add nfs-utils</span><br><span class="line">.........</span><br><span class="line">(6/7) Installing nfs-utils (2.5.4-r1)</span><br><span class="line">(7/7) Installing nfs-utils-openrc (2.5.4-r1)</span><br><span class="line">Executing busybox-1.33.1-r3.trigger</span><br><span class="line">OK: 1603 MiB in 291 packages</span><br><span class="line"></span><br><span class="line">$ ssh w1 sudo apk update; ssh w1 sudo apk add nfs-utils</span><br><span class="line"></span><br><span class="line">$ ssh w2 sudo apk update; ssh w2 sudo apk add nfs-utils</span><br></pre></td></tr></table></figure>

<h2 id="設定-NFS-Server"><a href="#設定-NFS-Server" class="headerlink" title="設定 NFS Server"></a>設定 NFS Server</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rc-update add nfs</span><br><span class="line">* service nfs added to runlevel default</span><br><span class="line"></span><br><span class="line">K8s Master 建立共用資料夾</span><br><span class="line">$ sudo mkdir /opt/nfs; sudo chown -R nobody:nogroup /opt/nfs</span><br><span class="line"></span><br><span class="line">$ echo &quot;/opt/nfs $IP/24(rw,sync,no_subtree_check,no_root_squash)&quot; | sudo tee /etc/exports</span><br></pre></td></tr></table></figure>

<h2 id="啟動-NFS-Server"><a href="#啟動-NFS-Server" class="headerlink" title="啟動 NFS Server"></a>啟動 NFS Server</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rc-service rpcbind start</span><br><span class="line">$ sudo rc-service nfs start</span><br><span class="line">* Stopping NFS mountd ... [ ok ]</span><br><span class="line">* Stopping NFS daemon ... [ ok ]</span><br><span class="line">* Unexporting NFS directories ... [ ok ]</span><br><span class="line">* Exporting NFS directories ... [ ok ]</span><br><span class="line">* Starting NFS mountd ... [ ok ]</span><br><span class="line">* Starting NFS daemon ... [ ok ]</span><br><span class="line">* Starting NFS smnotify ... [ ok ]</span><br></pre></td></tr></table></figure>

<h2 id="測試-NFS"><a href="#測試-NFS" class="headerlink" title="測試 NFS"></a>測試 NFS</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># K8S Worker 測試掛載 nfs</span><br><span class="line"># 將 m1 主機的 /opt/nfs 目錄掛載到 w1 主機的 /mnt 目錄</span><br><span class="line">$ ssh w1 &quot;sudo mount -t nfs $IP:/opt/nfs /mnt&quot;</span><br><span class="line"></span><br><span class="line"># 在 /mnt 上建立一個空檔案</span><br><span class="line">$ ssh w1 &quot;sudo touch /mnt/mynfs&quot;</span><br><span class="line"></span><br><span class="line"># 卸載 nfs</span><br><span class="line">$ ssh w1 &quot;sudo umount /mnt&quot;</span><br><span class="line"></span><br><span class="line"># K8S Master 檢查</span><br><span class="line">$ ls -al /opt/nfs</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 2 nobody nogroup 4096 Oct 30 19:22 .</span><br><span class="line">drwxr-xr-x 4 root   root    4096 Oct 30 19:20 ..</span><br><span class="line">-rw-r--r-- 1 root   root       0 Oct 30 19:22 mynfs</span><br></pre></td></tr></table></figure>

<h2 id="安裝與建立-NFS-Provisioner"><a href="#安裝與建立-NFS-Provisioner" class="headerlink" title="安裝與建立 NFS Provisioner"></a>安裝與建立 NFS Provisioner</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 新增套件清單網址</span><br><span class="line">$ helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/</span><br><span class="line"></span><br><span class="line"># 更新儲存庫</span><br><span class="line">$ helm repo update</span><br><span class="line"></span><br><span class="line"># 搜尋剛剛的套件網址版本代號多少</span><br><span class="line">$ helm search repo nfs-subdir-external-provisioner</span><br><span class="line">NAME                                                    CHART VERSION   APP VERSION     DESCRIPTION            </span><br><span class="line">nfs-subdir-external-provisioner/nfs-subdir-exte...      4.0.17          4.0.2           nfs-subdir-external-provisioner is an automatic...</span><br><span class="line"></span><br><span class="line"># 安裝套件</span><br><span class="line">$ helm install nfs-subdir-external-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \</span><br><span class="line">--set storageClass.defaultClass=true \</span><br><span class="line">--set storageClass.name=mynfs \</span><br><span class="line">--set nfs.server=$IP \</span><br><span class="line">--set nfs.path=/opt/nfs</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="檢視-NFS-Provisioner"><a href="#檢視-NFS-Provisioner" class="headerlink" title="檢視 NFS Provisioner"></a>檢視 NFS Provisioner</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get storageclass</span><br><span class="line">NAME              PROVISIONER                                     RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">mynfs (default)   cluster.local/nfs-subdir-external-provisioner   Delete          Immediate           true                   17s</span><br><span class="line"></span><br><span class="line">$ kg all</span><br><span class="line">NAME                                                   READY   STATUS              RESTARTS   AGE</span><br><span class="line">pod/nfs-subdir-external-provisioner-7dc5ccf74b-lkrkj   0/1     ContainerCreating   0          22s</span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/kubernetes   ClusterIP   10.98.0.1    &lt;none&gt;        443/TCP   7d23h</span><br><span class="line"></span><br><span class="line">NAME                                              READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/nfs-subdir-external-provisioner   0/1     1            0           22s</span><br><span class="line"></span><br><span class="line">NAME                                                         DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/nfs-subdir-external-provisioner-7dc5ccf74b   1         1         0       22s</span><br></pre></td></tr></table></figure>

<h2 id="建立-PVC-測試-NFS-Client-Provisioner"><a href="#建立-PVC-測試-NFS-Client-Provisioner" class="headerlink" title="建立 PVC 測試 NFS Client Provisioner"></a>建立 PVC 測試 NFS Client Provisioner</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> $<span class="string">&#x27;kind: PersistentVolumeClaim</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: test-claim</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  accessModes: [&quot;ReadWriteOnce&quot;]</span></span><br><span class="line"><span class="string">  storageClassName: mynfs</span></span><br><span class="line"><span class="string">  resources:</span></span><br><span class="line"><span class="string">    requests:</span></span><br><span class="line"><span class="string">      storage: 1Mi &#x27;</span> &gt; pvc-nfscp.yaml </span><br></pre></td></tr></table></figure>

<ul>
<li><code>spec.resources.requests.storage</code>，設定的 <code>1Mi</code> 是參考值，真正在限制的人是底層的 NFS ，它如果沒能力，就不會真的被限制</li>
<li><code>spec.accessModes</code>，<code>ReadWriteOnce</code> 設定的是在本機才能被掛載，與 NFS 的概念完全背離，所以應該改為 <code>ReadWriteMany</code>，但其實這邊也是參考的，因為底層在運作是 NFS ，最後一樣能被其他主機來掛載</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f pvc-nfscp.yaml</span><br><span class="line">persistentvolumeclaim/test-claim created</span><br><span class="line"></span><br><span class="line">$ kg pv</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   REASON   AGE</span><br><span class="line">pvc-de200a3e-203b-4feb-ab8a-95f0be90cd3c   1Mi        RWO            Delete           Bound    default/test-claim   mynfs                   3s</span><br><span class="line"></span><br><span class="line">$ kg pvc</span><br><span class="line">NAME         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">test-claim   Bound    pvc-de200a3e-203b-4feb-ab8a-95f0be90cd3c   1Mi        RWO            mynfs          4s</span><br></pre></td></tr></table></figure>

<h2 id="建立-Job-測試-NFS-Client-Provisioner"><a href="#建立-Job-測試-NFS-Client-Provisioner" class="headerlink" title="建立 Job 測試 NFS Client Provisioner"></a>建立 Job 測試 NFS Client Provisioner</h2><p>編輯 Job YAML 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano nfs-job-test.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-job-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nfs-job-test</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">     <span class="attr">containers:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-job-test</span></span><br><span class="line">       <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/busybox</span></span><br><span class="line">       <span class="attr">command:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">       <span class="attr">args:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">&quot;touch /opt/SUCCESS &amp;&amp; exit 0 || exit 1&quot;</span></span><br><span class="line">       <span class="attr">volumeMounts:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pvc</span></span><br><span class="line">           <span class="attr">mountPath:</span> <span class="string">&quot;/opt&quot;</span></span><br><span class="line">     <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">     <span class="attr">volumes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pvc</span></span><br><span class="line">         <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">           <span class="attr">claimName:</span> <span class="string">test-claim</span></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ka -f nfs-job-test.yaml</span><br><span class="line"></span><br><span class="line">$ kg job</span><br><span class="line">NAME           COMPLETIONS   DURATION   AGE</span><br><span class="line">nfs-job-test   1/1           4s         10m</span><br><span class="line"></span><br><span class="line">$ dir /opt/nfs</span><br><span class="line">..........</span><br><span class="line">drwxrwxrwx 2 root   root    4.0K Oct 29 12:43 default-test-claim-pvc-788e2513-9de6-41d5-bb2d-f57e1fa5ce7c</span><br><span class="line"></span><br><span class="line">$ kubectl delete job nfs-job-test; kubectl delete pvc test-claim</span><br><span class="line"></span><br><span class="line">$ dir /opt/nfs</span><br><span class="line">total 12K</span><br><span class="line">drwxr-xr-x 3 nobody nogroup 4.0K Oct 29 13:05 .</span><br><span class="line">drwxr-xr-x 4 root   root    4.0K Oct 29 11:59 ..</span><br><span class="line">drwxrwxrwx 2 root   root    4.0K Oct 29 12:43 archived-default-test-claim-pvc-788e2513-9de6-41d5-bb2d-f57e1fa5ce7c</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes%20Init%20with%20Config.yaml.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes%20Init%20with%20Config.yaml.html" class="post-title-link" itemprop="url">Kubernetes Init with Config.yaml</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-13 11:26:50" itemprop="dateCreated datePublished" datetime="2022-09-13T11:26:50+08:00">2022-09-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 16:15:42" itemprop="dateModified" datetime="2023-05-07T16:15:42+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-Init-with-Config-yaml"><a href="#Kubernetes-Init-with-Config-yaml" class="headerlink" title="Kubernetes Init with Config.yaml"></a>Kubernetes Init with Config.yaml</h1><h2 id="Prepare"><a href="#Prepare" class="headerlink" title="Prepare"></a>Prepare</h2><p>To print the defaults for “init” actions use the following commands:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm config print init-defaults &gt; init-config.yaml</span><br></pre></td></tr></table></figure>


<p>編輯 <code>init-config.yaml</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano init-config.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="comment">#bootstrapTokens:                                       # remove</span></span><br><span class="line"><span class="comment">#- groups:                                              # remove</span></span><br><span class="line"><span class="comment">#  - system:bootstrappers:kubeadm:default-node-token    # remove</span></span><br><span class="line"><span class="comment">#  token: abcdef.0123456789abcdef                       # remove</span></span><br><span class="line"><span class="comment">#  ttl: 24h0m0s                                         # remove</span></span><br><span class="line"><span class="comment">#  usages:                                              # remove</span></span><br><span class="line"><span class="comment">#  - signing                                            # remove</span></span><br><span class="line"><span class="comment">#  - authentication                                     # remove</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="number">120.96</span><span class="number">.143</span><span class="number">.76</span>                       <span class="comment"># change from Master node IP</span></span><br><span class="line">  <span class="attr">bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">unix:///run/crio/crio.sock</span>                 <span class="comment"># change from CRI-O Unix Socket</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">c3-m1</span>                                           <span class="comment"># change from Master node hsotname</span></span><br><span class="line">  <span class="attr">taints:</span> <span class="literal">null</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">bobo</span>                                        <span class="comment"># set your clusterName</span></span><br><span class="line"><span class="attr">controllerManager:</span> &#123;&#125;</span><br><span class="line"><span class="attr">dns:</span> &#123;&#125;</span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">registry.k8s.io</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="number">1.25</span><span class="number">.0</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">k8s.bobo.org</span>                                 <span class="comment"># DNS domain used by Kubernetes Services.</span></span><br><span class="line">  <span class="attr">podSubnet:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span>                                <span class="comment"># the subnet used by Pods.</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">10.98</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span>                             <span class="comment"># subnet used by Kubernetes Services.</span></span><br><span class="line"><span class="attr">scheduler:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>nodeRegistration.taints</code>，taints specifies the taints the Node API object should be registered with. If this field is unset, i.e. nil, in the kubeadm init process it will be defaulted with a control-plane taint for control-plane nodes. <strong>If you don’t want to taint your control-plane node, set this field to an empty list, i.e. taints: <code>[]</code> in the YAML file. This field is solely used for Node registration.</strong></li>
</ul>
<h2 id="初始化-K8S"><a href="#初始化-K8S" class="headerlink" title="初始化 K8S"></a>初始化 K8S</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo kubeadm init --config=init-config.yaml</span><br></pre></td></tr></table></figure>

<ul>
<li><code>--config string</code> ，Path to a kubeadm configuration file.</li>
<li>When executing <code>kubeadm init</code> with the <code>--config</code> option, the following configuration types could be used: <ul>
<li>InitConfiguration</li>
<li>ClusterConfiguration</li>
<li>KubeProxyConfiguration</li>
<li>KubeletConfiguration</li>
</ul>
</li>
<li>but only one between <strong>InitConfiguration</strong> and <strong>ClusterConfiguration</strong> is <strong>mandatory</strong>.</li>
<li>If some configuration types are not provided, or provided only partially, kubeadm will use default values</li>
</ul>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta3/">kubeadm Configuration (v1beta3) - Kubernetes DOC</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/">Configure Access to Multiple Clusters - Kubernetes DOC </a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes-Cluster-build.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes-Cluster-build.html" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-05 02:34:30" itemprop="dateCreated datePublished" datetime="2022-09-05T02:34:30+08:00">2022-09-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 16:15:42" itemprop="dateModified" datetime="2023-05-07T16:15:42+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-Cluster-build"><a href="#Kubernetes-Cluster-build" class="headerlink" title="Kubernetes-Cluster-build"></a>Kubernetes-Cluster-build</h1><p>:::warning</p>
<p>:::spoiler 目錄</p>
<p>[TOC]</p>
<hr>
<p>:::</p>
<p>將 m1 主機安裝成 Kubernetes 的 Master</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 在 Windows 系統的 cmd 視窗, 執行以下命令</span><br><span class="line">$ ssh bigred@&lt;alp.m1 IP&gt;</span><br></pre></td></tr></table></figure>

<p>安裝 Kubernetes 要用的一些管理命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apk update; sudo apk add kubeadm kubelet kubectl --update-cache --repository http://dl-3.alpinelinux.org/alpine/edge/testing/ --allow-untrusted</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kubeadm</code>，建置 K8S 會用到的命令</li>
<li><code>kubelet</code>，將 <code>CRI-O</code> 建立出來的 Container 包成 pod 的程式</li>
<li><code>kubectl</code>，controls the Kubernetes cluster manager，<a target="_blank" rel="noopener" href="https://jamesdefabia.github.io/docs/user-guide/kubectl-overview/">kubectl-overview 官網介紹連結</a></li>
<li><code>apk add</code> 命令補充<ul>
<li><code>--repository &lt;REPO&gt;</code>，指定其他套件下載網址</li>
<li><code>--update-cache</code>， Alias for ‘–cache-max-age 1’</li>
<li><code>--allow-untrusted</code>，安裝帶有不受信任簽名或沒有簽名的套件</li>
</ul>
</li>
<li>因為手工建立 K8S 的關係，所以可以用到最新的版本</li>
</ul>
<h2 id="建立-K8S-Master"><a href="#建立-K8S-Master" class="headerlink" title="建立 K8S Master"></a>建立 K8S Master</h2><p>m1 的 IP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ echo $IP</span><br><span class="line">192.168.61.4</span><br></pre></td></tr></table></figure>

<p>透過 <code>kubeadm</code> 來設定 Master 主機</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo kubeadm init --service-cidr 10.98.0.0/24 --pod-network-cidr 10.244.0.0/16  --service-dns-domain=k8s.org --apiserver-advertise-address $IP</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kubeadm init</code> ，設定 Kubernetes control plane ( m1 主機 )，將它初始化</li>
<li><code>--service-cidr 10.98.0.0/24</code>，K8S <strong>對外</strong>提供服務的 IP 位址，給我們辦公室的同仁們，機房的其他應用系統，甚至 Internet 上面的使用者，來提供這樣的服務，我們設定的是<code>10.98.0.0/24</code> ，所以代表我們 Kubernetes 做出來的服務最多可以有 254 個。</li>
<li><code>--pod-network-cidr 10.244.0.0/16</code>，pod 的 IP 位址範圍，可以有 254 * 254 &#x3D; 64516 個 pod。 </li>
<li>以上兩個設定其實只要是私有 IP 就 ok 。</li>
<li><code>--service-dns-domain=k8s.org</code>，因為 K8S 內部有 Service Discovery ，所以要設定 Domain Name ，對外的應用系統連接網址使用此設定名稱，在外面做案子的話，就用公司的 Domain Name 來命名。</li>
<li><code>--apiserver-advertise-address $IP</code>，將 m1 主機的 IP 位址 設定為 Kubernetes Master 的 <code>API Server</code> 的 IP</li>
<li><a target="_blank" rel="noopener" href="https://www.densify.com/kubernetes-autoscaling/kubernetes-service-discovery">Kubernetes Service Discovery 介紹連結</a></li>
</ul>
<p>將 <code>Kubelet</code> 設定為系統自動啟動</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rc-update add kubelet default</span><br></pre></td></tr></table></figure>

<ul>
<li>為何 <code>Kubelet</code>，需設定為系統自動啟動 ?<br>因為它是一個 Daemon ，需要在背景一直 running 來等待 Scheduler 來找他。</li>
</ul>
<p>檢查 pod 的 image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman images</span><br><span class="line">REPOSITORY                                                TAG         IMAGE ID      CREATED        SIZE</span><br><span class="line">k8s.gcr.io/kube-apiserver                                 v1.24.3     d521dd763e2e  3 weeks ago    131 MB</span><br><span class="line">k8s.gcr.io/kube-proxy                                     v1.24.3     2ae1ba6417cb  3 weeks ago    112 MB</span><br><span class="line">k8s.gcr.io/kube-controller-manager                        v1.24.3     586c112956df  3 weeks ago    121 MB</span><br><span class="line">k8s.gcr.io/kube-scheduler                                 v1.24.3     3a5aa3a515f5  3 weeks ago    52.3 MB</span><br><span class="line">docker.io/rancher/mirrored-flannelcni-flannel             v0.19.0     c4300d1c88c8  4 weeks ago    63.3 MB</span><br><span class="line">docker.io/rancher/mirrored-flannelcni-flannel-cni-plugin  v1.1.0      fcecffc7ad4a  2 months ago   8.37 MB</span><br><span class="line">k8s.gcr.io/etcd                                           3.5.3-0     aebe758cef4c  3 months ago   301 MB</span><br><span class="line">docker.io/rancher/local-path-provisioner                  v0.0.22     e16d1e3a1066  4 months ago   35.3 MB</span><br><span class="line">k8s.gcr.io/pause                                          3.7         221177c6082a  5 months ago   718 kB</span><br><span class="line">k8s.gcr.io/coredns/coredns                                v1.8.6      a4ca41631cc7  10 months ago  47 MB</span><br><span class="line">registry.k8s.io/pause                                     3.6         6270bb605e12  11 months ago  690 kB</span><br></pre></td></tr></table></figure>

<ul>
<li><code>docker.io/rancher/mirrored-flannelcni-flannel:v1.1.0</code></li>
<li><code>docker.io/rancher/mirrored-flannelcni-flannel-cni-plugin:v0.19.0</code></li>
<li>以上兩片 image 是陳老師先幫我們準備好的</li>
</ul>
<h2 id="設定-K8S-Master"><a href="#設定-K8S-Master" class="headerlink" title="設定 K8S Master"></a>設定 K8S Master</h2><p>將 bigred 設成 K8S 管理者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p $HOME/.kube; sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config; sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>

<ul>
<li>先在使用者家目錄下建立一個 <code>.kube</code> 的目錄</li>
<li>然後拷貝 <code>admin.conf</code> 這個 K8S 管理者的設定檔到 使用者家目錄下 <code>.kube</code> 目錄裡面的 <code>config</code> 這個檔案裡面</li>
<li>最後將 <code>config</code> 的權限設為 當前使用者的權限</li>
<li><code>cp -i</code> ，覆蓋前會提示</li>
<li><code>id -u</code> ，顯示當前使用者的 UID</li>
<li><code>id -g</code> ，顯示當前使用者群組的 GID</li>
</ul>
<p>設定 K8S Master 可以執行 Pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl taint node m1 node-role.kubernetes.io/control-plane:NoSchedule-</span><br></pre></td></tr></table></figure>

<ul>
<li>K8s 的每個 node 都會有標記 taint ，而 m1 這台 node 在 K8S 初始化的時候會被標記 <code>NoSchedule</code> 的 taint ，有了這個 taint 之後， pod 就不會建在 m1 的 node 上，這時候在規則裡面改成 <code>NoSchedule-</code> ， 就能破格。</li>
</ul>
<p>Kubernetes 1.24.4 版還要再執行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl taint node m1 node-role.kubernetes.io/master:NoSchedule-</span><br></pre></td></tr></table></figure>


<h2 id="安裝-Flannel-網路套件"><a href="#安裝-Flannel-網路套件" class="headerlink" title="安裝 Flannel 網路套件"></a>安裝 Flannel 網路套件</h2><p>flannel 網路套件，動用的技術 : Static Route</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>

<ul>
<li>因建立 K8S 設定 POD 的 Subnet 為 10.244.0.0&#x2F;16, 而 flannel 內定網路 ID 為 10.244.0.0&#x2F;16, 所以不需修改 kube-flannel.yml</li>
</ul>
<p>安裝好後，將 m1 主機重新開機</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo reboot</span><br></pre></td></tr></table></figure>

<h2 id="檢視-Kubernetes-系統狀態"><a href="#檢視-Kubernetes-系統狀態" class="headerlink" title="檢視 Kubernetes 系統狀態"></a>檢視 Kubernetes 系統狀態</h2><p>檢查 node 的狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br><span class="line">NAME   STATUS   ROLES           AGE   VERSION</span><br><span class="line">m1     Ready    control-plane   74m   v1.24.3</span><br></pre></td></tr></table></figure>

<p>檢查 kube-system 這個 Namespace 裡面 pod 的狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-6d4b75cb6d-grkmp     1/1     Running   1          37m</span><br><span class="line">coredns-6d4b75cb6d-xlgfd     1/1     Running   1          37m</span><br><span class="line">etcd-m1                      1/1     Running   1          37m</span><br><span class="line">kube-apiserver-m1            1/1     Running   1          37m</span><br><span class="line">kube-controller-manager-m1   1/1     Running   1          37m</span><br><span class="line">kube-proxy-ftk9d             1/1     Running   1          37m</span><br><span class="line">kube-scheduler-m1            1/1     Running   1          37m</span><br></pre></td></tr></table></figure>

<p><strong>注意！這邊的 Namespace 與 linux 的 namespace 不同</strong></p>
<ul>
<li><code>-n</code> ， namespace ，K8S 系統的運作空間</li>
<li><code>coredns</code>，供外部通訊所使用的 Domain Name Server ( 負責做 Service Discovery )</li>
<li><code>kube-apiserver-m1</code>，負責接收使用者的命令</li>
<li><code>etcd-m1</code>，紀錄 K8S 系統的 Metadata</li>
<li><code>kube-scheduler-m1</code>，負責啟動 Pod</li>
<li><code>kube-controller-manager-m1</code>，負責監控與維護 Pod</li>
<li><code>flannel</code> + <code>kube-proxy</code> 可以讓 pod 在不同 nodes 之間網路能互通有無</li>
</ul>
<p>看 m1 主機維運系統的 4 個 pod 的 Container 狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ crictl ps -a</span><br></pre></td></tr></table></figure>

<p>output : </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CONTAINER           IMAGE                                                              CREATED             STATE               NAME                      ATTEMPT             POD ID              POD</span><br><span class="line">45c3af598722d       a4ca41631cc7ac19ce1be3ebf0314ac5f47af7c711f17066006db82ee3b75b03   9 minutes ago       Running             coredns                   1                   1a9c8965ba001       coredns-6d4b75cb6d-xlgfd</span><br><span class="line">54317fe6de819       a4ca41631cc7ac19ce1be3ebf0314ac5f47af7c711f17066006db82ee3b75b03   9 minutes ago       Running             coredns                   1                   6581b3ba9f2b8       coredns-6d4b75cb6d-grkmp</span><br><span class="line">06f7e1a7dc5c4       252b2c3ee6c86b9cba63c9bddc2d1638d4152b5713009ff9397498014d06178e   10 minutes ago      Running             kube-flannel              1                   b0b014f1d4cb6       kube-flannel-ds-r5p9q</span><br><span class="line">f32b9416f5600       2ae1ba6417cbcd0b381139277508ddbebd0cf055344b710f7ea16e4da954a302   10 minutes ago      Running             kube-proxy                1                   f5b632754d09e       kube-proxy-ftk9d</span><br><span class="line">81fa3b96f83f4       252b2c3ee6c86b9cba63c9bddc2d1638d4152b5713009ff9397498014d06178e   10 minutes ago      Exited              install-cni               1                   b0b014f1d4cb6       kube-flannel-ds-r5p9q</span><br><span class="line">38cdbe521c340       fcecffc7ad4af70c8b436d45688771e0562cbd20f55d98581ba22cf13aad360d   10 minutes ago      Exited              install-cni-plugin        1                   b0b014f1d4cb6       kube-flannel-ds-r5p9q</span><br><span class="line">46ac2b6b44a73       586c112956dfc2de95aef392cbfcbfa2b579c332993079ed4d13108ff2409f2f   10 minutes ago      Running             kube-controller-manager   1                   1132c83fc98fc       kube-controller-manager-m1</span><br><span class="line">adbf8a41e4cb8       d521dd763e2e345a72534dd1503df3f5a14645ccb3fb0c0dd672fdd6da8853db   10 minutes ago      Running             kube-apiserver            1                   e2caae9b8b044       kube-apiserver-m1</span><br><span class="line">ee38c42a981d8       aebe758cef4cd05b9f8cee39758227714d02f42ef3088023c1e3cd454f927a2b   10 minutes ago      Running             etcd                      1                   dc7ecd13048ef       etcd-m1</span><br><span class="line">794fdd119dd8d       3a5aa3a515f5d28b31ac5410cfaa56ddbbec1c4e88cbdf711db9de6bbf6b00b0   10 minutes ago      Running             kube-scheduler            1                   ded0bada61429       kube-scheduler-m1</span><br></pre></td></tr></table></figure>






<h2 id="w1-w2-安裝-kubelet-及-kubeadm-命令"><a href="#w1-w2-安裝-kubelet-及-kubeadm-命令" class="headerlink" title="w1, w2 安裝 kubelet 及 kubeadm 命令"></a>w1, w2 安裝 kubelet 及 kubeadm 命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ssh 到 w1 主機安裝 kubelet 及 kubeadm 命令</span><br><span class="line">$ ssh w1 &#x27;sudo apk add kubeadm kubelet --update-cache --repository http://dl-3.alpinelinux.org/alpine/edge/testing/ --allow-untrusted&#x27;</span><br><span class="line"></span><br><span class="line"># ssh 到 w2 主機安裝 kubelet 及 kubeadm 命令</span><br><span class="line">$ ssh w2 &#x27;sudo apk add kubeadm kubelet --update-cache --repository http://dl-3.alpinelinux.org/alpine/edge/testing/ --allow-untrusted&#x27;</span><br><span class="line"></span><br><span class="line"># ssh 到 w1, w2 主機，將 kubelet 設成 Deamon</span><br><span class="line">$ ssh w1 &#x27;sudo rc-update add kubelet default&#x27;; ssh w2 &#x27;sudo rc-update add kubelet default&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>work node 不裝 <code>kubectl</code> 的原因是因為我們規劃的管理主機在 m1 ，work node 不需要管理其他機器。</li>
</ul>
<h2 id="w1-w2-加入-K8S-Cluster"><a href="#w1-w2-加入-K8S-Cluster" class="headerlink" title="w1, w2 加入 K8S Cluster"></a>w1, w2 加入 K8S Cluster</h2><p>在 m1 的終端機, 執行以下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 設定 JOIN 環境變數</span></span><br><span class="line">$ <span class="built_in">export</span> JOIN=$(<span class="built_in">echo</span> <span class="string">&quot; sudo `kubeadm token create --print-join-command 2&gt;/dev/null`&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 將 w1 主機，join 到 m1 的這個 k8s 的 Cluster</span></span><br><span class="line">$ ssh w1 <span class="string">&quot;<span class="variable">$JOIN</span>&quot;</span>; ssh w2 <span class="string">&quot;<span class="variable">$JOIN</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 將 w2 主機，join 到 m1 的這個 k8s 的 Cluster</span></span><br><span class="line">$ ssh w1 sudo reboot; ssh w2 sudo reboot</span><br></pre></td></tr></table></figure>

<p>:::info</p>
<p>:::spoiler JOIN 變數解析 </p>
<p>描述 : 將 w1 和 w2 的主機，join 到 K8S 系統的命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ echo &quot; sudo `kubeadm token create --print-join-command`&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>--print-join-command</code>，不要只打印令牌，而是打印使用令牌加入集群所需的完整 “kubeadm join” 標誌。</li>
</ul>
<p>output : </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm join 192.168.61.4:6443 --token tx06v1.le8z0pagl0ltfycz --discovery-token-ca-cert-hash sha256:0f4c243af9e70715a72f30ba0bc5cc44210f1b8fc66447cde16bad3a8c48d691</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-token/">Kubernetes 官網 kubeadm token 的說明連結 </a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/admin/bootstrap-tokens/">kubeadm token 補充</a></li>
</ul>
<p>:::</p>
<h2 id="設定-K8S-Worker-標籤"><a href="#設定-K8S-Worker-標籤" class="headerlink" title="設定 K8S Worker 標籤"></a>設定 K8S Worker 標籤</h2><p>在 m1 終端機, 執行以下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br><span class="line">NAME   STATUS   ROLES           AGE     VERSION</span><br><span class="line">m1     Ready    control-plane   76m     v1.24.3</span><br><span class="line">w1     Ready    &lt;none&gt;          4m21s   v1.24.3</span><br><span class="line">w2     Ready    &lt;none&gt;          79s     v1.24.3</span><br></pre></td></tr></table></figure>

<p>即使此時 w1 和 w2 <code>notready</code> ，也可以貼標籤，因為它是對 <code>etcd</code> 的資料庫作業。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl label node w1 node-role.kubernetes.io/worker=; kubectl label node w2 node-role.kubernetes.io/worker=</span><br></pre></td></tr></table></figure>

<ul>
<li>對 w1 和 w2 node 的 role 貼上 worker 的標籤</li>
<li><code>worker=</code>， worker 的等號後面還可以放更詳細的說明，例如 : Asia, Taipei… 等</li>
</ul>
<p>檢查是否符合預期</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br><span class="line">NAME   STATUS   ROLES           AGE   VERSION</span><br><span class="line">m1     Ready    control-plane   75m   v1.24.3</span><br><span class="line">w1     Ready    worker          37m   v1.24.3</span><br><span class="line">w2     Ready    worker          36m   v1.24.3</span><br></pre></td></tr></table></figure>



<hr>
<h1 id="Kubernetes-檢測"><a href="#Kubernetes-檢測" class="headerlink" title="Kubernetes 檢測"></a>Kubernetes 檢測</h1><h2 id="建立-K8S-POD"><a href="#建立-K8S-POD" class="headerlink" title="建立 K8S POD"></a>建立 K8S POD</h2><p>kubectl run 產生 pod ，pod 名字 nginx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run nginx --image=quay.io/cloudwalker/nginx</span><br><span class="line">pod/nginx created --&gt; ( 高機率騙人，有可能產生出來是掛的 )</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kubectl run</code>，Create and run a particular image in a pod.</li>
<li><code>--image=&#39;&#39;</code>，The image for the container to run.</li>
</ul>
<p>檢查是否符合預期</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME    READY   STATUS              RESTARTS   AGE</span><br><span class="line">nginx   0/1     ContainerCreating   0          8s</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx   1/1     Running   0          52s</span><br><span class="line"></span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE   IP           NODE   NOMINATED NODE   READINESS GATE</span><br><span class="line">nginx   1/1     Running   0          74s   10.244.1.3   w1     &lt;none&gt;     &lt;none&gt;</span><br><span class="line">-o output </span><br></pre></td></tr></table></figure>

<ul>
<li>READY 的 1&#x2F;1 </li>
<li>分子 -&gt; 幾台正在 running 的 Container ; 分母 1 個 pod 有幾台 Container</li>
<li><code>-o wide</code> ，可以看到 pod 的 ip 位址，和所在的 node</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s http://10.244.1.3 | grep &#x27;Welcome&#x27;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line"># 刪除 pod &lt;pod name&gt;</span><br><span class="line">$ kubectl delete pods nginx</span><br><span class="line"></span><br><span class="line">$ kubectl run nginx --image=quay.io/cloudwalker/nginx</span><br><span class="line">pod/nginx created</span><br><span class="line"></span><br><span class="line">$ kubectl run a1 --image=quay.io/cloudwalker/alpine</span><br><span class="line">pod/a1 created</span><br><span class="line"></span><br><span class="line">## 失敗原因是因為 </span><br><span class="line">## quay.io/cloudwalker/alpine 這張光碟片第一個跑的命令是 sh，</span><br><span class="line">## 所以後面給一個虛擬終端機</span><br><span class="line">$ kg pods</span><br><span class="line">NAME    READY   STATUS             RESTARTS      AGE</span><br><span class="line">a1      0/1     CrashLoopBackOff   2 (18s ago)   44s</span><br><span class="line"></span><br><span class="line"># -it ，給一個個虛擬終端機</span><br><span class="line"># --rm ，pod 停止就刪除 pod</span><br><span class="line">$ kubectl run a1 --rm --image=quay.io/cloudwalker/alpine -it</span><br><span class="line"></span><br><span class="line">$ kubectl exec -it a1 -- sh</span><br><span class="line">## 要對 pod 下達命令一定要在 -- 後面</span><br><span class="line">/ # curl http://10.244.1.3</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">...中間省略</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">/ # exit</span><br></pre></td></tr></table></figure>

<ul>
<li>兩個 pod 之間可以互通有無</li>
<li>工作主機 和 master 主機也可以的到 nginx 那台 pod<br><img src="https://i.imgur.com/wyEgvEA.png"><br><img src="https://i.imgur.com/wlGqQgP.png"><br><img src="https://i.imgur.com/GBHb05F.png"></li>
</ul>
<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes-First-Steps.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes-First-Steps.html" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-04 03:30:10" itemprop="dateCreated datePublished" datetime="2022-09-04T03:30:10+08:00">2022-09-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 16:15:42" itemprop="dateModified" datetime="2023-05-07T16:15:42+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-First-Steps"><a href="#Kubernetes-First-Steps" class="headerlink" title="Kubernetes-First-Steps"></a>Kubernetes-First-Steps</h1><p>:::warning</p>
<p>:::spoiler 目錄</p>
<p>[TOC]</p>
<hr>
<p>:::</p>
<h2 id="建立-K8S-應用物件方式"><a href="#建立-K8S-應用物件方式" class="headerlink" title="建立 K8S 應用物件方式"></a>建立 K8S 應用物件方式</h2><ul>
<li><code>kubectl run</code> (命令式 Imperative) - Manage K8s object (POD, Controller, Service) using CLI<ul>
<li>透過以上命令式建立 pod 能做到的功能是有限的。</li>
<li>e.g., 像要讓 pod 到指定 node 去 run 是做不到的; K8S 還有很多物件是無法用 <code>kubeclt run</code> 的方法產生</li>
<li><code>kubectl run</code> (Imperative) 這命令適合做概念性(物件的雛形)驗證 (Proof of Concept；POC)</li>
<li>結論 : <code>kubeclt run</code> 的方法 對於 K8S 能產生和設定多少物件是有限的</li>
</ul>
</li>
<li><code>kubectl create/apply</code> (聲明式 Declarative) - By defining K8s objects in yaml file<ul>
<li>K8S 產生物件的正規做法，但有個必要條件，須先設計 yaml 檔，才能產生對應的物件</li>
<li><code>kubectl create</code> (Declarative) 與 yaml 設定檔適合建立複雜的企業應用服務</li>
</ul>
</li>
<li>“Imperative” is a command - like “create 42 widgets”.</li>
<li>“Declarative” is a statement of the desired end result - like “I want 42 widgets to exist”.</li>
<li>For creating multiple complex object, declarative approach is preferred as it follows Infrastructure as a Code approach. However, imperative approach is also useful when we want to do quick POC and save yourself from writing yaml files. Let’s take a look at some imperative commands.</li>
</ul>
<h1 id="Using-Namespace"><a href="#Using-Namespace" class="headerlink" title="Using Namespace"></a>Using Namespace</h1><ul>
<li>在 K8S 裡的 Namespace ，可以想像成大樓裡的辦公室，裡面可以有很多人 (Container)，辦公室中還可以有很多桌子、椅子和影印機…等物件(pod, deployment, Service…等)</li>
<li><strong>Partition Cluster resources</strong>.</li>
<li>Kubernetes Namespaces can be used to divide a cluster into logical partitions allowing a single large Kubernetes cluster to be used by multiple users and teams, or a single user with multiple applications. Each user, team, or application running in a Namespace, is isolated from every other user, team, or application in other Namespaces and they operate as if they are the sole user of the cluster (note that Namespaces do not provide network segmentation).</li>
<li>Namespaces 有以下幾個特點<ul>
<li>在同一個 Kubernetes Cluster 中，每個 Namespaces 的名稱都是要獨特的</li>
<li>當一個 Namespaces 被刪除時，在該 Namespace 裡的所有物件也會被刪除<ul>
<li>注意!只會刪除 K8S 產生的物件，如果 K8S 的物件有產生檔案或目錄是不會被刪除的。</li>
</ul>
</li>
<li>可以透過 Resource Quotas 限制一個 Namespaces 所可以存取的資源<ul>
<li>不只限制可用的運算資源，還能限制 K8S 的物件</li>
<li>有防火牆的機制，可以允許或禁止 pod 連到另一個 Namespace 的 pod ，或是讓一個 pod 可以上網</li>
</ul>
</li>
</ul>
</li>
<li>結論 : K8S 的物件一定要指定一個 Namespace 給它 run。開發應用系統必定會建立專案目錄, 設計 K8S Application 需在 Namespace, 來運作</li>
</ul>
<p><strong>檢視 K8S 當前所有 Namespace 的資訊</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get ns</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   10d</span><br><span class="line">kube-flannel      Active   10d</span><br><span class="line">kube-node-lease   Active   10d</span><br><span class="line">kube-public       Active   10d</span><br><span class="line">kube-system       Active   10d</span><br></pre></td></tr></table></figure>

<ul>
<li><code>default</code>，預設的 Namespaces 名稱為 default，過去我們產生的物件像是， Deployment， Services 等若沒特別指定 Namespace 都是存放在名稱為 default 的 namespaces 中。</li>
<li><code>kube-public</code>，是個特殊的 namespace，存放在裡面的物件可被所有的使用者讀取。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-6d4b75cb6d-tslq8     1/1     Running   5          10d</span><br><span class="line">coredns-6d4b75cb6d-vqz9h     1/1     Running   5          10d</span><br><span class="line">etcd-m1                      1/1     Running   5          10d</span><br><span class="line">kube-apiserver-m1            1/1     Running   5          10d</span><br><span class="line">kube-controller-manager-m1   1/1     Running   5          10d</span><br><span class="line">kube-proxy-274g9             1/1     Running   4          10d</span><br><span class="line">kube-proxy-kqlrm             1/1     Running   4          10d</span><br><span class="line">kube-proxy-zw6sb             1/1     Running   5          10d</span><br><span class="line">kube-scheduler-m1            1/1     Running   5          10d</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kube-system</code>，在 Kubernetes 中，較特別的資源都會存放在 kube-system 這個 namespace。若是用 <code>kubectl get all -n kube-system</code> 查看，可以發現 kube-dns 或是 kube-apiserver…等維運系統的 pod 都是存放在該 namepsace 中。</li>
<li>Namespace 參考文章連結 : <a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/m/articles/10197186">https://ithelp.ithome.com.tw/m/articles/10197186</a></li>
</ul>
<h2 id="K8S-default-Namespace"><a href="#K8S-default-Namespace" class="headerlink" title="K8S default Namespace"></a>K8S default Namespace</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create deployment --image quay.io/cloudwalker/nginx demo-nginx</span><br><span class="line">deployment.apps/demo-nginx created</span><br><span class="line"></span><br><span class="line">$ kubectl describe deployment demo-nginx | grep Namespace</span><br><span class="line">Namespace:              default</span><br><span class="line"></span><br><span class="line">$ kubectl create deployment --image quay.io/cloudwalker/nginx demo-nginx</span><br><span class="line">Error from server (AlreadyExists): deployments.apps &quot;demo-nginx&quot; already exists</span><br><span class="line"></span><br><span class="line">$ kubectl create deployment --image quay.io/cloudwalker/nginx demo-nginx -n kube-public</span><br></pre></td></tr></table></figure>



<h2 id="Assigning-Pods-to-Namespace"><a href="#Assigning-Pods-to-Namespace" class="headerlink" title="Assigning Pods to Namespace"></a>Assigning Pods to Namespace</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 建立工作目錄</span><br><span class="line">$ mkdir -p ~/wulin/yaml; cd ~/wulin</span><br><span class="line"></span><br><span class="line"># 建立新的 namespace</span><br><span class="line">$ kubectl create namespace myoffice</span><br><span class="line">namespace/myoffice created</span><br><span class="line"></span><br><span class="line"># 檢查有無建立成功</span><br><span class="line">$ kubectl get namespace</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   10d</span><br><span class="line">kube-flannel      Active   10d</span><br><span class="line">kube-node-lease   Active   10d</span><br><span class="line">kube-public       Active   10d</span><br><span class="line">kube-system       Active   10d</span><br><span class="line">myoffice          Active   2s</span><br><span class="line"></span><br><span class="line"># 刪除 myoffice namespace</span><br><span class="line">$ kubectl delete namespace myoffice</span><br><span class="line"></span><br><span class="line"># 再次建立 myoffice namespace</span><br><span class="line">$ kubeclt create namespace myoffice</span><br><span class="line"></span><br><span class="line"># 檢查</span><br><span class="line">$ kubectl get namespace</span><br></pre></td></tr></table></figure>


<p>建立 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run n1 --image=quay.io/cloudwalker/alpine -n myoffice -- sleep infinity</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kubectl run</code>，用指定 image 產生 pod</li>
<li><code>n1</code>，pod 的名字</li>
<li><code>-n myoffice</code>，指定等等的 pod 會建在 myoffice 這個 namespace</li>
<li><code>-- sleep infinity</code>，<code>--</code>後面放的是 Container 要執行的程式 ，這裡是 <code>sleep infinity</code><ul>
<li>forever sleeping ( never awake until escape )</li>
</ul>
</li>
</ul>
<p>檢視 pod 的狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kg pods</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">gocgi   1/1     Running   1          20h</span><br><span class="line">mydb    1/1     Running   1          21h</span><br><span class="line">pod1    1/1     Running   1          16h</span><br></pre></td></tr></table></figure>

<ul>
<li>這裡看到的是在 default namespace 的 pod 資訊</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kg pods -n myoffice</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE</span><br><span class="line">n1     1/1     Running   0          22m</span><br></pre></td></tr></table></figure>

<ul>
<li>這裡看到的是 myoffice 這個 namespace 裡面 pod 資訊</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -it n1 sh</span><br><span class="line">kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.</span><br><span class="line">Error from server (NotFound): pods &quot;n1&quot; not found</span><br></pre></td></tr></table></figure>
<ul>
<li>錯誤訊息翻譯:<ul>
<li><code>kubectl exec [POD] [COMMAND]</code> ，這個用法以被棄用，且即將在未來的版本被刪除</li>
<li>要使用 <code>kubectl exec [POD] -- [COMMAND]</code>，Command 前面要加 <code>--</code></li>
<li><code>Error from server (NotFound): pods &quot;n1&quot; not found</code>，找不到 n1 這台 pod，因未指定 Namespace 的話，預設會到 default 這個 namespace 裡面找有沒有 n1 這個 pod</li>
</ul>
</li>
<li>用法須更正為:<ul>
<li><code>kubectl exec -it n1 -n myoffice -- sh</code></li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -it -n myoffice n1 -- sh</span><br><span class="line">/ # ping -c 1 www.hinet.net</span><br><span class="line">PING www.hinet.net (163.28.83.113): 56 data bytes</span><br><span class="line">ping: permission denied (are you root?)</span><br><span class="line"></span><br><span class="line"># 檢視 NameServer 是誰</span><br><span class="line">/ # cat /etc/resolv.conf</span><br><span class="line">search myoffice.svc.k8s.org svc.k8s.org k8s.org localdomain</span><br><span class="line">nameserver 10.98.0.10</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line">/ # exit</span><br></pre></td></tr></table></figure>

<ul>
<li><code>nameserver 10.98.0.10</code>，這是 K8S 的 DNS Server</li>
<li>它會幫我們把 <code>www.hinet.net</code> 這個名稱丟到網路去問，最後解析出 <code>163.28.83.113</code> 這個 IP 位址</li>
<li><code>ping: permission denied (are you root?)</code>，權限不足，Linux Capaibility 不給權限</li>
</ul>
<p>用 yaml 檔建立 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano ~/wulin/yaml/pod-n2.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">n2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">myoffice</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">n2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">n2</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/busybox</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&quot;60&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">n2</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>kind</code> ，指定要建立 pod 這個物件</li>
<li><code>metadata</code>，設定重要資訊<ul>
<li><code>name: n2</code>，pod 名字 : n2</li>
<li><code>namespace</code>，設定 pod 所在的 namespace : myoffice</li>
<li><code>labels</code>，pod 上貼一個標籤</li>
</ul>
</li>
<li><code>spec</code>，設定 pod 內部的結構<ul>
<li><code>hostname: n2</code>，設定 Container 的 hostname，多個 Container 也會共用同一個 hostname</li>
<li><code>contaienrs</code>，設定 Container 的資訊</li>
<li><code>command</code>，container 要先執行的命令<ul>
<li>yaml 檔中的 <code>command:</code> 這個宣告, 會覆蓋掉 image 的內定命令, 包括 entrypoint 指定的命令</li>
</ul>
</li>
<li><code>name</code>，設定 Container 在系統上的名稱</li>
</ul>
</li>
</ul>
<p>apply 它</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f ~/wulin/yaml/pod-n2.yaml</span><br></pre></td></tr></table></figure>

<p>檢查是否符合預期</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n myoffice</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE</span><br><span class="line">n1     1/1     Running   0          61m</span><br><span class="line">n2     1/1     Running   0          14s</span><br></pre></td></tr></table></figure>

<h3 id="切換-Namespace"><a href="#切換-Namespace" class="headerlink" title="切換 Namespace"></a>切換 Namespace</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config set-context --current --namespace=myoffice</span><br></pre></td></tr></table></figure>

<ul>
<li><code>set-context</code>，進入 K8S 的路口</li>
<li><code>set-context</code> ，入口的意思，進入商業辦公大樓的大門</li>
<li><code>--current</code> ，入口指定預設的入口，因為進入的方法有很多種，我們就走預設的入口</li>
<li><code>--namespace=myoffice</code> ，進到 myoffice 這個 namespace</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME   READY   STATUS    RESTARTS       AGE</span><br><span class="line">n1     1/1     Running   0              25m</span><br><span class="line">n2     1/1     Running   5 (105s ago)   8m32s</span><br><span class="line"></span><br><span class="line">$ cat ~/.kube/config | grep -A 6 contexts:</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    namespace: myoffice</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br></pre></td></tr></table></figure>

<ul>
<li><code>~/.kube/config</code>，進入 K8S 這棟大樓的磁卡 (裡面記錄著使用者在 K8S 的名字和識別代號，及擁有多大的權限可以對 K8S 的物件進行訪問…等資訊)</li>
<li><code>contexts</code>，大樓的入口，後面加 <code>s</code> 是因為可能會有很多入口<ul>
<li><code>context</code>，大樓的入口</li>
<li><code>cluster: kubernetes</code>，大樓的名字 : <code>kubernetes</code></li>
<li><code>namespace: myoffice</code>，大樓裡的辦公室名字: <code>myoffice</code></li>
<li><code>user: kubernetes-admin</code>，使用者進入大樓辦公室用的身分名稱</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cat ~/.kube/config | grep users -A1</span><br><span class="line">users:</span><br><span class="line">- name: kubernetes-admin</span><br></pre></td></tr></table></figure>

<ul>
<li>在 K8S 系統中，我們 bigred 的帳號，是 kubernetes-admin (由 <code>~/.kube/config</code> 這個檔案得知)</li>
</ul>
<h1 id="OpenSSH-實務應用"><a href="#OpenSSH-實務應用" class="headerlink" title="OpenSSH 實務應用"></a>OpenSSH 實務應用</h1><h2 id="Container-Image-設計與建立"><a href="#Container-Image-設計與建立" class="headerlink" title="Container Image 設計與建立"></a>Container Image 設計與建立</h2><p>在 m1 終端機, 執行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p ~/wulin/&#123;sshd,fbs&#125;</span><br><span class="line"></span><br><span class="line">$ echo $&#x27;FROM quay.io/cloudwalker/alpine</span><br><span class="line">RUN apk update &amp;&amp; apk upgrade &amp;&amp; apk add --no-cache nano sudo wget curl \</span><br><span class="line">    tree elinks bash shadow procps util-linux git coreutils binutils \</span><br><span class="line">    findutils grep openssh-server tzdata &amp;&amp; \</span><br><span class="line">    # 設定時區</span><br><span class="line">    cp /usr/share/zoneinfo/Asia/Taipei /etc/localtime &amp;&amp; \</span><br><span class="line">    ssh-keygen -t rsa -P &quot;&quot; -f /etc/ssh/ssh_host_rsa_key &amp;&amp; \</span><br><span class="line">    echo -e \&#x27;Welcome to ALP sshd 6000\\n\&#x27; &gt; /etc/motd &amp;&amp; \</span><br><span class="line">    # 建立管理者帳號 bigred</span><br><span class="line">    adduser -s /bin/bash -h /home/bigred -G wheel -D bigred &amp;&amp; \</span><br><span class="line">    echo &quot;%wheel   ALL=(ALL) NOPASSWD: ALL&quot; &gt;&gt; /etc/sudoers &amp;&amp; \</span><br><span class="line">    echo -e \&#x27;bigred\\nbigred\\n\&#x27; | passwd bigred &amp;&gt;/dev/null &amp;&amp; \</span><br><span class="line">    rm /sbin/reboot &amp;&amp; rm /usr/bin/killall</span><br><span class="line"></span><br><span class="line">EXPOSE 22</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [&quot;/usr/sbin/sshd&quot;]</span><br><span class="line">CMD [&quot;-D&quot;]&#x27; &gt; ~/wulin/sshd/Dockerfile</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ENTRYPOINT [&quot;/usr/sbin/sshd&quot;]</code> ，強制宣告等下 run 的 Container 等等只能跑 <code>/usr/sbin/sshd</code> 這個命令</li>
<li><code>CMD [&quot;-D&quot;]</code> ，上面命令的參數</li>
</ul>
<p>Container Image 建立與測試  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman build -t alp.sshd ~/wulin/sshd/</span><br><span class="line"></span><br><span class="line">$ sudo podman images | grep alp.sshd</span><br><span class="line">localhost/alp.sshd   latest  01424a71e3d6  3 minutes ago  67.6 MB</span><br><span class="line"></span><br><span class="line">$ sudo podman run --name a1 -h a1 -d -p 22100:22 alp.sshd</span><br><span class="line">220ce94e636ce9270604bd31a7dd5d515be6008ab6351295cd10a66da5d978d1</span><br><span class="line"></span><br><span class="line">$ ssh bigred@<span class="variable">$IP</span> -p 22100</span><br><span class="line">bigred@192.168.61.4 s password: bigred</span><br><span class="line">Welcome to ALP sshd 6000</span><br><span class="line"></span><br><span class="line">a1:~$ git version</span><br><span class="line">git version 2.30.2</span><br><span class="line"></span><br><span class="line">a1:~$ <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">$ sudo podman <span class="built_in">rm</span> -f a1</span><br></pre></td></tr></table></figure>

<h1 id="第一次接觸-Kubernetes-App"><a href="#第一次接觸-Kubernetes-App" class="headerlink" title="第一次接觸 Kubernetes App"></a>第一次接觸 Kubernetes App</h1><p>建立 K8S 應用物件方式</p>
<ol>
<li><code>kubectl run</code> (命令式 Imperative) - Manage K8s object (POD, Controller, Service) using CLI</li>
<li><code>kubectl create/apply</code> (聲明式 Declarative) - By defining K8s objects in yaml file<ul>
<li>yaml ，全名 : Yet Another Markup Language ( 因為不用再看到 xml 檔了 )</li>
</ul>
</li>
</ol>
<p>For creating multiple complex object, declarative approach is preferred as it follows Infrastructure as a Code approach. However, imperative approach is also useful when we want to do quick POC and save yourself from writing yaml files. Let’s take a look at some imperative commands.</p>
<blockquote>
<p>kubectl run (Imperative) 這命令適合做概念性驗證 (Proof of Concept；POC), kubectl create (Declarative) 與 yaml 設定檔適合建立複雜的企業應用服務</p>
</blockquote>
<h2 id="建立-Demo-App"><a href="#建立-Demo-App" class="headerlink" title="建立 Demo App"></a>建立 Demo App</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># 建立一個 pod ，image 用的是 alp.sshd</span><br><span class="line">$ kubectl run demo --image=alp.sshd</span><br><span class="line"></span><br><span class="line">[註] 從 1.18 這個版本開始, 上面命令只會產生 pod, 不再會產生 deployment object 及 replicaset controller. </span><br><span class="line"></span><br><span class="line"># 為何 pod 會建立失敗 ? ErrImagePull ?</span><br><span class="line">$ kg pods -o wide</span><br><span class="line">NAME    READY   STATUS         RESTARTS   AGE   IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">demo    0/1     ErrImagePull   0          13s   10.244.2.5   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># 因為在我們的工作主機上，沒有這片 image，所以先刪除 pod</span><br><span class="line"># --force ，強制刪除</span><br><span class="line">$ kubectl delete pods demo --force</span><br><span class="line">warning: Immediate deletion does not wait for confirmation that the running resource has been terminated. The resource may continue to run on the cluster indefinitely.</span><br><span class="line">pod &quot;demo&quot; force deleted</span><br><span class="line"></span><br><span class="line"># 打包 alp.sshd 這個 image</span><br><span class="line">$ sudo podman save alp.sshd &gt; alp.sshd.tar</span><br><span class="line"></span><br><span class="line"># 將打包檔拷貝到 w1 和 w2 主機</span><br><span class="line">$ scp alp.sshd.tar w1:alp.sshd.tar; scp alp.sshd.tar w2:alp.sshd.tar</span><br><span class="line"></span><br><span class="line"># 在 w1 和 w2 主機，將打包檔的 image 還原</span><br><span class="line">$ ssh w1 &#x27;sudo podman load &lt; alp.sshd.tar&#x27;</span><br><span class="line">$ ssh w2 &#x27;sudo podman load &lt; alp.sshd.tar&#x27;</span><br><span class="line"></span><br><span class="line"># 再 run 一次 pod</span><br><span class="line"># --image-pull-policy IfNotPresent ，如果本地端有 image 就不用上網下載了</span><br><span class="line">$ kubectl run demo --image-pull-policy IfNotPresent --image=localhost/alp.sshd</span><br><span class="line">pod/demo created</span><br><span class="line"></span><br><span class="line"># 以下命令會失敗的原因是因為， image 前面不加 localhost ，就會上網飆到 docker.io/library 抓 image</span><br><span class="line">$ kubectl run demo --image=alp.sshd</span><br><span class="line"></span><br><span class="line"># 其實不加 --image-pull-policy IfNotPresent 也會過</span><br><span class="line">$ kubectl run demo --image=localhost/alp.sshd</span><br><span class="line"></span><br><span class="line"># 檢查是否符合預期</span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE     IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">demo   1/1     Running   0    3m12s   10.244.2.2   w2     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h2 id="建立-OpenSSH-Pod"><a href="#建立-OpenSSH-Pod" class="headerlink" title="建立 OpenSSH Pod"></a>建立 OpenSSH Pod</h2><p>編輯 sshd yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano ~/wulin/sshd/pod-sshd.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-sshd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysshd</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">localhost/alp.sshd</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/bin/bash</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">        adduser -s /bin/bash -h /home/rbean rbean</span></span><br><span class="line"><span class="string">        echo -e &#x27;rbean\nrbean\n&#x27; | passwd rbean</span></span><br><span class="line"><span class="string">        /usr/sbin/sshd -D</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在 K8S yaml 檔的 <code>command</code> 能破格 Dockerfile 設定的 <code>ENTRYPOINT</code>，讓 Container 跑 <code>command</code> 宣告的命令</li>
<li>但是 Container run 的程式還是要在前景執行</li>
<li>所以 <code>command</code> 最後還是要宣告 <code>/usr/sbin/sshd -D</code>，讓 Container 有個 <code>SSH Server</code> 一直在前景執行的命令</li>
<li><code>/bin/bash -c</code>，<code>c</code> 的意思是 command，合起來就是讓 bash 貝殼程式跑下面的命令</li>
<li><code>|</code>，這裡的 pipe 意思是會保留以下宣告命令的格式，有空格就空格，有換行就換行，通通保留，如果沒有宣告，貝殼程式會把下面 3 行命令當成一行</li>
</ul>
<p>用 apply 產生 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f ~/wulin/sshd/pod-sshd.yaml</span><br></pre></td></tr></table></figure>

<p>檢查 pod 狀態</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kg po pod-sshd -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-sshd   1/1     Running   0          2m    10.244.1.37   w1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>SSH 連線測試 pod 功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ssh rbean@10.244.1.37</span><br><span class="line">rbean@10.244.1.37s password:</span><br><span class="line">Welcome to ALP sshd 6000</span><br><span class="line"></span><br><span class="line"># 建立 zzz 目錄</span><br><span class="line">pod-sshd:~$ mkdir zzz</span><br><span class="line">pod-sshd:~$ ls -ld zzz</span><br><span class="line">drwxr-sr-x 2 rbean rbean 4096 Sep  1 09:49 zzz</span><br><span class="line">pod-sshd:~$ exit</span><br><span class="line">logout</span><br><span class="line">Connection to 10.244.1.37 closed.</span><br></pre></td></tr></table></figure>

<p>刪除 pod </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod pod-sshd</span><br><span class="line">pod &quot;pod-sshd&quot; deleted</span><br></pre></td></tr></table></figure>

<p>再次建立 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f ~/wulin/sshd/pod-sshd.yaml</span><br><span class="line">pod/pod-sshd created</span><br></pre></td></tr></table></figure>

<p>連進 pod 檢視 zzz 目錄是否還在 ?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod pod-sshd -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-sshd   1/1     Running   0          73s   10.244.1.38   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># 用 rbean 帳號連進 pod</span><br><span class="line">$ ssh rbean@10.244.1.38</span><br><span class="line">Warning: Permanently added &#x27;10.244.1.38&#x27; (RSA) to the list of known hosts.</span><br><span class="line">rbean@10.244.1.38s password:</span><br><span class="line">Welcome to ALP sshd 6000</span><br><span class="line"></span><br><span class="line"># 檢視剛剛建立的目錄</span><br><span class="line">pod-sshd:~$ ls -l</span><br><span class="line">total 0</span><br></pre></td></tr></table></figure>

<ul>
<li>結論 : pod 只要沒有動用 volume ，當 pod 被刪除時，資料通通消失</li>
</ul>
<p>將 pod 所在的 w1 這台機器重開機</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh w1 &#x27;sudo reboot&#x27;</span><br></pre></td></tr></table></figure>

<p>再次檢視 pod 狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods pod-sshd -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-sshd   1/1     Running   1          20m   10.244.1.39   w1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>發現 pod 重新建立，Pod_IP 變了，資料也沒啦 !</li>
<li><strong>在 K8S 的系統中，只要 node 主機重開，它上面 run 的 pod 都會浴火重生(重建)，pod 沒有 volume 的話，資料通通再見 !</strong></li>
</ul>
<h2 id="Access-Kubernetes-Pods-from-outside"><a href="#Access-Kubernetes-Pods-from-outside" class="headerlink" title="Access Kubernetes Pods from outside"></a>Access Kubernetes Pods from outside</h2><p>編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano ~/wulin/yaml/podhostport.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podhostport</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wk01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/alpine.sshd</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">22</span></span><br><span class="line">       <span class="attr">hostPort:</span> <span class="number">22101</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">add:</span> [<span class="string">&quot;AUDIT_WRITE&quot;</span>, <span class="string">&quot;SYS_CHROOT&quot;</span>, <span class="string">&quot;CAP_NET_RAW&quot;</span>]</span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/usr/sbin/sshd&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;-D&quot;</span>]</span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">kubernetes.io/hostname:</span> <span class="string">w1</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>image:</code> ，Container 的 image 可以換裝成 <code>localhost/alp.sshd</code></li>
<li><code>hostport: 22101</code>，<code>kube-proxy</code> 會在 pod 所在主機開一個 22101 的 port，對應到 pod 裡 Container 開的 22 port，效能優於 <code>kubectl port-forward</code> </li>
<li>:::spoiler hostport 示意圖<br><img src="https://i.imgur.com/tixjWdt.png"><br>:::</li>
<li><code>nodeselector</code>，透過 node 上的 labels 來決定 pod 要建在哪台 node 上</li>
</ul>
<h2 id="讓-mydb-pod-也用-hostport-開"><a href="#讓-mydb-pod-也用-hostport-開" class="headerlink" title="讓 mydb pod 也用 hostport 開"></a>讓 mydb pod 也用 hostport 開</h2><p>先建立工作目錄</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p ~/wulin/mydb/</span><br></pre></td></tr></table></figure>

<p>編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano wulin/mydb/pod-mydb.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">mydb</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">localhost/mydb</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mydb</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">      <span class="attr">hostPort:</span> <span class="number">3306</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>產生 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ka -f wulin/mydb/pod-mydb.yaml</span><br><span class="line">pod/mydb created</span><br></pre></td></tr></table></figure>

<h2 id="檢視-Linux-capabilities"><a href="#檢視-Linux-capabilities" class="headerlink" title="檢視 Linux capabilities"></a>檢視 Linux capabilities</h2><ul>
<li><strong>Linux capabilities ，規範 Container 可以做什麼事，而規範 Container 等同於規範 pod</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ crio-status config</span><br><span class="line"></span><br><span class="line">output : </span><br><span class="line">...</span><br><span class="line">default_capabilities = [&quot;CHOWN&quot;, &quot;DAC_OVERRIDE&quot;, &quot;FSETID&quot;, &quot;FOWNER&quot;, &quot;SETGID&quot;, &quot;SETUID&quot;, &quot;SETPCAP&quot;, &quot;NET_BIND_SERVICE&quot;, &quot;AUDIT_WRITE&quot;, &quot;SYS_CHROOT&quot;, &quot;KILL&quot;]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li><code>NET_BIND_SERVICE</code> ，如果 Container 要開的 port number 小於 1024 ，會需要有這個 Capabilities</li>
<li><code>SSH</code> 通訊協定一定會需要 “<code>AUDIT_WRITE</code>“, “<code>SYS_CHROOT</code>“ 這兩個 Capabilities，才能讓 CRI-O 做出來的 Container run openssh 的時候，能夠讓 openssh Server 與外部連接，給別人從外面連進來，如果沒有以上兩個 Capabilities ，即使要用 root 去登入也沒用。設定後要記得重新開機。</li>
</ul>
<h3 id="CRI-O-規範-Linux-capabilities-的檔案"><a href="#CRI-O-規範-Linux-capabilities-的檔案" class="headerlink" title="CRI-O 規範 Linux capabilities 的檔案"></a>CRI-O 規範 Linux capabilities 的檔案</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nano /etc/crio/crio.conf</span><br><span class="line"></span><br><span class="line">output : </span><br><span class="line"></span><br><span class="line">[crio.runtime]</span><br><span class="line">.......</span><br><span class="line">default_capabilities = [</span><br><span class="line">  &quot;CHOWN&quot;,</span><br><span class="line">  &quot;DAC_OVERRIDE&quot;,</span><br><span class="line">  &quot;FSETID&quot;,</span><br><span class="line">  &quot;FOWNER&quot;,</span><br><span class="line">  &quot;SETGID&quot;,</span><br><span class="line">  &quot;SETUID&quot;,</span><br><span class="line">  &quot;SETPCAP&quot;,</span><br><span class="line">  &quot;NET_BIND_SERVICE&quot;,</span><br><span class="line">  &quot;AUDIT_WRITE&quot;,</span><br><span class="line">  &quot;SYS_CHROOT&quot;,</span><br><span class="line">  &quot;KILL&quot;</span><br><span class="line">]</span><br><span class="line">.......</span><br></pre></td></tr></table></figure>

<p>++讓 demo 這個 pod 安裝 libcap 套件++</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> demo -- sudo apk add libcap</span><br></pre></td></tr></table></figure>

<ul>
<li><code>--</code>，兩個 <code>-</code> 後面接的命令就是要給 pod 執行</li>
</ul>
<blockquote>
<p>如果這行安裝失敗，可以進入 pod 的 Container 將 nameserver 的設定檔 ( <code>/etc/resolv.conf</code> )，新增一行 <code>nameserver 8.8.8.8</code></p>
</blockquote>
<p>++查看 demo 這個 pod 裡面的 Container 裡面有哪些 Linux capabilities++</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec demo -- sudo capsh --print</span><br><span class="line"></span><br><span class="line">output :</span><br><span class="line"></span><br><span class="line">Current: cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_sys_chroot,cap_audit_write=ep</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="連接與移除-Demo-App"><a href="#連接與移除-Demo-App" class="headerlink" title="連接與移除 Demo App"></a>連接與移除 Demo App</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># K8S 叢集內連接 demo app，k8s 叢集內部的網路連線全程都會加密</span><br><span class="line"># -it ，給一個虛擬終端機</span><br><span class="line"># -- bash ，跑 bash 貝殼程式</span><br><span class="line">$ kubectl exec -it pods/demo -- bash</span><br><span class="line">bash-5.1# exit</span><br><span class="line"></span><br><span class="line"># 檢視 demo 這個 pod 的 IP 位址</span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE   IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">demo   1/1     Running   0          26m   10.244.2.2   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># ssh 連進 demo 這個 pod</span><br><span class="line">bigred@m1:~$ ssh bigred@10.244.2.2</span><br><span class="line">Warning: Permanently added &#x27;10.244.2.2&#x27; (RSA) to the list of known hosts.</span><br><span class="line">bigred@10.244.2.2 s password:</span><br><span class="line">Welcome to ALP sshd 6000</span><br><span class="line"></span><br><span class="line"># 離開 pod</span><br><span class="line">demo:~$ exit</span><br><span class="line"></span><br><span class="line"># K8S 叢集外連接 demo app</span><br><span class="line"># --address 只能指定 Master 的 IP 位址</span><br><span class="line">$ kubectl port-forward --address $IP pods/demo 22100:22 &amp;</span><br><span class="line">[1] 27780</span><br><span class="line"></span><br><span class="line"># 在 Windows 系統的 cmd 視窗, 執行以下命令</span><br><span class="line">$ ssh bigred@&lt;alp.m1 IP&gt; -p 22100</span><br><span class="line">Handling connection for 22100</span><br><span class="line">bigred@192.168.61.4 s password: bigred</span><br><span class="line">Welcome to ALP sshd 6000</span><br><span class="line"></span><br><span class="line"># 離開 pod</span><br><span class="line">demo:~$ exit</span><br><span class="line"></span><br><span class="line"># 移除 pod</span><br><span class="line">$ kubectl delete pod  demo</span><br></pre></td></tr></table></figure>

<p>以上動作運作架構圖</p>
<p><img src="https://i.imgur.com/7fFcPeY.png"></p>
<h1 id="第一次接觸-YAML-File"><a href="#第一次接觸-YAML-File" class="headerlink" title="第一次接觸 YAML File"></a>第一次接觸 YAML File</h1><h2 id="建立-OpenSSH-Pod-1"><a href="#建立-OpenSSH-Pod-1" class="headerlink" title="建立 OpenSSH Pod"></a>建立 OpenSSH Pod</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 建立專案目錄，編輯 yaml 檔</span><br><span class="line">$ cd ~/wulin; nano sshd/pod-sshd.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-sshd</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: mysshd</span><br><span class="line">    image: localhost/alp.sshd</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>apiVersion: v1</code> ，這行是跟 API Server 說，我們的 yaml 檔是 v1 ，這行的設定由 K8s 的版本來決定</p>
</li>
<li><p><code>kind: Pod</code> ， 設定 K8s 的物件</p>
</li>
<li><pre><code class="!">metadata:
name: pod-sshd ---&gt; 設定 pod 的名字
spec:
containers:
- name: mysshd ---&gt; 設定 Container 的名稱
  image: localhost/alp.sshd ---&gt; 設定 Container 用哪片 image 
  imagePullPolicy: IfNotPresent ---&gt; 如果本地端有這片 image，不用上網下載
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- `imagePullPolicy: Never` ，不要上網下載 image </span><br><span class="line"></span><br><span class="line">```bash!</span><br><span class="line"># apply yaml 檔，建立 pod</span><br><span class="line">$ kubectl apply -f sshd/pod-sshd.yaml</span><br><span class="line"></span><br><span class="line"># 檢查是否符合預期</span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE    IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">demo       1/1     Running   0          126m   10.244.2.2   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-sshd   1/1     Running   0          13s    10.244.1.3   w1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p><code>10.244.1.3</code>，看到這個 IP 位址 ，就知道 Flannel 網路套件在做事，將我們的 pod 分配到第一台工作機</p>
</li>
</ul>
<h2 id="再次修改-yaml-檔"><a href="#再次修改-yaml-檔" class="headerlink" title="再次修改 yaml 檔"></a>再次修改 yaml 檔</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ nano sshd/pod-sshd.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-sshd</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: mysshd</span><br><span class="line">    image: localhost/alp.sshd</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - /bin/bash</span><br><span class="line">      - -c</span><br><span class="line">      - |</span><br><span class="line">        adduser -s /bin/bash -h /home/rbean rbean</span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&#x27;rbean\nrbean\n&#x27;</span> | passwd rbean</span><br><span class="line">        /usr/sbin/sshd -D</span><br></pre></td></tr></table></figure>

<ul>
<li><code>command:</code>，在 K8s 的 yaml 檔中宣告一段等下 Container 要跑的 shell script ，即使 Container 的 image 本身有 <code>ENTRYPOINT [&quot;/usr/sbin/sshd&quot;]</code> ，一樣會被破格，強制要跑命令</li>
</ul>
<hr>
<h1 id="建立-File-Browser-Server"><a href="#建立-File-Browser-Server" class="headerlink" title="建立 File Browser Server"></a>建立 File Browser Server</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ cd ~/wulin/</span><br><span class="line"></span><br><span class="line">$ nano fbs/Dockerfile</span><br><span class="line">FROM quay.io/cloudwalker/alpine</span><br><span class="line">RUN apk update &amp;&amp; apk upgrade &amp;&amp; apk add --no-cache nano sudo wget curl \</span><br><span class="line">    tree elinks bash shadow procps util-linux coreutils binutils findutils grep &amp;&amp; \</span><br><span class="line">    curl -fsSL https://raw.githubusercontent.com/filebrowser/get/master/get.sh | bash &amp;&amp; \</span><br><span class="line">    # 設定 filebrowser</span><br><span class="line">    filebrowser config init --port 4000 --address &quot;&quot; --log &quot;/tmp/fbs&quot; --root=&quot;/srv&quot; &amp;&amp; \</span><br><span class="line">    # 建立管理者帳號</span><br><span class="line">    filebrowser users add admin &quot;admin&quot; --perm.admin=true</span><br><span class="line"></span><br><span class="line">CMD [&quot;filebrowser&quot;]</span><br></pre></td></tr></table></figure>

<ul>
<li><code>curl -fsSL &#39;URL/get.sh&#39; | bash</code>，利用 curl 命令將網站上的程式輸出在螢幕，但是 <code>| bash</code>，會將輸出在螢幕的程式碼丟給重裝貝殼執行，這樣做的好處是不會留下紀錄。<ul>
<li><code>-f</code>，下載失敗不會輸出錯誤訊息</li>
<li><code>-s</code>，Silent mode</li>
</ul>
</li>
<li><code>filebrowser config init</code>，將網站初始化<ul>
<li><code>--port 4000</code> ，網站的 port number : 4000</li>
<li><code>--address &quot;&quot;</code> ，任何 IP 位址的來源都能與我連線</li>
<li><code>--log &quot;/tmp/fbs&quot;</code>，網站 log 檔的存放檔案</li>
<li><code> --root=&quot;/srv&quot;</code> ，使用者丟檔案到網站後存放的目錄區，可自行設定</li>
</ul>
</li>
<li><code>filebrowser users add</code>，建立帳號<ul>
<li><code>admin &quot;admin&quot;</code>，帳號 : <code>admin</code>，密碼 : <code>admin</code></li>
<li><code>--perm.admin=true</code>，打開管理員的權限</li>
</ul>
</li>
</ul>
<p>build image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman build -t alp.myfbs fbs/</span><br><span class="line"></span><br><span class="line"># 檢查是否符合預期</span><br><span class="line">$ sudo podman images | grep fbs</span><br><span class="line">localhost/alp.myfbs       latest      24d1b68d43f8  About a minute ago  74.3 MB</span><br></pre></td></tr></table></figure>

<p>手動部署 alp.myfbs Image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 備份 Image </span><br><span class="line">$ sudo podman save localhost/alp.myfbs &gt; alpine.myfbs.tar</span><br><span class="line"></span><br><span class="line">$ scp alpine.myfbs.tar w1:~; scp alpine.myfbs.tar w2:~</span><br><span class="line"></span><br><span class="line">$ ssh w1 &#x27;sudo podman load &lt; alpine.myfbs.tar&#x27;; ssh w2 &#x27;sudo podman load &lt; alpine.myfbs.tar&#x27;</span><br></pre></td></tr></table></figure>

<p>建立 File Browser Server Pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 編輯 yaml 檔</span></span><br><span class="line">$ nano fbs/pod-fbs.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-fbs</span><br><span class="line">  labels:</span><br><span class="line">    name: pod-fbs</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: myfbs</span><br><span class="line">    image: localhost/alp.myfbs</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    ports:</span><br><span class="line">     - containerPort: 4000</span><br></pre></td></tr></table></figure>

<p>用 yaml 檔 建立 pod </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f fbs/pod-fbs.yaml</span><br></pre></td></tr></table></figure>

<p>檢查 pod 的 4000 port 有無開啟</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 看 pod 的 IP</span><br><span class="line">$ kg pods -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE     IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-fbs    1/1     Running   0          2m30s   10.244.1.6   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># 網貓測 4000 port</span><br><span class="line">$ nc -w 1 10.244.1.6 4000</span><br><span class="line"></span><br><span class="line">$ echo $?</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<h3 id="建立-File-Browser-Server-Service"><a href="#建立-File-Browser-Server-Service" class="headerlink" title="建立 File Browser Server Service"></a>建立 File Browser Server Service</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ nano fbs/svc-fbs.yaml</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: svc-fbs</span><br><span class="line">spec:</span><br><span class="line">  externalIPs:</span><br><span class="line">  - 192.168.61.4</span><br><span class="line">  selector:</span><br><span class="line">    name: pod-fbs</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8080</span><br><span class="line">    targetPort: 4000</span><br></pre></td></tr></table></figure>

<ul>
<li><code>selector:</code> ，選擇有貼 pod-fbs 這個標籤的 pod</li>
<li><code>externalIPs:</code> ，設定對外服務的 IP 位址</li>
<li><pre><code>ports:
- port: 8080   ---&gt; 對外的 port number
  targetPort: 4000   ---&gt; pod 開的 port number
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">建立 service/svc-fbs 服務</span><br><span class="line"></span><br></pre></td></tr></table></figure>
$ kubectl apply -f  fbs/svc-fbs.yaml
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">檢查是否符合預期</span><br><span class="line"></span><br><span class="line">```bash=</span><br><span class="line">$ kubectl get all -o wide</span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE   IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/pod-fbs    1/1     Running   0          14m   10.244.1.6   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/pod-sshd   1/1     Running   0          39m   10.244.2.4   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP    EXTERNAL-IP    PORT(S)    AGE    SELECTOR</span><br><span class="line">service/kubernetes   ClusterIP   10.98.0.1     &lt;none&gt;         443/TCP    4h5m   &lt;none&gt;</span><br><span class="line">service/svc-fbs      ClusterIP   10.98.0.230   192.168.61.4   8080/TCP   83s    name=pod-fbs</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<p>看 pod 的標籤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods --show-labels</span><br><span class="line">AME       READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">pod-fbs    1/1     Running   0          20m   name=pod-fbs</span><br><span class="line">pod-sshd   1/1     Running   0          44m   &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h3 id="FBS-架構示意圖"><a href="#FBS-架構示意圖" class="headerlink" title="FBS 架構示意圖"></a>FBS 架構示意圖</h3><p><img src="https://i.imgur.com/5G9pk3U.png"></p>
<ul>
<li>多建立 Service 這個物件的原因是因為，K8S 的 pod 很容易浴火重生，一旦重建， pod IP 會發生變動，如果這時候我們 pod 是一個網站，這個網站的 IP 位址時不時更換，會搞死人。</li>
<li>所以這時候需要透過 Service ，服務的 IP 在 K8S 中是固定的，不會因為主機重開，Service IP 就變動，所以只要讓 Service 透過 labels 綁住我們的 pod ，這樣即使 pod 浴火重生，也沒關係，我們一樣可以靠 Service 連的到我們的 pod</li>
</ul>
<h3 id="提問-如何得知檔案丟到網站後，存放在哪"><a href="#提問-如何得知檔案丟到網站後，存放在哪" class="headerlink" title="提問 : 如何得知檔案丟到網站後，存放在哪?"></a>提問 : 如何得知檔案丟到網站後，存放在哪?</h3><p>答 : pod-fbs 的 container 裡 <code>/srv</code> 目錄下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 進入 pod </span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it pod/pod-fbs -- bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 檢查是否符合預期</span></span><br><span class="line">bash-5.1<span class="comment"># ls -al srv</span></span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x 1 root root 4096 Jul 31 06:46 .</span><br><span class="line">dr-xr-xr-x 1 root root 4096 Jul 31 06:23 ..</span><br><span class="line">drwxr-xr-x 3 root root 4096 Jul 31 06:46 ALP3</span><br><span class="line"></span><br><span class="line">bash-5.1<span class="comment"># touch srv/zzz.txt</span></span><br><span class="line">bash-5.1<span class="comment"># ls -al srv/</span></span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x 1 root root 4096 Jul 31 06:51 .</span><br><span class="line">dr-xr-xr-x 1 root root 4096 Jul 31 06:23 ..</span><br><span class="line">drwxr-xr-x 3 root root 4096 Jul 31 06:46 ALP3</span><br><span class="line">-rw-r--r-- 1 root root    0 Jul 31 06:51 zzz.txt</span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/YpO3DbL.png"></p>
<h3 id="災難篇"><a href="#災難篇" class="headerlink" title="災難篇"></a>災難篇</h3><p>如果刪除 pod ，裡面存放的內容就不見了 ! ! !</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod pod-fbs</span><br><span class="line">pod &quot;pod-fbs&quot; deleted</span><br><span class="line"></span><br><span class="line">$ kubectl delete svc svc-fbs</span><br><span class="line">service &quot;svc-fbs&quot; deleted</span><br></pre></td></tr></table></figure>

<p>對於 K8s 的 Storage 怎麼處理 ?</p>
<h2 id="對-pod-的-yaml-檔新增-hostPath-PV"><a href="#對-pod-的-yaml-檔新增-hostPath-PV" class="headerlink" title="對 pod 的 yaml 檔新增 hostPath PV"></a>對 pod 的 yaml 檔新增 hostPath PV</h2><p>編輯 yaml 檔</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano fbs/pod-fbs.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-fbs</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-fbs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myfbs</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">localhost/alp.myfbs</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">4000</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/srv</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="comment"># directory location on host</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/tmp</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>volumeMounts</code>，設定 Container 的目錄要將哪個目錄掛載到 <code>volumes</code> 的目錄<ul>
<li><code>mountPath</code>，要掛載的目錄</li>
</ul>
</li>
<li><code>volumes</code>，下面可以宣告儲存體的設定<ul>
<li><code>hostPath</code>，volume 的型態<ul>
<li><code>path: /tmp</code>，這是一個在 Linux 系統的 <code>/tmp</code> 目錄，但注意 ! 這個目錄重開機裡面的內容會消失 (這是 Linux <code>/tmp</code> 目錄的規則)。</li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/volumes/">K8s 官網 hostPath 範例連結</a></li>
<li>如果刪除 pod 再重建一次， pod 可能會跑到別台 node 主機，如何解決 ?<br>答 : 針對第一次建立 pod 時，如果 pod 在 node 1 主機上，則每次重建 pod 時，就要安排在這台 node 主機上</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-fbs</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-fbs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myfbs</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">localhost/alp.myfbs</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">4000</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/srv</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="comment"># directory location on host</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/tmp</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">kubernetes.io/hostname:</span> <span class="string">w2</span></span><br></pre></td></tr></table></figure>



<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes%20CRI%20%E5%9F%BA%E7%A4%8E%E9%81%8B%E4%BD%9C.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes%20CRI%20%E5%9F%BA%E7%A4%8E%E9%81%8B%E4%BD%9C.html" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-08-30 06:54:16" itemprop="dateCreated datePublished" datetime="2022-08-30T06:54:16+08:00">2022-08-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 16:15:42" itemprop="dateModified" datetime="2023-05-07T16:15:42+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-CRI-基礎運作"><a href="#Kubernetes-CRI-基礎運作" class="headerlink" title="Kubernetes CRI 基礎運作"></a>Kubernetes CRI 基礎運作</h1><p>:::warning</p>
<p>:::spoiler 目錄</p>
<p>[TOC]</p>
<hr>
<p>:::</p>
<p>:::success<br>檢查 node 主機的運作情形</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br></pre></td></tr></table></figure>

<p>:::spoiler 命令結果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME   STATUS   ROLES           AGE   VERSION</span><br><span class="line">m1     Ready    control-plane   16h   v1.24.0</span><br><span class="line">w1     Ready    worker          16h   v1.24.0</span><br><span class="line">w2     Ready    worker          16h   v1.24.0</span><br></pre></td></tr></table></figure>
<p>:::</p>
<p>:::success<br>檢視pod 的運作情況</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system -o wide</span><br></pre></td></tr></table></figure>

<p>:::spoiler 命令結果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">NAME                         READY   STATUS    RESTARTS   AGE   IP             NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-6d4b75cb6d-58jvb     1/1     Running   2          16h   10.244.0.6     m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-6d4b75cb6d-z2sjv     1/1     Running   2          16h   10.244.0.7     m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">etcd-m1                      1/1     Running   3          16h   192.168.61.4   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-apiserver-m1            1/1     Running   3          16h   192.168.61.4   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-controller-manager-m1   1/1     Running   3          16h   192.168.61.4   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-jpqmz        1/1     Running   2          16h   192.168.61.7   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-qcsfc        1/1     Running   2          16h   192.168.61.6   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-rwmjm        1/1     Running   7          16h   192.168.61.4   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-proxy-cx78m             1/1     Running   2          16h   192.168.61.6   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-proxy-fcb8s             1/1     Running   3          16h   192.168.61.4   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-proxy-tgmbm             1/1     Running   2          16h   192.168.61.7   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-scheduler-m1            1/1     Running   3          16h   192.168.61.4   m1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>後面加<code>-o wide</code> 可以看到pod 的 ip 位址 和所在的主機<br>:::</p>
</blockquote>
<p>:::success<br>檢視 CRI-O 的版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ crio -version</span><br></pre></td></tr></table></figure>

<p>CRI-O 的版本一定跟著 K8S 的版本在運作</p>
<p>:::spoiler 命令結果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">crio version 1.24.1</span><br><span class="line">Version:          1.24.1</span><br><span class="line">GitCommit:        edda4988043086ee714c0b651ff91e68fa70adf9</span><br><span class="line">GitTreeState:     clean</span><br><span class="line">BuildDate:        2022-07-21T14:19:25Z</span><br><span class="line">GoVersion:        go1.18.4</span><br><span class="line">Compiler:         gc</span><br><span class="line">Platform:         linux/amd64</span><br><span class="line">Linkmode:         dynamic</span><br><span class="line">BuildTags:        containers_image_openpgp, containers_image_ostree_stub, seccomp, selinux</span><br><span class="line">SeccompEnabled:   true</span><br><span class="line">AppArmorEnabled:  false</span><br></pre></td></tr></table></figure>
<p>:::</p>
<p>:::success<br>crictl 的簡易手冊</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ crictl --help | grep -A 20 COMMANDS:</span><br></pre></td></tr></table></figure>

<p>:::spoiler 命令結果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">COMMANDS:</span><br><span class="line">   attach              Attach to a running container</span><br><span class="line">   create              Create a new container</span><br><span class="line">   exec                Run a command in a running container</span><br><span class="line">   version             Display runtime version information</span><br><span class="line">   images, image, img  List images</span><br><span class="line">   inspect             Display the status of one or more containers</span><br><span class="line">   inspecti            Return the status of one or more images</span><br><span class="line">   imagefsinfo         Return image filesystem info</span><br><span class="line">   inspectp            Display the status of one or more pods</span><br><span class="line">   logs                Fetch the logs of a container</span><br><span class="line">   port-forward        Forward local port to a pod</span><br><span class="line">   ps                  List containers</span><br><span class="line">   pull                Pull an image from a registry</span><br><span class="line">   run                 Run a new container inside a sandbox</span><br><span class="line">   runp                Run a new pod</span><br><span class="line">   rm                  Remove one or more containers</span><br><span class="line">   rmi                 Remove one or more images</span><br><span class="line">   rmp                 Remove one or more pods</span><br><span class="line">   pods                List pods</span><br><span class="line">   start               Start one or more created containers</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>run</code> ，可以透過 cri-o 建立 container<br>:::</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ crictl</span><br><span class="line">NAME:</span><br><span class="line">   crictl - client for CRI</span><br></pre></td></tr></table></figure>

<ul>
<li>crictl 這個套件，專門管理 CRI 的套件</li>
<li>crictl + crio 約略等於 Podman</li>
<li>如果一個系統的 deamon 太多，會很容易被人攻陷，且資源運算上會吃很兇，所以docker 被淘汰</li>
<li>podman 出生 全名： pod manager ，他可以做到docker 90%可以做的事情，且不需要依靠deamon</li>
</ul>
<p>:::success</p>
<p>檢視 podman 處理 image 的功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman --help</span><br><span class="line">  load        Load image(s) from a tar archive</span><br><span class="line">  save        Save image(s) to an archive</span><br><span class="line">  export      Export container&#x27;s filesystem contents as a tar archive</span><br><span class="line">  import      Import a tarball to create a filesystem image</span><br></pre></td></tr></table></figure>

<p><font color=red><strong><code>CRI-O</code> 並沒有以上 <code>load</code> ( 還原 image )、 <code>save</code> ( 備份 image ) 、<code>build</code>、 <code>export</code> 和 <code>import</code> 的命令</strong></font></p>
<p>因為 cri-o 只有下載 image 的能力，所以需要 podman 來支援 image 的管理<br>在老師的系統中使用 CRI-O + podman 來維運 K8s</p>
<p>podman 和 cri-o 上網抓 image 後儲存的位置相同，怎麼證明？<br>:::</p>
<h2 id="Podman-與-CRI-O-Image-存儲目錄"><a href="#Podman-與-CRI-O-Image-存儲目錄" class="headerlink" title="Podman 與 CRI-O Image 存儲目錄"></a>Podman 與 CRI-O Image 存儲目錄</h2><p>檢視 podman 儲存 image 的目錄</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /etc/containers/storage.conf | grep -A 15 <span class="string">&#x27;\[storage\]&#x27;</span></span><br><span class="line">[storage]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Default Storage Driver, Must be set for proper operation.</span></span><br><span class="line">driver = <span class="string">&quot;overlay&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Temporary storage location</span></span><br><span class="line">runroot = <span class="string">&quot;/run/containers/storage&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Primary Read/Write location of container storage</span></span><br><span class="line"><span class="comment"># When changing the graphroot location on an SELINUX system, you must</span></span><br><span class="line"><span class="comment"># ensure  the labeling matches the default locations labels with the</span></span><br><span class="line"><span class="comment"># following commands:</span></span><br><span class="line"><span class="comment"># semanage fcontext -a -e /var/lib/containers/storage /NEWSTORAGEPATH</span></span><br><span class="line"><span class="comment"># restorecon -R -v /NEWSTORAGEPATH</span></span><br><span class="line">graphroot = <span class="string">&quot;/var/lib/containers/storage&quot;</span></span><br></pre></td></tr></table></figure>

<p>檢視 cri-o 儲存 image 的目錄</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ crio-status config</span><br><span class="line">[crio]</span><br><span class="line">  root = &quot;/var/lib/containers/storage&quot;</span><br></pre></td></tr></table></figure>


<p>透過 crictl 的命令來看 image 的資訊</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ crictl images</span><br><span class="line">IMAGE                                                      TAG                 IMAGE ID            SIZE</span><br><span class="line">docker.io/rancher/mirrored-flannelcni-flannel-cni-plugin   v1.1.0              fcecffc7ad4af       8.37MB</span><br><span class="line">docker.io/rancher/mirrored-flannelcni-flannel              v0.18.0             744246d629cff       63.3MB</span><br><span class="line">k8s.gcr.io/coredns/coredns                                 v1.8.6              a4ca41631cc7a       47MB</span><br><span class="line">k8s.gcr.io/etcd                                            3.5.3-0             aebe758cef4cd       301MB</span><br><span class="line">k8s.gcr.io/kube-apiserver                                  v1.24.1             e9f4b425f9192       131MB</span><br><span class="line">k8s.gcr.io/kube-controller-manager                         v1.24.1             b4ea7e648530d       121MB</span><br><span class="line">k8s.gcr.io/kube-proxy                                      v1.24.1             beb86f5d8e6cd       112MB</span><br><span class="line">k8s.gcr.io/kube-scheduler                                  v1.24.1             18688a72645c5       52.3MB</span><br><span class="line">k8s.gcr.io/pause                                           3.6                 6270bb605e12e       690kB</span><br><span class="line">k8s.gcr.io/pause                                           3.7                 221177c6082a8       718kB</span><br></pre></td></tr></table></figure>

<p>透過 sudo podman 的命令來看 image 的資訊</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman images</span><br><span class="line">REPOSITORY                                                TAG         IMAGE ID      CREATED       SIZE</span><br><span class="line">docker.io/rancher/mirrored-flannelcni-flannel             v0.18.0     744246d629cf  4 days ago    63.3 MB</span><br><span class="line">k8s.gcr.io/kube-apiserver                                 v1.24.1     e9f4b425f919  6 days ago    131 MB</span><br><span class="line">k8s.gcr.io/kube-controller-manager                        v1.24.1     b4ea7e648530  6 days ago    121 MB</span><br><span class="line">k8s.gcr.io/kube-scheduler                                 v1.24.1     18688a72645c  6 days ago    52.3 MB</span><br><span class="line">k8s.gcr.io/kube-proxy                                     v1.24.1     beb86f5d8e6c  6 days ago    112 MB</span><br><span class="line">docker.io/rancher/mirrored-flannelcni-flannel-cni-plugin  v1.1.0      fcecffc7ad4a  10 days ago   8.37 MB</span><br><span class="line">k8s.gcr.io/etcd                                           3.5.3-0     aebe758cef4c  6 weeks ago   301 MB</span><br><span class="line">k8s.gcr.io/pause                                          3.7         221177c6082a  2 months ago  718 kB</span><br><span class="line">k8s.gcr.io/coredns/coredns                                v1.8.6      a4ca41631cc7  7 months ago  47 MB</span><br><span class="line">k8s.gcr.io/pause                                          3.6         6270bb605e12  9 months ago  690 kB</span><br></pre></td></tr></table></figure>


<p>可以發現 Podman 和 CRI-O 儲存 image 的資訊</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">備份 image </span><br><span class="line">$ sudo podman save docker.io/rancher/mirrored-flannelcni-flannel-cni-plugin:v1.1.0 &gt; flannel-plugin.tar</span><br><span class="line"></span><br><span class="line">備份 image </span><br><span class="line">$ sudo podman save docker.io/rancher/mirrored-flannelcni-flannel:v0.18.1 &gt; flannel.tar</span><br><span class="line"></span><br><span class="line">還原 image</span><br><span class="line">$ sudo podman load &lt; flannel-plugin.tar</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Crun-與-runC-大小比較"><a href="#Crun-與-runC-大小比較" class="headerlink" title="Crun 與 runC 大小比較"></a>Crun 與 runC 大小比較</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ls -lh `which runc`</span><br><span class="line">-rwxr-xr-x 1 root root 9.1M Aug  2 18:39 /usr/bin/runc</span><br><span class="line"></span><br><span class="line">$ ls -lh `which crun`</span><br><span class="line">-rwxr-xr-x 1 root root 383K Apr 28 06:20 /usr/bin/crun</span><br></pre></td></tr></table></figure>

<h2 id="crun-與-runc-效能比較"><a href="#crun-與-runc-效能比較" class="headerlink" title="crun 與 runc 效能比較"></a>crun 與 runc 效能比較</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">## 建立 Container 所需的rootfs</span><br><span class="line">$ mkdir -p ~/wulin/rt/rootfs; cd ~/wulin/rt/rootfs; curl -o alpine.tar.gz http://dl-cdn.alpinelinux.org/alpine/v3.14/releases/x86_64/alpine-minirootfs-3.14.2-x86_64.tar.gz; tar xvf alpine.tar.gz ;rm alpine.tar.gz; cd ..</span><br><span class="line"></span><br><span class="line">## 更改權限</span><br><span class="line">$ sudo chown root:root -R rootfs/</span><br><span class="line"></span><br><span class="line">## 產生 config.json</span><br><span class="line">$ runc spec</span><br></pre></td></tr></table></figure>


<p>實測 run<font color=red>c</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ time for i in &#123;1..100&#125;; do echo &quot;exit&quot; | sudo runc run b1 &amp;&gt;/dev/null; done</span><br></pre></td></tr></table></figure>

<p>output : </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">real    0m3.238s</span><br><span class="line">user    0m1.386s</span><br><span class="line">sys     0m1.392s</span><br></pre></td></tr></table></figure>


<p>實測 <font color=red>c</font>run</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ time for i in &#123;1..100&#125;; do echo &quot;exit&quot; | sudo crun run b1 &amp;&gt;/dev/null; done</span><br></pre></td></tr></table></figure>

<p>output : </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">real    0m1.081s</span><br><span class="line">user    0m0.545s</span><br><span class="line">sys     0m0.418s</span><br></pre></td></tr></table></figure>




<h2 id="設定-CRI-O-執行-crun"><a href="#設定-CRI-O-執行-crun" class="headerlink" title="設定 CRI-O 執行 crun"></a>設定 CRI-O 執行 crun</h2><p>3 台主機： m1 w1 w2 都要設定</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nano /etc/crio/crio.conf</span><br><span class="line">[crio.runtime]</span><br><span class="line"><span class="comment"># Overide defaults to not use systemd cgroups.</span></span><br><span class="line">conmon_cgroup = <span class="string">&quot;pod&quot;</span></span><br><span class="line">cgroup_manager = <span class="string">&quot;cgroupfs&quot;</span></span><br><span class="line">default_runtime = <span class="string">&quot;crun&quot;</span></span><br><span class="line"></span><br><span class="line">[crio.runtime.runtimes.crun]</span><br><span class="line">runtime_path = <span class="string">&quot;/usr/bin/crun&quot;</span></span><br><span class="line">runtime_type = <span class="string">&quot;oci&quot;</span></span><br><span class="line">runtime_root = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">[crio.network]</span><br><span class="line">network_dir = <span class="string">&quot;/etc/cni/net.d/&quot;</span></span><br><span class="line">plugin_dir = <span class="string">&quot;/opt/cni/bin&quot;</span></span><br></pre></td></tr></table></figure>


<ul>
<li><code>default_runtime = &quot;crun&quot;</code>，設定 CRI-O 用 crun 來建 Cotainer</li>
<li><code>[crio.runtime.runtimes.crun]</code>，下面放 crun 的設定項目</li>
<li><code>runtime_path</code>，設定 crun 放在哪</li>
<li><code>runtime_type</code>，crun 用的標準</li>
<li>CRI-O 內定使用 runc 建 Container，但 crun 比較快，所以修改 CRI-O 設定檔來使用 crun，代表最底層 container 的執行從 runc 改成 crun。</li>
<li>為什麼有 crun 可以用？因為有安裝 podman，podman 內定使用 crun 建 Container。</li>
</ul>
<p>都設定好後，要重啟 node</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ssh w1 sudo reboot</span><br><span class="line">$ ssh w2 sudo reboot</span><br><span class="line">$ sudo reboot</span><br></pre></td></tr></table></figure>

<p>好了後，確定 nodes 是否正常運作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kg nodes</span><br></pre></td></tr></table></figure>

<p>再確定主機內的 pods 是否都有 running</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ks</span><br></pre></td></tr></table></figure>

<p>補充 : </p>
<ul>
<li><code>crun</code> ，由安裝 podman 附帶安裝。</li>
</ul>
<h2 id="Kubernetes-檢測"><a href="#Kubernetes-檢測" class="headerlink" title="Kubernetes 檢測"></a>Kubernetes 檢測</h2><p>透過 kubectl 產生一個 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run nginx --image=quay.io/cloudwalker/nginx</span><br></pre></td></tr></table></figure>

<blockquote>
<p>因為只有指定一個 image 所以 只會這個 pod 只會產生一台 container</p>
</blockquote>
<p>檢查 pod 運作資訊</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx   1/1     Running   0          22s</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>READY 1/1</code> ，後面的 1 是 pod 裡有幾台Container，前面的 1 是 pod 的裡面的 Container 是否有 running ，如果有 running 就會顯示 1</p>
</blockquote>
<p>curl pod 的 ip 看網站有沒有順利啟動</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://10.244.1.2</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">...以下省略</span><br></pre></td></tr></table></figure>

<h3 id="檢視-K8s-Cluster-的網路運作"><a href="#檢視-K8s-Cluster-的網路運作" class="headerlink" title="檢視 K8s Cluster 的網路運作"></a>檢視 K8s Cluster 的網路運作</h3><p><img src="https://i.imgur.com/qYLBPUu.png"></p>
<p>當我們建立了一個 pod ，裡面的 Container 起了一個網站，這台 pod  會得到一個 Virtul IP ，這個虛擬 IP 是透過 iptables 做出來的，我們可以在 m1 、 w1 和 w2 都能用 curl 指令連到 pod 所建立的網站。</p>
<hr>
<p>建立和執行我們的 pod </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run a1 -it --image=quay.io/cloudwalker/alpine -- sh</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>-it</code> ， 給一個虛擬終端機<br><code>--</code> ，分割符號，後面是針對 pod 所要下達的命令</p>
</blockquote>
<p>進 pod ， 安裝 curl 指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ apk add curl</span><br></pre></td></tr></table></figure>

<p>連線到剛剛建立 nginx 的那台 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://10.244.1.2</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">...以下省略</span><br></pre></td></tr></table></figure>

<p>更新網路示意圖</p>
<p><img src="https://i.imgur.com/u840Vz0.png"></p>
<p>小總結</p>
<ul>
<li>VM m1、w1、w2 皆使用 NAT 模式，由這三臺 VM 組成 Keubernetes Cluster</li>
<li>pod 是由 Keubernetes 部署的，具備 IP Address（Virtual IP）<ul>
<li>Virtual IP｜沒有設定在網路卡上，是透過 iptables 實作出來的 IP Address</li>
</ul>
</li>
<li>因為上述架構的關係 pod、node 之間能實現網路通訊</li>
</ul>
<p>by 第三組</p>
<p>刪除剛剛建立的兩台 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pods a1</span><br><span class="line">$ kubectl delete pods nginx</span><br></pre></td></tr></table></figure>


<hr>
<h1 id="Kubernetes-CNI-基礎運作"><a href="#Kubernetes-CNI-基礎運作" class="headerlink" title="Kubernetes CNI 基礎運作"></a>Kubernetes CNI 基礎運作</h1><h2 id="Flannel-CNI-單一節點運作架構"><a href="#Flannel-CNI-單一節點運作架構" class="headerlink" title="Flannel CNI 單一節點運作架構"></a>Flannel CNI 單一節點運作架構</h2><p><img src="https://i.imgur.com/p5RRYhy.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">m1:~$ ifconfig</span><br><span class="line">cni0      Link encap:Ethernet  HWaddr 0E:31:89:91:11:C2</span><br><span class="line">          inet addr:10.244.0.1  Bcast:10.244.0.255  Mask:255.255.255.0</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ ssh w1 <span class="string">&#x27;ifconfig&#x27;</span></span><br><span class="line">cni0      Link encap:Ethernet  HWaddr 82:58:F3:07:50:67</span><br><span class="line">          inet addr:10.244.1.1  Bcast:10.244.1.255  Mask:255.255.255.0</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ ssh w2 <span class="string">&#x27;ifconfig&#x27;</span></span><br><span class="line">cni0      Link encap:Ethernet  HWaddr 06:B1:21:B1:1F:8B</span><br><span class="line">          inet addr:10.244.2.1  Bcast:10.244.2.255  Mask:255.255.255.0</span><br><span class="line"></span><br><span class="line">m1:~$ brctl show</span><br><span class="line">bridge name     bridge <span class="built_in">id</span>               STP enabled     interfaces</span><br><span class="line">cni0            8000.0e31899111c2       no              vethbb0b5903</span><br><span class="line">                                                        vethfc422baa</span><br><span class="line">                                            </span><br><span class="line">$ ssh w1 <span class="string">&#x27;brctl show&#x27;</span></span><br><span class="line">bridge name     bridge <span class="built_in">id</span>               STP enabled     interfaces</span><br><span class="line">cni0            8000.8258f3075067       no</span><br><span class="line"></span><br><span class="line">$ ssh w2 <span class="string">&#x27;brctl show&#x27;</span></span><br><span class="line">bridge name     bridge <span class="built_in">id</span>               STP enabled     interfaces</span><br><span class="line">cni0            8000.06b121b11f8b       no              vethfff77f1d</span><br><span class="line"></span><br><span class="line">$ ps aux | grep -v grep | grep flanneld</span><br><span class="line">root       4406  0.1  0.6 1335180 37392 ?       Ssl  14:52   0:09 /opt/bin/flanneld --ip-masq --kube-subnet-mgr</span><br></pre></td></tr></table></figure>


<ul>
<li>因 w1 及 w2 沒有建立過 POD, 所以沒有建立 cni0 橋接器, 一但有建立 POD, cni0 橋接器便會建立</li>
</ul>
<h2 id="插播"><a href="#插播" class="headerlink" title="插播"></a>插播</h2><h3 id="建立-mysql-Contianer"><a href="#建立-mysql-Contianer" class="headerlink" title="建立 mysql Contianer"></a>建立 mysql Contianer</h3><p>準備和進入工作目錄、編輯 Dockerfile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir mydb; cd mydb</span><br><span class="line"></span><br><span class="line">$ nano Dockerfile</span><br></pre></td></tr></table></figure>

<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> quay.io/cloudwalker/mysql-server</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> MYSQL_ROOT_PASSWORD bigred</span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> myuser.sql /docker-entrypoint-initdb.d</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">3306</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>FROM</code>，指定要用哪一片 image 建立新的 image ，這裡指定的是 <code>quay.io/cloudwalker/mysql-server</code></li>
<li><code>ENV</code>，等等在 build image 的時候，宣告 變數 <code>MYSQL_ROOT_PASSWORD</code> 的值等於 <code>bigred</code></li>
<li><code>ADD</code>，image 做出來後，將 myuser.sql 這個檔案複製到 image 的 <code>/docker-entrypoint-initdb.d</code> 目錄<ul>
<li>要 <code>ADD</code> 的檔案，需要和 Dockerfile 放在同一層目錄</li>
</ul>
</li>
<li><code>EXPOSE 3306</code>，在 Container 上開一個對外的 3306 port</li>
</ul>
<p>編輯 <code>muser.sql</code> </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ nano myuser.sql</span><br><span class="line">CREATE USER <span class="string">&#x27;bigred&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;bigred&#x27;</span>;</span><br><span class="line">GRANT ALL PRIVILEGES ON *.* TO <span class="string">&#x27;bigred&#x27;</span>@<span class="string">&#x27;%&#x27;</span> WITH GRANT OPTION;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<p>build image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman build --no-cache -t mydb .</span><br></pre></td></tr></table></figure>

<p>output : </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">STEP 1/4: FROM quay.io/cloudwalker/mysql-server</span><br><span class="line">STEP 2/4: ENV MYSQL_ROOT_PASSWORD bigred</span><br><span class="line">WARN[0000] HEALTHCHECK is not supported for OCI image format and will be ignored. Must use `docker` format</span><br><span class="line">--&gt; c0485a22f11</span><br><span class="line">STEP 3/4: ADD myuser.sql /docker-entrypoint-initdb.d</span><br><span class="line">WARN[0000] HEALTHCHECK is not supported for OCI image format and will be ignored. Must use `docker` format</span><br><span class="line">--&gt; c0a9de19856</span><br><span class="line">STEP 4/4: EXPOSE 3306</span><br><span class="line">COMMIT mydb</span><br><span class="line">WARN[0000] HEALTHCHECK is not supported for OCI image format and will be ignored. Must use `docker` format</span><br><span class="line">--&gt; 11a146f48e4</span><br><span class="line">Successfully tagged localhost/mydb:latest</span><br><span class="line">11a146f48e4c2b108f161d7ea8224ce1317594152399ad592ace997f90a148cc</span><br></pre></td></tr></table></figure>

<ul>
<li>出現 Warning 的原因是因為，image 的格式有分 OCI 和 Docker 。</li>
<li>Docker 的格式有健康檢查，如果由 image 建出來的 Container 不健康，例如 Container 在 running 時，沒有開 3306 port ，他就會提醒。</li>
<li>OCI 的格式沒有健康檢查的服務。</li>
</ul>
<p>檢查 image 有沒有建出來</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman images</span><br><span class="line">REPOSITORY             TAG         IMAGE ID      CREATED        SIZE</span><br><span class="line">localhost/mydb         latest      11a146f48e4c  5 minutes ago  439 MB</span><br></pre></td></tr></table></figure>

<p>run Container</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman run --rm --name bobo -d -p 3306:3306 localhost/mydb</span><br></pre></td></tr></table></figure>

<p>檢查 Container 的狀態</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman ps -a</span><br><span class="line">CONTAINER ID  IMAGE                  COMMAND     CREATED         STATUS            PORTS                   NAMES</span><br><span class="line">13b1733d3975  localhost/mydb:latest  mysqld      10 seconds ago  Up 9 seconds ago  0.0.0.0:3306-&gt;3306/tcp  bobo</span><br></pre></td></tr></table></figure>

<p>登入 mysql</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -ubigred -p -h $IP</span><br><span class="line">Enter password:bigred</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; select user,host from mysql.user;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| user             | host      |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| bigred           | %         |</span><br><span class="line">| healthchecker    | localhost |</span><br><span class="line">| mysql.infoschema | localhost |</span><br><span class="line">| mysql.session    | localhost |</span><br><span class="line">| mysql.sys        | localhost |</span><br><span class="line">| root             | localhost |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">6 rows in set (0.001 sec)</span><br></pre></td></tr></table></figure>


<h3 id="建立-gocgi-Container"><a href="#建立-gocgi-Container" class="headerlink" title="建立 gocgi Container"></a>建立 gocgi Container</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://www.oc99.org/zip/gocgi.zip</span><br><span class="line"></span><br><span class="line">$ unzip gocgi.zip</span><br><span class="line"></span><br><span class="line">$ tree gocgi</span><br><span class="line">gocgi</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── go.mod</span><br><span class="line">├── gocgi</span><br><span class="line">├── main</span><br><span class="line">├── main.go</span><br><span class="line">└── www</span><br><span class="line">    ├── cgi</span><br><span class="line">    │   ├── cgidb.sh</span><br><span class="line">    │   ├── cgitbl.sh</span><br><span class="line">    │   ├── hs2.sh</span><br><span class="line">    │   └── mysql.sh</span><br><span class="line">    ├── css</span><br><span class="line">    │   └── styles.css</span><br><span class="line">    ├── html</span><br><span class="line">    │   ├── db.html</span><br><span class="line">    │   ├── hs2.html</span><br><span class="line">    │   ├── index.html</span><br><span class="line">    │   ├── mysql.html</span><br><span class="line">    │   └── tbl.html</span><br><span class="line">    ├── img</span><br><span class="line">    │   └── 2085263.png</span><br><span class="line">    ├── index.html</span><br><span class="line">    └── js</span><br><span class="line"></span><br><span class="line">6 directories, 17 files</span><br></pre></td></tr></table></figure>

<p>檢視 main.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;net/http&quot;</span></span><br><span class="line">  <span class="string">&quot;net/http/cgi&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cgiMySQL</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">handler := cgi.Handler&#123;Path: <span class="string">&quot;./www/cgi/mysql.sh&quot;</span>&#125;</span><br><span class="line">handler.ServeHTTP(w, r)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cgiHS2</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">handler := cgi.Handler&#123;Path: <span class="string">&quot;./www/cgi/hs2.sh&quot;</span>&#125;</span><br><span class="line">handler.ServeHTTP(w, r)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  static := http.FileServer(http.Dir(<span class="string">&quot;./www/&quot;</span>))</span><br><span class="line">  http.Handle(<span class="string">&quot;/&quot;</span>,static)</span><br><span class="line"></span><br><span class="line">  http.HandleFunc(<span class="string">&quot;/mysql&quot;</span>, cgiMySQL)</span><br><span class="line">  http.HandleFunc(<span class="string">&quot;/hs2&quot;</span>, cgiHS2)</span><br><span class="line"></span><br><span class="line">  http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>檢視 Dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> quay.io/cloudwalker/alpine</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk update &amp;&amp; apk upgrade &amp;&amp; <span class="built_in">mkdir</span> /www</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> gocgi /</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> www /www/</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/gocgi&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>FROM quay.io/cloudwalker/alpine</code>，指定 <code>quay.io/cloudwalker/alpine</code> 這片 image 建立新的 image</li>
<li><code>RUN</code>，在建立 image 時，執行 <code>apk update &amp;&amp; apk upgrade &amp;&amp; mkdir /www</code>，系統更新和在 image 的根目錄下建立 www 目錄</li>
<li><code>ADD gocgi /</code>，將 gocgi 這支程式拷貝到 image 的根目錄</li>
<li><code>ADD www /www/</code>，將 <code>www</code> 目錄下的所有子目錄和檔案拷貝到 image 的 <code>/www</code> 目錄下</li>
<li><code>CMD [&quot;/gocgi&quot;]</code>，等等 run Container 時，內定執行的命令是 gocgi 這支程式</li>
</ul>
<p>build image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman build -t localhost/gocgi .</span><br></pre></td></tr></table></figure>

<p>檢查 image 有無 build 成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman images</span><br><span class="line">REPOSITORY          TAG         IMAGE ID      CREATED            SIZE</span><br><span class="line">localhost/gocgi     latest      99424c6c5514  31 seconds ago     20.1 MB</span><br></pre></td></tr></table></figure>

<p>用 <code>localhost/gocgi</code> 這片 image 建 Container</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman run  --name mybobo -d -p 80:8080 localhost/mycgi</span><br></pre></td></tr></table></figure>

<p>檢查 Container 的狀態</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman ps -a</span><br><span class="line">CONTAINER ID  IMAGE                   COMMAND     CREATED            STATUS                PORTS                   NAMES</span><br><span class="line">13b1733d3975  localhost/mydb:latest   mysqld      About an hour ago  Up About an hour ago  0.0.0.0:3306-&gt;3306/tcp  bobo</span><br><span class="line">c6194081d78b  localhost/gocgi:latest  /gocgi      4 seconds ago      Up 4 seconds ago      0.0.0.0:80-&gt;8080/tcp    mybobo</span><br></pre></td></tr></table></figure>


<p>檢測服務</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://192.168.179.4</span><br><span class="line">&lt;h1&gt;HaHa&lt;/h1&gt;</span><br></pre></td></tr></table></figure>




<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes-Objects.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes-Objects.html" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-08-28 06:51:02" itemprop="dateCreated datePublished" datetime="2022-08-28T06:51:02+08:00">2022-08-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 16:15:42" itemprop="dateModified" datetime="2023-05-07T16:15:42+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-Objects"><a href="#Kubernetes-Objects" class="headerlink" title="Kubernetes-Objects"></a>Kubernetes-Objects</h1><p>:::warning</p>
<p>:::spoiler 目錄</p>
<p>[TOC]</p>
<hr>
<p>:::</p>
<h2 id="認識-K8S-叢集物件"><a href="#認識-K8S-叢集物件" class="headerlink" title="認識 K8S 叢集物件"></a>認識 K8S 叢集物件</h2><p><img src="https://i.imgur.com/vVVHNS6.png"></p>
<ul>
<li><code>CustomResourceDefinitions</code> ，自定義 K8s 的物件</li>
</ul>
<h2 id="K8S-Object-Short-names"><a href="#K8S-Object-Short-names" class="headerlink" title="K8S Object Short-names"></a>K8S Object Short-names</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Short name       Full name</span><br><span class="line">csr      	  certificatesigningrequests</span><br><span class="line">cm	          configmaps</span><br><span class="line">ds	          daemonsets</span><br><span class="line">deploy	          deployments</span><br><span class="line">ep	          endpoints</span><br><span class="line">ev	          events</span><br><span class="line">hpa      	  horizontalpodautoscalers</span><br><span class="line">ing	          ingresses</span><br><span class="line">ns	          namespaces</span><br><span class="line">pvc	          persistentvolumeclaims</span><br><span class="line">svc	          services</span><br><span class="line">pv	          persistentvolumes</span><br><span class="line">po	          pods</span><br><span class="line">pdb	          poddisruptionbudgets</span><br><span class="line">psp	          podsecuritypolicies</span><br><span class="line">rs	          replicasets</span><br><span class="line">rc	          replicationcontrollers</span><br><span class="line">quota	          resourcequotas</span><br><span class="line">sa	          serviceaccounts</span><br></pre></td></tr></table></figure>

<h1 id="建立-Kubernetes-POD"><a href="#建立-Kubernetes-POD" class="headerlink" title="建立 Kubernetes POD"></a>建立 Kubernetes POD</h1><p>:::spoiler Node &amp; POD 示意圖</p>
<p><img src="https://i.imgur.com/ji3dIzS.png"></p>
<p>:::</p>
<ul>
<li>volime 儲存體 ，供 pod 使用</li>
<li>一個 pod 可以跑很多台 Container ，代表可以 run 很多 企業要用的 Application</li>
</ul>
<h2 id="認識-Kubernetes-Pod"><a href="#認識-Kubernetes-Pod" class="headerlink" title="認識 Kubernetes Pod"></a>認識 Kubernetes Pod</h2><ul>
<li><font color=red><strong>Pods are not intended to live long.</strong></font><ul>
<li>pod 很容易領便當</li>
<li>K8s 內定，node 主機重開，裡面的 pod 會浴火重生</li>
</ul>
</li>
<li>This group of containers would share storage, Linux namespaces, cgroups, IP addresses.<ul>
<li>pod 中的 Container 會共享 volume , Linux Namespaces, cgroups, IP 位址</li>
</ul>
</li>
</ul>
<h2 id="Single-Container-Pod-建立與連接"><a href="#Single-Container-Pod-建立與連接" class="headerlink" title="Single Container Pod 建立與連接"></a>Single Container Pod 建立與連接</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 Windows 系統的 cmd 視窗, 執行以下命令</span></span><br><span class="line">$ ssh bigred@&lt;alp.m1 IP&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 從 1.18 這個版本開始, 下面命令只會產生 pod, </span></span><br><span class="line"><span class="comment"># 不再會產生 deployment object 及 replicaset controller.</span></span><br><span class="line"><span class="comment"># --image= ，等號右邊的格式為 image 網站/帳號/image 名稱</span></span><br><span class="line">$ kubectl run a1 --image-pull-policy IfNotPresent --image=quay.io/cloudwalker/alpine.derby</span><br><span class="line">pod/a1 created</span><br><span class="line"></span><br><span class="line"><span class="comment"># STATUS 的 ContainerCreating，</span></span><br><span class="line"><span class="comment"># 代表 Container 正在被 CRI-O 透過 pull 命令到網路上下載 Container 需要的 image</span></span><br><span class="line">$ kg pods -o wide</span><br><span class="line">NAME   READY   STATUS              RESTARTS   AGE   IP       NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">a1     0/1     ContainerCreating   0          64s   &lt;none&gt;   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把 pod 的 IP 位址丟到一個變數</span></span><br><span class="line">$ podip=$(kg pods -o wide | grep -e <span class="string">&quot;^a1 &quot;</span> | <span class="built_in">tr</span> -s <span class="string">&#x27; &#x27;</span> | <span class="built_in">cut</span> -d <span class="string">&#x27; &#x27;</span> -f6)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 檢查是否符合預期</span></span><br><span class="line">$ curl http://<span class="variable">$podip</span>:8888</span><br><span class="line">&lt;h1&gt;Welcome to Spring Boot&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">$ curl http://<span class="variable">$podip</span>:8888/hostname</span><br><span class="line">Hostname : a1</span><br></pre></td></tr></table></figure>


<p>進入a1 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -it a1 -- bash</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>--</code>分隔符號，後面放的是 pod 要執行的程式<br>連線的動作會經過加密，安全等級不輸 SSH</p>
</blockquote>
<p>檢查有無啟動pid 的 namespace</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># ps aux</span><br><span class="line">USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root          1  0.0  0.0   2180  1672 ?        Ss   06:29   0:00 bash -c /derby/app/startup</span><br><span class="line">root          2  1.5  2.5 3496804 207136 ?      Sl   06:29   0:11 java -jar -Dderby.system.home=/derby/db /derby/app/dt-0.0.1-SNAPSHOT.war</span><br><span class="line">root         44  0.0  0.0   2312  1696 pts/0    Ss   06:40   0:00 bash</span><br><span class="line">root         45  0.0  0.0   1624   520 pts/0    R+   06:41   0:00 ps aux</span><br></pre></td></tr></table></figure>
<p>有！</p>
<p>在 pod a1 裡搞破壞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rm -r /bin/*</span><br><span class="line">bash-4.4# ls -al /bin/</span><br><span class="line">bash: ls: command not found</span><br><span class="line">bash-4.4# exit</span><br><span class="line">exit</span><br><span class="line">command terminated with exit code 127</span><br><span class="line"></span><br><span class="line">bigred@m1:~$ kubectl exec -it a1 -- bash</span><br><span class="line">2022-05-31T06:44:14.000679204Z: 2022-05-31T06:44:14.000679086Z: executable file `bash` not found in $PATH: No such file or directory</span><br></pre></td></tr></table></figure>

<p>檢查 node 本機的 &#x2F;bin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bigred@m1:~$ ls -al /bin/</span><br></pre></td></tr></table></figure>

<p>可以發現沒被破壞</p>
<p>刪除pod a1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod a1</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="Single-Container-Pod-自動重新建立"><a href="#Single-Container-Pod-自動重新建立" class="headerlink" title="Single Container Pod 自動重新建立"></a>Single Container Pod 自動重新建立</h2><p>重新建立並執行 a1 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run a1 --image=quay.io/cloudwalker/alpine -- sleep 15</span><br></pre></td></tr></table></figure>

<p>當 pod 的狀態呈現 Compelted 時， K8s 會將 pod 浴火重生，讓 pod 再次 runnning</p>
<p>:::success<br>監控 pod a1 的狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods a1 --watch</span><br></pre></td></tr></table></figure>

<p>:::spoiler 結果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME   READY   STATUS             RESTARTS      AGE</span><br><span class="line">a1     0/1     CrashLoopBackOff   4 (31s ago)   3m24s</span><br><span class="line">a1     1/1     Running            5 (86s ago)   4m19s</span><br><span class="line">a1     0/1     Completed          5 (101s ago)   4m34s</span><br><span class="line">a1     0/1     CrashLoopBackOff   5 (16s ago)    4m49s</span><br><span class="line">...以下省略</span><br></pre></td></tr></table></figure>
<p><font color=red>當STATUS 出現<code>CrashLoopBackOff</code> ，代表 pod 正在不斷被重啟。<br>    重啟 6 次後, 會將重啟時間拉長, 繼續重啟</font><br>:::</p>
<p>刪除 pod a1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod  a1</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="K8S-Node-系統重新啟動"><a href="#K8S-Node-系統重新啟動" class="headerlink" title="K8S Node 系統重新啟動"></a>K8S Node 系統重新啟動</h2><p>:::success</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 建立並執行 pod a1</span></span><br><span class="line">$ kubectl run a1 --image=quay.io/ict39/alpine.derby </span><br><span class="line">pod/a1 created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 pod a1 的 ip 位址和所在主機</span></span><br><span class="line">$ kubectl get pod a1 -o wide | grep a1</span><br><span class="line">a1     1/1     Running   0          36s   10.244.2.10   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 將 pod a1 所在主機重新開機</span></span><br><span class="line">$ ssh w2 sudo reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># 檢查 pod a1 的狀態</span></span><br><span class="line">$ kubectl get pod a1 -o wide | grep a1</span><br><span class="line">a1     0/1     ContainerCreating   1          2m23s   &lt;none&gt;   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次檢查 pod a1 的狀態</span></span><br><span class="line">$ kubectl get pod a1 -o wide | grep a1</span><br><span class="line">a1     1/1     Running   1          2m35s   10.244.2.11   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刪除 pod a1</span></span><br><span class="line">$ kubectl delete pod  a1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><font color=red><strong>結論： pod a1 的 IP 位址會改變, 這是因爲 node 重啟時會產生一個新 Pod</strong></font><br>:::</p>
<hr>
<h2 id="Single-Container-Pod-永不重啟"><a href="#Single-Container-Pod-永不重啟" class="headerlink" title="Single Container Pod 永不重啟"></a>Single Container Pod 永不重啟</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run a1 --restart=<span class="string">&#x27;Never&#x27;</span>  --image=quay.io/cloudwalker/alpine -- <span class="built_in">sleep</span> 15</span><br><span class="line">pod/a1 created</span><br><span class="line"></span><br><span class="line">$ kubectl get pods </span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE</span><br><span class="line">a1        1/1        Running   0                 10s</span><br><span class="line"></span><br><span class="line">$ kubectl get pods </span><br><span class="line">NAME   READY   STATUS       RESTARTS   AGE</span><br><span class="line">a1        0/1       Completed   0                32s</span><br><span class="line"></span><br><span class="line">$ kubectl delete pod a1</span><br><span class="line">pod <span class="string">&quot;a1&quot;</span> deleted</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<hr>
<h2 id="建立-Share-PID-Namespace-Pod"><a href="#建立-Share-PID-Namespace-Pod" class="headerlink" title="建立 Share PID Namespace Pod"></a>建立 Share PID Namespace Pod</h2><p>先建立 wulin 工作目錄</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p ~/wulin/yaml; cd ~/wulin</span><br></pre></td></tr></table></figure>

<p>:::success<br>宣告 yaml&#x2F;yml 檔<br><font color=red><strong>超級注意！縮編格式一定要對！不然絕對噴 Error 給你看!</strong></font></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: sharepid</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  shareProcessNamespace: true</span></span><br><span class="line"><span class="string">  hostname: xyz </span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: derby</span></span><br><span class="line"><span class="string">    image: quay.io/cloudwalker/alpine.derby</span></span><br><span class="line"><span class="string">    imagePullPolicy: Always</span></span><br><span class="line"><span class="string">  - name: shell</span></span><br><span class="line"><span class="string">    image: quay.io/cloudwalker/alpine</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    tty: true  &#x27;</span> &gt; yaml/sharepid.yml</span><br></pre></td></tr></table></figure>
<ul>
<li><code>kind</code> ， 宣告要產生什麼</li>
<li><code>metadata</code> ，會宣告 pod 的名稱</li>
<li><code>spec</code> ， pod 的結構說明<ul>
<li>有兩個 image 代表有兩台 Container ， 名字分別是：derby 和 shell ，他們共用 hostname: xyz</li>
<li><code>shareProcessNamespace: true</code> ，兩台 Container 用同一個 pid 的 Namespace</li>
<li><code>tty: true</code> ，給一個虛擬終端機，因為 <code>quay.io/cloudwalker/alpine</code> 這個 image 內定執行的命令是 sh ，所以一定要有一台虛擬終端機</li>
<li><code>imagePullPolicy: Always</code> ，代表每次都要下載 image</li>
<li><code>imagePullPolicy: IfNotPresent</code> ， 代表沒有 image 再下載</li>
<li><font color=red>如果企業無法上網，就要宣告<code>imagePullPolicy: Never</code></font></li>
</ul>
</li>
<li>最後要輸出的檔名可以<code>*.yaml</code> 或是 <code>*.yml</code> 都可以。<br>:::</li>
</ul>
<p>k8s 標準的運作，透過 yaml 檔作業</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f yaml/sharepid.yml </span><br></pre></td></tr></table></figure>



<hr>
<h2 id="檢視-Pod-內部資訊"><a href="#檢視-Pod-內部資訊" class="headerlink" title="檢視 Pod 內部資訊"></a>檢視 Pod 內部資訊</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod/sharepid -o jsonpath=&#x27;&#123;.spec.containers[*].name&#125;&#x27;;echo &quot;&quot;</span><br><span class="line">derby shell</span><br></pre></td></tr></table></figure>


<p>相同電腦名稱</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec sharepid  -c shell -- hostname; kubectl exec sharepid  -c derby -- hostname</span><br><span class="line">xyz</span><br><span class="line">xyz</span><br></pre></td></tr></table></figure>
<blockquote>
<p>-c 指定Container</p>
</blockquote>
<p>共用 IP 位址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec sharepid  -c shell -- hostname -i; kubectl exec sharepid  -c derby -- hostname -i</span><br><span class="line">10.244.1.4</span><br><span class="line">10.244.1.4</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="檢測-Pod-內部-Process"><a href="#檢測-Pod-內部-Process" class="headerlink" title="檢測 Pod 內部 Process"></a>檢測 Pod 內部 Process</h2><p>登入 sharepid 中的 shell container</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -it sharepid  -c shell -- sh</span><br><span class="line">/ # whoami</span><br><span class="line">root</span><br><span class="line">/ # apk add curl</span><br><span class="line">.......</span><br><span class="line">/ # curl http://localhost:8888/hostname</span><br><span class="line">Hostname : xyz</span><br></pre></td></tr></table></figure>
<blockquote>
<p>當我們透過localhost來連接不同的 Container 時，會更有效率，速度接近記憶體的速度。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/ # ps aux</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 /pause</span><br><span class="line">    6 root      0:00 bash -c /derby/app/startup</span><br><span class="line">   11 root      0:18 java -jar -Dderby.system.home=/derby/db /derby/app/dt-0.0.1-SNAPSHOT.war</span><br><span class="line">   53 root      0:00 /bin/sh</span><br><span class="line">   ...........</span><br><span class="line"></span><br><span class="line">/ # kill -9 1          無法 強制關閉 PID 1</span><br><span class="line">/ # kill -15 1        可以 正常關閉 PID 1</span><br><span class="line">/ # command terminated with exit code 137</span><br></pre></td></tr></table></figure>

<blockquote>
<p>K8s 中所有的 pod 一啟動一定會產生 &#x2F;pause 這台 Container ，裡面跑的程式是 sleep （睡一輩子）站在資安的角度：全球最安全的命令，老師翻成中文：睡夢羅漢</p>
</blockquote>
<h2 id="更多-POD-設定"><a href="#更多-POD-設定" class="headerlink" title="更多 POD 設定"></a>更多 POD 設定</h2><p>:::success</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: twoc</span></span><br><span class="line"><span class="string">  annotations:</span></span><br><span class="line"><span class="string">    kubectl.kubernetes.io/default-container: &quot;shell&quot;</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  shareProcessNamespace: false</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: derby</span></span><br><span class="line"><span class="string">    image: quay.io/cloudwalker/alpine.derby</span></span><br><span class="line"><span class="string">    imagePullPolicy: Never</span></span><br><span class="line"><span class="string">  - name: shell</span></span><br><span class="line"><span class="string">    image: quay.io/cloudwalker/busybox</span></span><br><span class="line"><span class="string">    command:</span></span><br><span class="line"><span class="string">      - sleep</span></span><br><span class="line"><span class="string">      - &quot;60&quot;</span></span><br><span class="line"><span class="string">  restartPolicy: Never&#x27;</span>&gt; yaml/twoc.yml</span><br></pre></td></tr></table></figure>
<ul>
<li>shareProcessNamespace: false ，如果不宣告，內定是 false。</li>
<li>restartPolicy: Never ，設定 pod 永不重啟。<br>:::</li>
</ul>
<p>建立 pod </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f yaml/twoc.yml</span><br><span class="line">pod/twoc created</span><br></pre></td></tr></table></figure>

<p>檢查</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kg pods -o wide</span><br><span class="line">NAME       READY   STATUS              RESTARTS       AGE   IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">sharepid   2/2     Running             2 (6m4s ago)   32m   10.244.1.5   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">twoc       1/2     ErrImageNeverPull   0              59s   10.244.2.6   w2     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>發現 w2 的 node 沒有 derby Container 的 image</p>
<p>修改yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ nano yaml/twoc.yml</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="DNS-for-Service"><a href="#DNS-for-Service" class="headerlink" title="DNS for Service"></a>DNS for Service</h1><p>取得 K8S 叢集的 DNS IP 位址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -n kube-system get svc</span><br><span class="line">NAME       TYPE        CLUSTER-IP  EXTERNAL-IP   PORT(S)                          AGE</span><br><span class="line">kube-dns   ClusterIP  10.98.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP  24h</span><br><span class="line"></span><br><span class="line">$ kubectl describe service kube-dns -n kube-system</span><br><span class="line">.........</span><br><span class="line">IP:                10.98.0.10</span><br><span class="line">IPs:               10.98.0.10</span><br><span class="line">Port:              dns  53/UDP</span><br><span class="line">TargetPort:        53/UDP</span><br><span class="line">Endpoints:         10.244.0.6:53,10.244.0.7:53</span><br><span class="line">Port:              dns-tcp  53/TCP</span><br><span class="line">TargetPort:        53/TCP</span><br><span class="line">Endpoints:         10.244.0.6:53,10.244.0.7:53</span><br><span class="line">Port:              metrics  9153/TCP</span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line">$ kubectl get pods -n kube-system -o wide | grep coredns</span><br><span class="line">coredns-78fcd69978-5v6cd     1/1     Running   2          5d3h   10.244.0.6      m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-78fcd69978-j4z9r     1/1     Running   2          5d3h   10.244.0.7      m1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kube-dns</code> ，它的 IP 位址會固定在 <code>&lt;network_id&gt;.10</code> ，只有 network_id 可以自己設，預設尾數是 10 ，開的 port : 53</li>
<li>透過 <code>kubectl describe</code> 看 <code>kube-dns</code> 詳細的資訊，可以看到 <code>Endpoints:</code> 有兩個 IP 位址，代表後面有兩個 pod 在運作</li>
<li>因 pod 浴火重生 IP 位址可能會發生變化，只有 K8S 的服務會鎖在一個 IP 位址，透過 <code>Selector</code> 來抓到對應的 pod<ul>
<li>服務不會浴火重生，它只是一個儲存在 etcd 裡面的資料區塊，記錄著自己的 IP 位址，及自己真正在運作的 pod 是誰，還有紀錄整個 K8S pod 的 IP 位址及它們的 domain name</li>
</ul>
</li>
</ul>
<p><img src="https://i.imgur.com/ud14Cy4.png"></p>
<ul>
<li>當 K8S 內部的 pod 要上網時， <code>kube-dns</code> 會提供 <strong>名稱解析的服務</strong>，讓我們的 pod 得到要上網的 IP 位址。</li>
<li>當我們建立一個 mysrv 的 service ，這時候他會去和 <code>kube-dns</code> 註冊自己的網址和對應的 IP 位址 ( A record )</li>
</ul>
<p><img src="https://i.imgur.com/PK4jp46.png"></p>
<ul>
<li>無頭服務 ( <code>headless</code> ) 的特性 : service 本身不會有 IP 位址，他一樣會去跟 <code>kube-dns</code> 註冊，不過註冊的資訊會有 pod 的名字及 pod 的 IP 位址 (以上是老師的小秘笈)<ul>
<li>標準的作法是 ，他一樣會去跟 <code>kube-dns</code> 註冊，註冊的資訊是自己 service 本身的名字及對應 pod 的 IP 位址</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run d1 -it --image=quay.io/cloudwalker/alpine</span><br><span class="line">If you dont see a command prompt, try pressing enter.</span><br><span class="line">/ # cat /etc/resolv.conf</span><br><span class="line">search default.svc.k8s.io svc.k8s.io k8s.io localdomain</span><br><span class="line">nameserver 10.98.0.10</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line">/ # ping www.hinet.net</span><br><span class="line">PING www.hinet.net (203.66.32.110): 56 data bytes</span><br><span class="line"></span><br><span class="line">/ # exit</span><br></pre></td></tr></table></figure>

<p><strong>DNS for Service</strong></p>
<p>編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano yaml/service-dns.yaml</span><br></pre></td></tr></table></figure>


<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">k8s-nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">k8s-nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">k8s-nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-cluster</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">k8s-nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-headless</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">k8s-nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>

<p><strong>透過 <code>kubectl create</code> 產生 yaml 檔中的物件(包含 : deployment, svc-cluster, svc-headless)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f yaml/service-dns.yaml</span><br></pre></td></tr></table></figure>

<p>檢查</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kg all</span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/k8s-nginx-56975f8f86-f49nr   1/1     Running   0          4m40s</span><br><span class="line">pod/k8s-nginx-56975f8f86-hf4zh   1/1     Running   0          4m40s</span><br><span class="line">pod/k8s-nginx-56975f8f86-qk727   1/1     Running   0          4m40s</span><br><span class="line"></span><br><span class="line">NAME                   TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/kubernetes     ClusterIP   10.98.0.1     &lt;none&gt;        443/TCP   17d</span><br><span class="line">service/svc-cluster    ClusterIP   10.98.0.179   &lt;none&gt;        80/TCP    4m40s</span><br><span class="line">service/svc-headless   ClusterIP   None          &lt;none&gt;        80/TCP    4m40s</span><br><span class="line"></span><br><span class="line">NAME                        READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/k8s-nginx   3/3     3            3           4m40s</span><br><span class="line"></span><br><span class="line">NAME                                   DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/k8s-nginx-56975f8f86   3         3         3       4m40s</span><br></pre></td></tr></table></figure>

<p>檢視 Service endpoints，當前的服務用的是相同的 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get endpoints svc-cluster</span><br><span class="line">NAME          ENDPOINTS                                      AGE</span><br><span class="line">svc-cluster   10.244.1.35:80,10.244.2.35:80,10.244.2.36:80   8m25s</span><br><span class="line"></span><br><span class="line">$ kubectl get endpoints svc-headless</span><br><span class="line">NAME           ENDPOINTS                                      AGE</span><br><span class="line">svc-headless   10.244.1.35:80,10.244.2.35:80,10.244.2.36:80   8m31s</span><br></pre></td></tr></table></figure>

<p><strong>查詢 Service IP</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ nslookup</span><br><span class="line">&gt; server 10.98.0.10</span><br><span class="line">Default server: 10.98.0.10</span><br><span class="line">Address: 10.98.0.10#53</span><br><span class="line">&gt; svc-headless.default.svc.k8s.org</span><br><span class="line">Server:         10.98.0.10</span><br><span class="line">Address:        10.98.0.10#53</span><br><span class="line"></span><br><span class="line">Name:   svc-headless.default.svc.k8s.org</span><br><span class="line">Address: 10.244.1.35</span><br><span class="line">Name:   svc-headless.default.svc.k8s.org</span><br><span class="line">Address: 10.244.2.35</span><br><span class="line">Name:   svc-headless.default.svc.k8s.org</span><br><span class="line">Address: 10.244.2.36</span><br><span class="line"></span><br><span class="line">&gt; svc-cluster.default.svc.k8s.org</span><br><span class="line">Server:		10.96.0.10</span><br><span class="line">Address:	10.96.0.10#53</span><br><span class="line"></span><br><span class="line">Name:   svc-cluster.default.svc.k8s.org</span><br><span class="line">Address: 10.98.0.3</span><br><span class="line">&gt; exit</span><br></pre></td></tr></table></figure>

<ul>
<li>透過 <code>nslookup</code> ，設定 <code>DNS server</code> 是 <code>10.98.0.10</code> (Kube-dns) 後，來檢視我們建立的服務 dns 資訊</li>
<li><code>svc-headless.default.svc.k8s.org</code> <ul>
<li>名字的組成 : <code>服務名稱.服務所在的namespace.svc.k8s.org</code></li>
<li><code>svc</code> ，代表是 service 的紀錄</li>
<li><code>k8s.org</code> ，是我們在 init K8S 的時候設定的</li>
</ul>
</li>
<li><code>A record</code>，由一個 <code>Name</code> + 一個 <code>IP Address</code> 組成</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; kube-dns.kube-system.svc.k8s.org</span><br><span class="line">Server:         10.98.0.10</span><br><span class="line">Address:        10.98.0.10#53</span><br><span class="line"></span><br><span class="line">Name:   kube-dns.kube-system.svc.k8s.org</span><br><span class="line">Address: 10.98.0.10</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run d1 --rm -it --image=quay.io/cloudwalker/alpine</span><br><span class="line">/ # ping svc-cluster</span><br><span class="line">PING svc-cluster (10.98.0.174): 56 data bytes</span><br><span class="line">ping: permission denied (are you root?)</span><br><span class="line"></span><br><span class="line">/ # ping svc-headless</span><br><span class="line">PING svc-headless (10.244.1.6): 56 data bytes</span><br><span class="line">ping: permission denied (are you root?)</span><br><span class="line"></span><br><span class="line">/ # ping svc-headless</span><br><span class="line">PING svc-headless (10.244.2.10): 56 data bytes</span><br><span class="line">ping: permission denied (are you root?)</span><br><span class="line"></span><br><span class="line">/ # ping svc-headless</span><br><span class="line">PING svc-headless (10.244.1.6): 56 data bytes</span><br><span class="line">ping: permission denied (are you root?)</span><br><span class="line">/ # exit</span><br></pre></td></tr></table></figure>

<ul>
<li>為何只打 <code>ping svc-cluster</code> 名稱就能解析出 IP 位址 ?</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run d1 --rm -it --image=quay.io/cloudwalker/alpine</span><br><span class="line">If you don&#x27;t see a command prompt, try pressing enter.</span><br><span class="line">/ # cat /etc/resolv.conf</span><br><span class="line">search default.svc.k8s.org svc.k8s.org k8s.org mcu.edu.tw</span><br><span class="line">nameserver 10.98.0.10</span><br><span class="line">options ndots:5</span><br></pre></td></tr></table></figure>

<ul>
<li>因為 <code>search default.svc.k8s.org svc.k8s.org k8s.org mcu.edu.tw</code> <ul>
<li>這行表示我們在 <code>ping svc-cluster</code> 時，會自動幫我們在名稱後面加上 search 後面的字串做收尋，如 : <code>ping svc-cluster.default.svc.k8s.org</code> 找不到時，會在換後面的字串 <code>ping svc-cluster.svc.k8s.org</code> 做收尋，依此類推，一直到最後一個字串，如果都沒有就表示無法解析</li>
</ul>
</li>
</ul>
<p><strong>建立 POD 之間的 DNS 名稱解析</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ nano ~/wulin/yaml/svcfqdn.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: dt</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    name: busybox</span><br><span class="line">  clusterIP: None</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f  ~/wulin/yaml/svcfqdn.yaml </span><br><span class="line">service/dt created</span><br><span class="line"></span><br><span class="line">$ kubectl get svc dt</span><br><span class="line">NAME   TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">dt        ClusterIP   None           &lt;none&gt;          &lt;none&gt;    23s</span><br></pre></td></tr></table></figure>

<p><strong>新增 Pod 的搜尋網域名</strong></p>
<p>透過 <code>nano ~/wulin/yaml/podfqdn.yaml</code> 來編輯 yaml 檔</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">b1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">b1</span></span><br><span class="line">  <span class="attr">subdomain:</span> <span class="string">dt</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/alpine</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">add:</span> [<span class="string">&quot;CAP_NET_RAW&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">b2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">b2</span></span><br><span class="line">  <span class="attr">subdomain:</span> <span class="string">dt</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/alpine</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">add:</span> [<span class="string">&quot;CAP_NET_RAW&quot;</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li><pre><code>spec:
hostname: b1
subdomain: dt
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    - subdomain ，可以讓我們在 ping 的時候，在 pod 的名字後面 + `dt` ，就能被解析</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">```bash!</span><br><span class="line">$ kubectl apply -f ~/wulin/yaml/podfqdn.yaml </span><br><span class="line"></span><br><span class="line">$ kubectl exec -it b2 -- sh</span><br><span class="line">/ # ping -c 1 b1.dt.default.svc.k8s.org</span><br><span class="line">PING b1.dt.default.svc.k8s.org (10.244.2.8): 56 data bytes</span><br><span class="line">.........</span><br><span class="line"></span><br><span class="line"># 可解析簡易名稱</span><br><span class="line">/ # ping -c 1 b1.dt</span><br><span class="line">PING b1.dt (10.244.2.8): 56 data bytes</span><br><span class="line">.........</span><br><span class="line"></span><br><span class="line">/ # apk add nano; nano /etc/resolv.conf</span><br><span class="line">search  dt.default.svc.k8s.org default.svc.k8s.org svc.k8s.org localdomain</span><br><span class="line">nameserver 10.98.0.10</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line">/ # ping -c 1 b1</span><br><span class="line">PING b1 (10.244.2.8): 56 data bytes</span><br><span class="line">.........</span><br><span class="line">/ # exit</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<h3 id="新增-Pod-的搜尋網域名"><a href="#新增-Pod-的搜尋網域名" class="headerlink" title="新增 Pod 的搜尋網域名"></a>新增 Pod 的搜尋網域名</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete -f ~/wulin/yaml/podfqdn.yaml</span><br><span class="line"></span><br><span class="line">$ nano ~/wulin/yaml/podfqdn.yaml</span><br><span class="line">..............</span><br><span class="line">spec:</span><br><span class="line">  hostname: b2</span><br><span class="line">  subdomain: dt</span><br><span class="line">  containers:</span><br><span class="line">  - image: quay.io/cloudwalker/alpine</span><br><span class="line">    imagePullPolicy: Always</span><br><span class="line">    command:</span><br><span class="line">      - sleep</span><br><span class="line">      - &quot;3600&quot;</span><br><span class="line">    name: busybox</span><br><span class="line">    securityContext:</span><br><span class="line">      capabilities:</span><br><span class="line">        add: [&quot;CAP_NET_RAW&quot;]</span><br><span class="line">  dnsConfig:</span><br><span class="line">    searches:</span><br><span class="line">    - dt.default.svc.k8s.org</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f ~/wulin/yaml/podfqdn.yaml </span><br><span class="line"></span><br><span class="line">$ kubectl exec -it b2 -- sh</span><br><span class="line">/ # cat /etc/resolv.conf</span><br><span class="line">search default.svc.k8s.org svc.k8s.org k8s.org localdomain dt.default.svc.k8s.org</span><br><span class="line">nameserver 10.98.0.10</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line">/ # ping -c 1 b1</span><br><span class="line">PING b1 (10.244.2.3): 56 data bytes</span><br><span class="line">64 bytes from 10.244.2.3: seq=0 ttl=62 time=0.590 ms</span><br><span class="line"></span><br><span class="line">--- b1 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.590/0.590/0.590 ms</span><br><span class="line"></span><br><span class="line">/ # exit</span><br></pre></td></tr></table></figure>



<h2 id="佈署-Kubernetes-Job-Controller"><a href="#佈署-Kubernetes-Job-Controller" class="headerlink" title="佈署 Kubernetes Job Controller"></a>佈署 Kubernetes Job Controller</h2><p>建立 Kubernetes Job Controller</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  name: job1</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: job</span><br><span class="line">          image: quay.io/cloudwalker/busybox</span><br><span class="line">          args:</span><br><span class="line">            - /bin/sh</span><br><span class="line">            - -c</span><br><span class="line">            - date; echo sleeping....; sleep 30s; echo exiting...; date</span><br><span class="line">      restartPolicy: Never &#x27; &gt;  ~/wulin/yaml/job01.yaml</span><br><span class="line"></span><br><span class="line">$ ka -f yaml/job01.yaml</span><br><span class="line"></span><br><span class="line">$ kg job</span><br><span class="line">NAME   COMPLETIONS   DURATION   AGE</span><br><span class="line">job1   1/1           44s        5m26s</span><br><span class="line"></span><br><span class="line">$ kubectl get pod -l=job-name=job1</span><br><span class="line">NAME         READY   STATUS      RESTARTS   AGE</span><br><span class="line">job1-9b8xz   0/1     Completed   0          119m</span><br></pre></td></tr></table></figure>


<p>修改 yaml 檔</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">job1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">job</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/busybox</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">date;</span> <span class="string">echo</span> <span class="string">sleeping....;</span> <span class="string">sleep</span> <span class="string">30s;</span> <span class="string">echo</span> <span class="string">exiting...;</span> <span class="string">date</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>

<p>apply 它</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ka -f yaml/job01.yaml</span><br><span class="line">The Job &quot;job1&quot; is invalid: spec.template.spec.restartPolicy: Required value: valid values: &quot;OnFailure&quot;, &quot;Never&quot;</span><br></pre></td></tr></table></figure>

<p>檢視 Kubernetes Job Controller</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  name: job2</span><br><span class="line">spec:</span><br><span class="line">  activeDeadlineSeconds: 5</span><br><span class="line">  template:</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: job2</span><br><span class="line">          image: busybox</span><br><span class="line">          args:</span><br><span class="line">            - /bin/sh</span><br><span class="line">            - -c</span><br><span class="line">            - date; echo sleeping....; sleep 30s; echo exiting...; date</span><br><span class="line">      restartPolicy: Never &#x27; &gt;  ~/wulin/yaml/job02.yaml</span><br><span class="line"></span><br><span class="line">$ ka -f yaml/job02.yaml</span><br></pre></td></tr></table></figure>

<ul>
<li><code>activeDeadlineSeconds: 5</code> ，設定 Job 只能跑 5  秒，時間到會停止</li>
</ul>
<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes%20yaml%20%E6%AA%94%E8%BC%94%E5%8A%A9%E5%99%A8.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes%20yaml%20%E6%AA%94%E8%BC%94%E5%8A%A9%E5%99%A8.html" class="post-title-link" itemprop="url">Untitled</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-06-15 05:30:26" itemprop="dateCreated datePublished" datetime="2022-06-15T05:30:26+08:00">2022-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 16:15:42" itemprop="dateModified" datetime="2023-05-07T16:15:42+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-yaml-檔輔助器"><a href="#Kubernetes-yaml-檔輔助器" class="headerlink" title="Kubernetes yaml 檔輔助器"></a>Kubernetes yaml 檔輔助器</h1><ul>
<li><p>安裝 vscode</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/stackrox/kube-linter">cli 的輔助器</a></p>
</li>
</ul>
<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Antony Cehn</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Antony.Chen</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
