<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Antony 的學習筆記">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Antony 的學習筆記">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Antony Cehn">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Antony 的學習筆記</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Antony 的學習筆記</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">這個網站將紀錄持續記錄我學習到各種知識的筆記</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes%20Deployment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes%20Deployment/" class="post-title-link" itemprop="url">Kubernetes Deployment</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-08 03:34:00" itemprop="dateCreated datePublished" datetime="2023-02-08T03:34:00+08:00">2023-02-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 18:13:19" itemprop="dateModified" datetime="2023-05-07T18:13:19+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-Deployment"><a href="#Kubernetes-Deployment" class="headerlink" title="Kubernetes Deployment"></a>Kubernetes Deployment</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本篇主要介紹什麼是 Deployment object，並且透過這個 K8S 的 物件，<strong>將一個網站服務進行進版或退版，且服務不中斷。</strong></p>
<h2 id="目錄"><a href="#目錄" class="headerlink" title="目錄"></a>目錄</h2><p>[TOC]</p>
<hr>
<h1 id="認識-Deployment"><a href="#認識-Deployment" class="headerlink" title="認識 Deployment"></a>認識 Deployment</h1><p>A Deployment provides declarative updates for Pods and ReplicaSets.</p>
<p>You describe a desired state in a Deployment, and the Deployment Controller changes the actual state to the desired state at a controlled rate. You can define Deployments to create new ReplicaSets, or to remove existing Deployments and adopt all their resources with new Deployments.</p>
<p><img src="https://i.imgur.com/of3Paqu.png"></p>
<ul>
<li>一個在 etcd 中的控制區塊，裡面紀錄 ReplicaSet Controller 這個功能</li>
<li>Deployment 由 ReplicaSet 和 Pods 組成</li>
<li>Deployment 管理 ReplicaSet ， ReplicaSet 管理 Pods</li>
<li>Deployment 可做到 <strong>Replication of components</strong> + <strong>Auto-scaling</strong> + <strong>Load balancing</strong> + <strong>Rolling updates</strong></li>
<li>Rolling updates，是由 Deployment 在做的</li>
<li>讓企業 run 的應用系統能夠長長久久穩穩當當</li>
</ul>
<h1 id="認識-ReplicaSet"><a href="#認識-ReplicaSet" class="headerlink" title="認識 ReplicaSet"></a>認識 ReplicaSet</h1><p><img src="https://i.imgur.com/dHJsNuQ.png"></p>
<ul>
<li>ReplicaSet 是用來確保在 k8s 中，在資源允許的前提下，指定的 pod 的數量會跟使用者所期望的一致，也就是所謂的 desired status。</li>
<li>ReplicaSets 可以生成多個 pod (Scalability，橫向擴增或縮減)，主要目的是服務流量分散<ul>
<li>多個 pod 是一樣的 (本尊和分身的概念)</li>
<li>所有 Pod 都共享同一 PersistentVolumeClaim，並與同一 PersistentVolume 綁定</li>
</ul>
</li>
<li>ReplicaSet 有自我療傷的功能<ul>
<li>當管理的 pod 毀損或被刪除時，會自動再產生同樣的 pod 出來</li>
<li>只要啟動 PV ，pod 的資料就不會不見</li>
</ul>
</li>
<li>可控管 pod 的狀態，如果 pod 負載太重，會變成離線的狀態，處理完手上的事情再回來</li>
</ul>
<h2 id="撰寫-Depolyment-Object-部署檔案"><a href="#撰寫-Depolyment-Object-部署檔案" class="headerlink" title="撰寫 Depolyment Object 部署檔案"></a>撰寫 Depolyment Object 部署檔案</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: depobj</span><br><span class="line">  labels:</span><br><span class="line">    app: deppod</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: deppod</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: deppod</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: myalpine</span><br><span class="line">        image: quay.io/ict39/alpine</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        tty: true &#x27;&gt; ~/wulin/yaml/depobj.yaml </span><br></pre></td></tr></table></figure>

<ul>
<li><code>kind: Deployment</code>，生成 Deployment 的物件<ul>
<li><code>metadata.name</code>，Deployment 的名字</li>
<li><code>labels:</code>，貼標籤，key 是 app，value 是 deppod</li>
</ul>
</li>
<li><code>spec</code>，Deployment 的規格<ul>
<li><code>replicas: 2</code>，讓 ReplicaSet 產生 2 個 pod</li>
<li><code>selector.matchLabels:</code>，透過標籤管理 pod<ul>
<li><code>app: deppod</code>，標籤</li>
</ul>
</li>
<li><code>template:</code>，對 pod 的宣告<ul>
<li><code>metadata:</code>，pod 的重要資訊<ul>
<li><code>labels.app</code>，對 pod 貼 <code>app: deppod</code> 的標籤</li>
</ul>
</li>
<li><code>spec</code>，pod 的規格<ul>
<li><code>containers</code>，Container 的設定<ul>
<li><code>name</code>，Container 的名字</li>
<li><code>image</code>，Container 用的 image</li>
<li><code>imagePullPolicy: IfNotPresent</code>，如果 node 主機沒有 image 就上網下載</li>
<li><code>tty: true</code>，因 image 內定執行的命令是貝殼程式，所以要給終端機</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="建立與檢視-Depolyment-Object"><a href="#建立與檢視-Depolyment-Object" class="headerlink" title="建立與檢視 Depolyment Object"></a>建立與檢視 Depolyment Object</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f wulin/yaml/depobj.yaml</span><br><span class="line">deployment.apps/depobj created</span><br><span class="line"></span><br><span class="line">$ kubectl get all --selector app=deppod</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/depobj-7cb97745c-4k8jm   1/1     Running   0          2m32s</span><br><span class="line">pod/depobj-7cb97745c-ssbf4   1/1     Running   0          2m32s</span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/kubernetes   ClusterIP   10.98.0.1    &lt;none&gt;        443/TCP   24h</span><br><span class="line"></span><br><span class="line">NAME                     READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/depobj   2/2     2            2           2m32s</span><br><span class="line"></span><br><span class="line">NAME                               DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/depobj-7cb97745c   2         2         2       2m32s</span><br></pre></td></tr></table></figure>

<ul>
<li>先看 Deployment 的名字， <code>depobj</code></li>
<li>再看 Replicaset 的名字，<code>depobj-7cb97745c</code><ul>
<li>因為是由 Deployment 建立的，所以 Replicaset 會有 deplopyment 的名字</li>
</ul>
</li>
<li>再看 pod 的名字，<code>depobj-7cb97745c-4k8jm</code><ul>
<li>因為 pod 是由 Deploy 的 ReplicaSet 建立的，所以 pod 名字前面會帶有他們的名字</li>
</ul>
</li>
</ul>
<h2 id="測試-ReplicaSets-Controller"><a href="#測試-ReplicaSets-Controller" class="headerlink" title="測試 ReplicaSets Controller"></a>測試 ReplicaSets Controller</h2><p>刪除帶有 <code>app=deppod</code> 標籤的 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod --selector app=deppod</span><br><span class="line">pod &quot;depobj-7cb97745c-4k8jm&quot; deleted</span><br><span class="line">pod &quot;depobj-7cb97745c-ssbf4&quot; deleted</span><br></pre></td></tr></table></figure>

<ul>
<li>ReplicaSets Controller 會一直執行 reconciliation loop 程序, 確保 Deployment Object 的 actual state 與 desired state 一致. 上面命令刪除二個 POD, 這時 reconciliation loop 程序會再生成二個新的 POD, 由以下命令得知</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get all --selector app=deppod</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/depobj-7cb97745c-jg7fk   1/1     Running   0          2m23s</span><br><span class="line">pod/depobj-7cb97745c-smjlt   1/1     Running   0          2m23s</span><br><span class="line"></span><br><span class="line">NAME                     READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/depobj   2/2     2            2           22m</span><br><span class="line"></span><br><span class="line">NAME                               DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/depobj-7cb97745c   2         2         2       22m</span><br></pre></td></tr></table></figure>

<ul>
<li>pod 的名字後面流水號不同，代表 pod 真的有被重新建立</li>
</ul>
<h2 id="修改-Depolyment-Object-部署檔案"><a href="#修改-Depolyment-Object-部署檔案" class="headerlink" title="修改 Depolyment Object 部署檔案"></a>修改 Depolyment Object 部署檔案</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: depobj</span><br><span class="line">  labels:</span><br><span class="line">    app: deppod</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: deppod</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: deppod</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: myderby</span><br><span class="line">        image: quay.io/ict39/alpine.derby</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 8888 &#x27;&gt; ~/wulin/yaml/depobj.yaml </span><br></pre></td></tr></table></figure>

<p>不刪除原本的 Deployment Object，直接再次產生</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f wulin/yaml/depobj.yaml</span><br><span class="line">deployment.apps/depobj configured</span><br></pre></td></tr></table></figure>

<p>檢視所有帶有 <code>app=deppod</code> 這個標籤的物件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get all --selector app=deppod</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/depobj-85987557b8-pq6f7   1/1     Running   0          47s</span><br><span class="line"></span><br><span class="line">NAME                     READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/depobj   1/1     1            1           32m</span><br><span class="line"></span><br><span class="line">NAME                                DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/depobj-7cb97745c    0         0         0       32m</span><br><span class="line">replicaset.apps/depobj-85987557b8   1         1         1       47s</span><br></pre></td></tr></table></figure>

<ul>
<li><code>replicaset.apps/depobj-7cb97745c</code>，注意，這是上一個 Deployment 產生的 ReplicaSet</li>
<li>當 Deployment 裡面的 pod 換成產生不同的 Container ，原本的 pod 會被刪除，但是 ReplicaSet 不會被刪除</li>
</ul>
<h2 id="建立與檢視-Depolyment-Object-1"><a href="#建立與檢視-Depolyment-Object-1" class="headerlink" title="建立與檢視 Depolyment Object"></a>建立與檢視 Depolyment Object</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: depng</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: quay.io/cloudwalker/nginx:1.20</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80 &#x27;&gt; ~/wulin/yaml/depng.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f ~/wulin/yaml/depng.yaml </span><br><span class="line">deployment.apps/depng created</span><br><span class="line"></span><br><span class="line">$ kg all --selector app=nginx</span><br><span class="line">NAME                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/depng-7bff78c9c-ntc7t   1/1     Running   0          2m</span><br><span class="line">pod/depng-7bff78c9c-skj6f   1/1     Running   0          2m</span><br><span class="line"></span><br><span class="line">NAME                    READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/depng   2/2     2            2           2m</span><br><span class="line"></span><br><span class="line">NAME                              DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/depng-7bff78c9c   2         2         2       2m</span><br></pre></td></tr></table></figure>


<h2 id="Updating-a-Deployment"><a href="#Updating-a-Deployment" class="headerlink" title="Updating a Deployment"></a>Updating a Deployment</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl set image deployment.v1.apps/depng nginx=quay.io/cloudwalker/nginx:1.21 --record </span><br><span class="line">deployment.apps/depng image updated</span><br></pre></td></tr></table></figure>

<ul>
<li>將 image 換裝成新版 1.21</li>
<li><code>--record</code> ，記錄</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout status deployment.v1.apps/depng</span><br><span class="line">Waiting for deployment &quot;depng&quot; rollout to finish: 1 out of 2 new replicas have been updated...</span><br><span class="line">Waiting for deployment &quot;depng&quot; rollout to finish: 1 out of 2 new replicas have been updated...</span><br><span class="line">Waiting for deployment &quot;depng&quot; rollout to finish: 1 out of 2 new replicas have been updated...</span><br><span class="line">Waiting for deployment &quot;depng&quot; rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">Waiting for deployment &quot;depng&quot; rollout to finish: 1 old replicas are pending termination...</span><br><span class="line">deployment &quot;depng&quot; successfully rolled out</span><br></pre></td></tr></table></figure>

<ul>
<li>這命令要再上一個命令做完後趕快執行，不然只會看到最後一行</li>
<li>Deplyment 進版時，會先把新的 pod 建立起來，再把舊版本的 pod 刪除</li>
</ul>
<p>檢查 image 是不是真的換裝城新版的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe deployments depng</span><br><span class="line">Name:                   dep1</span><br><span class="line">............</span><br><span class="line">Pod Template:</span><br><span class="line">  Labels:  app=nginx</span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:        quay.io/cloudwalker/nginx:1.21</span><br><span class="line">    Port:         80/TCP</span><br><span class="line">    Host Port:    0/TCP</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Rolling-Back-a-Deployment"><a href="#Rolling-Back-a-Deployment" class="headerlink" title="Rolling Back a Deployment"></a>Rolling Back a Deployment</h2><p>將 Deployment 退回上一個版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl rollout undo deployment.v1.apps/depng --to-revision=1</span><br></pre></td></tr></table></figure>

<p>檢查是否符合預期</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe deployment depng</span><br><span class="line">........</span><br><span class="line">  Containers:</span><br><span class="line">   nginx:</span><br><span class="line">    Image:        quay.io/cloudwalker/nginx:1.20</span><br><span class="line">    Port:         80/TCP</span><br><span class="line">    Host Port:    0/TCP</span><br></pre></td></tr></table></figure>

<h2 id="Scaling-a-Deployment"><a href="#Scaling-a-Deployment" class="headerlink" title="Scaling a Deployment"></a>Scaling a Deployment</h2><p>將 Deployment 的 pod 擴充為 3 個</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale deployment.v1.apps/depng --replicas=3</span><br></pre></td></tr></table></figure>

<p>檢查是否符合預期</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get deployment depng</span><br><span class="line">NAME   DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">dep1   3         3         3            3           46m</span><br><span class="line"></span><br><span class="line">$ kubectl get pods | grep depng</span><br><span class="line">dep1-66f7f56f56-2rf8p   1/1     Running   0          39s</span><br><span class="line">dep1-66f7f56f56-bggcn   1/1     Running   0          71s</span><br><span class="line">dep1-66f7f56f56-mn589   1/1     Running   0          69s</span><br><span class="line"></span><br><span class="line">$ kubectl delete deployment depng</span><br></pre></td></tr></table></figure>









<hr>
<h1 id="明城老師版本"><a href="#明城老師版本" class="headerlink" title="明城老師版本"></a>明城老師版本</h1><h2 id="建立-Local-Persistent-Volume"><a href="#建立-Local-Persistent-Volume" class="headerlink" title="建立 Local Persistent Volume"></a>建立 Local Persistent Volume</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: PersistentVolume</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: pv-rwo-5m</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  capacity:</span></span><br><span class="line"><span class="string">    storage: 5Mi</span></span><br><span class="line"><span class="string">  accessModes:</span></span><br><span class="line"><span class="string">    - ReadWriteOnce</span></span><br><span class="line"><span class="string">  local:</span></span><br><span class="line"><span class="string">    path: &quot;/opt/pv/5m&quot;</span></span><br><span class="line"><span class="string">  nodeAffinity:</span></span><br><span class="line"><span class="string">    required:</span></span><br><span class="line"><span class="string">      nodeSelectorTerms:</span></span><br><span class="line"><span class="string">      - matchExpressions:</span></span><br><span class="line"><span class="string">        - key: kubernetes.io/hostname</span></span><br><span class="line"><span class="string">          operator: In</span></span><br><span class="line"><span class="string">          values:</span></span><br><span class="line"><span class="string">          - w1&#x27;</span> &gt; pv-rwo-5m.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f pv-rwo-5m.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl get pv pv-rwo-5m</span><br></pre></td></tr></table></figure>

<h2 id="建立-Local-PersistentVolumeClaim"><a href="#建立-Local-PersistentVolumeClaim" class="headerlink" title="建立 Local PersistentVolumeClaim"></a>建立 Local PersistentVolumeClaim</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: PersistentVolumeClaim</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: pvc-rwo-3m</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  accessModes:</span></span><br><span class="line"><span class="string">    - ReadWriteOnce</span></span><br><span class="line"><span class="string">  resources:</span></span><br><span class="line"><span class="string">    requests:</span></span><br><span class="line"><span class="string">      storage: 3Mi&#x27;</span> &gt; pvc-rwo-3m.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f pvc-rwo-3m.yaml</span><br></pre></td></tr></table></figure>


<h2 id="檢視-PV-與-PVC"><a href="#檢視-PV-與-PVC" class="headerlink" title="檢視 PV 與 PVC"></a>檢視 PV 與 PVC</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pvc pvc-rwo-3m</span><br><span class="line">NAME         STATUS   VOLUME      CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">pvc-rwo-3m   Bound    pv-rwo-5m   5Mi        RWO                           10s</span><br><span class="line"></span><br><span class="line">bigred@m1:~/0613$ kubectl get pv pv-rwo-5m</span><br><span class="line">NAME        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   REASON   AGE</span><br><span class="line">pv-rwo-5m   5Mi        RWO            Retain           Bound    default/pvc-rwo-3m                           55s</span><br></pre></td></tr></table></figure>

<h2 id="建立-Deployment"><a href="#建立-Deployment" class="headerlink" title="建立 Deployment"></a>建立 Deployment</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: nginx</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  replicas: 3</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: nginx</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: nginx</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">        - name: nginx</span></span><br><span class="line"><span class="string">          image: quay.io/flysangel/nginx</span></span><br><span class="line"><span class="string">          volumeMounts:</span></span><br><span class="line"><span class="string">            - name: html-storage</span></span><br><span class="line"><span class="string">              mountPath: /usr/share/nginx/html</span></span><br><span class="line"><span class="string">      volumes:</span></span><br><span class="line"><span class="string">        - name: html-storage</span></span><br><span class="line"><span class="string">          persistentVolumeClaim:</span></span><br><span class="line"><span class="string">            claimName: pvc-rwo-3m&#x27;</span> &gt; deploy-nginx.yaml</span><br></pre></td></tr></table></figure>

<h2 id="建立-Pod-使用-PVC"><a href="#建立-Pod-使用-PVC" class="headerlink" title="建立 Pod 使用 PVC"></a>建立 Pod 使用 PVC</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ssh w1 sudo <span class="built_in">mkdir</span> -p /opt/pv/5m</span><br><span class="line">$ ssh w1 <span class="string">&quot;echo &#x27;Hello My Pvc&#x27; | sudo tee /opt/pv/5m/index.html&quot;</span></span><br></pre></td></tr></table></figure>


<h2 id="驗證-nginx-首頁"><a href="#驗證-nginx-首頁" class="headerlink" title="驗證 nginx 首頁"></a>驗證 nginx 首頁</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f deploy-nginx.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl get pod -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP             NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-5bfb7cc7b7-2jkbl   1/1     Running   0          2m50s   10.244.1.116   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-5bfb7cc7b7-9zrbt   1/1     Running   0          2m50s   10.244.1.115   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-5bfb7cc7b7-g2glm   1/1     Running   0          2m50s   10.244.1.117   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ curl http://10.244.1.116</span><br><span class="line">Hello My Pvc</span><br><span class="line"></span><br><span class="line">$ curl http://10.244.1.115</span><br><span class="line">Hello My Pvc</span><br><span class="line"></span><br><span class="line">$ curl http://10.244.1.117</span><br><span class="line">Hello My Pvc</span><br></pre></td></tr></table></figure>

<blockquote>
<p>透過 Deployment&#x2F;ReplicaSets 建立的 pods 後面會有一串代碼</p>
</blockquote>
<hr>
<h2 id="認識-ReplicaSet-1"><a href="#認識-ReplicaSet-1" class="headerlink" title="認識 ReplicaSet"></a>認識 ReplicaSet</h2><p><img src="https://i.imgur.com/3sGeVno.png"></p>
<ul>
<li><p>對於 ReplicaSet 所管理的 Pod, 雖然每個 Pod 都有 hostname, 但當 Pod 被移轉時, hostname 會重新分配, 對於指向 ReplicaSet 的 Service, 其他服務訪問 Service 時會被隨機分配到某個 Pod</p>
</li>
<li><p>DNS 伺服器，幫我們把記不住的 IP 轉成記得住的網址</p>
</li>
<li><p>Service 建立後，會跟 K8s core-dns 註冊</p>
</li>
</ul>
<h2 id="建立-Service-Deployment"><a href="#建立-Service-Deployment" class="headerlink" title="建立 Service Deployment"></a>建立 Service Deployment</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: nginx</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  clusterIP: None</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: nginx&#x27;</span> &gt; svc-nginx.yaml</span><br></pre></td></tr></table></figure>

<p>上面這個 Service 是 Headless Service （ 無頭服務 ）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f svc-nginx.yaml</span><br><span class="line">service/nginx created</span><br><span class="line"></span><br><span class="line">$ kubectl get service</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.98.0.1    &lt;none&gt;        443/TCP   13d</span><br><span class="line">nginx        ClusterIP   None         &lt;none&gt;        &lt;none&gt;    14s</span><br></pre></td></tr></table></figure>

<h2 id="觀察-Service-Deployment"><a href="#觀察-Service-Deployment" class="headerlink" title="觀察 Service Deployment"></a>觀察 Service Deployment</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get service -n kube-system</span><br><span class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">kube-dns   ClusterIP   10.98.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   13d</span><br></pre></td></tr></table></figure>

<p>透過 nslookup 來將</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ nslookup</span><br><span class="line">&gt; server 10.98.0.10</span><br><span class="line">Default server: 10.98.0.10</span><br><span class="line">Address: 10.98.0.10<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">&gt; 10.244.1.115</span><br><span class="line">115.1.244.10.in-addr.arpa       name = 10-244-1-115.nginx.default.svc.k8s.org.</span><br><span class="line"></span><br><span class="line">&gt; 10.244.1.116</span><br><span class="line">116.1.244.10.in-addr.arpa       name = 10-244-1-116.nginx.default.svc.k8s.org.</span><br><span class="line"></span><br><span class="line">&gt; 10.244.1.117</span><br><span class="line">117.1.244.10.in-addr.arpa       name = 10-244-1-117.nginx.default.svc.k8s.org.</span><br><span class="line"></span><br><span class="line">&gt; nginx.default.svc.k8s.org</span><br><span class="line">Server:         10.98.0.10</span><br><span class="line">Address:        10.98.0.10<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">Name:   nginx.default.svc.k8s.org</span><br><span class="line">Address: 10.244.1.116</span><br><span class="line">Name:   nginx.default.svc.k8s.org</span><br><span class="line">Address: 10.244.1.117</span><br><span class="line">Name:   nginx.default.svc.k8s.org</span><br><span class="line">Address: 10.244.1.115</span><br></pre></td></tr></table></figure>

<h2 id="練習"><a href="#練習" class="headerlink" title="練習"></a>練習</h2><p>請問如何擴展 Deployment。<br>請觀察擴展 Deployment 時，pod 或 container 狀態為何。<br>請將 Local Persistent Volumes 換成 Local Path Provisioner。</p>
<p>練習完後請刪除練習環境<br>Pod -&gt; PVC</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl scale deploy/nginx --replicas=6</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes%20Landlord/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes%20Landlord/" class="post-title-link" itemprop="url">Kubernetes Landlord</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-01-07 08:21:42" itemprop="dateCreated datePublished" datetime="2023-01-07T08:21:42+08:00">2023-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 18:14:06" itemprop="dateModified" datetime="2023-05-07T18:14:06+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-Landlord"><a href="#Kubernetes-Landlord" class="headerlink" title="Kubernetes Landlord"></a>Kubernetes Landlord</h1><h2 id="部署-Landlord-on-K8S"><a href="#部署-Landlord-on-K8S" class="headerlink" title="部署 Landlord on K8S"></a>部署 Landlord on K8S</h2><p>環境準備<br>CNT.2022.v4 K8S 叢集建置完成<br>以下 K8S 公設完成部署</p>
<ul>
<li>MetalLB</li>
<li>Ingress NGINX Controller</li>
<li>Local Path Provisioner</li>
</ul>
<p>在 Windows 系統的 cmd 視窗登入 m1 主機</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create ns landlord</span><br><span class="line">namespace/landlord created</span><br><span class="line"></span><br><span class="line">$ kubectl create -n landlord configmap kuser-conf --from-file /home/bigred/.kube/config</span><br><span class="line">configmap/kuser-conf created</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f https://web.flymks.com/landlord/v1/landlord.yaml</span><br></pre></td></tr></table></figure>

<p>確認狀態</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get all -n landlord</span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/gateway-759f9676cd-fms9r   1/1     Running   0          12m</span><br><span class="line">pod/kuser-7bcd86d848-nvz5t     1/1     Running   0          12m</span><br><span class="line">pod/logger-7c68f4cf59-b255x    1/1     Running   0          12m</span><br><span class="line">pod/mariadb-b8fdcc6c4-48pj6    1/1     Running   1          12m</span><br><span class="line">pod/tenant-0                   1/1     Running   0          12m</span><br><span class="line">pod/tenant-1                   1/1     Running   0          11m</span><br><span class="line">pod/tenant-2                   1/1     Running   0          2m21s</span><br><span class="line"></span><br><span class="line">NAME              TYPE           CLUSTER-IP    EXTERNAL-IP      PORT(S)           AGE</span><br><span class="line">service/gateway   LoadBalancer   10.98.0.163   192.168.61.221   20000:31662/TCP   12m</span><br><span class="line">service/kuser     ClusterIP      None          &lt;none&gt;           &lt;none&gt;            12m</span><br><span class="line">service/logger    ClusterIP      None          &lt;none&gt;           &lt;none&gt;            12m</span><br><span class="line">service/mariadb   ClusterIP      None          &lt;none&gt;           &lt;none&gt;            12m</span><br><span class="line">service/tenant    ClusterIP      None          &lt;none&gt;           &lt;none&gt;            12m</span><br><span class="line"></span><br><span class="line">NAME                      READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/gateway   1/1     1            1           12m</span><br><span class="line">deployment.apps/kuser     1/1     1            1           12m</span><br><span class="line">deployment.apps/logger    1/1     1            1           12m</span><br><span class="line">deployment.apps/mariadb   1/1     1            1           12m</span><br><span class="line"></span><br><span class="line">NAME                                 DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/gateway-759f9676cd   1         1         1       12m</span><br><span class="line">replicaset.apps/kuser-7bcd86d848     1         1         1       12m</span><br><span class="line">replicaset.apps/logger-7c68f4cf59    1         1         1       12m</span><br><span class="line">replicaset.apps/mariadb-b8fdcc6c4    1         1         1       12m</span><br><span class="line"></span><br><span class="line">NAME                      READY   AGE</span><br><span class="line">statefulset.apps/tenant   3/3     12m</span><br></pre></td></tr></table></figure>

<h2 id="問題討論"><a href="#問題討論" class="headerlink" title="問題討論"></a>問題討論</h2><ul>
<li><p>為甚麼角色大多使用 deployment 設計 ?</p>
<ul>
<li>因為當 node 發生異常，導致 pod 掛掉時，在 node 上的 kubelet 也會跟著去世，這時候如果我們是使用 deployment 設計的 pod ，這些 pod 就會由 deployment 的 ReplicaSets 去照顧 pod ，讓 pod 浴火重生， pv 與 pvc 的問題，可以由分散式的 CSI 解決。</li>
</ul>
</li>
<li><p>為甚麼要有 Gateway 這個腳色 ？</p>
<ul>
<li>如果今天沒有提供 gateway ，使用者就要</li>
<li>統一控管網路的入口。</li>
</ul>
</li>
<li><p>為甚麼 Tenant 要用 StatefulSets 設計？</p>
<ul>
<li>讓 pod 各自有自己的 pvc 與 pv 。</li>
</ul>
</li>
<li><p>Tenant 是透過何種方式達到永存資料</p>
<ul>
<li>用 local-path-pr</li>
</ul>
</li>
<li><h2 id="可不可以沒有-Logger-，將資料直接放入-Mariadb-如果沒有-Logger-會有安全性的問題，-Logger-寫入-Mariadb-是用特殊方法寫入"><a href="#可不可以沒有-Logger-，將資料直接放入-Mariadb-如果沒有-Logger-會有安全性的問題，-Logger-寫入-Mariadb-是用特殊方法寫入" class="headerlink" title="可不可以沒有  Logger ，將資料直接放入 Mariadb  - 如果沒有 Logger 會有安全性的問題，  - Logger 寫入 Mariadb 是用特殊方法寫入"></a>可不可以沒有  Logger ，將資料直接放入 Mariadb<br>  - 如果沒有 Logger 會有安全性的問題，<br>  - Logger 寫入 Mariadb 是用特殊方法寫入</h2></li>
<li><p>沒有 Kuser 會如何</p>
<ul>
<li>為了能讓一般使用者能連接 Kubernetes</li>
</ul>
</li>
</ul>
<h2 id="Landlord-移除"><a href="#Landlord-移除" class="headerlink" title="Landlord 移除"></a>Landlord 移除</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete -f https://web.flymks.com/landlord/v1/landlord.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl delete ns tenant-0 tenant-1 tenant-2</span><br><span class="line"></span><br><span class="line">$ kubectl delete csr tenant-0-csr tenant-1-csr tenant-2-csr</span><br></pre></td></tr></table></figure>

<h1 id="實作-Landlord"><a href="#實作-Landlord" class="headerlink" title="實作 Landlord"></a>實作 Landlord</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">下載 Landlord 實作包</span><br><span class="line">$ wget https://web.flymks.com/landlord/v1/sre_landlord.zip</span><br><span class="line">…</span><br><span class="line">2022-06-12 22:29:50 (2.79 MB/s) - <span class="string">&#x27;sre_landlord.zip&#x27;</span> saved [18712/18712]</span><br><span class="line"></span><br><span class="line">$ unzip sre_landlord.zip</span><br><span class="line">Archive:  sre_landlord.zip</span><br><span class="line">…</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> sre_landlord</span><br></pre></td></tr></table></figure>

<h2 id="Landlord-目錄結構"><a href="#Landlord-目錄結構" class="headerlink" title="Landlord 目錄結構"></a>Landlord 目錄結構</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ tree .</span><br><span class="line">.</span><br><span class="line">├── Dockerfile.landlord.kubectl</span><br><span class="line">├── Dockerfile.landlord.kuser</span><br><span class="line">├── Dockerfile.landlord.mariadb</span><br><span class="line">├── LICENSE</span><br><span class="line">├── app_kuser</span><br><span class="line">│   ├── RBAC.md</span><br><span class="line">│   ├── ckuser    ---------------&gt; ## 判斷是否為 Kubernetes 使用者</span><br><span class="line">│   ├── config    ---------------&gt; ## 處理謙和過的憑證</span><br><span class="line">│   ├── create    ---------------&gt; ## 建立使用者憑證</span><br><span class="line">│   ├── delete    ---------------&gt; ## 刪除 Kubernetes 使用者</span><br><span class="line">│   ├── go.mod</span><br><span class="line">│   ├── go.sum</span><br><span class="line">│   ├── main.go</span><br><span class="line">│   └── template</span><br><span class="line">│       ├── config.temp</span><br><span class="line">│       ├── csr.temp</span><br><span class="line">│       ├── role.temp</span><br><span class="line">│       └── rolebind.temp</span><br><span class="line">├── bin</span><br><span class="line">│   ├── gateway</span><br><span class="line">│   │   └── adduser</span><br><span class="line">│   ├── logger</span><br><span class="line">│   │   └── log_server</span><br><span class="line">│   └── tenant</span><br><span class="line">│       └── log_client</span><br><span class="line">├── conf</span><br><span class="line">│   └── mariadb</span><br><span class="line">│       └── initdb</span><br><span class="line">│           └── initdb.sql</span><br><span class="line">└── landlord.yaml</span><br><span class="line"></span><br><span class="line">9 directories, 21 files</span><br></pre></td></tr></table></figure>



<p>提問：Golang 透過提交路由，執行內部 bash script。系統設計上，有哪些好處？</p>
<p>答：</p>
<ul>
<li>希望 使用者不用再打 create tenant-0 ，系統直接判定你是誰 幫你建立所有你要的功能，這也是一種降低 Human Error</li>
<li><font color =red>核心是希望權限由系統處理</font></li>
<li>Golang 不是分流，他主要的功能是 RestApi 的形式，透過網頁供他人存取，存取的程式 都是 bash script</li>
<li>整個系統都會由 ckuser 來處理與判定，不會讓非 Kubernetes 使用者（禁止未登入 Cluster 的指令請求）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> Dockerfile.landlord.kuser</span><br><span class="line">FROM quay.io/flysangel/golang AS build-env</span><br><span class="line"></span><br><span class="line">ADD ./app_kuser /src</span><br><span class="line"></span><br><span class="line">RUN \</span><br><span class="line">    <span class="built_in">cd</span> /src &amp;&amp; \</span><br><span class="line">    CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o main</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FROM quay.io/flysangel/image:alpine.base AS main</span><br><span class="line"></span><br><span class="line">RUN \</span><br><span class="line">    apk update &amp;&amp; \</span><br><span class="line">    apk add --no-cache openssl</span><br><span class="line"></span><br><span class="line">RUN \</span><br><span class="line">    curl -LO <span class="string">&quot;https://dl.k8s.io/release/<span class="subst">$(curl -L -s https://dl.k8s.io/release/stable.txt)</span>/bin/linux/amd64/kubectl&quot;</span> &amp;&amp; \</span><br><span class="line">    install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl &amp;&amp; \</span><br><span class="line">    <span class="built_in">rm</span> -r kubectl</span><br><span class="line"></span><br><span class="line">RUN \</span><br><span class="line">    <span class="built_in">mkdir</span> -p /app_kuser/kuser</span><br><span class="line"></span><br><span class="line">COPY --from=build-env /src/main /app_kuser/main</span><br><span class="line">COPY app_kuser/template /app_kuser/template</span><br><span class="line">COPY app_kuser/ckuser /app_kuser/ckuser</span><br><span class="line">COPY app_kuser/config /app_kuser/config</span><br><span class="line">COPY app_kuser/create /app_kuser/create</span><br><span class="line">COPY app_kuser/delete /app_kuser/delete</span><br><span class="line"></span><br><span class="line">WORKDIR /app_kuser</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [<span class="string">&quot;./main&quot;</span>]</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="實作-Kuser"><a href="#實作-Kuser" class="headerlink" title="實作 Kuser"></a>實作 Kuser</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman build -t quay.k8s.org/quay/landlord.kuser:1.0.0 -f Dockerfile.landlord.kuser .</span><br><span class="line"></span><br><span class="line">$ sudo podman login --tls-verify=<span class="literal">false</span> quay.k8s.org</span><br><span class="line">Username: quay</span><br><span class="line">Password: Quay12345</span><br><span class="line">Login Succeeded!</span><br><span class="line"></span><br><span class="line">$ sudo podman push --tls-verify=<span class="literal">false</span> quay.k8s.org/quay/landlord.kuser:1.0.0</span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> Dockerfile.landlord.mariadb</span><br><span class="line">FROM quay.io/flysangel/mariadb</span><br><span class="line"></span><br><span class="line">COPY conf/mariadb/initdb/initdb.sql /docker-entrypoint-initdb.d</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> conf/mariadb/initdb/initdb.sql</span><br><span class="line">CREATE TABLE IF NOT EXISTS <span class="built_in">history</span> (</span><br><span class="line">  Hostname VARCHAR(50),</span><br><span class="line">  Username VARCHAR(50),</span><br><span class="line">  Time VARCHAR(50),</span><br><span class="line">  Command VARCHAR(255)</span><br><span class="line">);</span><br><span class="line">CREATE TABLE IF NOT EXISTS inotify (</span><br><span class="line">  Hostname VARCHAR(50),</span><br><span class="line">  Time VARCHAR(50),</span><br><span class="line">  Event VARCHAR(20),</span><br><span class="line">  Path VARCHAR(255)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>


<h1 id="練習"><a href="#練習" class="headerlink" title="練習"></a>練習</h1><h2 id="實作-Gateway"><a href="#實作-Gateway" class="headerlink" title="實作 Gateway"></a>實作 Gateway</h2><p>請設計一個 Container Image 名為 landlord.gateway，標籤為 1.0.0，並滿足以下功能</p>
<ul>
<li><code>FROM quay.io/flysangel/image:alpine.sshd</code></li>
<li>複製 adduser 程式至 &#x2F;bin</li>
<li><code>CMD [&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;/bin/adduser; /usr/sbin/sshd -D&quot;]</code></li>
</ul>
<p>將 Container Image 上傳至落地 Quay<br>在 K8S 使用 landlord.gateway<br>驗證 Pod 內是否有成功建立使用者</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">$ nano Dockerfile.landlord.gateway</span><br><span class="line">FROM quay.io/flysangel/image:alpine.sshd</span><br><span class="line"></span><br><span class="line">COPY bin/gateway/adduser /bin</span><br><span class="line"></span><br><span class="line">CMD [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;/bin/adduser; /usr/sbin/sshd -D&quot;</span>]</span><br><span class="line"></span><br><span class="line">$ sudo podman build -t quay.k8s.org/quay/landlord.gateway:1.0.0 -f Dockerfile.landlord.gateway .</span><br><span class="line"></span><br><span class="line">$ sudo podman images | grep gateway</span><br><span class="line">quay.k8s.org/quay/landlord.gateway                        1.0.0             22cd776d7171  5 seconds ago   59.5 MB</span><br><span class="line"></span><br><span class="line">$ sudo podman push --tls-verify=<span class="literal">false</span> quay.k8s.org/quay/landlord.gateway:1.0.0</span><br><span class="line"></span><br><span class="line">$ nano pod-landlord.gateway.yml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: gateway</span><br><span class="line">  namespace: landlord</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: gateway</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: gateway</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - <span class="built_in">env</span>:</span><br><span class="line">        - name: NS</span><br><span class="line">          value: landlord</span><br><span class="line">        - name: USERTAG</span><br><span class="line">          value: tenant</span><br><span class="line">        image: quay.k8s.org/quay/landlord.gateway:1.0.0</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        name: gateway</span><br><span class="line">        securityContext:</span><br><span class="line">          capabilities:</span><br><span class="line">            add:</span><br><span class="line">            - AUDIT_WRITE</span><br><span class="line">            - SYS_CHROOT</span><br><span class="line">            - CAP_NET_RAW</span><br><span class="line">      restartPolicy: Always</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ kubectl apply -f Deployment-landlord.gateway.yml</span><br><span class="line"></span><br><span class="line">$ kubectl get pod -n landlord</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">gateway-6898d75c8f-5f2rc   1/1     Running   0          4s</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it -n landlord gateway-6898d75c8f-5f2rc -- bash</span><br><span class="line">bash-5.1<span class="comment">#/bin/adduser</span></span><br><span class="line">adduser: user <span class="string">&#x27;tenant-0&#x27;</span> <span class="keyword">in</span> use</span><br><span class="line">chpasswd: password <span class="keyword">for</span> <span class="string">&#x27;tenant-0&#x27;</span> changed</span><br><span class="line">adduser: user <span class="string">&#x27;tenant-1&#x27;</span> <span class="keyword">in</span> use</span><br><span class="line">chpasswd: password <span class="keyword">for</span> <span class="string">&#x27;tenant-1&#x27;</span> changed</span><br><span class="line">... 以下省略</span><br><span class="line"></span><br><span class="line">bash-5.1<span class="comment"># cat /etc/passwd</span></span><br><span class="line">... 以上省略</span><br><span class="line">tenant-0:x:1001:1001:Linux User,,,:/home/tenant-0:/bin/bash</span><br><span class="line">tenant-1:x:1002:1002:Linux User,,,:/home/tenant-1:/bin/bash</span><br><span class="line">tenant-2:x:1003:1003:Linux User,,,:/home/tenant-2:/bin/bash</span><br><span class="line">...</span><br><span class="line">tenant-98:x:1099:1099:Linux User,,,:/home/tenant-98:/bin/bash</span><br><span class="line">tenant-99:x:1100:1100:Linux User,,,:/home/tenant-99:/bin/bash</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="實作-Logger"><a href="#實作-Logger" class="headerlink" title="實作 Logger"></a>實作 Logger</h2><p>請設計一個 Container Image 名為 landlord.logger，標籤為 1.0.0，並滿足以下功能</p>
<ul>
<li><code>FROM quay.io/flysangel/image:alpine.base</code></li>
<li>安裝 <code>mysql client</code></li>
<li>複製 <code>log_server</code> 程式至 <code>/bin</code></li>
<li><code>CMD [&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;/bin/log_server&quot;]</code></li>
</ul>
<p>將 Container Image 上傳至落地 Quay<br>在 K8S 使用 landlord.logger<br>驗證 Pod 內是否有執行 log_server</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">$ nano Dockerfile.landlord.logger</span><br><span class="line">FROM quay.io/flysangel/image:alpine.base</span><br><span class="line"></span><br><span class="line">RUN \</span><br><span class="line">  apk update &amp;&amp; \</span><br><span class="line">  apk add mysql mysql-client</span><br><span class="line"></span><br><span class="line">COPY bin/logger/log_server /bin</span><br><span class="line">CMD [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;/bin/log_server&quot;</span></span><br><span class="line"></span><br><span class="line">$ sudo podman build -t quay.k8s.org/quay/landlord.logger:1.0.0 -f Dockerfile.landlord.logger .</span><br><span class="line"></span><br><span class="line">$ sudo podman images | grep logger</span><br><span class="line">quay.k8s.org/quay/landlord.logger                         1.0.0             7e8992f656b8  19 seconds ago     235 MB</span><br><span class="line"></span><br><span class="line">$ sudo podman push --tls-verify=<span class="literal">false</span> quay.k8s.org/quay/landlord.logger:1.0.0</span><br><span class="line"></span><br><span class="line">$ nano Deployment-landlord.logger.yml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: logger</span><br><span class="line">  namespace: landlord</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: logger</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: logger</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - <span class="built_in">env</span>:</span><br><span class="line">        - name: NS</span><br><span class="line">          value: landlord</span><br><span class="line">        - name: DB_SERVER</span><br><span class="line">          value: mariadb</span><br><span class="line">        - name: DB_NAME</span><br><span class="line">          value: landlord</span><br><span class="line">        - name: DB_ROOT</span><br><span class="line">          value: landlord</span><br><span class="line">        - name: DB_ROOT_PW</span><br><span class="line">          value: mymariadblandlord</span><br><span class="line">        image: quay.k8s.org/quay/landlord.logger:1.0.0</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        name: logger</span><br><span class="line">      restartPolicy: Always</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f Deployment-landlord.logger.yml</span><br><span class="line"></span><br><span class="line">$ kubectl get pod -n landlord -o wide</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE   IP             NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">gateway-6898d75c8f-5f2rc   1/1     Running   0          28m   10.244.1.146   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">logger-64d95c7ddd-wp46c    1/1     Running   0          21s   10.244.1.147   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it -n landlord logger-64d95c7ddd-wp46c -- bash</span><br><span class="line">bash-5.1<span class="comment">#cat /bin/log_server</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">nc -k -l -p 5566 |</span><br><span class="line">  <span class="keyword">while</span> <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;line&#125;</span>&quot;</span> | grep <span class="string">&#x27;HISTORY&#x27;</span>; <span class="keyword">then</span></span><br><span class="line">      HOSTNAME=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;line&#125;</span>&quot;</span> | grep <span class="string">&#x27;HISTORY&#x27;</span> | awk -F<span class="string">&#x27;|&#x27;</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">      USERNAME=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;line&#125;</span>&quot;</span> | grep <span class="string">&#x27;HISTORY&#x27;</span> | awk -F<span class="string">&#x27;|&#x27;</span> <span class="string">&#x27;&#123;print $3&#125;&#x27;</span>)</span><br><span class="line">      TIME=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;line&#125;</span>&quot;</span> | grep <span class="string">&#x27;HISTORY&#x27;</span> | awk -F<span class="string">&#x27;|&#x27;</span> <span class="string">&#x27;&#123;print $5&#125;&#x27;</span>)</span><br><span class="line">      COMMAND=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;line&#125;</span>&quot;</span> | grep <span class="string">&#x27;HISTORY&#x27;</span> | awk -F<span class="string">&#x27;|&#x27;</span> <span class="string">&#x27;&#123;print $6&#125;&#x27;</span>)</span><br><span class="line">      mysql -h <span class="string">&quot;<span class="variable">$&#123;DB_SERVER&#125;</span>.<span class="variable">$&#123;NS&#125;</span>&quot;</span> -u <span class="string">&quot;<span class="variable">$&#123;DB_ROOT&#125;</span>&quot;</span> -p<span class="string">&quot;<span class="variable">$&#123;DB_ROOT_PW&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;DB_NAME&#125;</span>&quot;</span> \</span><br><span class="line">        -e <span class="string">&quot;INSERT INTO history VALUES (&#x27;<span class="variable">$&#123;HOSTNAME&#125;</span>&#x27;,&#x27;<span class="variable">$&#123;USERNAME&#125;</span>&#x27;,&#x27;<span class="variable">$&#123;TIME&#125;</span>&#x27;,&#x27;<span class="variable">$&#123;COMMAND&#125;</span>&#x27;)&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;line&#125;</span>&quot;</span> | grep <span class="string">&#x27;INOTIFY&#x27;</span>; <span class="keyword">then</span></span><br><span class="line">      HOSTNAME=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;line&#125;</span>&quot;</span> | grep <span class="string">&#x27;INOTIFY&#x27;</span> | awk -F<span class="string">&#x27;|&#x27;</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line">      TIME=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;line&#125;</span>&quot;</span> | grep <span class="string">&#x27;INOTIFY&#x27;</span> | awk -F<span class="string">&#x27;|&#x27;</span> <span class="string">&#x27;&#123;print $3&#125;&#x27;</span>)</span><br><span class="line">      EVENT=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;line&#125;</span>&quot;</span> | grep <span class="string">&#x27;INOTIFY&#x27;</span> | awk -F<span class="string">&#x27;|&#x27;</span> <span class="string">&#x27;&#123;print $4&#125;&#x27;</span>)</span><br><span class="line">      INPATH=$(<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;line&#125;</span>&quot;</span> | grep <span class="string">&#x27;INOTIFY&#x27;</span> | awk -F<span class="string">&#x27;|&#x27;</span> <span class="string">&#x27;&#123;print $5&#125;&#x27;</span>)</span><br><span class="line">      mysql -h <span class="string">&quot;<span class="variable">$&#123;DB_SERVER&#125;</span>.<span class="variable">$&#123;NS&#125;</span>&quot;</span> -u <span class="string">&quot;<span class="variable">$&#123;DB_ROOT&#125;</span>&quot;</span> -p<span class="string">&quot;<span class="variable">$&#123;DB_ROOT_PW&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;DB_NAME&#125;</span>&quot;</span> \</span><br><span class="line">        -e <span class="string">&quot;INSERT INTO inotify VALUES (&#x27;<span class="variable">$&#123;HOSTNAME&#125;</span>&#x27;,&#x27;<span class="variable">$&#123;TIME&#125;</span>&#x27;,&#x27;<span class="variable">$&#123;EVENT&#125;</span>&#x27;,&#x27;<span class="variable">$&#123;INPATH&#125;</span>&#x27;)&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<hr>
<h2 id="實作-Tenant"><a href="#實作-Tenant" class="headerlink" title="實作 Tenant"></a>實作 Tenant</h2><p>請設計一個 Container Image 名為 landlord.tenant，標籤為 1.0.0，並滿足以下功能</p>
<ul>
<li><code>FROM quay.io/flysangel/image:alpine.sshd</code></li>
<li>安裝 <code>mysql client</code></li>
<li>安裝 <code>kubectl</code></li>
<li>複製 <code>log_client</code> 程式至 <code>/bin</code></li>
<li><code>CMD [&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;/bin/log_client &amp; /usr/sbin/sshd -D&quot;]</code></li>
</ul>
<p>將 Container Image 上傳至落地 Quay<br>在 K8S 使用 landlord.tenant<br>驗證 Pod 內是否有 kubectl 命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">$ nano Dockerfile.landlord.tenant</span><br><span class="line">FROM quay.io/flysangel/image:alpine.sshd</span><br><span class="line"></span><br><span class="line">RUN \</span><br><span class="line">    apk update &amp;&amp; \</span><br><span class="line">    apk add mysql mysql-client</span><br><span class="line"></span><br><span class="line">RUN \</span><br><span class="line">    curl -LO <span class="string">&quot;https://dl.k8s.io/release/<span class="subst">$(curl -L -s https://dl.k8s.io/release/stable.txt)</span>/bin/linux/amd64/kubectl&quot;</span> &amp;&amp; \</span><br><span class="line">    install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl &amp;&amp; \</span><br><span class="line">    <span class="built_in">rm</span> -r kubectl</span><br><span class="line"></span><br><span class="line">COPY bin/tenant/log_client /bin</span><br><span class="line"></span><br><span class="line">CMD [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;/bin/log_client &amp; /usr/sbin/sshd -D&quot;</span>]</span><br><span class="line"></span><br><span class="line">$ sudo podman build -t quay.k8s.org/quay/landlord.tenant:1.0.0 -f Dockerfile.landlord.tenant .</span><br><span class="line"></span><br><span class="line">$ sudo podman images | grep tenant</span><br><span class="line">quay.k8s.org/quay/landlord.tenant                         1.0.0             b4fc9e216ae3  30 seconds ago     285 MB</span><br><span class="line"></span><br><span class="line">$ sudo podman push --tls-verify=<span class="literal">false</span> quay.k8s.org/quay/landlord.tenant:1.0.0</span><br><span class="line"></span><br><span class="line">$ nano StatefulSet-landlord.tenant.yml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: tenant</span><br><span class="line">  namespace: landlord</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: tenant</span><br><span class="line">  serviceName: tenant</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: tenant</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - <span class="built_in">env</span>:</span><br><span class="line">        - name: NS</span><br><span class="line">          value: landlord</span><br><span class="line">        - name: LOG_SERVER</span><br><span class="line">          value: logger</span><br><span class="line">        - name: KUSER_SERVER</span><br><span class="line">          value: kuser</span><br><span class="line">        - name: EXCLUDE</span><br><span class="line">          value: .kube\|.bash_history</span><br><span class="line">        image: quay.k8s.org/quay/landlord.tenant:1.0.0</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        name: tenant</span><br><span class="line">        securityContext:</span><br><span class="line">          capabilities:</span><br><span class="line">            add:</span><br><span class="line">            - AUDIT_WRITE</span><br><span class="line">            - SYS_CHROOT</span><br><span class="line">            - CAP_NET_RAW</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /home/wk</span><br><span class="line">          name: wk</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">  - metadata:</span><br><span class="line">      name: wk</span><br><span class="line">    spec:</span><br><span class="line">      accessModes:</span><br><span class="line">      - ReadWriteOnce</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 1Gi</span><br><span class="line">      storageClassName: local-path</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f StatefulSet-landlord.tenant.yml</span><br><span class="line"></span><br><span class="line">$ kubectl get pods -n landlord</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">gateway-6898d75c8f-5f2rc   1/1     Running   0          101m</span><br><span class="line">logger-64d95c7ddd-wp46c    1/1     Running   0          73m</span><br><span class="line">tenant-0                   1/1     Running   0          33s</span><br><span class="line">tenant-1                   1/1     Running   0          27s</span><br><span class="line">tenant-2                   1/1     Running   0          20s</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it -n landlord tenant-0 -- bash</span><br><span class="line">bash-5.1<span class="comment"># which kubectl</span></span><br><span class="line">/usr/local/bin/kubectl</span><br><span class="line"></span><br><span class="line">bash-5.1<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it -n landlord tenant-1 -- bash</span><br><span class="line">bash-5.1<span class="comment"># which kubectl</span></span><br><span class="line">/usr/local/bin/kubectl</span><br><span class="line"></span><br><span class="line">bash-5.1<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it -n landlord tenant-2 -- bash</span><br><span class="line">bash-5.1<span class="comment"># which kubectl</span></span><br><span class="line">/usr/local/bin/kubectl</span><br><span class="line"></span><br><span class="line">bash-5.1<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/fD7I1xm.png"></p>
<h1 id="New"><a href="#New" class="headerlink" title="New"></a>New</h1><h2 id="檢視-Dockerfile-mariadb-v1-0-0"><a href="#檢視-Dockerfile-mariadb-v1-0-0" class="headerlink" title="檢視 Dockerfile.mariadb-v1.0.0"></a>檢視 Dockerfile.mariadb-v1.0.0</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> Dockerfile.mariadb-v1.0.0</span><br><span class="line">FROM quay.io/flysangel/mariadb</span><br><span class="line"></span><br><span class="line">COPY conf/mariadb/initdb/initdb.sql /docker-entrypoint-initdb.d</span><br></pre></td></tr></table></figure>

<ul>
<li>image 啟動時， 會先執行 <code>/docker-entrypoint-initdb.d</code> 底下的 <code>*.sql</code> 檔</li>
<li>這個功能只有 docker hub 做出來的 mariadb 做的 image 才有</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> conf/mariadb/initdb/initdb.sql</span><br><span class="line">CREATE TABLE IF NOT EXISTS <span class="built_in">history</span> (</span><br><span class="line">  Hostname VARCHAR(50),</span><br><span class="line">  Username VARCHAR(50),</span><br><span class="line">  Time VARCHAR(50),</span><br><span class="line">  Command VARCHAR(255)</span><br><span class="line">);</span><br><span class="line">CREATE TABLE IF NOT EXISTS inotify (</span><br><span class="line">  Hostname VARCHAR(50),</span><br><span class="line">  Time VARCHAR(50),</span><br><span class="line">  Event VARCHAR(20),</span><br><span class="line">  Path VARCHAR(255)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h2 id="檢視-Mariadb-YAML"><a href="#檢視-Mariadb-YAML" class="headerlink" title="檢視 Mariadb YAML"></a>檢視 Mariadb YAML</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mariadb</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">landlord</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mariadb</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mariadb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--character-set-server=utf8mb4</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--collation-server=utf8mb4_general_ci</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">root</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_DATABASE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">landlord</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_USER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">landlord</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MYSQL_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">mymariadblandlord</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TZ</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">Asia/Taipei</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/flysangel/landlord:mariadb-v1.0.0</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mariadb</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">mariadb</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mariadb</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">mariadb</span></span><br></pre></td></tr></table></figure>


<ul>
<li>ENV 的變數也是只有 docker hub 做出來的 mariadb 做的 image 才有</li>
<li>參考資料 : <a target="_blank" rel="noopener" href="https://hub.docker.com/_/mariadb">https://hub.docker.com/_/mariadb</a></li>
</ul>
<h2 id="實作-Mariadb"><a href="#實作-Mariadb" class="headerlink" title="實作 Mariadb"></a>實作 Mariadb</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman build -t $IP/myquay/landlord:mariadb-v1.0.0 -f Dockerfile.mariadb-v1.0.0</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-f, --file pathname or URL</code> ，pathname or URL of a Dockerfile</li>
</ul>
<h1 id="檢視-log-client"><a href="#檢視-log-client" class="headerlink" title="檢視 log_client"></a>檢視 log_client</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#set -x # debug mode</span></span><br><span class="line"><span class="built_in">set</span> -a <span class="comment"># var export</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create user</span></span><br><span class="line">KUSER=$(hostname)</span><br><span class="line">adduser -s /bin/bash -h /home/<span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span> -G wheel -u 1001 -D <span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span></span><br><span class="line">grep <span class="string">&#x27;^%wheel.*NOPASSWD.*ALL&#x27;</span> /etc/sudoers &gt;/dev/null || sed -i <span class="string">&#x27;/%wheel.*NOPASSWD/s/^# //&#x27;</span> /etc/sudoers</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>:<span class="variable">$&#123;KUSER&#125;</span>&quot;</span> | chpasswd</span><br><span class="line"><span class="keyword">if</span> [ -d /run/wk ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">ln</span> -s /run/wk /home/<span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span>/wk</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">mkdir</span> /home/<span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span>/wk</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">chown</span> -R <span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span>:wheel /home/<span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create kube config</span></span><br><span class="line">kubectl create namespace <span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span></span><br><span class="line">kubectl create serviceaccount <span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span> -n <span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span></span><br><span class="line">envsubst &lt;/bin/template/role.yaml | kubectl apply -f -</span><br><span class="line">kubectl create rolebinding <span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span> -n <span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span> --role=<span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span> --serviceaccount=<span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span>:<span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span></span><br><span class="line">envsubst &lt;/bin/template/secret.yaml | kubectl apply -f -</span><br><span class="line">CA=$(kubectl get secret <span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span> -n <span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span> -o jsonpath=<span class="string">&#x27;&#123;.data.ca\.crt&#125;&#x27;</span> | <span class="built_in">base64</span> -d)</span><br><span class="line">TOKEN=$(kubectl get secret <span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span> -n <span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span> -o jsonpath=<span class="string">&#x27;&#123;.data.token&#125;&#x27;</span> | <span class="built_in">base64</span> -d)</span><br><span class="line">serviceaccountpath=<span class="string">&#x27;/run/secrets/kubernetes.io/serviceaccount&#x27;</span></span><br><span class="line">umount <span class="variable">$&#123;serviceaccountpath&#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;CA&#125;</span>&quot;</span> | <span class="built_in">tee</span> <span class="variable">$&#123;serviceaccountpath&#125;</span>/ca.crt</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;TOKEN&#125;</span>&quot;</span> | <span class="built_in">tee</span> <span class="variable">$&#123;serviceaccountpath&#125;</span>/token</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;KUSER&#125;</span>&quot;</span> | <span class="built_in">tee</span> <span class="variable">$&#123;serviceaccountpath&#125;</span>/namespace</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">export KUBERNETES_SERVICE_HOST=<span class="variable">$&#123;KUBERNETES_SERVICE_HOST&#125;</span></span></span><br><span class="line"><span class="string">export KUBERNETES_SERVICE_PORT=<span class="variable">$&#123;KUBERNETES_SERVICE_PORT&#125;</span></span></span><br><span class="line"><span class="string">&quot;</span> | <span class="built_in">tee</span> -a /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># history collect</span></span><br><span class="line">sed -i <span class="string">&#x27;/HISTCONTROL\|HISTTIMEFORMAT\|PROMPT_COMMAND/d&#x27;</span> /etc/profile</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string">readonly HISTCONTROL=&#x27;&#x27;</span></span><br><span class="line"><span class="string">readonly HISTTIMEFORMAT=&#x27;|%Y-%m-%d %H:%M:%S|&#x27;</span></span><br><span class="line"><span class="string">readonly PROMPT_COMMAND=&#x27;echo HISTORY:\|\$(hostname)\|\$(whoami)\|\$(history 1) | timeout 0.1 nc <span class="variable">$&#123;LOG_SERVER&#125;</span>.<span class="variable">$&#123;NS&#125;</span> 5566; history -a; history -n&#x27;</span></span><br><span class="line"><span class="string">cd ~/wk</span></span><br><span class="line"><span class="string">&quot;</span> | <span class="built_in">tee</span> -a /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># filesystem collect</span></span><br><span class="line">inotifywait -rmq /home \</span><br><span class="line">  --format <span class="string">&#x27;|%T|%e|%w%f&#x27;</span> \</span><br><span class="line">  --timefmt <span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span> \</span><br><span class="line">  --event <span class="string">&#x27;modify,move,create,delete&#x27;</span> | <span class="keyword">while</span> <span class="built_in">read</span> -r line; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;line&#125;</span>&quot;</span> | grep -q <span class="string">&quot;<span class="variable">$&#123;EXCLUDE&#125;</span>&quot;</span> ||</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;INOTIFY:|<span class="subst">$(hostname)</span><span class="variable">$&#123;line&#125;</span>&quot;</span> | <span class="built_in">timeout</span> 0.1 nc <span class="string">&quot;<span class="variable">$&#123;LOG_SERVER&#125;</span>.<span class="variable">$&#123;NS&#125;</span>&quot;</span> 5566</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> +a <span class="comment"># var unexport</span></span><br></pre></td></tr></table></figure>






<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes-RBAC-Context/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes-RBAC-Context/" class="post-title-link" itemprop="url">Kubernetes-RBAC-Context</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-18 08:51:12" itemprop="dateCreated datePublished" datetime="2022-09-18T08:51:12+08:00">2022-09-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 18:14:24" itemprop="dateModified" datetime="2023-05-07T18:14:24+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-RBAC-Context"><a href="#Kubernetes-RBAC-Context" class="headerlink" title="Kubernetes-RBAC-Context"></a>Kubernetes-RBAC-Context</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><img src="https://i.imgur.com/TyAPgJl.png"></p>
<ul>
<li>Linux 系統可以讓多人同時協同作業，使用者登入後，工作目錄會在自己的家目錄。</li>
<li>在 K8S 的系統中，也能夠實現多使用者同時進入 K8S 的叢集做操作，登入 K8S 時，靠的是所在機器(Linux&#x2F;Windows 作業系統)的使用者家目錄下<code>~/.kube/config</code> 這個放憑證的檔案。</li>
<li>這個憑證會決定使用者在 K8S 可以進入哪個 Namespace ，可以”建立”還是”刪除”還是”查詢”物件…等。</li>
</ul>
<h2 id="K8S-Multi-Tenancy-管理套件"><a href="#K8S-Multi-Tenancy-管理套件" class="headerlink" title="K8S Multi-Tenancy 管理套件"></a>K8S Multi-Tenancy 管理套件</h2><p>下載老師準備好的環境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ cd; wget http://www.oc99.org/zip/k8suser.zip; unzip k8suser.zip; cd k8suser</span><br><span class="line"></span><br><span class="line">$ ls -l</span><br><span class="line">total 40</span><br><span class="line">-rw-r--r-- 1 bigred bigred  328 Apr  8 22:03 clusterbind.yaml</span><br><span class="line">-rw-r--r-- 1 bigred bigred  507 Apr  8 22:03 clusterole.yaml</span><br><span class="line">-rw-r--r-- 1 bigred bigred  269 Nov  1  2021 context.temp</span><br><span class="line">-rw-r--r-- 1 bigred bigred  277 Oct 30  2021 csr.yaml</span><br><span class="line">-rwxr-xr-x 1 bigred bigred   74 Apr  6 16:00 deluser.sh</span><br><span class="line">-rwxr-xr-x 1 bigred bigred  975 Apr  8 21:57 mkcontext.sh</span><br><span class="line">-rwxr-xr-x 1 bigred bigred 1045 Apr  6 16:01 mkubeuser.sh</span><br><span class="line">-rw-r--r-- 1 bigred bigred  986 Apr  7 17:30 role.temp</span><br><span class="line">-rw-r--r-- 1 bigred bigred  214 Apr  7 17:20 role.yaml</span><br><span class="line">-rw-r--r-- 1 bigred bigred  302 Oct 27  2021 rolebind.yaml</span><br></pre></td></tr></table></figure>

<h2 id="建立-K8S-User-及-憑証"><a href="#建立-K8S-User-及-憑証" class="headerlink" title="建立 K8S User 及 憑証"></a>建立 K8S User 及 憑証</h2><p>建立 bigboss 使用者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./mkubeuser.sh bigboss</span><br><span class="line">K8S bigboss created</span><br></pre></td></tr></table></figure>

<p>憑證放在 <code>kuser</code> 目錄</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ls -l kuser/</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 bigred bigred 1115 Sep 12 10:13 bigboss.crt</span><br><span class="line">-rw-r--r-- 1 bigred bigred  911 Sep 12 10:13 bigboss.csr</span><br><span class="line">-rw------- 1 bigred bigred 1675 Sep 12 10:13 bigboss.key</span><br></pre></td></tr></table></figure>

<ul>
<li><code>bigboss.key</code>，私鑰</li>
<li><code>bigboss.csr</code>，放的是使用者的資訊，包含私鑰，姓名和服務單位的資料</li>
<li><code>bigboss.crt</code>，K8S 根據你用 <code>bigboss.csr</code> 這個檔案申請認證後，產生的憑證檔<ul>
<li><code>crt</code> stand for <code>certificate</code></li>
</ul>
</li>
</ul>
<p>檢查 K8S 的所有使用者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config view | grep -A 10 -e &#x27;^users&#x27;</span><br><span class="line">users:</span><br><span class="line">- name: bigboss</span><br><span class="line">  user:</span><br><span class="line">    client-certificate: /home/bigred/k8suser/kuser/bigboss.crt</span><br><span class="line">    client-key: /home/bigred/k8suser/kuser/bigboss.key</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: REDACTED</span><br><span class="line">    client-key-data: REDACTED</span><br></pre></td></tr></table></figure>

<ul>
<li><code>REDACTED</code> ，表示沒有自己特別指定目錄將使用者登入資訊放在另一個檔案<ul>
<li>放在 <code>~/.kube/config</code> 這個檔案裡面</li>
</ul>
</li>
</ul>
<p>看 bigred 使用者在 K8S 系統的憑證</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ cat ~/.kube/config</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">  ...</span><br><span class="line">    server: https://192.168.61.4:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: bigboss</span><br><span class="line">  user:</span><br><span class="line">    client-certificate: /home/bigred/k8suser/kuser/bigboss.crt</span><br><span class="line">    client-key: /home/bigred/k8suser/kuser/bigboss.key</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data:</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li><code>clusters</code>，設定 K8S 叢集 (結尾是 s ，代表 K8S 的 Cluster 可以有很多個)<ul>
<li><code>cluster.server</code>，登入 K8S 的 IP 位址 : <code>https://192.168.61.4:6443</code></li>
<li><code>clusters.name</code>，K8S 叢集的名字 : <code>kubernetes</code></li>
</ul>
</li>
<li><code>contexts.</code>，設定 K8S 的入口 (結尾是 s ，代表 K8S 的入口可以有很多個)<ul>
<li><code>context.cluster</code>，入口在哪一個 K8S 叢集 ( 名字就叫 <code>kubernetes</code> )</li>
<li><code>context.user</code>，可以進入入口的使用者 : <code>kubernetes-admin</code></li>
<li><code>name</code>，入口的名字 : <code>kubernetes-admin@kubernetes</code></li>
</ul>
</li>
<li><code>current-context</code>，當前的入口 : <code>kubernetes-admin@kubernetes</code></li>
<li><code>kind: Config</code>，設定使用者登入的資訊</li>
<li>入口憑證檔的重點： <strong>當前的入口名字</strong>、<strong>哪位使用者可以進去</strong>、<strong>進到哪一個 K8S Cluster</strong></li>
</ul>
<h2 id="認識-Role-based-Access-Control"><a href="#認識-Role-based-Access-Control" class="headerlink" title="認識 Role-based Access Control"></a>認識 Role-based Access Control</h2><ol>
<li>Subjects: The set of users and processes that want to access the Kubernetes API.</li>
<li>Resources: The set of Kubernetes API Objects available in the cluster. Examples include Pods, Deployments, Services, Nodes, and PersistentVolumes, among others.</li>
<li>Verbs: The set of operations that can be executed to the resources above. Different verbs are available (examples: get, watch, create, delete, etc.), but ultimately all of them are Create, Read, Update or Delete (CRUD) operations.</li>
</ol>
<ul>
<li><code>Subject</code>，指的是 K8S 的 User (分為 User 和 ServiceAccount)<ul>
<li>Users: These are global, and meant for humans or processes living outside the cluster.<ul>
<li>人和 K8S Cluster <strong>外面</strong>的程序</li>
</ul>
</li>
<li>ServiceAccounts: These are namespaced and meant for intra-cluster processes running inside pods.<ul>
<li>在 K8S Cluster <strong>裡面</strong>的 pod 裡的程序</li>
</ul>
</li>
</ul>
</li>
<li><code>Resources</code>，指的是 K8S 的物件</li>
<li><code>Verbs</code>，指的是可以對 K8S 的物件做什麼動作<ul>
<li>像是可以看 pod 的資訊、新增 pod 或是 刪除 pod …等動作</li>
<li><code>watch</code>，是一直監控物件的狀態</li>
<li><code>get</code>，是看單一物件的狀態</li>
<li><code>list</code>，看單一種物件的狀態</li>
</ul>
</li>
</ul>
<h2 id="產生-Role"><a href="#產生-Role" class="headerlink" title="產生 Role"></a>產生 Role</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 檢視 RBAC 的版本</span><br><span class="line">$ kubectl api-versions | grep rbac</span><br><span class="line">rbac.authorization.k8s.io/v1</span><br><span class="line"></span><br><span class="line"># 建立 finance Namespace</span><br><span class="line">$ kubectl create namespace finance </span><br><span class="line"></span><br><span class="line"># 編輯 Role 的 yaml 檔</span><br><span class="line">$ echo $&#x27;kind: Role</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: finance   </span><br><span class="line">  name: finance-reader</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;] # &quot;&quot; indicates the core API group</span><br><span class="line">  resources: [&quot;pods&quot;, &quot;services&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;] &#x27; &gt; role.yaml</span><br><span class="line"></span><br><span class="line"># 建立 Role</span><br><span class="line">$ kubectl create -f role.yaml </span><br><span class="line">role.rbac.authorization.k8s.io/finance-reader created</span><br><span class="line"></span><br><span class="line"># 檢視 Role 資訊</span><br><span class="line">$ kubectl get roles --namespace=finance</span><br><span class="line">NAME             CREATED AT</span><br><span class="line">finance-reader   2020-10-21T13:48:50Z</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Role</code> ，設定一個 Namespace 裡對什麼物件可以有什麼動作</li>
<li><code>rules.resources</code>，主要設定 <code>pods</code> 和 <code>services</code> 的物件</li>
<li><code>rules.verbs</code>，針對剛剛的物件，設定動作 <code>get</code> 、 <code>watch</code> 和 <code>list</code></li>
</ul>
<h2 id="產生-RoleBinding"><a href="#產生-RoleBinding" class="headerlink" title="產生 RoleBinding"></a>產生 RoleBinding</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 建立 RoleBinding</span><br><span class="line">$ echo $&#x27;kind: RoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: finance-read-access</span><br><span class="line">  namespace: finance </span><br><span class="line">subjects:</span><br><span class="line">- kind: User</span><br><span class="line">  name: bigboss</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">roleRef:</span><br><span class="line">  kind: Role #this must be Role or ClusterRole</span><br><span class="line">  name: finance-reader </span><br><span class="line">  apiGroup: rbac.authorization.k8s.io &#x27; |  kubectl  apply  -f  -</span><br><span class="line"></span><br><span class="line"># 檢視 Rolebinding 資訊</span><br><span class="line">$ kubectl get rolebindings --namespace=finance</span><br><span class="line">NAME                  ROLE                  AGE</span><br><span class="line">finance-read-access   Role/finance-reader   8m13s</span><br></pre></td></tr></table></figure>

<ul>
<li><code>RoleBinding</code>，在單一 Namespace 中，將 Role 跟 K8S 的 User 綁在一起</li>
<li><code>subjects.kind</code>，設定 K8S User<ul>
<li><code>name: bigboss</code>，指定 K8S 的 bigboss User</li>
</ul>
</li>
<li><code>roleRef</code>，設定 Role 或是 ClusterRole<ul>
<li><code>name: finance-reader</code>，設定 <code>finance-reader</code> 這個 Role</li>
</ul>
</li>
</ul>
<h2 id="Create-Cluster-Role"><a href="#Create-Cluster-Role" class="headerlink" title="Create Cluster Role"></a>Create Cluster Role</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 建立 ClusterRole</span><br><span class="line">$ echo  $&#x27;kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  # &quot;namespace&quot; omitted since ClusterRoles are not namespaced</span><br><span class="line">  name: cluster-pods-reader</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;pods&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;] &#x27; | kubectl create -f  -</span><br><span class="line"></span><br><span class="line"># 檢查 ClusterRole 狀態</span><br><span class="line">$ kubectl get clusterroles | grep cluster-pods-reader</span><br><span class="line">NAME                 CREATED AT</span><br><span class="line">cluster-pods-reader  2022-09-12T03:41:26Z</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Cluster Role</code>，設定在全部的 Namespace 中對什麼物件可以有什麼動作</li>
<li><code>apiGroups</code>，有設定這個才能設定要限制 resource<ul>
<li><code>kubectl api-resources</code>，可以看 resources 在哪個 <code>apiGroups</code> 下</li>
</ul>
</li>
</ul>
<h2 id="Cluster-Role-Binding"><a href="#Cluster-Role-Binding" class="headerlink" title="Cluster Role Binding"></a>Cluster Role Binding</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># 建立 ClusterRoleBinding</span><br><span class="line">$ echo $&#x27;kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: read-cluster-pods</span><br><span class="line">subjects:</span><br><span class="line">- kind: User</span><br><span class="line">  name: bigboss  </span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">roleRef:</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-pods-reader</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io &#x27; | kubectl create -f  - </span><br><span class="line"></span><br><span class="line">$ kubectl get clusterrolebindings | grep read-cluster-pods</span><br><span class="line">NAME               ROLE                             AGE</span><br><span class="line">read-cluster-pods  ClusterRole/cluster-pods-reader  16s</span><br><span class="line"></span><br><span class="line">$ kubectl get pods --as=bigboss</span><br><span class="line">No resources found in default namespace</span><br></pre></td></tr></table></figure>

<ul>
<li><code>clusterRolebinding</code>，設定 K8S User (包含 service account)與 role 綁定而擁有存取權限</li>
</ul>
<h1 id="切換-K8S-Namespace"><a href="#切換-K8S-Namespace" class="headerlink" title="切換 K8S Namespace"></a>切換 K8S Namespace</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 執行以下命令, 可知目前使用的 K8S Context 的 namespace 沒有設定</span><br><span class="line"># 用的是預設 default 的 Namespace</span><br><span class="line">$ kubectl config get-contexts</span><br><span class="line">CURRENT   NAME                                CLUSTER      AUTHINFO      NAMESPACE</span><br><span class="line">*  kubernetes-admin@kubernetes   kubernetes   kubernetes-admin  </span><br><span class="line"></span><br><span class="line"># 只要從這個路口登入，Namespace 就會直接切換到 finance namespace</span><br><span class="line">$ kubectl config set-context $(kubectl config current-context) --namespace=finance</span><br><span class="line">Context &quot;kubernetes-admin@kubernetes&quot; modified.</span><br><span class="line"></span><br><span class="line"># 只會顯示 finance namespace 中的 POD</span><br><span class="line">$ kubectl get pods </span><br><span class="line">NAME         READY   STATUS    RESTARTS   AGE</span><br><span class="line">helloworld   1/1       Running   0          13h</span><br><span class="line"></span><br><span class="line"># 因內定為 finance namespace, 所以 bigboss 可以讀取</span><br><span class="line">$ kubectl get pods --as bigboss</span><br><span class="line">NAME         READY   STATUS    RESTARTS   AGE</span><br><span class="line">helloworld   1/1        Running   0         13h</span><br></pre></td></tr></table></figure>


<h2 id="切換回-K8S-Default-Namespace"><a href="#切換回-K8S-Default-Namespace" class="headerlink" title="切換回 K8S Default Namespace"></a>切換回 K8S Default Namespace</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 切換到 default namespace</span><br><span class="line">$ kubectl config set-context $(kubectl config current-context) --namespace=</span><br><span class="line">Context &quot;kubernetes-admin@kubernetes&quot; modified.</span><br><span class="line"></span><br><span class="line">$ kubectl get pods</span><br><span class="line">No resources found in default namespace.</span><br></pre></td></tr></table></figure>

<h1 id="建立-K8S-Context"><a href="#建立-K8S-Context" class="headerlink" title="建立 K8S Context"></a>建立 K8S Context</h1><p>建立 finance-context Context</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config set-context finance-context \</span><br><span class="line">--cluster=kubernetes --namespace=finance --user=bigboss</span><br></pre></td></tr></table></figure>

<ul>
<li><code>set-context  finance-context</code>，建立新的 K8S 的入口，後面接的是入口名稱 <code>finance-context</code></li>
<li><code>--cluster</code>，設定入口所在的 K8S 叢集</li>
<li><code>--namespace</code>，設定進入入口後的 Namespace</li>
<li><code>--user</code>，設定哪一個 K8S 的使用者可以進入新建立的入口</li>
</ul>
<p>檢視新的入口資訊</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config view | grep -A 10 contexts:</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    namespace: finance</span><br><span class="line">    user: bigboss</span><br><span class="line">  name: finance-context</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Contexts</code> 下面成功多了剛剛新建立的 <code>finance-context</code></li>
</ul>
<p>切換至 finance-context</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config use-context finance-context</span><br></pre></td></tr></table></figure>

<ul>
<li><code>use-context</code>，設定當前的入口</li>
</ul>
<p>在 finance-context 入口操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 檢視 nodes 資訊</span><br><span class="line">$ k get nodes</span><br><span class="line">Error from server (Forbidden): nodes is forbidden: User &quot;bigboss&quot; cannot list resource &quot;nodes&quot; in API group &quot;&quot; at the cluster scope</span><br><span class="line"></span><br><span class="line"># 檢視 pods 資訊</span><br><span class="line">$ k get pods</span><br><span class="line">NAME         READY   STATUS    RESTARTS   AGE</span><br><span class="line">helloworld   1/1     Running   0          124m</span><br><span class="line"></span><br><span class="line"># 檢視在 kube-system 中 pods 的資訊</span><br><span class="line">$ k get pods -n kube-system</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-565d847f94-rf5tn     1/1     Running   2          2d2h</span><br><span class="line">coredns-565d847f94-t5px2     1/1     Running   2          2d2h</span><br><span class="line">etcd-m1                      1/1     Running   2          2d2h</span><br><span class="line">kube-apiserver-m1            1/1     Running   2          2d2h</span><br><span class="line">kube-controller-manager-m1   1/1     Running   2          2d2h</span><br><span class="line">kube-proxy-2pgpr             1/1     Running   2          2d2h</span><br><span class="line">kube-proxy-fh9c2             1/1     Running   2          2d2h</span><br><span class="line">kube-proxy-qblhl             1/1     Running   2          2d2h</span><br><span class="line">kube-scheduler-m1            1/1     Running   2          2d2h</span><br></pre></td></tr></table></figure>


<h1 id="K8S-Multi-Tenancy-實作"><a href="#K8S-Multi-Tenancy-實作" class="headerlink" title="K8S Multi-Tenancy 實作"></a>K8S Multi-Tenancy 實作</h1><h2 id="前置動作"><a href="#前置動作" class="headerlink" title="前置動作"></a>前置動作</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir tmp; cd tmp</span><br><span class="line"></span><br><span class="line">$ unzip ~/k8suser.zip</span><br><span class="line"></span><br><span class="line">$ cp k8suser/*.yaml ~/k8suser/</span><br></pre></td></tr></table></figure>


<h2 id="建立-K8S-User-及-憑証-1"><a href="#建立-K8S-User-及-憑証-1" class="headerlink" title="建立 K8S User 及 憑証"></a>建立 K8S User 及 憑証</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ./mkubeuser.sh rbean</span><br><span class="line">K8S rbean created</span><br><span class="line"></span><br><span class="line">$ ls -lt kuser/</span><br><span class="line">total 24</span><br><span class="line">-rw-r--r-- 1 bigred bigred 1111 Sep 12 13:49 rbean.crt</span><br><span class="line">-rw-r--r-- 1 bigred bigred  907 Sep 12 13:49 rbean.csr</span><br><span class="line">-rw------- 1 bigred bigred 1679 Sep 12 13:49 rbean.key</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>檢查是否符合預期</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ k config view | grep -A12 -e &#x27;^users&#x27;</span><br><span class="line">users:</span><br><span class="line">- name: bigboss</span><br><span class="line">  user:</span><br><span class="line">    client-certificate: /home/bigred/k8suser/kuser/bigboss.crt</span><br><span class="line">    client-key: /home/bigred/k8suser/kuser/bigboss.key</span><br><span class="line">- name: kubernetes-admin</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: REDACTED</span><br><span class="line">    client-key-data: REDACTED</span><br><span class="line">- name: rbean</span><br><span class="line">  user:</span><br><span class="line">    client-certificate: /home/bigred/k8suser/kuser/rbean.crt</span><br><span class="line">    client-key: /home/bigred/k8suser/kuser/rbean.key</span><br></pre></td></tr></table></figure>

<p>建立 rbean 使用者的入口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ ./mkcontext.sh rbean</span><br><span class="line">namespace/rbean created</span><br><span class="line">- context:</span><br><span class="line">    cluster: default</span><br><span class="line">    namespace: rbean</span><br><span class="line">    user: rbean</span><br><span class="line">  name: rbean-context</span><br><span class="line">Warning: resource roles/finance-reader is missing the kubectl.kubernetes.io/last-applied-configuration annotation which is required by kubectl apply. kubectl apply should only be used on resources created declaratively by either kubectl create --save-config or kubectl apply. The missing annotation will be patched automatically.</span><br><span class="line">role.rbac.authorization.k8s.io/finance-reader configured</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/rbean-rbind created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/rbean-clusterole created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/rbean-clusterbind created</span><br></pre></td></tr></table></figure>

<p>檢查</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.61.4:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">...</span><br><span class="line">- context:</span><br><span class="line">    cluster: default</span><br><span class="line">    namespace: rbean</span><br><span class="line">    user: rbean</span><br><span class="line">  name: rbean-context</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br><span class="line">...</span><br></pre></td></tr></table></figure>


<p>檢視 <code>mkubeuser.sh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> STU=<span class="variable">$&#123;1&#125;</span></span><br><span class="line"><span class="built_in">export</span> DIR_CSR=~/k8suser/kuser</span><br><span class="line"></span><br><span class="line">[ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> != <span class="string">&quot;1&quot;</span> ] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;mkubeuser.sh user&quot;</span> &amp;&amp; <span class="built_in">exit</span> 1</span><br><span class="line">[ ! -d <span class="variable">$&#123;DIR_CSR&#125;</span> ] &amp;&amp; <span class="built_in">mkdir</span> -p <span class="variable">$&#123;DIR_CSR&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">which</span> envsubst &amp;&gt;/dev/null</span><br><span class="line">[ $? = 1 ] &amp;&amp; sudo apk update &amp;&amp; sudo apk add gettext &amp;&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="variable">$&#123;DIR_CSR&#125;</span>/<span class="variable">$&#123;STU&#125;</span>.key ]; <span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;K8S <span class="variable">$&#123;STU&#125;</span> existed&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   openssl genrsa -out <span class="variable">$&#123;DIR_CSR&#125;</span>/<span class="variable">$&#123;STU&#125;</span>.key 2048 &amp;&gt;/dev/null</span><br><span class="line">   openssl req -new -key <span class="variable">$&#123;DIR_CSR&#125;</span>/<span class="variable">$&#123;STU&#125;</span>.key -out <span class="variable">$&#123;DIR_CSR&#125;</span>/<span class="variable">$&#123;STU&#125;</span>.csr -subj <span class="string">&quot;/CN=<span class="variable">$&#123;STU&#125;</span>/O=<span class="variable">$&#123;STU&#125;</span>&quot;</span></span><br><span class="line">   <span class="built_in">export</span> BASE64_CSR=$(<span class="built_in">cat</span> <span class="variable">$&#123;DIR_CSR&#125;</span>/<span class="variable">$&#123;STU&#125;</span>.csr | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">   <span class="built_in">cat</span> ~/k8suser/csr.yaml | envsubst | kubectl apply -f - &amp;&gt;/dev/null</span><br><span class="line">   kubectl certificate approve <span class="variable">$&#123;STU&#125;</span>-csr &amp;&gt;/dev/null</span><br><span class="line">   <span class="built_in">sleep</span> 5</span><br><span class="line">   kubectl get csr <span class="variable">$&#123;STU&#125;</span>-csr -o jsonpath=<span class="string">&#x27;&#123;.status.certificate&#125;&#x27;</span> | <span class="built_in">base64</span> -d &gt; <span class="variable">$&#123;DIR_CSR&#125;</span>/<span class="variable">$&#123;STU&#125;</span>.crt</span><br><span class="line">   kubectl config set-credentials <span class="variable">$&#123;STU&#125;</span> --client-certificate=<span class="variable">$&#123;DIR_CSR&#125;</span>/<span class="variable">$&#123;STU&#125;</span>.crt --client-key=<span class="variable">$&#123;DIR_CSR&#125;</span>/<span class="variable">$&#123;STU&#125;</span>.key &amp;&gt;/dev/null</span><br><span class="line">   kubectl config view | grep <span class="string">&quot;name: <span class="variable">$&#123;STU&#125;</span>&quot;</span> &amp;&gt;/dev/null</span><br><span class="line">   [ <span class="string">&quot;$?&quot;</span> == <span class="string">&quot;0&quot;</span> ] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;K8S <span class="variable">$&#123;STU&#125;</span> created&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<h2 id="檢視-K8S-User-Context"><a href="#檢視-K8S-User-Context" class="headerlink" title="檢視 K8S User Context"></a>檢視 K8S User Context</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ cat kuser/rbean.conf</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUMvakNDQWVhZ0F</span><br><span class="line">........</span><br><span class="line">    server: https://192.168.61.4:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    namespace: rbean</span><br><span class="line">    user: rbean</span><br><span class="line">  name: rbean-context</span><br><span class="line">current-context: rbean-context</span><br><span class="line">........</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: rbean</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCakNDQWU2Z0F..........</span><br><span class="line">    client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0........</span><br></pre></td></tr></table></figure>

<ul>
<li><code>client-certificate-data</code> 存放 公鑰 的憑証檔</li>
<li><code>client-key-data</code> ，存放使用者的 私鑰</li>
</ul>
<h2 id="檢視-Namespace-RBAC-設定"><a href="#檢視-Namespace-RBAC-設定" class="headerlink" title="檢視 Namespace RBAC 設定"></a>檢視 Namespace RBAC 設定</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get role -n rbean</span><br><span class="line">NAME         CREATED AT</span><br><span class="line">rbean-role   2022-04-08T14:50:29Z</span><br><span class="line"></span><br><span class="line">$ kubectl get clusterrole -n rbean | grep rbean</span><br><span class="line">rbean-clusterole   2022-04-08T14:50:29Z</span><br><span class="line"></span><br><span class="line">$ kubectl describe role rbean-role -n rbean</span><br><span class="line">Name:         rbean-clusterole</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources                         Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------                         -----------------  --------------  -----</span><br><span class="line">  csidrivers.storage.k8s.io         []                 []              [*]</span><br><span class="line">  csinodes.storage.k8s.io           []                 []              [*]</span><br><span class="line">  storageclasses.storage.k8s.io     []                 []              [*]</span><br><span class="line">  volumeattachments.storage.k8s.io  []                 []              [*]</span><br><span class="line">  nodes                             []                 []              [create delete deletecollection get list patch update watch]</span><br><span class="line">  persistentvolumes                 []                 []              [create delete deletecollection get list patch update watch]</span><br></pre></td></tr></table></figure>

<h2 id="建立-Linux-User-及-設定-K8S-憑証"><a href="#建立-Linux-User-及-設定-K8S-憑証" class="headerlink" title="建立 Linux User 及 設定 K8S 憑証"></a>建立 Linux User 及 設定 K8S 憑証</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ echo -e &quot;rbean\nrbean&quot; | sudo adduser rbean</span><br><span class="line"></span><br><span class="line">$ sudo mkdir /home/rbean/.kube; sudo cp ~/k8suser/kuser/rbean.conf /home/rbean/.kube/config; sudo chown -R rbean:rbean /home/rbean/.kube</span><br><span class="line"></span><br><span class="line">$ dir /home/rbean/.kube</span><br><span class="line">total 16K</span><br><span class="line">drwxr-sr-x 2 rbean rbean 4.0K Apr  7 10:00 .</span><br><span class="line">drwxr-sr-x 3 rbean rbean 4.0K Apr  7 10:00 ..</span><br><span class="line">-rw-r--r-- 1 rbean rbean 5.5K Apr  7 10:00 config</span><br><span class="line"></span><br><span class="line">$ exit</span><br></pre></td></tr></table></figure>

<ul>
<li><code>/home/rbean/.kube/config</code>，這個檔案為路口憑證檔</li>
</ul>
<h2 id="檢視-K8S-User-憑証"><a href="#檢視-K8S-User-憑証" class="headerlink" title="檢視 K8S User 憑証"></a>檢視 K8S User 憑証</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">在 Windows 系統的 cmd 視窗, 執行以下命令</span><br><span class="line">$ ssh rbean@&lt;alp.m1 IP&gt;</span><br><span class="line"></span><br><span class="line">$ kubectl config view</span><br><span class="line">apiVersion: v1</span><br><span class="line">clusters:</span><br><span class="line">- cluster:</span><br><span class="line">    certificate-authority-data: DATA+OMITTED</span><br><span class="line">    server: https://192.168.61.4:6443</span><br><span class="line">  name: kubernetes</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    namespace: rbean</span><br><span class="line">    user: rbean</span><br><span class="line">  name: rbean-context</span><br><span class="line">current-context: rbean-context</span><br><span class="line">kind: Config</span><br><span class="line">preferences: &#123;&#125;</span><br><span class="line">users:</span><br><span class="line">- name: rbean</span><br><span class="line">  user:</span><br><span class="line">    client-certificate-data: REDACTED</span><br><span class="line">    client-key-data: REDACTED</span><br></pre></td></tr></table></figure>

<h2 id="測試-K8S-User-憑証"><a href="#測試-K8S-User-憑証" class="headerlink" title="測試 K8S User 憑証"></a>測試 K8S User 憑証</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ kg all</span><br><span class="line">No resources found in rbean namespace.</span><br><span class="line">$ kg pv</span><br><span class="line">No resources found</span><br><span class="line">$ kg sc</span><br><span class="line">No resources found</span><br><span class="line"></span><br><span class="line">$ kubectl run a1 --rm -it --image=quay.io/cloudwalker/alpine</span><br><span class="line">If you don&#x27;t see a command prompt, try pressing enter.</span><br><span class="line">/ # ping -c 1 www.hinet.net</span><br><span class="line">PING www.hinet.net (163.28.83.113): 56 data bytes</span><br><span class="line">ping: permission denied (are you root?)</span><br><span class="line">/ # exit</span><br><span class="line"></span><br><span class="line">$ exit</span><br></pre></td></tr></table></figure>


<h1 id="bobo-網站應用系統"><a href="#bobo-網站應用系統" class="headerlink" title="bobo 網站應用系統"></a>bobo 網站應用系統</h1><h2 id="佈署-bobo-網站應用系統"><a href="#佈署-bobo-網站應用系統" class="headerlink" title="佈署 bobo 網站應用系統"></a>佈署 bobo 網站應用系統</h2><p>在 bigred 終端機, 執行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://www.oc99.org/zip/bobowas.zip; unzip bobowas.zip</span><br><span class="line"></span><br><span class="line"># 佈署 alp.mysql, alp.goweb 及 alp.myfbs image</span><br><span class="line">$ cd ~/bobowas/k8simg/</span><br><span class="line"></span><br><span class="line">$ ./go-k8s-images.sh</span><br><span class="line">[images build]</span><br><span class="line">alp.myfbs image ok</span><br><span class="line">alp.mysql image ok</span><br><span class="line">alp.goweb image ok</span><br><span class="line"></span><br><span class="line">[images deploy]</span><br><span class="line">w1: localhost/alp.myfbs image ok</span><br><span class="line">w2: localhost/alp.myfbs image ok</span><br><span class="line"></span><br><span class="line">w1: localhost/alp.mysql image ok</span><br><span class="line">w2: localhost/alp.mysql image ok</span><br><span class="line"></span><br><span class="line">w1: localhost/alp.goweb image ok</span><br><span class="line">w2: localhost/alp.goweb image ok</span><br></pre></td></tr></table></figure>

<p>在 rbean 終端機, 執行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://www.oc99.org/zip/bobowas.zip; unzip bobowas.zip</span><br><span class="line"></span><br><span class="line">$ cd /home/bigred/bobowas/k8sobj/</span><br><span class="line"></span><br><span class="line">$ ./go-k8s-object.sh</span><br><span class="line">bobo.fbs(w1) pod created</span><br><span class="line">bobo.mysql(w2) pod created</span><br><span class="line">bobo.goweb(w1) pod created</span><br><span class="line">bobo.gosvc service created</span><br><span class="line"></span><br><span class="line">$ kg all</span><br><span class="line">NAME                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/bobo.fbs         1/1       Running    0               15s</span><br><span class="line">pod/bobo.goweb    1/1       Running    0               15s</span><br><span class="line">pod/bobo.mysql    1/1        Running    0               15s</span><br><span class="line"></span><br><span class="line">NAME                   TYPE        CLUSTER-IP    EXTERNAL-IP    PORT(S)   AGE</span><br><span class="line">service/svc-gosrv   ClusterIP  10.98.0.237  192.168.61.4   80/TCP   15s</span><br></pre></td></tr></table></figure>


<h1 id="K8S-Namespace-Resource-Quota"><a href="#K8S-Namespace-Resource-Quota" class="headerlink" title="K8S Namespace Resource Quota"></a>K8S Namespace Resource Quota</h1><p>在 bigred 終端機, 執行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano ~/bobowas/k8sobj/nsrq.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">compute-quota</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">rbean</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">requests.cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="attr">requests.memory:</span> <span class="string">256Mi</span></span><br><span class="line">    <span class="attr">requests.nvidia.com/gpu:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">limits.cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">limits.memory:</span> <span class="string">1Gi</span></span><br><span class="line">    <span class="attr">limits.nvidia.com/gpu:</span> <span class="number">2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">object-quota</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">rbean</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">pods:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line">    <span class="attr">configmaps:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">persistentvolumeclaims:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">replicationcontrollers:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">secrets:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="attr">services:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="attr">services.loadbalancers:</span> <span class="string">&quot;2&quot;</span></span><br></pre></td></tr></table></figure>

<p>產生 resourcequota</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ka -f nsrq.yaml</span><br></pre></td></tr></table></figure>

<h2 id="檢視-Resource-Quota"><a href="#檢視-Resource-Quota" class="headerlink" title="檢視 Resource Quota"></a>檢視 Resource Quota</h2><p>在 rbean 終端機, 執行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get resourcequotas</span><br><span class="line">NAME            AGE     REQUEST                                                                                                                                            LIMIT</span><br><span class="line">compute-quota   2m36s   requests.cpu: 0/1, requests.memory: 0/256Mi, requests.nvidia.com/gpu: 0/1                                                                          limits.cpu: 0/2, limits.memory: 0/1Gi, limits.nvidia.com/gpu: 0/2</span><br><span class="line">object-quota    2m36s   configmaps: 1/2, persistentvolumeclaims: 0/2, pods: 3/3, replicationcontrollers: 0/2, secrets: 0/10, services: 1/10, services.loadbalancers: 0/2</span><br></pre></td></tr></table></figure>

<ul>
<li>Resource Quota 建立後，並不會限制已經建立的 pod 。</li>
</ul>
<p>產生 a1 的 pod 測試有沒有被限制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run a1 --rm -it --image=quay.io/cloudwalker/alpine</span><br><span class="line">Error from server (Forbidden): pods &quot;a1&quot; is forbidden: failed quota: compute-quota: must specify limits.cpu for: a1; limits.memory for: a1; requests.cpu for: a1; requests.memory for: a1</span><br></pre></td></tr></table></figure>

<ul>
<li>錯誤訊息說明 : 建立 pod 時，要設定使用的資源</li>
</ul>
<p>重新編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run a1 --image=quay.io/cloudwalker/alpine --dry-run=client -o yaml &gt; pod.yaml</span><br></pre></td></tr></table></figure>

<p>編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano pod.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">a1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">a1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/alpine</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">a1</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">         <span class="attr">cpu:</span> <span class="number">1.0</span></span><br><span class="line">         <span class="attr">memory:</span> <span class="string">256Mi</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">         <span class="attr">cpu:</span> <span class="number">2.0</span></span><br><span class="line">         <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>再重新產生 pod </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f pod.yaml</span><br><span class="line">Error from server (Forbidden): error when creating &quot;pod.yaml&quot;: pods &quot;a1&quot; is forbidden: exceeded quota: object-quota, requested: pods=1, used: pods=3, limited: pods=3</span><br></pre></td></tr></table></figure>

<ul>
<li>這時候噴的錯誤就是超過 resourcequota 的限制</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes-Resource-CPU-Memory/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes-Resource-CPU-Memory/" class="post-title-link" itemprop="url">Kubernetes-Resource-CPU-Memory</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-18 05:14:58" itemprop="dateCreated datePublished" datetime="2022-09-18T05:14:58+08:00">2022-09-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 16:15:42" itemprop="dateModified" datetime="2023-05-07T16:15:42+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-Resource-CPU-Memory"><a href="#Kubernetes-Resource-CPU-Memory" class="headerlink" title="Kubernetes-Resource-CPU-Memory"></a>Kubernetes-Resource-CPU-Memory</h1><p>:::warning</p>
<p>:::spoiler 目錄</p>
<p>[TOC]</p>
<p>:::</p>
<h2 id="Assigning-Pods-to-Nodes"><a href="#Assigning-Pods-to-Nodes" class="headerlink" title="Assigning Pods to Nodes"></a>Assigning Pods to Nodes</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"># 檢視所有 node 的 labels</span><br><span class="line">$ kubectl get nodes --show-labels</span><br><span class="line"></span><br><span class="line"># 編輯 nodeselect 的 yaml 檔</span><br><span class="line">$ echo &#x27;apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: p1</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: c1</span><br><span class="line">    image: quay.io/cloudwalker/busybox</span><br><span class="line">    imagePullPolicy: Never</span><br><span class="line">    tty: true</span><br><span class="line">  nodeSelector:</span><br><span class="line">    kubernetes.io/hostname : m1 &#x27;&gt; ~/wulin/yaml/nodeselect.yaml </span><br><span class="line">    </span><br><span class="line"># apply 它</span><br><span class="line">$ kubectl apply -f  ~/wulin/yaml/nodeselect.yaml </span><br><span class="line">pod/p1 created</span><br><span class="line"></span><br><span class="line"># 檢查是否跑在 m1 這台指定的 node 上</span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE   IP           NODE    NOMINATED NODE   READINESS GATES</span><br><span class="line">p1     1/1     Running   0          35s   10.233.2.2           m1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># 刪除 p1 pod</span><br><span class="line">$ kubectl delete pods p1</span><br><span class="line">pod &quot;p1&quot; deleted</span><br><span class="line"></span><br><span class="line"># 編輯 depnode 的 yaml 檔</span><br><span class="line">$ nano ~/wulin/yaml/depnode.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: depnode</span><br><span class="line">  labels:</span><br><span class="line">    app: depnode</span><br><span class="line">spec:</span><br><span class="line">  replicas: 4</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: depnode</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: depnode</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: alp</span><br><span class="line">        image: quay.io/cloudwalker/alpine</span><br><span class="line">        tty: true</span><br><span class="line"></span><br><span class="line">$ ka  -f  ~/wulin/yaml/depnode.yaml</span><br><span class="line"></span><br><span class="line">$ kg pods -o wide --selector app=depnode</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE    IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">depnode-7789fd7db7-2h6t5   1/1     Running   0       5m4s   10.244.2.12   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">depnode-7789fd7db7-2vc6s   1/1     Running   0       5m4s   10.244.0.10   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">depnode-7789fd7db7-vl6g2   1/1     Running   0        5m4s   10.244.1.11   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">depnode-7789fd7db7-z4zxr   1/1     Running   0        5m4s   10.244.1.12   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ kd -f ~/wulin/yaml/depnode.yaml</span><br><span class="line"></span><br><span class="line">$ nano ~/wulin/yaml/depnode.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">.......</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: alp</span><br><span class="line">        image: quay.io/cloudwalker/alpine</span><br><span class="line">        tty: true</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">          - labelSelector:</span><br><span class="line">              matchExpressions:</span><br><span class="line">              - key: app</span><br><span class="line">                operator: In</span><br><span class="line">                values:</span><br><span class="line">                - depnode</span><br><span class="line">            topologyKey: kubernetes.io/hostname</span><br><span class="line"></span><br><span class="line">$ ka  -f  ~/wulin/yaml/depnode.yaml</span><br><span class="line"></span><br><span class="line">$ kg pods -o wide --selector app=depnode</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">depnode-7c65d66984-6cplq   1/1     Running   0          25s   10.244.2.13   w2       &lt;none&gt;           &lt;none&gt;</span><br><span class="line">depnode-7c65d66984-hgbs5   1/1     Running   0          25s   10.244.0.11   m1       &lt;none&gt;           &lt;none&gt;</span><br><span class="line">depnode-7c65d66984-pb9f9   0/1     Pending   0          25s   &lt;none&gt;        &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">depnode-7c65d66984-qj7g4   1/1     Running   0          25s   10.244.1.13   w1       &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ kd -f ~/wulin/yaml/depnode.yaml</span><br></pre></td></tr></table></figure>


<h1 id="Metrics-Server"><a href="#Metrics-Server" class="headerlink" title="Metrics Server"></a>Metrics Server</h1><p><strong>安裝 Metrics Server</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span><br><span class="line"></span><br><span class="line">$ nano components.yaml</span><br><span class="line">..........</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - --cert-dir=/tmp</span><br><span class="line">        - --secure-port=4443</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span><br><span class="line">        - --kubelet-use-node-status-port</span><br><span class="line">        - --metric-resolution=15s</span><br><span class="line">        - --kubelet-insecure-tls</span><br><span class="line">        image: k8s.gcr.io/metrics-server/metrics-server:v0.6.1</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f components.yaml</span><br></pre></td></tr></table></figure>

<ul>
<li><code>- --kubelet-insecure-tls</code> ，所有 K8S 在網路上運作傳輸的封包和資料都會進行加密</li>
</ul>
<p>檢視 Worker Node 資源使用狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl top nodes</span><br><span class="line">NAME   CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span><br><span class="line">m1       84m             4%        603Mi                7%</span><br><span class="line">w1       26m             1%        496Mi                6%</span><br><span class="line">w2       27m             1%        459Mi                5%</span><br></pre></td></tr></table></figure>

<ul>
<li>CPU 的單位 : milliCPU</li>
<li>1 core &#x3D; 1000m</li>
<li>m1 node 比較忙的原因是因為它裡面跑的 pod 都是在做系統維運的</li>
</ul>
<p>檢視 pod 的資源使用狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl top pods -n bobo</span><br><span class="line">NAME         CPU(cores)   MEMORY(bytes)</span><br><span class="line">bobo.fbs     0m           3Mi</span><br><span class="line">bobo.goweb   1m           1Mi</span><br><span class="line">bobo.mysql   7m           289Mi</span><br></pre></td></tr></table></figure>

<h3 id="Rsource-Requests-amp-Limits"><a href="#Rsource-Requests-amp-Limits" class="headerlink" title="Rsource Requests &amp; Limits"></a>Rsource Requests &amp; Limits</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: podres</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: podres</span><br><span class="line">    image: quay.io/cloudwalker/alpine</span><br><span class="line">    command: [&quot;/usr/bin/yes&quot;]</span><br><span class="line">    resources:</span><br><span class="line">       requests:</span><br><span class="line">          cpu: 100m</span><br><span class="line">          memory: 640M</span><br><span class="line">       limits:</span><br><span class="line">          cpu: 500m&#x27;&gt; ~/wulin/yaml/resource.yaml </span><br><span class="line"></span><br><span class="line">$ kubectl apply -f  ~/wulin/yaml/resource.yaml</span><br></pre></td></tr></table></figure>


<h1 id="Horizontal-Pod-Autoscaler"><a href="#Horizontal-Pod-Autoscaler" class="headerlink" title="Horizontal Pod Autoscaler"></a>Horizontal Pod Autoscaler</h1><p>The Horizontal Pod Autoscaler is implemented as a control loop, with a period controlled by the controller manager’s –horizontal-pod-autoscaler-sync-period flag (with a default value of 15 seconds)</p>
<ul>
<li>HPA 一定會透過 Metrics Server 來得到 Deployment 的 pod 現在使用資源的狀態</li>
</ul>
<p>建立 Horizontal Pod Autoscaler</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir ~/wulin/hpa; cd ~/wulin/hpa</span><br><span class="line"></span><br><span class="line">$ nano hpa-dep.yaml</span><br></pre></td></tr></table></figure>

<p>編輯 yaml 檔</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hpa-dep</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">hpa.pod</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">hpa.pod</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alp</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/alpine</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<ul>
<li>單位 m 指的是 milli-cores，每 1000m &#x3D; 1 vCore</li>
<li>設定可以用 m 或分數，例如：</li>
<li>設定 0.5 &#x3D; 500m</li>
<li>設定 300m &#x3D; 0.3</li>
<li>這裡設定的 1 代表的是 1000m，代表 1 個 pod 只能使用一顆 vCore 的運算資源</li>
</ul>
<p>編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano hpa-sp.yml </span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">hpa-sp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">hpa-dep</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">targetCPUUtilizationPercentage:</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>scaleTargetRef:</code>，要監控的對象</li>
<li><code>minReplicas: 2</code>，擴充的 pod 最少會有兩個</li>
<li><code>maxReplicas: 5</code>，擴充的 pod 最多只能有五個</li>
<li><code>targetCPUUtilizationPercentage: 30</code>，設定 30% 代表 HPA 將會維持 Pod 的平均 CPU 使用率為 30 %，只要超出 30%，即會自動擴展</li>
</ul>
<p><strong>建立與檢測 Horizontal Pod Autoscaler</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f  .</span><br><span class="line">deployment.apps/hpa-dep created</span><br><span class="line">horizontalpodautoscaler.autoscaling/hpa-sp created</span><br><span class="line"></span><br><span class="line">$ kubectl get pods</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">hpa-dep-765c997fc8-6vbmd   1/1     Running   0          22s</span><br><span class="line">hpa-dep-765c997fc8-g9kgd   1/1     Running   0          22</span><br><span class="line"></span><br><span class="line">$ kubectl get hpa --watch</span><br><span class="line">NAME     REFERENCE            TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">hpa-sp   Deployment/hpa-dep   0%/30%    2         5         2          4m47s</span><br><span class="line">hpa-sp   Deployment/hpa-dep   0%/30%    2         5         2          5m16s</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 開啟新的 命令提示字元 視窗</span><br><span class="line">$ ssh bigred@&lt;m1 node ip&gt;</span><br><span class="line"></span><br><span class="line">$ kg pod</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">hpa-dep-765c997fc8-6vbmd   1/1     Running   0          7m21s</span><br><span class="line">hpa-dep-765c997fc8-g9kgd   1/1     Running   0          7m21s</span><br><span class="line"></span><br><span class="line">$ kubectl exec hpa-dep-765c997fc8-6vbmd -- timeout 240 yes &gt;/dev/null &amp;</span><br><span class="line">$ kubectl exec hpa-dep-765c997fc8-g9kgd -- timeout 240 yes &gt;/dev/null &amp;</span><br></pre></td></tr></table></figure>

<ul>
<li>利用 <code>yes</code> 命令會霸佔 CPU 的特性，來測試 HPA</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get hpa --watch</span><br><span class="line">NAME     REFERENCE            TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">hpa-sp   Deployment/hpa-dep   0%/30%    2         5         2          25m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   33%/30%   2         5         2          25m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   56%/30%   2         5         3          26m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   56%/30%   2         5         4          26m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   55%/30%   2         5         4          26m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   56%/30%   2         5         4          27m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   56%/30%   2         5         4          27m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   56%/30%   2         5         4          27m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   57%/30%   2         5         4          27m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   57%/30%   2         5         4          28m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   56%/30%   2         5         4          28m</span><br><span class="line">hpa-sp   Deployment/hpa-dep   57%/30%   2         5         4          28m</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到 <code>REPLICAS</code> 擴充為 4</li>
</ul>
<p>檢查 pod 有沒有 running</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">hpa-dep-765c997fc8-6vbmd   1/1     Running   0          26m</span><br><span class="line">hpa-dep-765c997fc8-7rdcm   0/1     Pending   0          38s</span><br><span class="line">hpa-dep-765c997fc8-g9kgd   1/1     Running   0          26m</span><br><span class="line">hpa-dep-765c997fc8-wvvm2   0/1     Pending   0          23s</span><br></pre></td></tr></table></figure>

<p>為何擴充的 pod 都是 pending ?<br>用 <code>kubectl describe</code> 看一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe pods hpa-dep-765c997fc8-7rdcm</span><br><span class="line">Name:           hpa-dep-765c997fc8-7rdcm</span><br><span class="line">...</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age   From               Message</span><br><span class="line">  ----     ------            ----  ----               -------</span><br><span class="line">  Warning  FailedScheduling  53s   default-scheduler  0/5 nodes are available: 2 Insufficient cpu, 3 node(s) had untolerated taint &#123;node-role.kubernetes.io/master: &#125;. preemption: 0/5 nodes are available: 2 No preemption victims found for incoming pod, 3 Preemption is not helpful for scheduling.</span><br></pre></td></tr></table></figure>

<ul>
<li>錯誤訊息說明，已經沒有 node 上有足夠的 CPU 讓 pod run，因為我們是用 VM 來 run K8S ，設定給 VM 用的 CPU 只有 2 Core</li>
<li>雖然 K8S 的 HPA 能自動幫我們橫向擴充 pod ，但是硬體資源 (CPU) 不夠力，擴充出來的 pod 也沒辦法 run，所以要特別注意。</li>
</ul>
<p>可以根據 <code>kubectl top</code>來檢視 node 使用資源狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ k top nodes</span><br><span class="line">NAME   CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span><br><span class="line">m1     1102m        55%    869Mi           11%</span><br><span class="line">m2     270m         13%    803Mi           10%</span><br><span class="line">m3     240m         12%    695Mi           8%</span><br><span class="line">w1     1372m        68%    265Mi           3%</span><br><span class="line">w2     1396m        69%    644Mi           8%</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到 w1 和 w2 node 的 CPU 使用率都飆到將近 70 % ，已經沒有足夠的運算資源，再讓多的 pod run 了，所以才會顯示 pending 的狀態</li>
</ul>
<p>刪除 deployment 和 hpa</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kd -f hpa-dep.yaml</span><br><span class="line">$ kd -f hpa-sp.yml</span><br></pre></td></tr></table></figure>

<p>修改 pod 可以使用的 CPU 運作資源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano hpa-dep.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="string">...</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">400m</span></span><br></pre></td></tr></table></figure>

<ul>
<li>將最後的 CPU 設成 400m</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano hpa-sp.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line">  <span class="attr">targetCPUUtilizationPercentage:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<ul>
<li>將 <code>targetCPUUtilizationPercentage</code> 的值改成 10</li>
</ul>
<p>再次產生物件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ka -f .</span><br><span class="line">deployment.apps/hpa-dep created</span><br><span class="line">horizontalpodautoscaler.autoscaling/hpa-sp created</span><br><span class="line"></span><br><span class="line">$ kg hpa --watch</span><br><span class="line">NAME     REFERENCE            TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">hpa-sp   Deployment/hpa-dep   0%/10%    2         5         2          47s</span><br></pre></td></tr></table></figure>

<p>在另一個終端機，檢視</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kg pod</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">hpa-dep-6f5bd9dd57-ggs9b   1/1     Running   0          56s</span><br><span class="line">hpa-dep-6f5bd9dd57-kmxmb   1/1     Running   0          56s</span><br></pre></td></tr></table></figure>

<p>讓 pod 飆 yes</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec hpa-dep-6f5bd9dd57-ggs9b -- timeout 240 yes &gt;/dev/null &amp;</span><br><span class="line">$ kubectl exec hpa-dep-6f5bd9dd57-kmxmb -- timeout 240 yes &gt;/dev/null &amp;</span><br></pre></td></tr></table></figure>

<p>回原來的終端機</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kg hpa --watch</span><br><span class="line">NAME     REFERENCE            TARGETS   MINPODS   MAXPODS   REPLICAS   AGE</span><br><span class="line">hpa-sp   Deployment/hpa-dep   0%/10%    2         5         2          47s</span><br><span class="line">hpa-sp   Deployment/hpa-dep   3%/10%    2         5         2          3m15s</span><br><span class="line">hpa-sp   Deployment/hpa-dep   69%/10%   2         5         2          3m31s</span><br><span class="line">hpa-sp   Deployment/hpa-dep   100%/10%   2         5         4          3m46s</span><br><span class="line">hpa-sp   Deployment/hpa-dep   100%/10%   2         5         5          4m1s</span><br><span class="line">hpa-sp   Deployment/hpa-dep   50%/10%    2         5         5          4m16s</span><br><span class="line">hpa-sp   Deployment/hpa-dep   40%/10%    2         5         5          4m31s</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到 <code>REPLICAS</code> 擴充為 4</li>
</ul>
<p>再到另一個終端機，檢視 pod 有無 runninf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kg po -o wide</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE     IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">hpa-dep-6f5bd9dd57-7tkdp   1/1     Running   0          24s     10.244.3.7   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">hpa-dep-6f5bd9dd57-cntd5   1/1     Running   0          9s      10.244.3.8   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">hpa-dep-6f5bd9dd57-ggs9b   1/1     Running   0          3m55s   10.244.4.6   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">hpa-dep-6f5bd9dd57-kmxmb   1/1     Running   0          3m55s   10.244.3.6   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">hpa-dep-6f5bd9dd57-qlgr6   1/1     Running   0          24s     10.244.4.7   w2     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>通通健康的在跑，因為我們設定一個 pod 只能 run 400m ，且目前單一 node 總共有 2000m 可以用，所以當然可以讓擴充出來的 pod 快樂的 running</li>
</ul>
<p>檢視 node 使用運作資源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ k top nodes</span><br><span class="line">NAME   CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%</span><br><span class="line">m1     867m         43%    897Mi           11%</span><br><span class="line">m2     241m         12%    807Mi           10%</span><br><span class="line">m3     229m         11%    704Mi           8%</span><br><span class="line">w1     1068m        53%    266Mi           3%</span><br><span class="line">w2     1084m        54%    650Mi           8%</span><br></pre></td></tr></table></figure>

<p>結束測試，刪除物件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kd -f .</span><br></pre></td></tr></table></figure>

<h1 id="Managing-the-Container-Life-Cycle"><a href="#Managing-the-Container-Life-Cycle" class="headerlink" title="Managing the Container Life Cycle"></a>Managing the Container Life Cycle</h1><h2 id="Liveness-and-Readiness-Probes"><a href="#Liveness-and-Readiness-Probes" class="headerlink" title="Liveness and Readiness Probes"></a>Liveness and Readiness Probes</h2><p>(2022&#x2F;09&#x2F;05 10:35)</p>
<ul>
<li>The kubelet uses liveness probes to know when to restart a Container. For example, liveness probes could catch a deadlock, where an application is running, but unable to make progress. Restarting a Container in such a state can help to make the application more available despite bugs.</li>
<li>The kubelet uses readiness probes to know when a Container is ready to start accepting traffic. A Pod is considered ready when all of its Containers are ready. One use of this signal is to control which Pods are used as backends for Services. When a Pod is not ready, it is removed from Service load balancers.</li>
</ul>
<p>共有三種檢測方式，分別是</p>
<ul>
<li>ExecAction: Executes a specified command inside the Container. The diagnostic is considered successful if the command exits with a status code of 0.</li>
<li>TCPSocketAction: Performs a TCP check against the Container’s IP address on a specified port. The diagnostic is considered successful if the port is open.<ul>
<li>像是 Linux 命令的 <code>nc</code> ，檢查 IP 的 port 有沒有開</li>
</ul>
</li>
<li>HTTPGetAction: Performs an HTTP Get request against the Container’s IP address on a specified port and path. The diagnostic is considered successful if the response has a status code greater than or equal to 200 and less than 400.<ul>
<li>像是 Linux 命令的 <code>curl</code> ，</li>
</ul>
</li>
</ul>
<p>Each probe has one of three results:</p>
<ol>
<li>Success: The Container passed the diagnostic.</li>
<li>Failure: The Container failed the diagnostic.</li>
<li>Unknown: The diagnostic failed, so no action should be taken.</li>
</ol>
<ul>
<li>在老師的 K8S Cluster 中，探針會透過 Kubelet 和 CRI-O 監控 Container 的一支程式叫 <code>conmon</code> 來講話，看 Container 的狀態</li>
<li>如果遇到探針無法執行，需檢查 <code>conmon</code> 的版本 <code>conmon --version</code> 是不是 <code>2.1.2</code>，再 K8S <code>1.23</code> 以後的版本，須將 conmon 升級至 <code>2.1.4</code> 版本<ul>
<li>升級命令 : <code>sudo apk upgrade conmon --no-cache --update-cache --allow-untrusted --repository http://dl-cdn.alpinelinux.org/alpine/edge/community</code></li>
</ul>
</li>
</ul>
<h2 id="Liveness-Probe-Exec"><a href="#Liveness-Probe-Exec" class="headerlink" title="Liveness Probe - Exec"></a>Liveness Probe - Exec</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: liveness-exec</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: liveness</span><br><span class="line">    image: k8s.gcr.io/busybox</span><br><span class="line">    command: [/bin/sh]</span><br><span class="line">    args:</span><br><span class="line">    - -c</span><br><span class="line">    - touch /tmp/healthy; sleep 20; rm -rf /tmp/healthy; sleep 300</span><br><span class="line">    livenessProbe:</span><br><span class="line">      exec:</span><br><span class="line">        command:</span><br><span class="line">        - cat</span><br><span class="line">        - /tmp/healthy</span><br><span class="line">      initialDelaySeconds: 5</span><br><span class="line">      periodSeconds: 5 &#x27;&gt;  ~/wulin/yaml/exec-liveness.yml</span><br></pre></td></tr></table></figure>

<ul>
<li>Container 跑的命令是 先建立 <code>/tmp/healthy</code> 這個空檔案，再睡 20 秒，刪除檔案，再睡 300 秒</li>
<li><code>livenessProbe</code> ，liveness 探針<ul>
<li><code>exec</code> ，透過進入 Container 執行命令來健康檢查<ul>
<li>執行的命令是 看 <code>/tmp/healthy</code> 檔案的內容</li>
</ul>
</li>
<li><code>initialDelaySeconds: 5</code>，Container init 後，等 5 秒後，開始健康檢查</li>
<li><code>periodSeconds: 5</code>，每 5 秒檢查一次</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 佈署 exec-liveness.yml</span><br><span class="line">$ kubectl apply -f  ~/wulin/yaml/exec-liveness.yml</span><br><span class="line"></span><br><span class="line"># 檢視 exec-liveness Pod 的 Event</span><br><span class="line">$ kubectl describe pod liveness-exec</span><br><span class="line">.......</span><br><span class="line">  Normal   Pulled     58s                kubelet            Successfully pulled image &quot;k8s.gcr.io/busybox&quot; in 7.253319528s</span><br><span class="line">  Normal   Created    57s                kubelet            Created container liveness</span><br><span class="line">  Normal   Started    56s                kubelet            Started container liveness</span><br><span class="line">  Warning  Unhealthy  25s (x3 over 35s)  kubelet            Liveness probe failed: cat: cant open &#x27;/tmp/healthy&#x27;: No such file or directory</span><br><span class="line">  Normal   Killing    25s                kubelet            Container liveness failed liveness probe, will be restarted</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME              READY   STATUS    RESTARTS   AGE</span><br><span class="line">liveness-exec   1/1     Running    2          2m57s</span><br><span class="line"></span><br><span class="line">移除 Pod</span><br><span class="line">$ kubectl delete -f  ~/wulin/yaml/exec-liveness.yml</span><br></pre></td></tr></table></figure>


<h1 id="K8S-Namespace-LimitRange"><a href="#K8S-Namespace-LimitRange" class="headerlink" title="K8S Namespace LimitRange"></a>K8S Namespace LimitRange</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create namespace memlimit</span><br><span class="line"></span><br><span class="line">$ echo &#x27;apiVersion: v1</span><br><span class="line">kind: LimitRange</span><br><span class="line">metadata:</span><br><span class="line">  name: mem-limit-range</span><br><span class="line">spec:</span><br><span class="line">  limits:</span><br><span class="line">  - default:</span><br><span class="line">      memory: 512Mi</span><br><span class="line">    defaultRequest:</span><br><span class="line">      memory: 256Mi</span><br><span class="line">    max:</span><br><span class="line">      memory: 2Gi</span><br><span class="line">    min:</span><br><span class="line">      memory: 256Mi</span><br><span class="line">    type: Container  &#x27;&gt; ~/wulin/yaml/limitrange.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply  -f  ~/wulin/yaml/limitrange.yaml -n memlimit</span><br></pre></td></tr></table></figure>

<ul>
<li><code>default.memory</code>，</li>
<li><code>LimitRange</code> ，會針對一個 POD 產生限制, 並不是限制所有 POD 的總和</li>
<li>注意 ! 如果 Namespace 在 <code>LimitRange</code> 產生之前的物件，是不會受到</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: memlimit-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: memlimit-pod-nginx</span><br><span class="line">    image: k8s.gcr.io/nginx &#x27; &gt; ~/wulin/yaml/memlimit-pod.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f ~/wulin/yaml/memlimit-pod.yaml -n memlimit</span><br><span class="line">pod/memlimit-pod created</span><br><span class="line"></span><br><span class="line">$ echo &#x27;apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: memlimit-pod1</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: memlimit-pod-nginx</span><br><span class="line">    image: k8s.gcr.io/nginx</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        memory: &quot;2Gi&quot;  &#x27; &gt; ~/wulin/yaml/memlimit-pod1.yaml</span><br><span class="line"></span><br><span class="line"># 以下命令會執行成功</span><br><span class="line">$ kubectl apply -f  ~/wulin/yaml/memlimit-pod1.yaml -n memlimit</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="K8S-Namespace-Resource-Quota"><a href="#K8S-Namespace-Resource-Quota" class="headerlink" title="K8S Namespace Resource Quota"></a>K8S Namespace Resource Quota</h1><p>編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano ~/wulin/yaml/nsrslimit.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mynsrs</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">compute-quota</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">mynsrs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">requests.cpu:</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">    <span class="attr">requests.memory:</span> <span class="string">256Mi</span></span><br><span class="line">    <span class="attr">requests.nvidia.com/gpu:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">limits.cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">limits.memory:</span> <span class="string">1Gi</span></span><br><span class="line">    <span class="attr">limits.nvidia.com/gpu:</span> <span class="number">2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ResourceQuota</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">object-quota</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">mynsrs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hard:</span></span><br><span class="line">    <span class="attr">configmaps:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">persistentvolumeclaims:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">replicationcontrollers:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">    <span class="attr">secrets:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="attr">services:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="attr">services.loadbalancers:</span> <span class="string">&quot;2&quot;</span></span><br></pre></td></tr></table></figure>


<ul>
<li>yaml 檔中，如果要宣告多個物件，物件跟物間中間用 <code>---</code> 區隔</li>
<li>在 <code>ResourceQuota</code> 中，如果有宣告建立物件的數量限制，代表該物件只能被建立幾個，未宣告的物件則不受數量限制。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nsrs-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nsrs-pod-nginx</span><br><span class="line">    image: k8s.gcr.io/nginx &#x27; &gt; ~/wulin/yaml/nsrs-pod.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f ~/wulin/yaml/nsrs-pod.yaml -n mynsrs</span><br><span class="line">Error from server (Forbidden): error when creating &quot;nsrs-pod.yaml&quot;: pods &quot;nsrs-pod&quot; is forbidden: failed quota: compute-quota: must specify limits.cpu,limits.memory,requests.cpu,requests.memory</span><br></pre></td></tr></table></figure>

<ul>
<li>當一個 Namespace 有分配 ResourceQuota 和對應的 Namespace 時，所有在該 Namespace 內使用元件時必須都要詳細指明用量，不然不給用！</li>
</ul>
<p>重新設定運算資源</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: nsrs-pod</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: nsrs-pod-nginx</span></span><br><span class="line"><span class="string">    image: k8s.gcr.io/nginx </span></span><br><span class="line"><span class="string">    resources:</span></span><br><span class="line"><span class="string">      requests:</span></span><br><span class="line"><span class="string">         cpu: 1.0</span></span><br><span class="line"><span class="string">         memory: 256Mi</span></span><br><span class="line"><span class="string">      limits:</span></span><br><span class="line"><span class="string">         cpu: 2.0</span></span><br><span class="line"><span class="string">         memory: 512Mi &#x27;</span> &gt; ~/wulin/yaml/nsrs-pod.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f ~/wulin/yaml/nsrs-pod.yaml -n mynsrs</span><br><span class="line"></span><br><span class="line">$ kg po -n mynsrs</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">nsrs-pod   1/1     Running   0          93s</span><br><span class="line"></span><br><span class="line">$ kg resourcequotas -n mynsrs</span><br><span class="line">NAME            AGE   REQUEST                                                                                                                                 LIMIT</span><br><span class="line">compute-quota   10m   requests.cpu: 1/1, requests.memory: 256Mi/256Mi, requests.nvidia.com/gpu: 0/1                                                           limits.cpu: 2/2, limits.memory: 512Mi/1Gi, limits.nvidia.com/gpu: 0/2</span><br><span class="line">object-quota    10m   configmaps: 1/2, persistentvolumeclaims: 0/2, replicationcontrollers: 0/2, secrets: 0/10, services: 0/10, services.loadbalancers: 0/2</span><br></pre></td></tr></table></figure>

<p>在建立同樣運算資源的 pod 一次</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nsrs-pod1</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nsrs-pod-nginx</span><br><span class="line">    image: k8s.gcr.io/nginx </span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">         cpu: 1.0</span><br><span class="line">         memory: 256Mi</span><br><span class="line">      limits:</span><br><span class="line">         cpu: 2.0</span><br><span class="line">         memory: 512Mi &#x27; &gt; ~/wulin/yaml/nsrs-pod1.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f ~/wulin/yaml/nsrs-pod1.yaml -n mynsrs</span><br><span class="line">Error from server (Forbidden): error when creating &quot;nsrs-pod1.yaml&quot;: pods &quot;nsrs-pod1&quot; is forbidden: exceeded quota: compute-quota, requested: limits.cpu=2,requests.cpu=1,requests.memory=256Mi, used: limits.cpu=2,requests.cpu=1,requests.memory=256Mi, limited: limits.cpu=2,requests.cpu=1,requests.memory=256Mi</span><br></pre></td></tr></table></figure>








      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes%20Resource%20Storage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes%20Resource%20Storage/" class="post-title-link" itemprop="url">Kubernetes Resource Storage (NFS)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-18 02:45:34" itemprop="dateCreated datePublished" datetime="2022-09-18T02:45:34+08:00">2022-09-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 18:14:01" itemprop="dateModified" datetime="2023-05-07T18:14:01+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-Resource-Storage-NFS"><a href="#Kubernetes-Resource-Storage-NFS" class="headerlink" title="Kubernetes Resource Storage (NFS)"></a>Kubernetes Resource Storage (NFS)</h1><h1 id="Kubernetes-Volume"><a href="#Kubernetes-Volume" class="headerlink" title="Kubernetes Volume"></a>Kubernetes Volume</h1><ul>
<li>Type of Storage<ul>
<li>Container Filesystem (Overlay2)<ul>
<li>Container 掛點，檔案系統掛點</li>
</ul>
</li>
<li>Volume (emptyDir)<ul>
<li>每個 Container 會共用 pod 的目錄</li>
<li>生命週期與 pod 一樣， pod 裡其中一個 Container 毀損，並不影響到 Volume</li>
</ul>
</li>
<li>Persistent volume. (hostPath, Local,NFS)<ul>
<li>永存的儲存體</li>
<li>生命週期與 K8S Cluster 相同</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="empty-dir-volume"><a href="#empty-dir-volume" class="headerlink" title="empty dir volume"></a>empty dir volume</h2><p><img src="https://i.imgur.com/yfocaAI.png"></p>
<ul>
<li>empty dir 的運作，等同於 Container 的 Volume</li>
<li>empty dir，這個目錄存在於 Linux 系統中，系統會自動幫我們產生這個目錄區（名字很長不是人記得）。</li>
<li>一個 pod 裡的多個 Container 共用同一個 Linux 系統的目錄區</li>
</ul>
<h2 id="Shared-volumes-in-a-Kubernetes-Pod"><a href="#Shared-volumes-in-a-Kubernetes-Pod" class="headerlink" title="Shared volumes in a Kubernetes Pod"></a>Shared volumes in a Kubernetes Pod</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano ~/wulin/yaml/sidecar.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sidecar</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">1st</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/nginx</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">2nd</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/alpine</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/html</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">while</span> <span class="literal">true</span><span class="string">;</span> <span class="string">do</span></span><br><span class="line">          <span class="string">date</span> <span class="string">&gt;&gt;</span> <span class="string">/html/index.html;</span></span><br><span class="line">          <span class="string">sleep</span> <span class="number">1</span><span class="string">;</span></span><br><span class="line">        <span class="string">done</span></span><br></pre></td></tr></table></figure>

<ul>
<li>將 <code>1st</code> 和 <code>2nd</code> 兩台 Container 的目錄</li>
<li><code>spec.volumes.emptyDir: &#123;&#125;</code>，這個目錄等下會被 mount 到 <code>spec.volumes.mountPath: /usr/share/nginx/html</code> 這個目錄</li>
</ul>
<p>建立 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ka -f ~/wulin/yaml/sidecar.yaml</span><br></pre></td></tr></table></figure>

<p>進入 sidecar pod 裡面的 1st Container 看 <code>/usr/share/nginx/html/index.html</code> 檔案的倒數 3 行的內容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec sidecar -c 1st -- /bin/cat  /usr/share/nginx/html/index.html | tail -n 3</span><br><span class="line">Thu Dec 16 13:20:14 UTC 2021</span><br><span class="line">Thu Dec 16 13:20:15 UTC 2021</span><br><span class="line">Thu Dec 16 13:20:16 UTC 2021</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kubectl exec</code>，在 pod 中的 Container 裡面執行命令</li>
<li><code>-c</code> 後面接的是 Container 的名字</li>
<li><code>--</code> 後面放在 Container 裡要執行的命令</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ kg pods -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">sidecar   2/2     Running   0          12m   10.244.0.6   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ kubectl get pod sidecar --template=&#123;&#123;.status.podIP&#125;&#125;; echo</span><br><span class="line">10.244.0.6</span><br><span class="line"></span><br><span class="line">$ podip=$(kubectl get pod sidecar --template=&#123;&#123;.status.podIP&#125;&#125;)</span><br><span class="line"></span><br><span class="line">$ curl -s http://$podip | head -n 5</span><br><span class="line">Thu Dec 16 13:06:28 UTC 2021</span><br><span class="line">Thu Dec 16 13:06:29 UTC 2021</span><br><span class="line">Thu Dec 16 13:06:30 UTC 2021</span><br><span class="line">Thu Dec 16 13:06:31 UTC 2021</span><br><span class="line">Thu Dec 16 13:06:32 UTC 2021</span><br></pre></td></tr></table></figure>

<h2 id="hostPath-Volume-應用範例"><a href="#hostPath-Volume-應用範例" class="headerlink" title="hostPath Volume 應用範例"></a>hostPath Volume 應用範例</h2><p>編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 在 m1 終端機執行</span><br><span class="line">$ nano ~/wulin/yaml/pod-hp.yaml </span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-hp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-hp</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/nginx</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">&quot;http-server&quot;</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/usr/share/nginx/html&quot;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">hp-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hp-volume</span></span><br><span class="line">      <span class="attr">hostPath:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/opt/hostpath</span></span><br></pre></td></tr></table></figure>

<p>產生 pod </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f ~/wulin/yaml/pod-hp.yaml   (不會產生 PV Object)</span><br><span class="line"></span><br><span class="line"># 看 pod IP 位址</span><br><span class="line">$ kg po -o wide</span><br><span class="line">NAME     READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-hp   1/1     Running   0          65s   10.244.4.12   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># 檢查 hostpath 目錄</span><br><span class="line">$ ssh w2 &#x27;ls -l /opt&#x27;</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 3 root root 4096 Dec 25  2021 cni</span><br><span class="line">drwxr-xr-x 2 root root 4096 Sep  4 15:30 hostpath</span><br><span class="line"></span><br><span class="line"># 對照 w1 node 是不會有的</span><br><span class="line">$ ssh w1 &#x27;ls -l /opt&#x27;</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 3 root root 4096 Dec 25  2021 cni</span><br><span class="line">drwxr-xr-x 9 root root 4096 Sep  4 00:23 www</span><br><span class="line"></span><br><span class="line"># 進入 pod 產生 index.html 檔案</span><br><span class="line">$ kubectl exec -it pod-hp -- sh</span><br><span class="line"># echo &quot;&lt;h1&gt;let me go&lt;/h1&gt;&quot; &gt; /usr/share/nginx/html/index.html</span><br><span class="line"># exit</span><br><span class="line"></span><br><span class="line">$ curl http://10.244.2.20</span><br><span class="line">&lt;h1&gt;let me go&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<p>檢查剛剛產生的 index.html 是否產生在 w2 的 <code>/opt/hostpath</code> 目錄</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ssh w2 &#x27;ls -l /opt/hostpath/&#x27;</span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 19 Sep  4 15:34 index.html</span><br></pre></td></tr></table></figure>


<hr>
<h1 id="Persistent-Volumes-運作架構"><a href="#Persistent-Volumes-運作架構" class="headerlink" title="Persistent Volumes 運作架構"></a>Persistent Volumes 運作架構</h1><p><img src="https://i.imgur.com/WaCuRbV.png"></p>
<ul>
<li>管理 storage 一直都是一個不簡單的課題，為了讓 developer 可以更專注在開發上，k8s 中提出了兩個概念(resource object)，分別是 Persistent Volume(PV) &amp; Persistent Volume Claim(PVC)，透過這兩個概念將連結 storage 的過程抽象化，讓使用者不需要了解 storage 在底層是如何運作的，只要了解如何使用即可，大幅降低使用者操作 storage 的困難度。</li>
<li>Persistent Volume(PV) 由 storage 管理者負責產生，在 k8s 中就是一種可用的 storage resource，同樣也是一種 volume plugin，但有自己獨立的 lifecycle，且包含的就是實際與 storage 連結的實作細節。</li>
<li>Persistent Volume Claim(PVC) 則是來自使用者的 storage request，就跟 pod 一樣都是要消耗特定的資源，PVC 消耗 PV 資源(pod 消耗 node 資源)，PVC 指定特定 size or access mode 的 PV(pod 可以指定 CPU, memory … etc)。</li>
<li>由於 PVC 可以允許使用者自行指定所需要 PV 的相關屬性，因此除了 size, access mode 外，可能還會有 performance 的需求。而為了滿足不同的使用目的，cluster administrator 就必須要準備好不同的 PV 來處理不同 PVC 的需求；若是 PVC 數量不多且需求單純，手動產生 PV 可能還可以接受，但若是 PVC 的數量眾多且需求多變，那可能就需要 [StorageClass] 的協助了!</li>
<li><a target="_blank" rel="noopener" href="https://godleon.github.io/blog/Kubernetes/k8s-PersistentVolume-Overview/">Persistent Volume (Claim) Overview Link (必看)</a></li>
</ul>
<h2 id="Local-Persistent-Volumes"><a href="#Local-Persistent-Volumes" class="headerlink" title="Local Persistent Volumes"></a>Local Persistent Volumes</h2><ul>
<li><strong>local PV 的產生一定要用 yaml 檔產生</strong></li>
<li><strong>且一定要需告在哪一台 node</strong></li>
<li><strong>宣告的目錄區，需要事先準備</strong></li>
<li>the Kubernetes scheduler ensures that a pod using a Local Persistent Volume is always scheduled to the same node.</li>
</ul>
<h3 id="建立-Local-PersistentVolume"><a href="#建立-Local-PersistentVolume" class="headerlink" title="建立 Local PersistentVolume"></a><strong>建立 Local PersistentVolume</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: pv-local</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  local:</span><br><span class="line">    path: &quot;/opt/local&quot;</span><br><span class="line">  nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">      - matchExpressions:</span><br><span class="line">        - key: kubernetes.io/hostname</span><br><span class="line">          operator: In</span><br><span class="line">          values:</span><br><span class="line">          - m1 &#x27; &gt; ~/wulin/yaml/pv-local.yaml </span><br></pre></td></tr></table></figure>

<ul>
<li>以上設定的 capacity(儲存空間大小), accessModes(目錄權限) 數據都是參考用的</li>
<li>PV 會產生在 m1 的 node 上，所以以上設定的數據是由 m1 node 上 Linux 系統在管理目錄區的 Quota 做容量控管及權限設定，實際上要求有沒有做到，PV 本身是不會管的</li>
</ul>
<h3 id="產生-PV"><a href="#產生-PV" class="headerlink" title="產生 PV"></a><strong>產生 PV</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f ~/wulin/yaml/pv-local.yaml </span><br><span class="line">persistentvolume/pv-local created</span><br><span class="line"></span><br><span class="line">$ kubectl get pv pv-local</span><br><span class="line">NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">pv-local   10Gi       RWO            Retain           Available                                   102s</span><br></pre></td></tr></table></figure>

<h3 id="建立-Local-PersistentVolumeClaim"><a href="#建立-Local-PersistentVolumeClaim" class="headerlink" title="建立 Local PersistentVolumeClaim"></a>建立 Local PersistentVolumeClaim</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: pvc-local</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  storageClassName: &quot;&quot;  </span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 3Gi &#x27; &gt; ~/wulin/yaml/pvc-local.yaml</span><br></pre></td></tr></table></figure>

<ul>
<li>注意! 在 yaml 檔中的宣告，並未指定要用哪個 PV</li>
<li>PVC 會去尋找滿足 <code>accessModes</code> 和 <code>resources.requests.storage</code> 的 PV 來 Bound 建立連接</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f ~/wulin/yaml/pvc-local.yaml</span><br></pre></td></tr></table></figure>

<p>檢查 pv 與 pvc 狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kg pv</span><br><span class="line">NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM               STORAGECLASS   REASON   AGE</span><br><span class="line">pv-local   10Gi       RWO            Retain           Bound    default/pvc-local                           32m</span><br><span class="line"></span><br><span class="line">$ kg pvc</span><br><span class="line">NAME        STATUS   VOLUME     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">pvc-local   Bound    pv-local   10Gi       RWO                           46s</span><br></pre></td></tr></table></figure>

<h3 id="建立使用-pvc-local-的第一個-Pod"><a href="#建立使用-pvc-local-的第一個-Pod" class="headerlink" title="建立使用 pvc-local 的第一個 Pod"></a>建立使用 pvc-local 的第一個 Pod</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;kind: Pod</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-pvc1</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">    - name: pv-storage</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">       claimName: pvc-local</span><br><span class="line">  containers:</span><br><span class="line">    - name: pod-pvc1</span><br><span class="line">      image: quay.io/cloudwalker/nginx</span><br><span class="line">      imagePullPolicy: IfNotPresent</span><br><span class="line">      ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: &quot;http-server&quot;</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - mountPath: &quot;/usr/share/nginx/html&quot;</span><br><span class="line">          name: pv-storage &#x27; &gt; ~/wulin/yaml/pod-pvc1.yaml </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f ~/wulin/yaml/pod-pvc1.yaml </span><br><span class="line"></span><br><span class="line">$ kg po</span><br><span class="line">NAME       READY   STATUS              RESTARTS   AGE</span><br><span class="line">g1         1/1     Running             0          116m</span><br><span class="line">g2         1/1     Running             0          115m</span><br><span class="line">pod-pvc1   0/1     ContainerCreating   0          12m</span><br><span class="line"></span><br><span class="line">$ kubectl describe pod pod-pvc1</span><br><span class="line">...</span><br><span class="line">... path &quot;/opt/local&quot; does not exist</span><br></pre></td></tr></table></figure>

<ul>
<li>因為沒事先在指定主機 (m1) 建立 &#x2F;opt&#x2F;local 目錄</li>
</ul>
<p>解決</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir /opt/local</span><br></pre></td></tr></table></figure>

<p>檢查</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kg po pod-pvc1</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-pvc1   1/1     Running   0          20m</span><br></pre></td></tr></table></figure>

<h3 id="建立-NGINX-首頁"><a href="#建立-NGINX-首頁" class="headerlink" title="建立 NGINX 首頁"></a>建立 NGINX 首頁</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -it pod-pvc1 -- bash</span><br><span class="line">root@pv-pod:/# echo &quot;&lt;h1&gt;POD-PVC1&lt;/h1&gt;&quot; &gt; /usr/share/nginx/html/index.html</span><br><span class="line">root@pv-pod:/# exit</span><br><span class="line"></span><br><span class="line">$ ls -l /opt/local/</span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 18 Sep  7 15:49 index.html</span><br></pre></td></tr></table></figure>

<p>刪除 pod 與 pvc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod pod-pvc1</span><br><span class="line">pod &quot;pod-pvc1&quot; deleted</span><br><span class="line"></span><br><span class="line">$ kubectl delete pvc pvc-local</span><br><span class="line">persistentvolumeclaim &quot;pvc-local&quot; deleted</span><br><span class="line"></span><br><span class="line">$ kg pvc</span><br><span class="line">No resources found in default namespace.</span><br></pre></td></tr></table></figure>

<p>檢視被刪除 pvc 後的 pv</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kg pv</span><br><span class="line">NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM               STORAGECLASS   REASON   AGE</span><br><span class="line">pv-local   10Gi       RWO            Retain           Released   default/pvc-local                           62m</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到狀態是 <code>Released</code></li>
</ul>
<p>如果再次建立一樣的 pvc 呢?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f pvc-local.yaml</span><br></pre></td></tr></table></figure>

<p>檢視 pvc 的狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kg pvc</span><br><span class="line">NAME        STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">pvc-local   Pending                                                     7s</span><br></pre></td></tr></table></figure>


<h1 id="Helm"><a href="#Helm" class="headerlink" title="Helm"></a>Helm</h1><ul>
<li>像是 Alpine Linux 的 apk ，可以在 K8S 新增套件</li>
<li>要自行安裝，原生的 K8S 沒有 Helm</li>
</ul>
<h2 id="安裝-Helm-3"><a href="#安裝-Helm-3" class="headerlink" title="安裝 Helm 3"></a>安裝 Helm 3</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash</span><br></pre></td></tr></table></figure>

<ul>
<li><code>get-helm-3</code> ，安裝 Helm 的程式</li>
<li>漿螢幕輸出透過水管直接將安裝 Helm 的程式餵給 貝殼程式</li>
</ul>
<h1 id="NFS-Dynamic-Volume-Provision"><a href="#NFS-Dynamic-Volume-Provision" class="headerlink" title="NFS Dynamic Volume Provision"></a>NFS Dynamic Volume Provision</h1><h2 id="安裝-NFS-套件"><a href="#安裝-NFS-套件" class="headerlink" title="安裝 NFS 套件"></a>安裝 NFS 套件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">K8S Master/Worker 都要安裝</span><br><span class="line">$ sudo apk update; sudo apk add nfs-utils</span><br><span class="line">.........</span><br><span class="line">(6/7) Installing nfs-utils (2.5.4-r1)</span><br><span class="line">(7/7) Installing nfs-utils-openrc (2.5.4-r1)</span><br><span class="line">Executing busybox-1.33.1-r3.trigger</span><br><span class="line">OK: 1603 MiB in 291 packages</span><br><span class="line"></span><br><span class="line">$ ssh w1 sudo apk update; ssh w1 sudo apk add nfs-utils</span><br><span class="line"></span><br><span class="line">$ ssh w2 sudo apk update; ssh w2 sudo apk add nfs-utils</span><br></pre></td></tr></table></figure>

<h2 id="設定-NFS-Server"><a href="#設定-NFS-Server" class="headerlink" title="設定 NFS Server"></a>設定 NFS Server</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rc-update add nfs</span><br><span class="line">* service nfs added to runlevel default</span><br><span class="line"></span><br><span class="line">K8s Master 建立共用資料夾</span><br><span class="line">$ sudo mkdir /opt/nfs; sudo chown -R nobody:nogroup /opt/nfs</span><br><span class="line"></span><br><span class="line">$ echo &quot;/opt/nfs $IP/24(rw,sync,no_subtree_check,no_root_squash)&quot; | sudo tee /etc/exports</span><br></pre></td></tr></table></figure>

<h2 id="啟動-NFS-Server"><a href="#啟動-NFS-Server" class="headerlink" title="啟動 NFS Server"></a>啟動 NFS Server</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rc-service rpcbind start</span><br><span class="line">$ sudo rc-service nfs start</span><br><span class="line">* Stopping NFS mountd ... [ ok ]</span><br><span class="line">* Stopping NFS daemon ... [ ok ]</span><br><span class="line">* Unexporting NFS directories ... [ ok ]</span><br><span class="line">* Exporting NFS directories ... [ ok ]</span><br><span class="line">* Starting NFS mountd ... [ ok ]</span><br><span class="line">* Starting NFS daemon ... [ ok ]</span><br><span class="line">* Starting NFS smnotify ... [ ok ]</span><br></pre></td></tr></table></figure>

<h2 id="測試-NFS"><a href="#測試-NFS" class="headerlink" title="測試 NFS"></a>測試 NFS</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># K8S Worker 測試掛載 nfs</span><br><span class="line"># 將 m1 主機的 /opt/nfs 目錄掛載到 w1 主機的 /mnt 目錄</span><br><span class="line">$ ssh w1 &quot;sudo mount -t nfs $IP:/opt/nfs /mnt&quot;</span><br><span class="line"></span><br><span class="line"># 在 /mnt 上建立一個空檔案</span><br><span class="line">$ ssh w1 &quot;sudo touch /mnt/mynfs&quot;</span><br><span class="line"></span><br><span class="line"># 卸載 nfs</span><br><span class="line">$ ssh w1 &quot;sudo umount /mnt&quot;</span><br><span class="line"></span><br><span class="line"># K8S Master 檢查</span><br><span class="line">$ ls -al /opt/nfs</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 2 nobody nogroup 4096 Oct 30 19:22 .</span><br><span class="line">drwxr-xr-x 4 root   root    4096 Oct 30 19:20 ..</span><br><span class="line">-rw-r--r-- 1 root   root       0 Oct 30 19:22 mynfs</span><br></pre></td></tr></table></figure>

<h2 id="安裝與建立-NFS-Provisioner"><a href="#安裝與建立-NFS-Provisioner" class="headerlink" title="安裝與建立 NFS Provisioner"></a>安裝與建立 NFS Provisioner</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 新增套件清單網址</span><br><span class="line">$ helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/</span><br><span class="line"></span><br><span class="line"># 更新儲存庫</span><br><span class="line">$ helm repo update</span><br><span class="line"></span><br><span class="line"># 搜尋剛剛的套件網址版本代號多少</span><br><span class="line">$ helm search repo nfs-subdir-external-provisioner</span><br><span class="line">NAME                                                    CHART VERSION   APP VERSION     DESCRIPTION            </span><br><span class="line">nfs-subdir-external-provisioner/nfs-subdir-exte...      4.0.17          4.0.2           nfs-subdir-external-provisioner is an automatic...</span><br><span class="line"></span><br><span class="line"># 安裝套件</span><br><span class="line">$ helm install nfs-subdir-external-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \</span><br><span class="line">--set storageClass.defaultClass=true \</span><br><span class="line">--set storageClass.name=mynfs \</span><br><span class="line">--set nfs.server=$IP \</span><br><span class="line">--set nfs.path=/opt/nfs</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="檢視-NFS-Provisioner"><a href="#檢視-NFS-Provisioner" class="headerlink" title="檢視 NFS Provisioner"></a>檢視 NFS Provisioner</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get storageclass</span><br><span class="line">NAME              PROVISIONER                                     RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">mynfs (default)   cluster.local/nfs-subdir-external-provisioner   Delete          Immediate           true                   17s</span><br><span class="line"></span><br><span class="line">$ kg all</span><br><span class="line">NAME                                                   READY   STATUS              RESTARTS   AGE</span><br><span class="line">pod/nfs-subdir-external-provisioner-7dc5ccf74b-lkrkj   0/1     ContainerCreating   0          22s</span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/kubernetes   ClusterIP   10.98.0.1    &lt;none&gt;        443/TCP   7d23h</span><br><span class="line"></span><br><span class="line">NAME                                              READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/nfs-subdir-external-provisioner   0/1     1            0           22s</span><br><span class="line"></span><br><span class="line">NAME                                                         DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/nfs-subdir-external-provisioner-7dc5ccf74b   1         1         0       22s</span><br></pre></td></tr></table></figure>

<h2 id="建立-PVC-測試-NFS-Client-Provisioner"><a href="#建立-PVC-測試-NFS-Client-Provisioner" class="headerlink" title="建立 PVC 測試 NFS Client Provisioner"></a>建立 PVC 測試 NFS Client Provisioner</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> $<span class="string">&#x27;kind: PersistentVolumeClaim</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: test-claim</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  accessModes: [&quot;ReadWriteOnce&quot;]</span></span><br><span class="line"><span class="string">  storageClassName: mynfs</span></span><br><span class="line"><span class="string">  resources:</span></span><br><span class="line"><span class="string">    requests:</span></span><br><span class="line"><span class="string">      storage: 1Mi &#x27;</span> &gt; pvc-nfscp.yaml </span><br></pre></td></tr></table></figure>

<ul>
<li><code>spec.resources.requests.storage</code>，設定的 <code>1Mi</code> 是參考值，真正在限制的人是底層的 NFS ，它如果沒能力，就不會真的被限制</li>
<li><code>spec.accessModes</code>，<code>ReadWriteOnce</code> 設定的是在本機才能被掛載，與 NFS 的概念完全背離，所以應該改為 <code>ReadWriteMany</code>，但其實這邊也是參考的，因為底層在運作是 NFS ，最後一樣能被其他主機來掛載</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f pvc-nfscp.yaml</span><br><span class="line">persistentvolumeclaim/test-claim created</span><br><span class="line"></span><br><span class="line">$ kg pv</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   REASON   AGE</span><br><span class="line">pvc-de200a3e-203b-4feb-ab8a-95f0be90cd3c   1Mi        RWO            Delete           Bound    default/test-claim   mynfs                   3s</span><br><span class="line"></span><br><span class="line">$ kg pvc</span><br><span class="line">NAME         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">test-claim   Bound    pvc-de200a3e-203b-4feb-ab8a-95f0be90cd3c   1Mi        RWO            mynfs          4s</span><br></pre></td></tr></table></figure>

<h2 id="建立-Job-測試-NFS-Client-Provisioner"><a href="#建立-Job-測試-NFS-Client-Provisioner" class="headerlink" title="建立 Job 測試 NFS Client Provisioner"></a>建立 Job 測試 NFS Client Provisioner</h2><p>編輯 Job YAML 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano nfs-job-test.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-job-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nfs-job-test</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">     <span class="attr">containers:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-job-test</span></span><br><span class="line">       <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/busybox</span></span><br><span class="line">       <span class="attr">command:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">       <span class="attr">args:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">&quot;touch /opt/SUCCESS &amp;&amp; exit 0 || exit 1&quot;</span></span><br><span class="line">       <span class="attr">volumeMounts:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pvc</span></span><br><span class="line">           <span class="attr">mountPath:</span> <span class="string">&quot;/opt&quot;</span></span><br><span class="line">     <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">     <span class="attr">volumes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pvc</span></span><br><span class="line">         <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">           <span class="attr">claimName:</span> <span class="string">test-claim</span></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ka -f nfs-job-test.yaml</span><br><span class="line"></span><br><span class="line">$ kg job</span><br><span class="line">NAME           COMPLETIONS   DURATION   AGE</span><br><span class="line">nfs-job-test   1/1           4s         10m</span><br><span class="line"></span><br><span class="line">$ dir /opt/nfs</span><br><span class="line">..........</span><br><span class="line">drwxrwxrwx 2 root   root    4.0K Oct 29 12:43 default-test-claim-pvc-788e2513-9de6-41d5-bb2d-f57e1fa5ce7c</span><br><span class="line"></span><br><span class="line">$ kubectl delete job nfs-job-test; kubectl delete pvc test-claim</span><br><span class="line"></span><br><span class="line">$ dir /opt/nfs</span><br><span class="line">total 12K</span><br><span class="line">drwxr-xr-x 3 nobody nogroup 4.0K Oct 29 13:05 .</span><br><span class="line">drwxr-xr-x 4 root   root    4.0K Oct 29 11:59 ..</span><br><span class="line">drwxrwxrwx 2 root   root    4.0K Oct 29 12:43 archived-default-test-claim-pvc-788e2513-9de6-41d5-bb2d-f57e1fa5ce7c</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes%20%E5%85%AC%E5%85%B1%E5%BB%BA%E8%A8%AD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes%20%E5%85%AC%E5%85%B1%E5%BB%BA%E8%A8%AD/" class="post-title-link" itemprop="url">Kubernetes 公共建設</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-15 14:04:12" itemprop="dateCreated datePublished" datetime="2022-09-15T14:04:12+08:00">2022-09-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 18:14:14" itemprop="dateModified" datetime="2023-05-07T18:14:14+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-公共建設"><a href="#Kubernetes-公共建設" class="headerlink" title="Kubernetes 公共建設"></a>Kubernetes 公共建設</h1><h1 id="學習目標"><a href="#學習目標" class="headerlink" title="學習目標"></a>學習目標</h1><ul>
<li>MetalLB</li>
<li>Nginx ingress</li>
<li>Metrics server</li>
<li>Rook ceph</li>
</ul>
<hr>
<h1 id="Why-MetalLB"><a href="#Why-MetalLB" class="headerlink" title="Why MetalLB"></a>Why MetalLB</h1><p>Kubernetes does not offer an implementation of network load balancers (Services of type LoadBalancer) for bare-metal clusters. The implementations of network load balancers that Kubernetes does ship with are all glue code that calls out to various IaaS platforms (GCP, AWS, Azure…). </p>
<p>MetalLB aims to redress this imbalance by offering a network load balancer implementation that integrates with standard network equipment, so that external services on bare-metal clusters also “just work” as much as possible.</p>
<h1 id="公有雲的環境"><a href="#公有雲的環境" class="headerlink" title="公有雲的環境"></a>公有雲的環境</h1><p><img src="https://i.imgur.com/EM8zSWM.png"></p>
<h1 id="MetalLB-的環境"><a href="#MetalLB-的環境" class="headerlink" title="MetalLB 的環境"></a>MetalLB 的環境</h1><p><img src="https://i.imgur.com/M3hG8ym.png"></p>
<h2 id="MetalLB-安裝"><a href="#MetalLB-安裝" class="headerlink" title="MetalLB 安裝"></a>MetalLB 安裝</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ get -qO - https://raw.githubusercontent.com/metallb/metallb/v0.13.4/config/manifests/metallb-native.yaml | kubectl apply -f -</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">apiVersion: metallb.io/v1beta1</span></span><br><span class="line"><span class="string">kind: IPAddressPool</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: mlb1</span></span><br><span class="line"><span class="string">  namespace: metallb-system</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  addresses:</span></span><br><span class="line"><span class="string">    - 192.168.61.220-192.168.61.230</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: metallb.io/v1beta1</span></span><br><span class="line"><span class="string">kind: L2Advertisement</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: mlb1</span></span><br><span class="line"><span class="string">  namespace: metallb-system&#x27;</span> | kubectl apply -f -</span><br><span class="line"></span><br><span class="line">$ kubectl get pod -n metallb-system -o wide</span><br><span class="line">NAME                          READY   STATUS    RESTARTS   AGE   IP             NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">controller-7476b58756-r5tn4   1/1     Running   0          13m   10.244.1.31    w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">speaker-bnzj7                 1/1     Running   0          41s   192.168.61.4   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">speaker-hrcsp                 1/1     Running   0          13m   192.168.61.6   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">speaker-mfwm5                 1/1     Running   0          13m   192.168.61.7   w2     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>


<h2 id="MetalLB-測試"><a href="#MetalLB-測試" class="headerlink" title="MetalLB 測試"></a>MetalLB 測試</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: Deployment</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: s1.dep</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  replicas: 2</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: s1.dep</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: s1.dep</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">      - name: app</span></span><br><span class="line"><span class="string">        image: quay.io/flysangel/image:app.golang&#x27;</span> | kubectl apply -f -</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: s1</span></span><br><span class="line"><span class="string">  annotations:</span></span><br><span class="line"><span class="string">    metallb.universe.tf/address-pool: mlb1</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">  - port: 80</span></span><br><span class="line"><span class="string">    targetPort: 8080</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    app: s1.dep</span></span><br><span class="line"><span class="string">  type: LoadBalancer&#x27;</span> | kubectl apply -f -</span><br><span class="line"></span><br><span class="line">$ kubectl get pod</span><br><span class="line">NAME                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">s1.dep-55f7bf48df-9znvv   1/1     Running   0          4m3s</span><br><span class="line">s1.dep-55f7bf48df-ghstg   1/1     Running   0          4m3s</span><br><span class="line"></span><br><span class="line">bigred@m1:~/0608$ kubectl get service</span><br><span class="line">NAME         TYPE           CLUSTER-IP    EXTERNAL-IP      PORT(S)        AGE</span><br><span class="line">kubernetes   ClusterIP      10.98.0.1     &lt;none&gt;           443/TCP        8d</span><br><span class="line">s1           LoadBalancer   10.98.0.253   192.168.61.220   80:32544/TCP   13s</span><br><span class="line"></span><br><span class="line">$ curl -w <span class="string">&quot;\n&quot;</span> http://192.168.61.220</span><br><span class="line">&#123;<span class="string">&quot;message&quot;</span>:<span class="string">&quot;Hello Golang&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">$ curl -w <span class="string">&quot;\n&quot;</span> http://192.168.61.220/hostname</span><br><span class="line">&#123;<span class="string">&quot;message&quot;</span>:<span class="string">&quot;s1.dep-55f7bf48df-zcbcp&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">$ curl -w <span class="string">&quot;\n&quot;</span> http://192.168.61.220/hostname</span><br><span class="line">&#123;<span class="string">&quot;message&quot;</span>:<span class="string">&quot;s1.dep-55f7bf48df-b588s&quot;</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="MetalLB-驗證"><a href="#MetalLB-驗證" class="headerlink" title="MetalLB 驗證"></a>MetalLB 驗證</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo arping -c 4 192.168.61.220</span><br><span class="line">ARPING 192.168.61.220 from 192.168.61.4 eth0</span><br><span class="line">Unicast reply from 192.168.61.220 [00:50:56:AB:00:06]  1.083ms</span><br><span class="line">Unicast reply from 192.168.61.220 [00:50:56:AB:00:06]  1.869ms</span><br><span class="line">Unicast reply from 192.168.61.220 [00:50:56:AB:00:06]  0.912ms</span><br><span class="line">Unicast reply from 192.168.61.220 [00:50:56:AB:00:06]  0.997ms</span><br><span class="line">Sent 4 probes (1 broadcast(s))</span><br><span class="line">Received 4 response(s)</span><br></pre></td></tr></table></figure>


<p>請檢查 <code>00:50:56:AB:00:07</code> 此 MAC 為哪台主機？<br>將該台主機關機，五分鐘後重新測試命令，請問 MAC 換至哪台主機？<br>為甚麼是五分鐘後測試？</p>
<hr>
<h1 id="Ingress-controller"><a href="#Ingress-controller" class="headerlink" title="Ingress controller"></a>Ingress controller</h1><p><img src="https://i.imgur.com/dM7Jz7Y.png"></p>
<h2 id="Ingress-Nginx-安裝"><a href="#Ingress-Nginx-安裝" class="headerlink" title="Ingress Nginx 安裝"></a>Ingress Nginx 安裝</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">在windows 更改 /etc/hosts</span><br><span class="line">需用管理員權限執行 CMD</span><br><span class="line">$ notepad C:\Windows\System32\drivers\etc\hosts</span><br><span class="line">192.168.61.220 test.k8s.org quay.k8s.org gf.k8s.org pgf.k8s.org jenkins.k8s.org</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ wget -qO - https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.3.0/deploy/static/provider/cloud/deploy.yaml | sed <span class="string">&#x27;s|name: nginx|name: ig1|g&#x27;</span> | kubectl apply -f -</span><br><span class="line"></span><br><span class="line">$ kubectl get service -n ingress-nginx</span><br><span class="line">NAME                                 TYPE           CLUSTER-IP   EXTERNAL-IP      PORT(S)                      AGE</span><br><span class="line">ingress-nginx-controller             LoadBalancer   10.98.0.47   192.168.61.220   80:31727/TCP,443:30789/TCP   23s</span><br><span class="line">ingress-nginx-controller-admission   ClusterIP      10.98.0.17   &lt;none&gt;           443/TCP                      23s</span><br><span class="line"></span><br><span class="line">$ kubectl get ingressclass</span><br><span class="line">NAME   CONTROLLER             PARAMETERS   AGE</span><br><span class="line">ig1    k8s.io/ingress-nginx   &lt;none&gt;       28s</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes%20Resource%20Storage%20by%20%E6%98%8E%E5%9F%8E%E8%80%81%E5%B8%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes%20Resource%20Storage%20by%20%E6%98%8E%E5%9F%8E%E8%80%81%E5%B8%AB/" class="post-title-link" itemprop="url">Kubernetes Resource Storage by 明城老師</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-15 11:47:22" itemprop="dateCreated datePublished" datetime="2022-09-15T11:47:22+08:00">2022-09-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 18:14:10" itemprop="dateModified" datetime="2023-05-07T18:14:10+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-Resource-Storage-by-明城老師"><a href="#Kubernetes-Resource-Storage-by-明城老師" class="headerlink" title="Kubernetes Resource Storage by 明城老師"></a>Kubernetes Resource Storage by 明城老師</h1><h2 id="學習目標"><a href="#學習目標" class="headerlink" title="學習目標"></a>學習目標</h2><ul>
<li>EmptyDir （ k8s 原生 ）</li>
<li>HostPath  （ k8s 原生 ）</li>
<li>Local Persistent Volumes （ k8s 原生 ）</li>
<li>Local Path Provisioner<ul>
<li>需額外安裝</li>
</ul>
</li>
</ul>
<h2 id="Kubernetes-Volume"><a href="#Kubernetes-Volume" class="headerlink" title="Kubernetes Volume"></a>Kubernetes Volume</h2><p><img src="https://i.imgur.com/q65JTtm.png"></p>
<ul>
<li>emptydir 讓兩個 Container 共用</li>
<li>HostPath, Local Persistent Volumes 可以讓多個 pod 一起使用</li>
<li>當 pod 沒有宣告儲存的地方， pod 掛了 &#x3D; 資料遺失</li>
<li>Storage 在叢集裡面或外面</li>
</ul>
<hr>
<h2 id="EmptyDir-應用"><a href="#EmptyDir-應用" class="headerlink" title="EmptyDir 應用"></a>EmptyDir 應用</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: time-emptydir</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - image: quay.io/flysangel/busybox</span></span><br><span class="line"><span class="string">    name: c1</span></span><br><span class="line"><span class="string">    command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;while true; do echo $(date) &gt; /cache/time; sleep 1; done&quot;]</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      mountPath: /cache</span></span><br><span class="line"><span class="string">  - image: quay.io/flysangel/busybox</span></span><br><span class="line"><span class="string">    name: c2</span></span><br><span class="line"><span class="string">    command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;while true; do cat /cache/time; sleep 5; done&quot;]</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      mountPath: /cache</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">  - name: cache</span></span><br><span class="line"><span class="string">    emptyDir: &#123;&#125;&#x27;</span> &gt; time-pod-emptydir.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">## 建立並啟動 pod</span></span><br><span class="line">$ kubectl apply -f time-pod-emptydir.yaml</span><br><span class="line">pod/time-emptydir created</span><br><span class="line"></span><br><span class="line"><span class="comment">## 檢查 pod 的運作狀態</span></span><br><span class="line">$ kubectl get pod time-emptydir -o wide</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE   IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">time-emptydir   2/2     Running   0          12m   10.244.1.9   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 看 Container 的運作狀況</span></span><br><span class="line">$ kubectl logs time-emptydir -c c2</span><br><span class="line">...</span><br><span class="line">Sun Nov 7 01:55:49 UTC 2021</span><br><span class="line">Sun Nov 7 01:55:54 UTC 2021</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="檢視-Emptydir"><a href="#檢視-Emptydir" class="headerlink" title="檢視 Emptydir"></a>檢視 Emptydir</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ ssh w1 sudo tree /var/lib/kubelet/pods/ | grep -B 10 cache</span><br><span class="line">│               └── token -&gt; ..data/token</span><br><span class="line">├── 4795b226-d3c9-40f4-9941-d6dfe1ada41c</span><br><span class="line">│   ├── containers</span><br><span class="line">│   │   ├── c1</span><br><span class="line">│   │   │   └── c16cc904</span><br><span class="line">│   │   └── c2</span><br><span class="line">│   │       └── 4fe3441b</span><br><span class="line">│   ├── etc-hosts</span><br><span class="line">│   ├── plugins</span><br><span class="line">│   │   └── kubernetes.io~empty-dir</span><br><span class="line">│   │       ├── cache</span><br><span class="line">│   │       │   └── ready</span><br><span class="line">│   │       └── wrapped_kube-api-access-jfsdk</span><br><span class="line">│   │           └── ready</span><br><span class="line">│   └── volumes</span><br><span class="line">│       ├── kubernetes.io~empty-dir</span><br><span class="line">│       │   └── cache</span><br></pre></td></tr></table></figure>


<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 把 pod 宰了</span></span><br><span class="line">$ kubectl delete pod time-emptydir</span><br><span class="line">pod <span class="string">&quot;time-emptydir&quot;</span> deleted</span><br><span class="line"></span><br><span class="line"><span class="comment">## 再檢視一次 Emptydir</span></span><br><span class="line">$ ssh w1 sudo tree /var/lib/kubelet/pods/ | grep -B 10 cache</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="請再次產生-emptyDir-應用，判斷-emptyDir-的生命週期是否與-Pod-一致。"><a href="#請再次產生-emptyDir-應用，判斷-emptyDir-的生命週期是否與-Pod-一致。" class="headerlink" title="請再次產生 emptyDir 應用，判斷 emptyDir 的生命週期是否與 Pod 一致。"></a>請再次產生 emptyDir 應用，判斷 emptyDir 的生命週期是否與 Pod 一致。</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f time-pod-emptydir.yaml</span><br><span class="line">pod/time-emptydir created</span><br><span class="line"></span><br><span class="line">$ ssh w2 sudo tree /var/lib/kubelet/pods/ | grep -B 10 cache</span><br><span class="line">│               └── token -&gt; ..data/token</span><br><span class="line">└── dfbc42a8-6576-4f4b-b9fa-0e2553e98d04</span><br><span class="line">    ├── containers</span><br><span class="line">    │   ├── c1</span><br><span class="line">    │   │   └── a2548b80</span><br><span class="line">    │   └── c2</span><br><span class="line">    │       └── c22897a2</span><br><span class="line">    ├── etc-hosts</span><br><span class="line">    ├── plugins</span><br><span class="line">    │   └── kubernetes.io~empty-dir</span><br><span class="line">    │       ├── cache</span><br><span class="line">    │       │   └── ready</span><br><span class="line">    │       └── wrapped_kube-api-access-qtk78</span><br><span class="line">    │           └── ready</span><br><span class="line">    └── volumes</span><br><span class="line">        ├── kubernetes.io~empty-dir</span><br><span class="line">        │   └── cache</span><br><span class="line">		</span><br><span class="line">$ kubectl delete pod time-emptydir</span><br><span class="line">pod &quot;time-emptydir&quot; deleted</span><br><span class="line"></span><br><span class="line">$ ssh w2 sudo tree /var/lib/kubelet/pods/ | grep -B 10 cache</span><br></pre></td></tr></table></figure>

<p><font color=red><strong>答：一致，但是 Container 的 Overlay2 生命週期可能更短，單獨把 Container 宰了 Overlay2 就沒了。</strong></font></p>
<hr>
<h2 id="HostPath-應用"><a href="#HostPath-應用" class="headerlink" title="HostPath 應用"></a>HostPath 應用</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 宣告 pod yaml 檔</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: time-hostpath</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - image: quay.io/flysangel/busybox</span></span><br><span class="line"><span class="string">    name: c1</span></span><br><span class="line"><span class="string">    command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;while true; do echo $(date) &gt; /cache/time; sleep 1; done&quot;]</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      mountPath: /cache</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      hostPath:</span></span><br><span class="line"><span class="string">        path: /opt/pv/cache&#x27;</span> &gt; time-pod-hostpath.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">## 建立並啟動 pod</span></span><br><span class="line">$ kubectl apply -f time-pod-hostpath.yaml</span><br><span class="line">pod/time-hostpath created</span><br><span class="line"></span><br><span class="line"><span class="comment">## 檢視 pod 運作狀況</span></span><br><span class="line">bigred@m1:~/0608$ kubectl get pod time-hostpath -o wide</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">time-hostpath   1/1     Running   0          9s    10.244.1.10   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看 pod 掛載的目錄區</span></span><br><span class="line">bigred@m1:~/0608$ ssh w1 sudo tree /opt/pv/cache</span><br><span class="line">/opt/pv/cache</span><br><span class="line">└── time</span><br><span class="line"></span><br><span class="line">0 directories, 1 file</span><br><span class="line"></span><br><span class="line"><span class="comment">## 透過 cat 檢視 pod 掛載目錄區裡的檔案內容</span></span><br><span class="line">bigred@m1:~/0608$ ssh w1 sudo <span class="built_in">cat</span> /opt/pv/cache/time</span><br><span class="line">Wed Jun 8 01:56:39 UTC 2022</span><br><span class="line"></span><br><span class="line">bigred@m1:~/0608$ ssh w1 sudo <span class="built_in">cat</span> /opt/pv/cache/time</span><br><span class="line">Wed Jun 8 01:56:48 UTC 2022</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="刪除-pod-檢視-Hostpath-是否存在"><a href="#刪除-pod-檢視-Hostpath-是否存在" class="headerlink" title="刪除 pod 檢視 Hostpath 是否存在"></a>刪除 pod 檢視 Hostpath 是否存在</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete -f time-pod-hostpath.yaml</span><br><span class="line">pod <span class="string">&quot;time-hostpath&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">$ ssh w1 sudo tree /opt/pv/cache</span><br><span class="line">/opt/pv/cache</span><br><span class="line">└── time</span><br><span class="line"></span><br><span class="line">0 directories, 1 file</span><br><span class="line"></span><br><span class="line">$ ssh w1 sudo <span class="built_in">cat</span> /opt/pv/cache/time</span><br><span class="line">Wed Jun 8 02:03:39 UTC 2022</span><br></pre></td></tr></table></figure>

<p>答： 當 pod 被刪除時， Hostpath 還會存在。</p>
<h3 id="反覆建立-emptydir、hostPath-應用，判斷-hostPath-Pod-是否固定於同一個節點上。"><a href="#反覆建立-emptydir、hostPath-應用，判斷-hostPath-Pod-是否固定於同一個節點上。" class="headerlink" title="反覆建立 emptydir、hostPath 應用，判斷 hostPath Pod 是否固定於同一個節點上。"></a>反覆建立 emptydir、hostPath 應用，判斷 hostPath Pod 是否固定於同一個節點上。</h3><p>當 k8s 在建立 pod 時， Scheduler 會判斷 node 的悠閒度，來建立 pod。</p>
<p>:::success</p>
<p>在 yml 檔內宣告 pod 要在 哪台 node 上產生</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: time-hostpath</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - image: quay.io/flysangel/busybox</span></span><br><span class="line"><span class="string">    name: c1</span></span><br><span class="line"><span class="string">    command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;while true; do echo $(date) &gt; /cache/time; sleep 1; done&quot;]</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      mountPath: /cache</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      hostPath:</span></span><br><span class="line"><span class="string">        path: /opt/pv/cache</span></span><br><span class="line"><span class="string">  nodeSelector:</span></span><br><span class="line"><span class="string">    kubernetes.io/hostname: w1&#x27;</span> &gt; time-pod-hostpath.yaml</span><br></pre></td></tr></table></figure>

<p>下面這兩行可以指定 pod 要在哪一個 node 產生</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nodeSelector:</span><br><span class="line">  kubernetes.io/hostname: w1</span><br></pre></td></tr></table></figure>
<p>:::</p>
<h3 id="練習"><a href="#練習" class="headerlink" title="練習"></a>練習</h3><p>題目：建立兩個 hostPath 應用，一個 pod 名稱為 hostPath-1 固定在 w1 的 node 上，另一個 pod 名稱為 hostPath-2 固定在 w2 的 node 上。</p>
<p>答：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: hostpath1</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - image: quay.io/flysangel/busybox</span></span><br><span class="line"><span class="string">    name: c1</span></span><br><span class="line"><span class="string">    command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;while true; do echo $(date) &gt; /cache/time; sleep 1; done&quot;]</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      mountPath: /cache</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      hostPath:</span></span><br><span class="line"><span class="string">        path: /opt/pv/cache</span></span><br><span class="line"><span class="string">  nodeSelector:</span></span><br><span class="line"><span class="string">    kubernetes.io/hostname: w1&#x27;</span> &gt; pod-hostpath-1.yaml</span><br><span class="line">	</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: hostpath2</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - image: quay.io/flysangel/busybox</span></span><br><span class="line"><span class="string">    name: c1</span></span><br><span class="line"><span class="string">    command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;while true; do echo $(date) &gt; /cache/time; sleep 1; done&quot;]</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      mountPath: /cache</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      hostPath:</span></span><br><span class="line"><span class="string">        path: /opt/pv/cache</span></span><br><span class="line"><span class="string">  nodeSelector:</span></span><br><span class="line"><span class="string">    kubernetes.io/hostname: w2&#x27;</span> &gt; pod-hostpath-2.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f pod-hostpath-1.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f pod-hostpath-2.yaml</span><br><span class="line"></span><br><span class="line">$ kg pods -o wide</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">hostpath1   1/1     Running   0          71s   10.244.1.15   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">hostpath2   1/1     Running   0          32s   10.244.2.22   w2     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="認識-Persistent-Volumes"><a href="#認識-Persistent-Volumes" class="headerlink" title="認識 Persistent Volumes"></a>認識 Persistent Volumes</h2><ul>
<li><p>PersistentVolume (PV) </p>
<ul>
<li>a piece of storage in the cluster </li>
<li><font color=red><strong>provisioned by an administrator or dynamically provisioned using Storage Classes.</strong></font> </li>
<li>It is a resource in the cluster just like a node is a cluster resource.</li>
</ul>
</li>
<li><p>PersistentVolumeClaim (PVC) </p>
<ul>
<li>request for storage by a user. </li>
<li>Pods consume node resources and PVCs consume PV resources.</li>
<li>Pods can request specific levels of resources (CPU and Memory).</li>
<li>Claims can request specific size and access modes (ReadWriteOnce, ReadOnlyMany or ReadWriteMany).</li>
</ul>
</li>
</ul>
<p>PV 與 PVC 的 Access modes</p>
<ul>
<li>ReadWriteOnce(RWO)<ul>
<li>the volume can be mounted as read-write by a single node. ReadWriteOnce access mode still can allow multiple pods to access the volume when the pods are running on the same node.</li>
<li><font color=red>在同一個主機，可以提供多個 pod 一起使用同一個 pvc</font></li>
</ul>
</li>
<li>ReadOnlyMany(ROX)<ul>
<li>the volume can be mounted as read-only by many nodes.</li>
<li>在多台主機掛載，但只能讀取</li>
</ul>
</li>
<li>ReadWriteMany(RWX)<ul>
<li>the volume can be mounted as read-write by many nodes.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>PV Persistent Volumes &amp; PVC Persistent Volume Claim<ul>
<li>PVC｜Persistent Volume Claim（PV 的取用宣告）</li>
<li>PV 與 PVC 是一對一關係，只要 PV 與 PVC 建立關係後（Access mode 也必須要符合），PV 就沒辦法被其他 PVC 取用了</li>
<li>取用 PV 只能向上擴充，不能低於 PVC 的需求（要五毛可以給一塊，但不能只給一毛，但多給就是浪費資源）</li>
<li>Persistent Volumes Access mode<ul>
<li>ReadWriteOnce（RWO）<ul>
<li>提供同一個節點的多個 pod 存取</li>
</ul>
</li>
<li>ReadOnlyMany（ROX）<ul>
<li>提供跨節點的多個 pod 存取，唯讀</li>
</ul>
</li>
<li>ReadWriteMany（RWX）<ul>
<li>提供跨節點的多個 pod 存取，可讀可寫</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://i.imgur.com/38qkXr1.png"></p>
<p><img src="https://i.imgur.com/ONd2sk6.png"></p>
<p>當 PVC 這邊</p>
<h2 id="認識-Local-Persistent-Volumes"><a href="#認識-Local-Persistent-Volumes" class="headerlink" title="認識 Local Persistent Volumes"></a><strong>認識 Local Persistent Volumes</strong></h2><ul>
<li><p>What is a Local Persistent Volume?</p>
<ul>
<li>A local persistent volume represents a local disk directly-attached to a single Kubernetes Node.</li>
</ul>
</li>
<li><p>How is it different from a HostPath Volume?</p>
<ul>
<li>To better understand the benefits of a Local Persistent Volume, it is useful to compare it to a HostPath volume. HostPath volumes mount a file or directory from the host node’s filesystem into a Pod. Similarly a Local Persistent Volume mounts a local disk or partition into a Pod.</li>
</ul>
</li>
<li><p>How is it different from a HostPath Volume?</p>
<ul>
<li><p>The biggest difference is that the Kubernetes scheduler understands which node a Local Persistent Volume belongs to. With HostPath volumes, a pod referencing a HostPath volume may be moved by the scheduler to a different node resulting in data loss. But with Local Persistent Volumes, the Kubernetes scheduler ensures that a pod using a Local Persistent Volume is always scheduled to the same node.</p>
</li>
<li><p>Local Persistent Volumes</p>
<ul>
<li>基礎與 hostpath 相同，但是可以單獨掛載硬碟來使用</li>
<li>當 PCV 與 LPV 綁定後，pod 就會被限制在 LPV 的所在節點上</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="建立-Local-Persistent-Volume"><a href="#建立-Local-Persistent-Volume" class="headerlink" title="建立 Local Persistent Volume"></a>建立 Local Persistent Volume</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;kind: PersistentVolume</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: pv-rwo-5m</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  capacity:</span></span><br><span class="line"><span class="string">    storage: 5Mi</span></span><br><span class="line"><span class="string">  accessModes:</span></span><br><span class="line"><span class="string">    - ReadWriteOnce</span></span><br><span class="line"><span class="string">  local:</span></span><br><span class="line"><span class="string">    path: &quot;/opt/pv/5m&quot;</span></span><br><span class="line"><span class="string">  nodeAffinity:</span></span><br><span class="line"><span class="string">    required:</span></span><br><span class="line"><span class="string">      nodeSelectorTerms:</span></span><br><span class="line"><span class="string">      - matchExpressions:</span></span><br><span class="line"><span class="string">        - key: kubernetes.io/hostname</span></span><br><span class="line"><span class="string">          operator: In</span></span><br><span class="line"><span class="string">          values:</span></span><br><span class="line"><span class="string">          - w1&#x27;</span> &gt; pv-rwo-5m.yaml</span><br></pre></td></tr></table></figure>

<h3 id="建立-Local-PersistentVolumeClaim"><a href="#建立-Local-PersistentVolumeClaim" class="headerlink" title="建立 Local PersistentVolumeClaim"></a>建立 Local PersistentVolumeClaim</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: nginx-1</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">    - name: nginx-1</span></span><br><span class="line"><span class="string">      image: quay.io/flysangel/nginx</span></span><br><span class="line"><span class="string">      volumeMounts:</span></span><br><span class="line"><span class="string">        - name: html-storage</span></span><br><span class="line"><span class="string">          mountPath: /usr/share/nginx/html</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: html-storage</span></span><br><span class="line"><span class="string">      persistentVolumeClaim:</span></span><br><span class="line"><span class="string">        claimName: pvc-rwo-3m&#x27;</span> &gt; nginx-pod-1.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f nginx-pod-1.yaml</span><br><span class="line">pod/nginx-1 created</span><br><span class="line"></span><br><span class="line">$ kubectl get pod nginx-1 -o wide </span><br><span class="line">NAME      READY   STATUS              RESTARTS   AGE   IP       NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-1   0/1     ContainerCreating   0          17s   &lt;none&gt;   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ kubectl describe pod nginx-1</span><br><span class="line">...</span><br><span class="line">Warning  FailedMount  12s (x6 over 28s)  kubelet</span><br><span class="line">MountVolume.NewMounter initialization failed <span class="keyword">for</span> volume <span class="string">&quot;pv-rwo-5m&quot;</span> : </span><br><span class="line">path <span class="string">&quot;/opt/pv/5m&quot;</span> does not exist</span><br><span class="line"></span><br><span class="line">$ ssh w1 sudo <span class="built_in">mkdir</span> –p /opt/pv/5m</span><br><span class="line"></span><br><span class="line">$ kubectl get pod -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP             NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-1   1/1     Running   0          11m   10.199.3.207   w1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p><font color=red><strong>注意！HostPath 如果給的目錄不存在，系統會自動幫你建立，但是 PV 本身在建立的時候，要自己建好目錄區，否則就算 PVC 與 PV bound 在一起，一樣會無法建立 pod</strong></font></p>
<h3 id="建立-nginx-首頁"><a href="#建立-nginx-首頁" class="headerlink" title="建立 nginx 首頁"></a>建立 nginx 首頁</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it nginx-1 -- bash</span><br><span class="line">root@nginx-1:/<span class="comment"># echo &#x27;Hello My Pvc&#x27; &gt; /usr/share/nginx/html/index.html</span></span><br><span class="line"></span><br><span class="line">root@nginx-1:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">bigred@m1:~/0608$ ssh w1 <span class="built_in">cat</span> /opt/pv/5m/index.html</span><br><span class="line">Hello My Pvc</span><br><span class="line"></span><br><span class="line">bigred@m1:~/0608$ curl 10.244.1.16</span><br><span class="line">Hello My Pvc</span><br></pre></td></tr></table></figure>

<h3 id="移除-Pod-與-PVC-重新建立"><a href="#移除-Pod-與-PVC-重新建立" class="headerlink" title="移除 Pod 與 PVC 重新建立"></a>移除 Pod 與 PVC 重新建立</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete -f nginx-pod-1.yaml</span><br><span class="line">pod <span class="string">&quot;nginx-1&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">$ kubectl delete -f pvc-rwo-3m.yaml</span><br><span class="line">persistentvolumeclaim <span class="string">&quot;pvc-rwo-3m&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">$ kubectl get pv pv-rwo-5m</span><br><span class="line">NAME        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM                STORAGECLASS   REASON   AGE</span><br><span class="line">pv-rwo-5m   5Mi        RWO            Retain           Released   default/pvc-rwo-3m                           18m</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f pvc-rwo-3m.yaml</span><br><span class="line">persistentvolumeclaim/pvc-rwo-3m created</span><br><span class="line"></span><br><span class="line">$ kubectl get pvc pvc-rwo-3m</span><br><span class="line">NAME         STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">pvc-rwo-3m   Pending         </span><br><span class="line">2s</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">export</span> KUBE_EDITOR=<span class="string">&quot;nano&quot;</span></span><br><span class="line"></span><br><span class="line">$ kubectl edit pv pv-rwo-5m</span><br><span class="line"><span class="comment">## 刪除以下這段</span></span><br><span class="line">  claimRef:</span><br><span class="line">    apiVersion: v1</span><br><span class="line">    kind: PersistentVolumeClaim</span><br><span class="line">    name: pvc-rwo-3m</span><br><span class="line">    namespace: default</span><br><span class="line">    resourceVersion: <span class="string">&quot;602201&quot;</span></span><br><span class="line">    uid: 79c392da-3cc3-4088-876e-e83799c22441</span><br></pre></td></tr></table></figure>

<p>當 pvc 與 pv Bound 過一次後， pv 會一直記著當前的 pvc ，當我們把 pvc 刪掉後，去檢查 pv 的狀態會顯示 Released ，於是我們建了一個一模一樣的 pvc 後發現他的狀態是 Pending ，發現 pv 其實還是記著被刪掉的 pvc ，所以如果要讓 pv 忘記舊的 pvc 要透過 <code>kubectl edit pv $pv_name</code>，進去把紀錄的 pvc 資訊都刪除。</p>
<p>注意！ pv 刪除後，pv 對應的目錄也要刪除，資料才會清空。</p>
<hr>
<h1 id="練習-1"><a href="#練習-1" class="headerlink" title="練習"></a>練習</h1><p>:::success</p>
<p>題目：<br>建立兩個 nginx Pod 掛載相同的 PVC，Access Modes 為 ReadWriteOnce，觀察兩個 Pod 是否在同一台節點上。</p>
<p>答案：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 編輯 nginx-pod-1.yaml檔</span></span><br><span class="line">$ nano nginx-pod-1.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-1</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: nginx-1</span><br><span class="line">      image: quay.io/flysangel/nginx</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - name: html-storage</span><br><span class="line">          mountPath: /usr/share/nginx/html</span><br><span class="line">  volumes:</span><br><span class="line">    - name: html-storage</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: pvc-rwo-3m</span><br><span class="line"></span><br><span class="line"><span class="comment">## 編輯 nginx-pod-2.yaml檔</span></span><br><span class="line">$ nano nginx-pod-2.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-2</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: nginx-2</span><br><span class="line">      image: quay.io/flysangel/nginx</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - name: html-storage</span><br><span class="line">          mountPath: /usr/share/nginx/html</span><br><span class="line">  volumes:</span><br><span class="line">    - name: html-storage</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: pvc-rwo-3m</span><br><span class="line"></span><br><span class="line"><span class="comment">## 編輯 pv 的 yml 檔</span></span><br><span class="line">$ nano pv-rwo-5m.yaml</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: pv-rwo-5m</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 5Mi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    path: <span class="string">&quot;/opt/pv/5m&quot;</span></span><br><span class="line">  nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">      - matchExpressions:</span><br><span class="line">        - key: kubernetes.io/hostname</span><br><span class="line">          operator: In</span><br><span class="line">          values:</span><br><span class="line">          - w1</span><br><span class="line"></span><br><span class="line"><span class="comment">## 編輯 pvc 的 yml 檔</span></span><br><span class="line">$ nano pvc-rwo-3m.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: pvc-rwo-3m</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 3Mi</span><br><span class="line"></span><br><span class="line"><span class="comment">## 建立 pv </span></span><br><span class="line">$ kubectl apply -f pv-rwo-5m.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">## 檢查 pv 狀態</span></span><br><span class="line">$ kg pv</span><br><span class="line">NAME        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   REASON   AGE</span><br><span class="line">pv-rwo-5m   5Mi        RWO            Retain           Bound    default/pvc-rwo-3m                           17s</span><br><span class="line"></span><br><span class="line"><span class="comment">## 建立 pvc</span></span><br><span class="line">$ kubectl apply -f pvc-rwo-3m.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">## 檢查 pvc 狀態</span></span><br><span class="line">$ kg pvc</span><br><span class="line">NAME         STATUS   VOLUME      CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">pvc-rwo-3m   Bound    pv-rwo-5m   5Mi        RWO                           13s</span><br><span class="line"></span><br><span class="line"><span class="comment">## 建立 nginx-pod-1</span></span><br><span class="line">$ kubectl apply -f nginx-pod-1.yaml</span><br><span class="line">pod/nginx-1 created</span><br><span class="line"></span><br><span class="line"><span class="comment">## 建立 nginx-pod-2</span></span><br><span class="line">$ kubectl apply -f nginx-pod-2.yaml</span><br><span class="line">pod/nginx-2 created</span><br><span class="line"></span><br><span class="line"><span class="comment">## 檢視結果是否符合預期</span></span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE     IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-1   1/1     Running   0          2m28s   10.244.1.17   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-2   1/1     Running   0          2m25s   10.244.1.18   w1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p><font color=red>結論：兩個 pod 會在同一個 node</font></p>
<p>:::</p>
<p>:::success</p>
<p>題目：<br>建立兩個 nginx Pod 掛載相同的 PVC，Access Modes 為 ReadWriteMany，將一個 Pod 鎖定在 W1，另一個 Pod 鎖定在 W2，觀察兩個 Pod 的狀態。</p>
<p>答案：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 清理空間</span></span><br><span class="line">$ kubectl delete -f nginx-pod-1.yaml</span><br><span class="line">$ kubectl delete -f nginx-pod-2.yaml</span><br><span class="line">$ kubectl delete -f pvc-rwo-3m.yaml</span><br><span class="line">$ kubectl delete -f pv-rwo-5m.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">## </span></span><br><span class="line"></span><br><span class="line">677  nano pv-rwo-5m.yaml</span><br><span class="line">  678  nano pvc-rwo-3m.yaml</span><br><span class="line">  679  kubectl apply -f pvc-rwo-3m.yaml</span><br><span class="line">  680  kubectl apply -f pv-rwo-5m.yaml</span><br><span class="line">  681  kg pv</span><br><span class="line">  682  kg pvc</span><br><span class="line">  683  kg pv</span><br><span class="line">  684  nano nginx-pod-1.yaml</span><br><span class="line">  685  kubectl apply -f nginx-pod-1.yaml</span><br><span class="line">  686  kubectl apply -f nginx-pod-2.yaml</span><br><span class="line">$ kg pods -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-1   1/1     Running   0          9s    10.244.1.20   w1       &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-2   0/1     Pending   0          5s    &lt;none&gt;        &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<p>:::success</p>
<p>題目：<br>建立一個 nginx pod 掛載 PVC，Access Modes 為 ReadOnlyMany，並產生一個 10MB 的檔案，觀察是否可以正常儲存。</p>
<p>答案：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">$ nano pvc-rwo-3m.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: pvc-rwo-3m</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadOnlyMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 3Mi</span><br><span class="line"></span><br><span class="line">$ nano pv-rwo-5m.yaml</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: pv-rwo-5m</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 5Mi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadOnlyMany</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    path: <span class="string">&quot;/opt/pv/5m&quot;</span></span><br><span class="line">  nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">      - matchExpressions:</span><br><span class="line">        - key: kubernetes.io/hostname</span><br><span class="line">          operator: In</span><br><span class="line">          values:</span><br><span class="line">          - w1</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f pv-rwo-5m.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f pvc-rwo-3m.yaml</span><br><span class="line"></span><br><span class="line">$ kg pv</span><br><span class="line">NAME        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   REASON   AGE</span><br><span class="line">pv-rwo-5m   5Mi        ROX            Retain           Bound    default/pvc-rwo-3m                           22m</span><br><span class="line"></span><br><span class="line">$ kg pvc</span><br><span class="line">NAME         STATUS   VOLUME      CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">pvc-rwo-3m   Bound    pv-rwo-5m   5Mi        ROX                           22m</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f nginx-pod-1.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl get pod nginx-1 -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-1   1/1     Running   0          20m   10.244.1.21   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it nginx-1 -- bash</span><br><span class="line"></span><br><span class="line">root@nginx-1:/usr/share/nginx/html<span class="comment"># dd if=/dev/zero of=test bs=1M count=10</span></span><br><span class="line">10+0 records <span class="keyword">in</span></span><br><span class="line">10+0 records out</span><br><span class="line">10485760 bytes (10 MB, 10 MiB) copied, 0.00454216 s, 2.3 GB/s</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>:::</p>
<p>依序建立 3 個 ROX PV(3g, 5g, 10g)，再依序建立 3 個 PVC(4g, 8g, 5g)，觀察 PVC 與 PV 之關係。</p>
<hr>
<h1 id="Local-Path-Provisioner"><a href="#Local-Path-Provisioner" class="headerlink" title="Local Path Provisioner"></a>Local Path Provisioner</h1><p>Local Path Provisioner provides a way for the Kubernetes users to utilize the local storage in each node. Based on the user configuration, the Local Path Provisioner will create hostPath based persistent volume on the node automatically. It utilizes the features introduced by Kubernetes Local Persistent Volume feature, but make it a simpler solution than the built-in local volume feature in Kubernetes.</p>
<ul>
<li>只要 pod 宣告新增 pvc ，他會自動新增 pv<ul>
<li>單純建立 pvc 的話，不會自動新增 pv</li>
</ul>
</li>
<li>刪除 pvc ，他也會自動幫我們刪除 pv<ul>
<li>pv 的目錄也會被刪除，不會殘留</li>
<li>刪除有使用 pvc 的 pod ，pvc 還會在</li>
</ul>
</li>
<li>StorageClass “local-path”: Only support ReadWriteOnce access mode</li>
<li>capacitiy 也不會限制</li>
</ul>
<h2 id="安裝-Local-Path-Provisioner"><a href="#安裝-Local-Path-Provisioner" class="headerlink" title="安裝 Local Path Provisioner"></a>安裝 Local Path Provisioner</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.22/deploy/local-path-storage.yaml</span><br><span class="line">namespace/local-path-storage created</span><br><span class="line">serviceaccount/local-path-provisioner-service-account created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/local-path-provisioner-role created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/local-path-provisioner-bind created</span><br><span class="line">deployment.apps/local-path-provisioner created</span><br><span class="line">storageclass.storage.k8s.io/local-path created</span><br><span class="line">configmap/local-path-config created</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -n local-path-storage</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">local-path-provisioner-7fdb4745c6-njprx   1/1     Running   0          4m47s</span><br></pre></td></tr></table></figure>

<h2 id="建立-PersistentVolumeClaim"><a href="#建立-PersistentVolumeClaim" class="headerlink" title="建立 PersistentVolumeClaim"></a>建立 PersistentVolumeClaim</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: PersistentVolumeClaim</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: html-storage</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  storageClassName: local-path</span></span><br><span class="line"><span class="string">  accessModes:</span></span><br><span class="line"><span class="string">    - ReadWriteOnce</span></span><br><span class="line"><span class="string">  resources:</span></span><br><span class="line"><span class="string">    requests:</span></span><br><span class="line"><span class="string">      storage: 3Mi&#x27;</span> &gt; nginx-pvc.yaml</span><br><span class="line">	  </span><br><span class="line">$ kubectl apply -f nginx-pvc.yaml</span><br><span class="line">persistentvolumeclaim/html-storage created</span><br><span class="line"></span><br><span class="line">$ kubectl get pvc html-storage </span><br><span class="line">NAME           STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">html-storage   Pending                                      local-path     29s</span><br><span class="line"></span><br><span class="line">$ kubectl get pv</span><br><span class="line">No resources found</span><br><span class="line"></span><br><span class="line">$ kubectl get pod nginx -o wide</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE     IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx   1/1     Running   0          2m11s   10.244.1.23   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="刪除-Pod-檢查-PV-PVC"><a href="#刪除-Pod-檢查-PV-PVC" class="headerlink" title="刪除 Pod 檢查 PV PVC"></a>刪除 Pod 檢查 PV PVC</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete -f nginx-pod.yaml</span><br><span class="line">pod <span class="string">&quot;nginx&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">$ kg pvc</span><br><span class="line">NAME           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">html-storage   Bound    pvc-4a8cd7cc-bcd9-4aec-8d6f-171877bdc51b   3Mi        RWO            local-path     15m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ kubectl delete -f nginx-pvc.yaml</span><br><span class="line">persistentvolumeclaim <span class="string">&quot;html-storage&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">$ kubectl get pvc</span><br><span class="line">No resources found <span class="keyword">in</span> default namespace.</span><br><span class="line"></span><br><span class="line">$ kubectl get pv</span><br><span class="line">No resources found</span><br><span class="line"></span><br><span class="line">$ ssh w1 <span class="built_in">ls</span> -al /opt/local-path-provisioner</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 2 root root 4096 Jun  8 14:47 .</span><br><span class="line">drwxr-xr-x 5 root root 4096 Jun  8 14:32 ..</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="練習-2"><a href="#練習-2" class="headerlink" title="練習"></a>練習</h1><p>:::success</p>
<p>題目：<br>建立兩個 nginx Pod 掛載相同的 PVC，Access Modes 為 ReadWriteOnce，觀察兩個 Pod 是否在同一台節點上。</p>
<p>答案：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$ nano nginx-pod.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-1</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: nginx</span><br><span class="line">      image: quay.io/flysangel/nginx</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - name: html-storage</span><br><span class="line">          mountPath: /usr/share/nginx/html</span><br><span class="line">  volumes:</span><br><span class="line">    - name: html-storage</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: html-storage</span><br><span class="line"></span><br><span class="line">$ nano nginx-pod2.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-2</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: nginx</span><br><span class="line">      image: quay.io/flysangel/nginx</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - name: html-storage</span><br><span class="line">          mountPath: /usr/share/nginx/html</span><br><span class="line">  volumes:</span><br><span class="line">    - name: html-storage</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: html-storage</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f nginx-pod.yaml</span><br><span class="line">pod/nginx-1 created</span><br><span class="line"></span><br><span class="line">bigred@m1:~/0608$ kubectl apply -f nginx-pod2.yaml</span><br><span class="line">pod/nginx-2 created</span><br><span class="line"></span><br><span class="line">bigred@m1:~/0608$ kg pods -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-1   1/1     Running   0          31s   10.244.1.29   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-2   1/1     Running   0          28s   10.244.1.28   w1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<p>建立兩個 nginx Pod 掛載相同的 PVC，Access Modes 為 ReadWriteMany，將一個 Pod 鎖定在 W1，另一個 Pod 鎖定在 W2，觀察兩個 Pod 的狀態。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete -f nginx-pod.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl delete -f nginx-pod2.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl delete -f nginx-pvc.yaml</span><br><span class="line"></span><br><span class="line">$ nano nginx-pvc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: html-storage</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: local-path</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 3Mi</span><br><span class="line"></span><br><span class="line">$ </span><br></pre></td></tr></table></figure>




<p>建立一個 nginx pod 掛載 PVC，Access Modes 為 ReadOnlyMany，並產生一個 10MB 的檔案，觀察是否可以正常儲存。</p>
<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes%20Init%20with%20Config.yaml/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes%20Init%20with%20Config.yaml/" class="post-title-link" itemprop="url">Kubernetes Init with Config.yaml</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-13 11:26:50" itemprop="dateCreated datePublished" datetime="2022-09-13T11:26:50+08:00">2022-09-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 16:15:42" itemprop="dateModified" datetime="2023-05-07T16:15:42+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-Init-with-Config-yaml"><a href="#Kubernetes-Init-with-Config-yaml" class="headerlink" title="Kubernetes Init with Config.yaml"></a>Kubernetes Init with Config.yaml</h1><h2 id="Prepare"><a href="#Prepare" class="headerlink" title="Prepare"></a>Prepare</h2><p>To print the defaults for “init” actions use the following commands:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubeadm config print init-defaults &gt; init-config.yaml</span><br></pre></td></tr></table></figure>


<p>編輯 <code>init-config.yaml</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano init-config.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="comment">#bootstrapTokens:                                       # remove</span></span><br><span class="line"><span class="comment">#- groups:                                              # remove</span></span><br><span class="line"><span class="comment">#  - system:bootstrappers:kubeadm:default-node-token    # remove</span></span><br><span class="line"><span class="comment">#  token: abcdef.0123456789abcdef                       # remove</span></span><br><span class="line"><span class="comment">#  ttl: 24h0m0s                                         # remove</span></span><br><span class="line"><span class="comment">#  usages:                                              # remove</span></span><br><span class="line"><span class="comment">#  - signing                                            # remove</span></span><br><span class="line"><span class="comment">#  - authentication                                     # remove</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">InitConfiguration</span></span><br><span class="line"><span class="attr">localAPIEndpoint:</span></span><br><span class="line">  <span class="attr">advertiseAddress:</span> <span class="number">120.96</span><span class="number">.143</span><span class="number">.76</span>                       <span class="comment"># change from Master node IP</span></span><br><span class="line">  <span class="attr">bindPort:</span> <span class="number">6443</span></span><br><span class="line"><span class="attr">nodeRegistration:</span></span><br><span class="line">  <span class="attr">criSocket:</span> <span class="string">unix:///run/crio/crio.sock</span>                 <span class="comment"># change from CRI-O Unix Socket</span></span><br><span class="line">  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">c3-m1</span>                                           <span class="comment"># change from Master node hsotname</span></span><br><span class="line">  <span class="attr">taints:</span> <span class="literal">null</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiServer:</span></span><br><span class="line">  <span class="attr">timeoutForControlPlane:</span> <span class="string">4m0s</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">kubeadm.k8s.io/v1beta3</span></span><br><span class="line"><span class="attr">certificatesDir:</span> <span class="string">/etc/kubernetes/pki</span></span><br><span class="line"><span class="attr">clusterName:</span> <span class="string">bobo</span>                                        <span class="comment"># set your clusterName</span></span><br><span class="line"><span class="attr">controllerManager:</span> &#123;&#125;</span><br><span class="line"><span class="attr">dns:</span> &#123;&#125;</span><br><span class="line"><span class="attr">etcd:</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">dataDir:</span> <span class="string">/var/lib/etcd</span></span><br><span class="line"><span class="attr">imageRepository:</span> <span class="string">registry.k8s.io</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterConfiguration</span></span><br><span class="line"><span class="attr">kubernetesVersion:</span> <span class="number">1.25</span><span class="number">.0</span></span><br><span class="line"><span class="attr">networking:</span></span><br><span class="line">  <span class="attr">dnsDomain:</span> <span class="string">k8s.bobo.org</span>                                 <span class="comment"># DNS domain used by Kubernetes Services.</span></span><br><span class="line">  <span class="attr">podSubnet:</span> <span class="number">10.244</span><span class="number">.0</span><span class="number">.0</span><span class="string">/16</span>                                <span class="comment"># the subnet used by Pods.</span></span><br><span class="line">  <span class="attr">serviceSubnet:</span> <span class="number">10.98</span><span class="number">.0</span><span class="number">.0</span><span class="string">/24</span>                             <span class="comment"># subnet used by Kubernetes Services.</span></span><br><span class="line"><span class="attr">scheduler:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>nodeRegistration.taints</code>，taints specifies the taints the Node API object should be registered with. If this field is unset, i.e. nil, in the kubeadm init process it will be defaulted with a control-plane taint for control-plane nodes. <strong>If you don’t want to taint your control-plane node, set this field to an empty list, i.e. taints: <code>[]</code> in the YAML file. This field is solely used for Node registration.</strong></li>
</ul>
<h2 id="初始化-K8S"><a href="#初始化-K8S" class="headerlink" title="初始化 K8S"></a>初始化 K8S</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo kubeadm init --config=init-config.yaml</span><br></pre></td></tr></table></figure>

<ul>
<li><code>--config string</code> ，Path to a kubeadm configuration file.</li>
<li>When executing <code>kubeadm init</code> with the <code>--config</code> option, the following configuration types could be used: <ul>
<li>InitConfiguration</li>
<li>ClusterConfiguration</li>
<li>KubeProxyConfiguration</li>
<li>KubeletConfiguration</li>
</ul>
</li>
<li>but only one between <strong>InitConfiguration</strong> and <strong>ClusterConfiguration</strong> is <strong>mandatory</strong>.</li>
<li>If some configuration types are not provided, or provided only partially, kubeadm will use default values</li>
</ul>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/config-api/kubeadm-config.v1beta3/">kubeadm Configuration (v1beta3) - Kubernetes DOC</a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/">Configure Access to Multiple Clusters - Kubernetes DOC </a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes-Cluster-build/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes-Cluster-build/" class="post-title-link" itemprop="url">Kubernetes-Cluster-build</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-05 02:34:30" itemprop="dateCreated datePublished" datetime="2022-09-05T02:34:30+08:00">2022-09-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 18:14:16" itemprop="dateModified" datetime="2023-05-07T18:14:16+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-Cluster-build"><a href="#Kubernetes-Cluster-build" class="headerlink" title="Kubernetes-Cluster-build"></a>Kubernetes-Cluster-build</h1><p>將 m1 主機安裝成 Kubernetes 的 Master</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 在 Windows 系統的 cmd 視窗, 執行以下命令</span><br><span class="line">$ ssh bigred@&lt;alp.m1 IP&gt;</span><br></pre></td></tr></table></figure>

<p>安裝 Kubernetes 要用的一些管理命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apk update; sudo apk add kubeadm kubelet kubectl --update-cache --repository http://dl-3.alpinelinux.org/alpine/edge/testing/ --allow-untrusted</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kubeadm</code>，建置 K8S 會用到的命令</li>
<li><code>kubelet</code>，將 <code>CRI-O</code> 建立出來的 Container 包成 pod 的程式</li>
<li><code>kubectl</code>，controls the Kubernetes cluster manager，<a target="_blank" rel="noopener" href="https://jamesdefabia.github.io/docs/user-guide/kubectl-overview/">kubectl-overview 官網介紹連結</a></li>
<li><code>apk add</code> 命令補充<ul>
<li><code>--repository &lt;REPO&gt;</code>，指定其他套件下載網址</li>
<li><code>--update-cache</code>， Alias for ‘–cache-max-age 1’</li>
<li><code>--allow-untrusted</code>，安裝帶有不受信任簽名或沒有簽名的套件</li>
</ul>
</li>
<li>因為手工建立 K8S 的關係，所以可以用到最新的版本</li>
</ul>
<h2 id="建立-K8S-Master"><a href="#建立-K8S-Master" class="headerlink" title="建立 K8S Master"></a>建立 K8S Master</h2><p>m1 的 IP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ echo $IP</span><br><span class="line">192.168.61.4</span><br></pre></td></tr></table></figure>

<p>透過 <code>kubeadm</code> 來設定 Master 主機</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo kubeadm init --service-cidr 10.98.0.0/24 --pod-network-cidr 10.244.0.0/16  --service-dns-domain=k8s.org --apiserver-advertise-address $IP</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kubeadm init</code> ，設定 Kubernetes control plane ( m1 主機 )，將它初始化</li>
<li><code>--service-cidr 10.98.0.0/24</code>，K8S <strong>對外</strong>提供服務的 IP 位址，給我們辦公室的同仁們，機房的其他應用系統，甚至 Internet 上面的使用者，來提供這樣的服務，我們設定的是<code>10.98.0.0/24</code> ，所以代表我們 Kubernetes 做出來的服務最多可以有 254 個。</li>
<li><code>--pod-network-cidr 10.244.0.0/16</code>，pod 的 IP 位址範圍，可以有 254 * 254 &#x3D; 64516 個 pod。 </li>
<li>以上兩個設定其實只要是私有 IP 就 ok 。</li>
<li><code>--service-dns-domain=k8s.org</code>，因為 K8S 內部有 Service Discovery ，所以要設定 Domain Name ，對外的應用系統連接網址使用此設定名稱，在外面做案子的話，就用公司的 Domain Name 來命名。</li>
<li><code>--apiserver-advertise-address $IP</code>，將 m1 主機的 IP 位址 設定為 Kubernetes Master 的 <code>API Server</code> 的 IP</li>
<li><a target="_blank" rel="noopener" href="https://www.densify.com/kubernetes-autoscaling/kubernetes-service-discovery">Kubernetes Service Discovery 介紹連結</a></li>
</ul>
<p>將 <code>Kubelet</code> 設定為系統自動啟動</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rc-update add kubelet default</span><br></pre></td></tr></table></figure>

<ul>
<li>為何 <code>Kubelet</code>，需設定為系統自動啟動 ?<br>因為它是一個 Daemon ，需要在背景一直 running 來等待 Scheduler 來找他。</li>
</ul>
<p>檢查 pod 的 image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman images</span><br><span class="line">REPOSITORY                                                TAG         IMAGE ID      CREATED        SIZE</span><br><span class="line">k8s.gcr.io/kube-apiserver                                 v1.24.3     d521dd763e2e  3 weeks ago    131 MB</span><br><span class="line">k8s.gcr.io/kube-proxy                                     v1.24.3     2ae1ba6417cb  3 weeks ago    112 MB</span><br><span class="line">k8s.gcr.io/kube-controller-manager                        v1.24.3     586c112956df  3 weeks ago    121 MB</span><br><span class="line">k8s.gcr.io/kube-scheduler                                 v1.24.3     3a5aa3a515f5  3 weeks ago    52.3 MB</span><br><span class="line">docker.io/rancher/mirrored-flannelcni-flannel             v0.19.0     c4300d1c88c8  4 weeks ago    63.3 MB</span><br><span class="line">docker.io/rancher/mirrored-flannelcni-flannel-cni-plugin  v1.1.0      fcecffc7ad4a  2 months ago   8.37 MB</span><br><span class="line">k8s.gcr.io/etcd                                           3.5.3-0     aebe758cef4c  3 months ago   301 MB</span><br><span class="line">docker.io/rancher/local-path-provisioner                  v0.0.22     e16d1e3a1066  4 months ago   35.3 MB</span><br><span class="line">k8s.gcr.io/pause                                          3.7         221177c6082a  5 months ago   718 kB</span><br><span class="line">k8s.gcr.io/coredns/coredns                                v1.8.6      a4ca41631cc7  10 months ago  47 MB</span><br><span class="line">registry.k8s.io/pause                                     3.6         6270bb605e12  11 months ago  690 kB</span><br></pre></td></tr></table></figure>

<ul>
<li><code>docker.io/rancher/mirrored-flannelcni-flannel:v1.1.0</code></li>
<li><code>docker.io/rancher/mirrored-flannelcni-flannel-cni-plugin:v0.19.0</code></li>
<li>以上兩片 image 是陳老師先幫我們準備好的</li>
</ul>
<h2 id="設定-K8S-Master"><a href="#設定-K8S-Master" class="headerlink" title="設定 K8S Master"></a>設定 K8S Master</h2><p>將 bigred 設成 K8S 管理者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p $HOME/.kube; sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config; sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br></pre></td></tr></table></figure>

<ul>
<li>先在使用者家目錄下建立一個 <code>.kube</code> 的目錄</li>
<li>然後拷貝 <code>admin.conf</code> 這個 K8S 管理者的設定檔到 使用者家目錄下 <code>.kube</code> 目錄裡面的 <code>config</code> 這個檔案裡面</li>
<li>最後將 <code>config</code> 的權限設為 當前使用者的權限</li>
<li><code>cp -i</code> ，覆蓋前會提示</li>
<li><code>id -u</code> ，顯示當前使用者的 UID</li>
<li><code>id -g</code> ，顯示當前使用者群組的 GID</li>
</ul>
<p>設定 K8S Master 可以執行 Pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl taint node m1 node-role.kubernetes.io/control-plane:NoSchedule-</span><br></pre></td></tr></table></figure>

<ul>
<li>K8s 的每個 node 都會有標記 taint ，而 m1 這台 node 在 K8S 初始化的時候會被標記 <code>NoSchedule</code> 的 taint ，有了這個 taint 之後， pod 就不會建在 m1 的 node 上，這時候在規則裡面改成 <code>NoSchedule-</code> ， 就能破格。</li>
</ul>
<p>Kubernetes 1.24.4 版還要再執行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl taint node m1 node-role.kubernetes.io/master:NoSchedule-</span><br></pre></td></tr></table></figure>


<h2 id="安裝-Flannel-網路套件"><a href="#安裝-Flannel-網路套件" class="headerlink" title="安裝 Flannel 網路套件"></a>安裝 Flannel 網路套件</h2><p>flannel 網路套件，動用的技術 : Static Route</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>

<ul>
<li>因建立 K8S 設定 POD 的 Subnet 為 10.244.0.0&#x2F;16, 而 flannel 內定網路 ID 為 10.244.0.0&#x2F;16, 所以不需修改 kube-flannel.yml</li>
</ul>
<p>安裝好後，將 m1 主機重新開機</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo reboot</span><br></pre></td></tr></table></figure>

<h2 id="檢視-Kubernetes-系統狀態"><a href="#檢視-Kubernetes-系統狀態" class="headerlink" title="檢視 Kubernetes 系統狀態"></a>檢視 Kubernetes 系統狀態</h2><p>檢查 node 的狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br><span class="line">NAME   STATUS   ROLES           AGE   VERSION</span><br><span class="line">m1     Ready    control-plane   74m   v1.24.3</span><br></pre></td></tr></table></figure>

<p>檢查 kube-system 這個 Namespace 裡面 pod 的狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-6d4b75cb6d-grkmp     1/1     Running   1          37m</span><br><span class="line">coredns-6d4b75cb6d-xlgfd     1/1     Running   1          37m</span><br><span class="line">etcd-m1                      1/1     Running   1          37m</span><br><span class="line">kube-apiserver-m1            1/1     Running   1          37m</span><br><span class="line">kube-controller-manager-m1   1/1     Running   1          37m</span><br><span class="line">kube-proxy-ftk9d             1/1     Running   1          37m</span><br><span class="line">kube-scheduler-m1            1/1     Running   1          37m</span><br></pre></td></tr></table></figure>

<p><strong>注意！這邊的 Namespace 與 linux 的 namespace 不同</strong></p>
<ul>
<li><code>-n</code> ， namespace ，K8S 系統的運作空間</li>
<li><code>coredns</code>，供外部通訊所使用的 Domain Name Server ( 負責做 Service Discovery )</li>
<li><code>kube-apiserver-m1</code>，負責接收使用者的命令</li>
<li><code>etcd-m1</code>，紀錄 K8S 系統的 Metadata</li>
<li><code>kube-scheduler-m1</code>，負責啟動 Pod</li>
<li><code>kube-controller-manager-m1</code>，負責監控與維護 Pod</li>
<li><code>flannel</code> + <code>kube-proxy</code> 可以讓 pod 在不同 nodes 之間網路能互通有無</li>
</ul>
<p>看 m1 主機維運系統的 4 個 pod 的 Container 狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ crictl ps -a</span><br></pre></td></tr></table></figure>

<p>output : </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CONTAINER           IMAGE                                                              CREATED             STATE               NAME                      ATTEMPT             POD ID              POD</span><br><span class="line">45c3af598722d       a4ca41631cc7ac19ce1be3ebf0314ac5f47af7c711f17066006db82ee3b75b03   9 minutes ago       Running             coredns                   1                   1a9c8965ba001       coredns-6d4b75cb6d-xlgfd</span><br><span class="line">54317fe6de819       a4ca41631cc7ac19ce1be3ebf0314ac5f47af7c711f17066006db82ee3b75b03   9 minutes ago       Running             coredns                   1                   6581b3ba9f2b8       coredns-6d4b75cb6d-grkmp</span><br><span class="line">06f7e1a7dc5c4       252b2c3ee6c86b9cba63c9bddc2d1638d4152b5713009ff9397498014d06178e   10 minutes ago      Running             kube-flannel              1                   b0b014f1d4cb6       kube-flannel-ds-r5p9q</span><br><span class="line">f32b9416f5600       2ae1ba6417cbcd0b381139277508ddbebd0cf055344b710f7ea16e4da954a302   10 minutes ago      Running             kube-proxy                1                   f5b632754d09e       kube-proxy-ftk9d</span><br><span class="line">81fa3b96f83f4       252b2c3ee6c86b9cba63c9bddc2d1638d4152b5713009ff9397498014d06178e   10 minutes ago      Exited              install-cni               1                   b0b014f1d4cb6       kube-flannel-ds-r5p9q</span><br><span class="line">38cdbe521c340       fcecffc7ad4af70c8b436d45688771e0562cbd20f55d98581ba22cf13aad360d   10 minutes ago      Exited              install-cni-plugin        1                   b0b014f1d4cb6       kube-flannel-ds-r5p9q</span><br><span class="line">46ac2b6b44a73       586c112956dfc2de95aef392cbfcbfa2b579c332993079ed4d13108ff2409f2f   10 minutes ago      Running             kube-controller-manager   1                   1132c83fc98fc       kube-controller-manager-m1</span><br><span class="line">adbf8a41e4cb8       d521dd763e2e345a72534dd1503df3f5a14645ccb3fb0c0dd672fdd6da8853db   10 minutes ago      Running             kube-apiserver            1                   e2caae9b8b044       kube-apiserver-m1</span><br><span class="line">ee38c42a981d8       aebe758cef4cd05b9f8cee39758227714d02f42ef3088023c1e3cd454f927a2b   10 minutes ago      Running             etcd                      1                   dc7ecd13048ef       etcd-m1</span><br><span class="line">794fdd119dd8d       3a5aa3a515f5d28b31ac5410cfaa56ddbbec1c4e88cbdf711db9de6bbf6b00b0   10 minutes ago      Running             kube-scheduler            1                   ded0bada61429       kube-scheduler-m1</span><br></pre></td></tr></table></figure>






<h2 id="w1-w2-安裝-kubelet-及-kubeadm-命令"><a href="#w1-w2-安裝-kubelet-及-kubeadm-命令" class="headerlink" title="w1, w2 安裝 kubelet 及 kubeadm 命令"></a>w1, w2 安裝 kubelet 及 kubeadm 命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ssh 到 w1 主機安裝 kubelet 及 kubeadm 命令</span><br><span class="line">$ ssh w1 &#x27;sudo apk add kubeadm kubelet --update-cache --repository http://dl-3.alpinelinux.org/alpine/edge/testing/ --allow-untrusted&#x27;</span><br><span class="line"></span><br><span class="line"># ssh 到 w2 主機安裝 kubelet 及 kubeadm 命令</span><br><span class="line">$ ssh w2 &#x27;sudo apk add kubeadm kubelet --update-cache --repository http://dl-3.alpinelinux.org/alpine/edge/testing/ --allow-untrusted&#x27;</span><br><span class="line"></span><br><span class="line"># ssh 到 w1, w2 主機，將 kubelet 設成 Deamon</span><br><span class="line">$ ssh w1 &#x27;sudo rc-update add kubelet default&#x27;; ssh w2 &#x27;sudo rc-update add kubelet default&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>work node 不裝 <code>kubectl</code> 的原因是因為我們規劃的管理主機在 m1 ，work node 不需要管理其他機器。</li>
</ul>
<h2 id="w1-w2-加入-K8S-Cluster"><a href="#w1-w2-加入-K8S-Cluster" class="headerlink" title="w1, w2 加入 K8S Cluster"></a>w1, w2 加入 K8S Cluster</h2><p>在 m1 的終端機, 執行以下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 設定 JOIN 環境變數</span></span><br><span class="line">$ <span class="built_in">export</span> JOIN=$(<span class="built_in">echo</span> <span class="string">&quot; sudo `kubeadm token create --print-join-command 2&gt;/dev/null`&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 將 w1 主機，join 到 m1 的這個 k8s 的 Cluster</span></span><br><span class="line">$ ssh w1 <span class="string">&quot;<span class="variable">$JOIN</span>&quot;</span>; ssh w2 <span class="string">&quot;<span class="variable">$JOIN</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 將 w2 主機，join 到 m1 的這個 k8s 的 Cluster</span></span><br><span class="line">$ ssh w1 sudo reboot; ssh w2 sudo reboot</span><br></pre></td></tr></table></figure>

<p>:::info</p>
<p>:::spoiler JOIN 變數解析 </p>
<p>描述 : 將 w1 和 w2 的主機，join 到 K8S 系統的命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ echo &quot; sudo `kubeadm token create --print-join-command`&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>--print-join-command</code>，不要只打印令牌，而是打印使用令牌加入集群所需的完整 “kubeadm join” 標誌。</li>
</ul>
<p>output : </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm join 192.168.61.4:6443 --token tx06v1.le8z0pagl0ltfycz --discovery-token-ca-cert-hash sha256:0f4c243af9e70715a72f30ba0bc5cc44210f1b8fc66447cde16bad3a8c48d691</span><br></pre></td></tr></table></figure>

<ul>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-token/">Kubernetes 官網 kubeadm token 的說明連結 </a></li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/admin/bootstrap-tokens/">kubeadm token 補充</a></li>
</ul>
<p>:::</p>
<h2 id="設定-K8S-Worker-標籤"><a href="#設定-K8S-Worker-標籤" class="headerlink" title="設定 K8S Worker 標籤"></a>設定 K8S Worker 標籤</h2><p>在 m1 終端機, 執行以下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br><span class="line">NAME   STATUS   ROLES           AGE     VERSION</span><br><span class="line">m1     Ready    control-plane   76m     v1.24.3</span><br><span class="line">w1     Ready    &lt;none&gt;          4m21s   v1.24.3</span><br><span class="line">w2     Ready    &lt;none&gt;          79s     v1.24.3</span><br></pre></td></tr></table></figure>

<p>即使此時 w1 和 w2 <code>notready</code> ，也可以貼標籤，因為它是對 <code>etcd</code> 的資料庫作業。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl label node w1 node-role.kubernetes.io/worker=; kubectl label node w2 node-role.kubernetes.io/worker=</span><br></pre></td></tr></table></figure>

<ul>
<li>對 w1 和 w2 node 的 role 貼上 worker 的標籤</li>
<li><code>worker=</code>， worker 的等號後面還可以放更詳細的說明，例如 : Asia, Taipei… 等</li>
</ul>
<p>檢查是否符合預期</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br><span class="line">NAME   STATUS   ROLES           AGE   VERSION</span><br><span class="line">m1     Ready    control-plane   75m   v1.24.3</span><br><span class="line">w1     Ready    worker          37m   v1.24.3</span><br><span class="line">w2     Ready    worker          36m   v1.24.3</span><br></pre></td></tr></table></figure>



<hr>
<h1 id="Kubernetes-檢測"><a href="#Kubernetes-檢測" class="headerlink" title="Kubernetes 檢測"></a>Kubernetes 檢測</h1><h2 id="建立-K8S-POD"><a href="#建立-K8S-POD" class="headerlink" title="建立 K8S POD"></a>建立 K8S POD</h2><p>kubectl run 產生 pod ，pod 名字 nginx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run nginx --image=quay.io/cloudwalker/nginx</span><br><span class="line">pod/nginx created --&gt; ( 高機率騙人，有可能產生出來是掛的 )</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kubectl run</code>，Create and run a particular image in a pod.</li>
<li><code>--image=&#39;&#39;</code>，The image for the container to run.</li>
</ul>
<p>檢查是否符合預期</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME    READY   STATUS              RESTARTS   AGE</span><br><span class="line">nginx   0/1     ContainerCreating   0          8s</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx   1/1     Running   0          52s</span><br><span class="line"></span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE   IP           NODE   NOMINATED NODE   READINESS GATE</span><br><span class="line">nginx   1/1     Running   0          74s   10.244.1.3   w1     &lt;none&gt;     &lt;none&gt;</span><br><span class="line">-o output </span><br></pre></td></tr></table></figure>

<ul>
<li>READY 的 1&#x2F;1 </li>
<li>分子 -&gt; 幾台正在 running 的 Container ; 分母 1 個 pod 有幾台 Container</li>
<li><code>-o wide</code> ，可以看到 pod 的 ip 位址，和所在的 node</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ curl -s http://10.244.1.3 | grep &#x27;Welcome&#x27;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line"># 刪除 pod &lt;pod name&gt;</span><br><span class="line">$ kubectl delete pods nginx</span><br><span class="line"></span><br><span class="line">$ kubectl run nginx --image=quay.io/cloudwalker/nginx</span><br><span class="line">pod/nginx created</span><br><span class="line"></span><br><span class="line">$ kubectl run a1 --image=quay.io/cloudwalker/alpine</span><br><span class="line">pod/a1 created</span><br><span class="line"></span><br><span class="line">## 失敗原因是因為 </span><br><span class="line">## quay.io/cloudwalker/alpine 這張光碟片第一個跑的命令是 sh，</span><br><span class="line">## 所以後面給一個虛擬終端機</span><br><span class="line">$ kg pods</span><br><span class="line">NAME    READY   STATUS             RESTARTS      AGE</span><br><span class="line">a1      0/1     CrashLoopBackOff   2 (18s ago)   44s</span><br><span class="line"></span><br><span class="line"># -it ，給一個個虛擬終端機</span><br><span class="line"># --rm ，pod 停止就刪除 pod</span><br><span class="line">$ kubectl run a1 --rm --image=quay.io/cloudwalker/alpine -it</span><br><span class="line"></span><br><span class="line">$ kubectl exec -it a1 -- sh</span><br><span class="line">## 要對 pod 下達命令一定要在 -- 後面</span><br><span class="line">/ # curl http://10.244.1.3</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">...中間省略</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">/ # exit</span><br></pre></td></tr></table></figure>

<ul>
<li>兩個 pod 之間可以互通有無</li>
<li>工作主機 和 master 主機也可以的到 nginx 那台 pod<br><img src="https://i.imgur.com/wyEgvEA.png"><br><img src="https://i.imgur.com/wlGqQgP.png"><br><img src="https://i.imgur.com/GBHb05F.png"></li>
</ul>
<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes-First-Steps/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/Kubernetes-First-Steps/" class="post-title-link" itemprop="url">Kubernetes-First-Steps</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-04 03:30:10" itemprop="dateCreated datePublished" datetime="2022-09-04T03:30:10+08:00">2022-09-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 18:14:19" itemprop="dateModified" datetime="2023-05-07T18:14:19+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Kubernetes-First-Steps"><a href="#Kubernetes-First-Steps" class="headerlink" title="Kubernetes-First-Steps"></a>Kubernetes-First-Steps</h1><h2 id="建立-K8S-應用物件方式"><a href="#建立-K8S-應用物件方式" class="headerlink" title="建立 K8S 應用物件方式"></a>建立 K8S 應用物件方式</h2><ul>
<li><code>kubectl run</code> (命令式 Imperative) - Manage K8s object (POD, Controller, Service) using CLI<ul>
<li>透過以上命令式建立 pod 能做到的功能是有限的。</li>
<li>e.g., 像要讓 pod 到指定 node 去 run 是做不到的; K8S 還有很多物件是無法用 <code>kubeclt run</code> 的方法產生</li>
<li><code>kubectl run</code> (Imperative) 這命令適合做概念性(物件的雛形)驗證 (Proof of Concept；POC)</li>
<li>結論 : <code>kubeclt run</code> 的方法 對於 K8S 能產生和設定多少物件是有限的</li>
</ul>
</li>
<li><code>kubectl create/apply</code> (聲明式 Declarative) - By defining K8s objects in yaml file<ul>
<li>K8S 產生物件的正規做法，但有個必要條件，須先設計 yaml 檔，才能產生對應的物件</li>
<li><code>kubectl create</code> (Declarative) 與 yaml 設定檔適合建立複雜的企業應用服務</li>
</ul>
</li>
<li>“Imperative” is a command - like “create 42 widgets”.</li>
<li>“Declarative” is a statement of the desired end result - like “I want 42 widgets to exist”.</li>
<li>For creating multiple complex object, declarative approach is preferred as it follows Infrastructure as a Code approach. However, imperative approach is also useful when we want to do quick POC and save yourself from writing yaml files. Let’s take a look at some imperative commands.</li>
</ul>
<h1 id="Using-Namespace"><a href="#Using-Namespace" class="headerlink" title="Using Namespace"></a>Using Namespace</h1><ul>
<li>在 K8S 裡的 Namespace ，可以想像成大樓裡的辦公室，裡面可以有很多人 (Container)，辦公室中還可以有很多桌子、椅子和影印機…等物件(pod, deployment, Service…等)</li>
<li><strong>Partition Cluster resources</strong>.</li>
<li>Kubernetes Namespaces can be used to divide a cluster into logical partitions allowing a single large Kubernetes cluster to be used by multiple users and teams, or a single user with multiple applications. Each user, team, or application running in a Namespace, is isolated from every other user, team, or application in other Namespaces and they operate as if they are the sole user of the cluster (note that Namespaces do not provide network segmentation).</li>
<li>Namespaces 有以下幾個特點<ul>
<li>在同一個 Kubernetes Cluster 中，每個 Namespaces 的名稱都是要獨特的</li>
<li>當一個 Namespaces 被刪除時，在該 Namespace 裡的所有物件也會被刪除<ul>
<li>注意!只會刪除 K8S 產生的物件，如果 K8S 的物件有產生檔案或目錄是不會被刪除的。</li>
</ul>
</li>
<li>可以透過 Resource Quotas 限制一個 Namespaces 所可以存取的資源<ul>
<li>不只限制可用的運算資源，還能限制 K8S 的物件</li>
<li>有防火牆的機制，可以允許或禁止 pod 連到另一個 Namespace 的 pod ，或是讓一個 pod 可以上網</li>
</ul>
</li>
</ul>
</li>
<li>結論 : K8S 的物件一定要指定一個 Namespace 給它 run。開發應用系統必定會建立專案目錄, 設計 K8S Application 需在 Namespace, 來運作</li>
</ul>
<p><strong>檢視 K8S 當前所有 Namespace 的資訊</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get ns</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   10d</span><br><span class="line">kube-flannel      Active   10d</span><br><span class="line">kube-node-lease   Active   10d</span><br><span class="line">kube-public       Active   10d</span><br><span class="line">kube-system       Active   10d</span><br></pre></td></tr></table></figure>

<ul>
<li><code>default</code>，預設的 Namespaces 名稱為 default，過去我們產生的物件像是， Deployment， Services 等若沒特別指定 Namespace 都是存放在名稱為 default 的 namespaces 中。</li>
<li><code>kube-public</code>，是個特殊的 namespace，存放在裡面的物件可被所有的使用者讀取。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-6d4b75cb6d-tslq8     1/1     Running   5          10d</span><br><span class="line">coredns-6d4b75cb6d-vqz9h     1/1     Running   5          10d</span><br><span class="line">etcd-m1                      1/1     Running   5          10d</span><br><span class="line">kube-apiserver-m1            1/1     Running   5          10d</span><br><span class="line">kube-controller-manager-m1   1/1     Running   5          10d</span><br><span class="line">kube-proxy-274g9             1/1     Running   4          10d</span><br><span class="line">kube-proxy-kqlrm             1/1     Running   4          10d</span><br><span class="line">kube-proxy-zw6sb             1/1     Running   5          10d</span><br><span class="line">kube-scheduler-m1            1/1     Running   5          10d</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kube-system</code>，在 Kubernetes 中，較特別的資源都會存放在 kube-system 這個 namespace。若是用 <code>kubectl get all -n kube-system</code> 查看，可以發現 kube-dns 或是 kube-apiserver…等維運系統的 pod 都是存放在該 namepsace 中。</li>
<li>Namespace 參考文章連結 : <a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/m/articles/10197186">https://ithelp.ithome.com.tw/m/articles/10197186</a></li>
</ul>
<h2 id="K8S-default-Namespace"><a href="#K8S-default-Namespace" class="headerlink" title="K8S default Namespace"></a>K8S default Namespace</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create deployment --image quay.io/cloudwalker/nginx demo-nginx</span><br><span class="line">deployment.apps/demo-nginx created</span><br><span class="line"></span><br><span class="line">$ kubectl describe deployment demo-nginx | grep Namespace</span><br><span class="line">Namespace:              default</span><br><span class="line"></span><br><span class="line">$ kubectl create deployment --image quay.io/cloudwalker/nginx demo-nginx</span><br><span class="line">Error from server (AlreadyExists): deployments.apps &quot;demo-nginx&quot; already exists</span><br><span class="line"></span><br><span class="line">$ kubectl create deployment --image quay.io/cloudwalker/nginx demo-nginx -n kube-public</span><br></pre></td></tr></table></figure>



<h2 id="Assigning-Pods-to-Namespace"><a href="#Assigning-Pods-to-Namespace" class="headerlink" title="Assigning Pods to Namespace"></a>Assigning Pods to Namespace</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 建立工作目錄</span><br><span class="line">$ mkdir -p ~/wulin/yaml; cd ~/wulin</span><br><span class="line"></span><br><span class="line"># 建立新的 namespace</span><br><span class="line">$ kubectl create namespace myoffice</span><br><span class="line">namespace/myoffice created</span><br><span class="line"></span><br><span class="line"># 檢查有無建立成功</span><br><span class="line">$ kubectl get namespace</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   10d</span><br><span class="line">kube-flannel      Active   10d</span><br><span class="line">kube-node-lease   Active   10d</span><br><span class="line">kube-public       Active   10d</span><br><span class="line">kube-system       Active   10d</span><br><span class="line">myoffice          Active   2s</span><br><span class="line"></span><br><span class="line"># 刪除 myoffice namespace</span><br><span class="line">$ kubectl delete namespace myoffice</span><br><span class="line"></span><br><span class="line"># 再次建立 myoffice namespace</span><br><span class="line">$ kubeclt create namespace myoffice</span><br><span class="line"></span><br><span class="line"># 檢查</span><br><span class="line">$ kubectl get namespace</span><br></pre></td></tr></table></figure>


<p>建立 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run n1 --image=quay.io/cloudwalker/alpine -n myoffice -- sleep infinity</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kubectl run</code>，用指定 image 產生 pod</li>
<li><code>n1</code>，pod 的名字</li>
<li><code>-n myoffice</code>，指定等等的 pod 會建在 myoffice 這個 namespace</li>
<li><code>-- sleep infinity</code>，<code>--</code>後面放的是 Container 要執行的程式 ，這裡是 <code>sleep infinity</code><ul>
<li>forever sleeping ( never awake until escape )</li>
</ul>
</li>
</ul>
<p>檢視 pod 的狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kg pods</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">gocgi   1/1     Running   1          20h</span><br><span class="line">mydb    1/1     Running   1          21h</span><br><span class="line">pod1    1/1     Running   1          16h</span><br></pre></td></tr></table></figure>

<ul>
<li>這裡看到的是在 default namespace 的 pod 資訊</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kg pods -n myoffice</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE</span><br><span class="line">n1     1/1     Running   0          22m</span><br></pre></td></tr></table></figure>

<ul>
<li>這裡看到的是 myoffice 這個 namespace 裡面 pod 資訊</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -it n1 sh</span><br><span class="line">kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.</span><br><span class="line">Error from server (NotFound): pods &quot;n1&quot; not found</span><br></pre></td></tr></table></figure>
<ul>
<li>錯誤訊息翻譯:<ul>
<li><code>kubectl exec [POD] [COMMAND]</code> ，這個用法以被棄用，且即將在未來的版本被刪除</li>
<li>要使用 <code>kubectl exec [POD] -- [COMMAND]</code>，Command 前面要加 <code>--</code></li>
<li><code>Error from server (NotFound): pods &quot;n1&quot; not found</code>，找不到 n1 這台 pod，因未指定 Namespace 的話，預設會到 default 這個 namespace 裡面找有沒有 n1 這個 pod</li>
</ul>
</li>
<li>用法須更正為:<ul>
<li><code>kubectl exec -it n1 -n myoffice -- sh</code></li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -it -n myoffice n1 -- sh</span><br><span class="line">/ # ping -c 1 www.hinet.net</span><br><span class="line">PING www.hinet.net (163.28.83.113): 56 data bytes</span><br><span class="line">ping: permission denied (are you root?)</span><br><span class="line"></span><br><span class="line"># 檢視 NameServer 是誰</span><br><span class="line">/ # cat /etc/resolv.conf</span><br><span class="line">search myoffice.svc.k8s.org svc.k8s.org k8s.org localdomain</span><br><span class="line">nameserver 10.98.0.10</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line">/ # exit</span><br></pre></td></tr></table></figure>

<ul>
<li><code>nameserver 10.98.0.10</code>，這是 K8S 的 DNS Server</li>
<li>它會幫我們把 <code>www.hinet.net</code> 這個名稱丟到網路去問，最後解析出 <code>163.28.83.113</code> 這個 IP 位址</li>
<li><code>ping: permission denied (are you root?)</code>，權限不足，Linux Capaibility 不給權限</li>
</ul>
<p>用 yaml 檔建立 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano ~/wulin/yaml/pod-n2.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">n2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">myoffice</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">n2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">n2</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/busybox</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&quot;60&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">n2</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>kind</code> ，指定要建立 pod 這個物件</li>
<li><code>metadata</code>，設定重要資訊<ul>
<li><code>name: n2</code>，pod 名字 : n2</li>
<li><code>namespace</code>，設定 pod 所在的 namespace : myoffice</li>
<li><code>labels</code>，pod 上貼一個標籤</li>
</ul>
</li>
<li><code>spec</code>，設定 pod 內部的結構<ul>
<li><code>hostname: n2</code>，設定 Container 的 hostname，多個 Container 也會共用同一個 hostname</li>
<li><code>contaienrs</code>，設定 Container 的資訊</li>
<li><code>command</code>，container 要先執行的命令<ul>
<li>yaml 檔中的 <code>command:</code> 這個宣告, 會覆蓋掉 image 的內定命令, 包括 entrypoint 指定的命令</li>
</ul>
</li>
<li><code>name</code>，設定 Container 在系統上的名稱</li>
</ul>
</li>
</ul>
<p>apply 它</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f ~/wulin/yaml/pod-n2.yaml</span><br></pre></td></tr></table></figure>

<p>檢查是否符合預期</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n myoffice</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE</span><br><span class="line">n1     1/1     Running   0          61m</span><br><span class="line">n2     1/1     Running   0          14s</span><br></pre></td></tr></table></figure>

<h3 id="切換-Namespace"><a href="#切換-Namespace" class="headerlink" title="切換 Namespace"></a>切換 Namespace</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config set-context --current --namespace=myoffice</span><br></pre></td></tr></table></figure>

<ul>
<li><code>set-context</code>，進入 K8S 的路口</li>
<li><code>set-context</code> ，入口的意思，進入商業辦公大樓的大門</li>
<li><code>--current</code> ，入口指定預設的入口，因為進入的方法有很多種，我們就走預設的入口</li>
<li><code>--namespace=myoffice</code> ，進到 myoffice 這個 namespace</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME   READY   STATUS    RESTARTS       AGE</span><br><span class="line">n1     1/1     Running   0              25m</span><br><span class="line">n2     1/1     Running   5 (105s ago)   8m32s</span><br><span class="line"></span><br><span class="line">$ cat ~/.kube/config | grep -A 6 contexts:</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    namespace: myoffice</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br></pre></td></tr></table></figure>

<ul>
<li><code>~/.kube/config</code>，進入 K8S 這棟大樓的磁卡 (裡面記錄著使用者在 K8S 的名字和識別代號，及擁有多大的權限可以對 K8S 的物件進行訪問…等資訊)</li>
<li><code>contexts</code>，大樓的入口，後面加 <code>s</code> 是因為可能會有很多入口<ul>
<li><code>context</code>，大樓的入口</li>
<li><code>cluster: kubernetes</code>，大樓的名字 : <code>kubernetes</code></li>
<li><code>namespace: myoffice</code>，大樓裡的辦公室名字: <code>myoffice</code></li>
<li><code>user: kubernetes-admin</code>，使用者進入大樓辦公室用的身分名稱</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cat ~/.kube/config | grep users -A1</span><br><span class="line">users:</span><br><span class="line">- name: kubernetes-admin</span><br></pre></td></tr></table></figure>

<ul>
<li>在 K8S 系統中，我們 bigred 的帳號，是 kubernetes-admin (由 <code>~/.kube/config</code> 這個檔案得知)</li>
</ul>
<h1 id="OpenSSH-實務應用"><a href="#OpenSSH-實務應用" class="headerlink" title="OpenSSH 實務應用"></a>OpenSSH 實務應用</h1><h2 id="Container-Image-設計與建立"><a href="#Container-Image-設計與建立" class="headerlink" title="Container Image 設計與建立"></a>Container Image 設計與建立</h2><p>在 m1 終端機, 執行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p ~/wulin/&#123;sshd,fbs&#125;</span><br><span class="line"></span><br><span class="line">$ echo $&#x27;FROM quay.io/cloudwalker/alpine</span><br><span class="line">RUN apk update &amp;&amp; apk upgrade &amp;&amp; apk add --no-cache nano sudo wget curl \</span><br><span class="line">    tree elinks bash shadow procps util-linux git coreutils binutils \</span><br><span class="line">    findutils grep openssh-server tzdata &amp;&amp; \</span><br><span class="line">    # 設定時區</span><br><span class="line">    cp /usr/share/zoneinfo/Asia/Taipei /etc/localtime &amp;&amp; \</span><br><span class="line">    ssh-keygen -t rsa -P &quot;&quot; -f /etc/ssh/ssh_host_rsa_key &amp;&amp; \</span><br><span class="line">    echo -e \&#x27;Welcome to ALP sshd 6000\\n\&#x27; &gt; /etc/motd &amp;&amp; \</span><br><span class="line">    # 建立管理者帳號 bigred</span><br><span class="line">    adduser -s /bin/bash -h /home/bigred -G wheel -D bigred &amp;&amp; \</span><br><span class="line">    echo &quot;%wheel   ALL=(ALL) NOPASSWD: ALL&quot; &gt;&gt; /etc/sudoers &amp;&amp; \</span><br><span class="line">    echo -e \&#x27;bigred\\nbigred\\n\&#x27; | passwd bigred &amp;&gt;/dev/null &amp;&amp; \</span><br><span class="line">    rm /sbin/reboot &amp;&amp; rm /usr/bin/killall</span><br><span class="line"></span><br><span class="line">EXPOSE 22</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [&quot;/usr/sbin/sshd&quot;]</span><br><span class="line">CMD [&quot;-D&quot;]&#x27; &gt; ~/wulin/sshd/Dockerfile</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ENTRYPOINT [&quot;/usr/sbin/sshd&quot;]</code> ，強制宣告等下 run 的 Container 等等只能跑 <code>/usr/sbin/sshd</code> 這個命令</li>
<li><code>CMD [&quot;-D&quot;]</code> ，上面命令的參數</li>
</ul>
<p>Container Image 建立與測試  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman build -t alp.sshd ~/wulin/sshd/</span><br><span class="line"></span><br><span class="line">$ sudo podman images | grep alp.sshd</span><br><span class="line">localhost/alp.sshd   latest  01424a71e3d6  3 minutes ago  67.6 MB</span><br><span class="line"></span><br><span class="line">$ sudo podman run --name a1 -h a1 -d -p 22100:22 alp.sshd</span><br><span class="line">220ce94e636ce9270604bd31a7dd5d515be6008ab6351295cd10a66da5d978d1</span><br><span class="line"></span><br><span class="line">$ ssh bigred@<span class="variable">$IP</span> -p 22100</span><br><span class="line">bigred@192.168.61.4 s password: bigred</span><br><span class="line">Welcome to ALP sshd 6000</span><br><span class="line"></span><br><span class="line">a1:~$ git version</span><br><span class="line">git version 2.30.2</span><br><span class="line"></span><br><span class="line">a1:~$ <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">$ sudo podman <span class="built_in">rm</span> -f a1</span><br></pre></td></tr></table></figure>

<h1 id="第一次接觸-Kubernetes-App"><a href="#第一次接觸-Kubernetes-App" class="headerlink" title="第一次接觸 Kubernetes App"></a>第一次接觸 Kubernetes App</h1><p>建立 K8S 應用物件方式</p>
<ol>
<li><code>kubectl run</code> (命令式 Imperative) - Manage K8s object (POD, Controller, Service) using CLI</li>
<li><code>kubectl create/apply</code> (聲明式 Declarative) - By defining K8s objects in yaml file<ul>
<li>yaml ，全名 : Yet Another Markup Language ( 因為不用再看到 xml 檔了 )</li>
</ul>
</li>
</ol>
<p>For creating multiple complex object, declarative approach is preferred as it follows Infrastructure as a Code approach. However, imperative approach is also useful when we want to do quick POC and save yourself from writing yaml files. Let’s take a look at some imperative commands.</p>
<blockquote>
<p>kubectl run (Imperative) 這命令適合做概念性驗證 (Proof of Concept；POC), kubectl create (Declarative) 與 yaml 設定檔適合建立複雜的企業應用服務</p>
</blockquote>
<h2 id="建立-Demo-App"><a href="#建立-Demo-App" class="headerlink" title="建立 Demo App"></a>建立 Demo App</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># 建立一個 pod ，image 用的是 alp.sshd</span><br><span class="line">$ kubectl run demo --image=alp.sshd</span><br><span class="line"></span><br><span class="line">[註] 從 1.18 這個版本開始, 上面命令只會產生 pod, 不再會產生 deployment object 及 replicaset controller. </span><br><span class="line"></span><br><span class="line"># 為何 pod 會建立失敗 ? ErrImagePull ?</span><br><span class="line">$ kg pods -o wide</span><br><span class="line">NAME    READY   STATUS         RESTARTS   AGE   IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">demo    0/1     ErrImagePull   0          13s   10.244.2.5   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># 因為在我們的工作主機上，沒有這片 image，所以先刪除 pod</span><br><span class="line"># --force ，強制刪除</span><br><span class="line">$ kubectl delete pods demo --force</span><br><span class="line">warning: Immediate deletion does not wait for confirmation that the running resource has been terminated. The resource may continue to run on the cluster indefinitely.</span><br><span class="line">pod &quot;demo&quot; force deleted</span><br><span class="line"></span><br><span class="line"># 打包 alp.sshd 這個 image</span><br><span class="line">$ sudo podman save alp.sshd &gt; alp.sshd.tar</span><br><span class="line"></span><br><span class="line"># 將打包檔拷貝到 w1 和 w2 主機</span><br><span class="line">$ scp alp.sshd.tar w1:alp.sshd.tar; scp alp.sshd.tar w2:alp.sshd.tar</span><br><span class="line"></span><br><span class="line"># 在 w1 和 w2 主機，將打包檔的 image 還原</span><br><span class="line">$ ssh w1 &#x27;sudo podman load &lt; alp.sshd.tar&#x27;</span><br><span class="line">$ ssh w2 &#x27;sudo podman load &lt; alp.sshd.tar&#x27;</span><br><span class="line"></span><br><span class="line"># 再 run 一次 pod</span><br><span class="line"># --image-pull-policy IfNotPresent ，如果本地端有 image 就不用上網下載了</span><br><span class="line">$ kubectl run demo --image-pull-policy IfNotPresent --image=localhost/alp.sshd</span><br><span class="line">pod/demo created</span><br><span class="line"></span><br><span class="line"># 以下命令會失敗的原因是因為， image 前面不加 localhost ，就會上網飆到 docker.io/library 抓 image</span><br><span class="line">$ kubectl run demo --image=alp.sshd</span><br><span class="line"></span><br><span class="line"># 其實不加 --image-pull-policy IfNotPresent 也會過</span><br><span class="line">$ kubectl run demo --image=localhost/alp.sshd</span><br><span class="line"></span><br><span class="line"># 檢查是否符合預期</span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE     IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">demo   1/1     Running   0    3m12s   10.244.2.2   w2     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h2 id="建立-OpenSSH-Pod"><a href="#建立-OpenSSH-Pod" class="headerlink" title="建立 OpenSSH Pod"></a>建立 OpenSSH Pod</h2><p>編輯 sshd yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano ~/wulin/sshd/pod-sshd.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-sshd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysshd</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">localhost/alp.sshd</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/bin/bash</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">        adduser -s /bin/bash -h /home/rbean rbean</span></span><br><span class="line"><span class="string">        echo -e &#x27;rbean\nrbean\n&#x27; | passwd rbean</span></span><br><span class="line"><span class="string">        /usr/sbin/sshd -D</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在 K8S yaml 檔的 <code>command</code> 能破格 Dockerfile 設定的 <code>ENTRYPOINT</code>，讓 Container 跑 <code>command</code> 宣告的命令</li>
<li>但是 Container run 的程式還是要在前景執行</li>
<li>所以 <code>command</code> 最後還是要宣告 <code>/usr/sbin/sshd -D</code>，讓 Container 有個 <code>SSH Server</code> 一直在前景執行的命令</li>
<li><code>/bin/bash -c</code>，<code>c</code> 的意思是 command，合起來就是讓 bash 貝殼程式跑下面的命令</li>
<li><code>|</code>，這裡的 pipe 意思是會保留以下宣告命令的格式，有空格就空格，有換行就換行，通通保留，如果沒有宣告，貝殼程式會把下面 3 行命令當成一行</li>
</ul>
<p>用 apply 產生 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f ~/wulin/sshd/pod-sshd.yaml</span><br></pre></td></tr></table></figure>

<p>檢查 pod 狀態</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kg po pod-sshd -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-sshd   1/1     Running   0          2m    10.244.1.37   w1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>SSH 連線測試 pod 功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ssh rbean@10.244.1.37</span><br><span class="line">rbean@10.244.1.37s password:</span><br><span class="line">Welcome to ALP sshd 6000</span><br><span class="line"></span><br><span class="line"># 建立 zzz 目錄</span><br><span class="line">pod-sshd:~$ mkdir zzz</span><br><span class="line">pod-sshd:~$ ls -ld zzz</span><br><span class="line">drwxr-sr-x 2 rbean rbean 4096 Sep  1 09:49 zzz</span><br><span class="line">pod-sshd:~$ exit</span><br><span class="line">logout</span><br><span class="line">Connection to 10.244.1.37 closed.</span><br></pre></td></tr></table></figure>

<p>刪除 pod </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod pod-sshd</span><br><span class="line">pod &quot;pod-sshd&quot; deleted</span><br></pre></td></tr></table></figure>

<p>再次建立 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f ~/wulin/sshd/pod-sshd.yaml</span><br><span class="line">pod/pod-sshd created</span><br></pre></td></tr></table></figure>

<p>連進 pod 檢視 zzz 目錄是否還在 ?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod pod-sshd -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-sshd   1/1     Running   0          73s   10.244.1.38   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># 用 rbean 帳號連進 pod</span><br><span class="line">$ ssh rbean@10.244.1.38</span><br><span class="line">Warning: Permanently added &#x27;10.244.1.38&#x27; (RSA) to the list of known hosts.</span><br><span class="line">rbean@10.244.1.38s password:</span><br><span class="line">Welcome to ALP sshd 6000</span><br><span class="line"></span><br><span class="line"># 檢視剛剛建立的目錄</span><br><span class="line">pod-sshd:~$ ls -l</span><br><span class="line">total 0</span><br></pre></td></tr></table></figure>

<ul>
<li>結論 : pod 只要沒有動用 volume ，當 pod 被刪除時，資料通通消失</li>
</ul>
<p>將 pod 所在的 w1 這台機器重開機</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh w1 &#x27;sudo reboot&#x27;</span><br></pre></td></tr></table></figure>

<p>再次檢視 pod 狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods pod-sshd -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-sshd   1/1     Running   1          20m   10.244.1.39   w1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>發現 pod 重新建立，Pod_IP 變了，資料也沒啦 !</li>
<li><strong>在 K8S 的系統中，只要 node 主機重開，它上面 run 的 pod 都會浴火重生(重建)，pod 沒有 volume 的話，資料通通再見 !</strong></li>
</ul>
<h2 id="Access-Kubernetes-Pods-from-outside"><a href="#Access-Kubernetes-Pods-from-outside" class="headerlink" title="Access Kubernetes Pods from outside"></a>Access Kubernetes Pods from outside</h2><p>編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano ~/wulin/yaml/podhostport.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podhostport</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wk01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/alpine.sshd</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">22</span></span><br><span class="line">       <span class="attr">hostPort:</span> <span class="number">22101</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">add:</span> [<span class="string">&quot;AUDIT_WRITE&quot;</span>, <span class="string">&quot;SYS_CHROOT&quot;</span>, <span class="string">&quot;CAP_NET_RAW&quot;</span>]</span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/usr/sbin/sshd&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;-D&quot;</span>]</span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">kubernetes.io/hostname:</span> <span class="string">w1</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>image:</code> ，Container 的 image 可以換裝成 <code>localhost/alp.sshd</code></li>
<li><code>hostport: 22101</code>，<code>kube-proxy</code> 會在 pod 所在主機開一個 22101 的 port，對應到 pod 裡 Container 開的 22 port，效能優於 <code>kubectl port-forward</code> </li>
<li>:::spoiler hostport 示意圖<br><img src="https://i.imgur.com/tixjWdt.png"><br>:::</li>
<li><code>nodeselector</code>，透過 node 上的 labels 來決定 pod 要建在哪台 node 上</li>
</ul>
<h2 id="讓-mydb-pod-也用-hostport-開"><a href="#讓-mydb-pod-也用-hostport-開" class="headerlink" title="讓 mydb pod 也用 hostport 開"></a>讓 mydb pod 也用 hostport 開</h2><p>先建立工作目錄</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p ~/wulin/mydb/</span><br></pre></td></tr></table></figure>

<p>編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano wulin/mydb/pod-mydb.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">mydb</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">localhost/mydb</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mydb</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">      <span class="attr">hostPort:</span> <span class="number">3306</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>產生 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ka -f wulin/mydb/pod-mydb.yaml</span><br><span class="line">pod/mydb created</span><br></pre></td></tr></table></figure>

<h2 id="檢視-Linux-capabilities"><a href="#檢視-Linux-capabilities" class="headerlink" title="檢視 Linux capabilities"></a>檢視 Linux capabilities</h2><ul>
<li><strong>Linux capabilities ，規範 Container 可以做什麼事，而規範 Container 等同於規範 pod</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ crio-status config</span><br><span class="line"></span><br><span class="line">output : </span><br><span class="line">...</span><br><span class="line">default_capabilities = [&quot;CHOWN&quot;, &quot;DAC_OVERRIDE&quot;, &quot;FSETID&quot;, &quot;FOWNER&quot;, &quot;SETGID&quot;, &quot;SETUID&quot;, &quot;SETPCAP&quot;, &quot;NET_BIND_SERVICE&quot;, &quot;AUDIT_WRITE&quot;, &quot;SYS_CHROOT&quot;, &quot;KILL&quot;]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li><code>NET_BIND_SERVICE</code> ，如果 Container 要開的 port number 小於 1024 ，會需要有這個 Capabilities</li>
<li><code>SSH</code> 通訊協定一定會需要 “<code>AUDIT_WRITE</code>“, “<code>SYS_CHROOT</code>“ 這兩個 Capabilities，才能讓 CRI-O 做出來的 Container run openssh 的時候，能夠讓 openssh Server 與外部連接，給別人從外面連進來，如果沒有以上兩個 Capabilities ，即使要用 root 去登入也沒用。設定後要記得重新開機。</li>
</ul>
<h3 id="CRI-O-規範-Linux-capabilities-的檔案"><a href="#CRI-O-規範-Linux-capabilities-的檔案" class="headerlink" title="CRI-O 規範 Linux capabilities 的檔案"></a>CRI-O 規範 Linux capabilities 的檔案</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nano /etc/crio/crio.conf</span><br><span class="line"></span><br><span class="line">output : </span><br><span class="line"></span><br><span class="line">[crio.runtime]</span><br><span class="line">.......</span><br><span class="line">default_capabilities = [</span><br><span class="line">  &quot;CHOWN&quot;,</span><br><span class="line">  &quot;DAC_OVERRIDE&quot;,</span><br><span class="line">  &quot;FSETID&quot;,</span><br><span class="line">  &quot;FOWNER&quot;,</span><br><span class="line">  &quot;SETGID&quot;,</span><br><span class="line">  &quot;SETUID&quot;,</span><br><span class="line">  &quot;SETPCAP&quot;,</span><br><span class="line">  &quot;NET_BIND_SERVICE&quot;,</span><br><span class="line">  &quot;AUDIT_WRITE&quot;,</span><br><span class="line">  &quot;SYS_CHROOT&quot;,</span><br><span class="line">  &quot;KILL&quot;</span><br><span class="line">]</span><br><span class="line">.......</span><br></pre></td></tr></table></figure>

<p>++讓 demo 這個 pod 安裝 libcap 套件++</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> demo -- sudo apk add libcap</span><br></pre></td></tr></table></figure>

<ul>
<li><code>--</code>，兩個 <code>-</code> 後面接的命令就是要給 pod 執行</li>
</ul>
<blockquote>
<p>如果這行安裝失敗，可以進入 pod 的 Container 將 nameserver 的設定檔 ( <code>/etc/resolv.conf</code> )，新增一行 <code>nameserver 8.8.8.8</code></p>
</blockquote>
<p>++查看 demo 這個 pod 裡面的 Container 裡面有哪些 Linux capabilities++</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec demo -- sudo capsh --print</span><br><span class="line"></span><br><span class="line">output :</span><br><span class="line"></span><br><span class="line">Current: cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_sys_chroot,cap_audit_write=ep</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="連接與移除-Demo-App"><a href="#連接與移除-Demo-App" class="headerlink" title="連接與移除 Demo App"></a>連接與移除 Demo App</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># K8S 叢集內連接 demo app，k8s 叢集內部的網路連線全程都會加密</span><br><span class="line"># -it ，給一個虛擬終端機</span><br><span class="line"># -- bash ，跑 bash 貝殼程式</span><br><span class="line">$ kubectl exec -it pods/demo -- bash</span><br><span class="line">bash-5.1# exit</span><br><span class="line"></span><br><span class="line"># 檢視 demo 這個 pod 的 IP 位址</span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE   IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">demo   1/1     Running   0          26m   10.244.2.2   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># ssh 連進 demo 這個 pod</span><br><span class="line">bigred@m1:~$ ssh bigred@10.244.2.2</span><br><span class="line">Warning: Permanently added &#x27;10.244.2.2&#x27; (RSA) to the list of known hosts.</span><br><span class="line">bigred@10.244.2.2 s password:</span><br><span class="line">Welcome to ALP sshd 6000</span><br><span class="line"></span><br><span class="line"># 離開 pod</span><br><span class="line">demo:~$ exit</span><br><span class="line"></span><br><span class="line"># K8S 叢集外連接 demo app</span><br><span class="line"># --address 只能指定 Master 的 IP 位址</span><br><span class="line">$ kubectl port-forward --address $IP pods/demo 22100:22 &amp;</span><br><span class="line">[1] 27780</span><br><span class="line"></span><br><span class="line"># 在 Windows 系統的 cmd 視窗, 執行以下命令</span><br><span class="line">$ ssh bigred@&lt;alp.m1 IP&gt; -p 22100</span><br><span class="line">Handling connection for 22100</span><br><span class="line">bigred@192.168.61.4 s password: bigred</span><br><span class="line">Welcome to ALP sshd 6000</span><br><span class="line"></span><br><span class="line"># 離開 pod</span><br><span class="line">demo:~$ exit</span><br><span class="line"></span><br><span class="line"># 移除 pod</span><br><span class="line">$ kubectl delete pod  demo</span><br></pre></td></tr></table></figure>

<p>以上動作運作架構圖</p>
<p><img src="https://i.imgur.com/7fFcPeY.png"></p>
<h1 id="第一次接觸-YAML-File"><a href="#第一次接觸-YAML-File" class="headerlink" title="第一次接觸 YAML File"></a>第一次接觸 YAML File</h1><h2 id="建立-OpenSSH-Pod-1"><a href="#建立-OpenSSH-Pod-1" class="headerlink" title="建立 OpenSSH Pod"></a>建立 OpenSSH Pod</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 建立專案目錄，編輯 yaml 檔</span><br><span class="line">$ cd ~/wulin; nano sshd/pod-sshd.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-sshd</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: mysshd</span><br><span class="line">    image: localhost/alp.sshd</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>apiVersion: v1</code> ，這行是跟 API Server 說，我們的 yaml 檔是 v1 ，這行的設定由 K8s 的版本來決定</p>
</li>
<li><p><code>kind: Pod</code> ， 設定 K8s 的物件</p>
</li>
<li><pre><code class="!">metadata:
name: pod-sshd ---&gt; 設定 pod 的名字
spec:
containers:
- name: mysshd ---&gt; 設定 Container 的名稱
  image: localhost/alp.sshd ---&gt; 設定 Container 用哪片 image 
  imagePullPolicy: IfNotPresent ---&gt; 如果本地端有這片 image，不用上網下載
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- `imagePullPolicy: Never` ，不要上網下載 image </span><br><span class="line"></span><br><span class="line">```bash!</span><br><span class="line"># apply yaml 檔，建立 pod</span><br><span class="line">$ kubectl apply -f sshd/pod-sshd.yaml</span><br><span class="line"></span><br><span class="line"># 檢查是否符合預期</span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE    IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">demo       1/1     Running   0          126m   10.244.2.2   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-sshd   1/1     Running   0          13s    10.244.1.3   w1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p><code>10.244.1.3</code>，看到這個 IP 位址 ，就知道 Flannel 網路套件在做事，將我們的 pod 分配到第一台工作機</p>
</li>
</ul>
<h2 id="再次修改-yaml-檔"><a href="#再次修改-yaml-檔" class="headerlink" title="再次修改 yaml 檔"></a>再次修改 yaml 檔</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ nano sshd/pod-sshd.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-sshd</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: mysshd</span><br><span class="line">    image: localhost/alp.sshd</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - /bin/bash</span><br><span class="line">      - -c</span><br><span class="line">      - |</span><br><span class="line">        adduser -s /bin/bash -h /home/rbean rbean</span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&#x27;rbean\nrbean\n&#x27;</span> | passwd rbean</span><br><span class="line">        /usr/sbin/sshd -D</span><br></pre></td></tr></table></figure>

<ul>
<li><code>command:</code>，在 K8s 的 yaml 檔中宣告一段等下 Container 要跑的 shell script ，即使 Container 的 image 本身有 <code>ENTRYPOINT [&quot;/usr/sbin/sshd&quot;]</code> ，一樣會被破格，強制要跑命令</li>
</ul>
<hr>
<h1 id="建立-File-Browser-Server"><a href="#建立-File-Browser-Server" class="headerlink" title="建立 File Browser Server"></a>建立 File Browser Server</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ cd ~/wulin/</span><br><span class="line"></span><br><span class="line">$ nano fbs/Dockerfile</span><br><span class="line">FROM quay.io/cloudwalker/alpine</span><br><span class="line">RUN apk update &amp;&amp; apk upgrade &amp;&amp; apk add --no-cache nano sudo wget curl \</span><br><span class="line">    tree elinks bash shadow procps util-linux coreutils binutils findutils grep &amp;&amp; \</span><br><span class="line">    curl -fsSL https://raw.githubusercontent.com/filebrowser/get/master/get.sh | bash &amp;&amp; \</span><br><span class="line">    # 設定 filebrowser</span><br><span class="line">    filebrowser config init --port 4000 --address &quot;&quot; --log &quot;/tmp/fbs&quot; --root=&quot;/srv&quot; &amp;&amp; \</span><br><span class="line">    # 建立管理者帳號</span><br><span class="line">    filebrowser users add admin &quot;admin&quot; --perm.admin=true</span><br><span class="line"></span><br><span class="line">CMD [&quot;filebrowser&quot;]</span><br></pre></td></tr></table></figure>

<ul>
<li><code>curl -fsSL &#39;URL/get.sh&#39; | bash</code>，利用 curl 命令將網站上的程式輸出在螢幕，但是 <code>| bash</code>，會將輸出在螢幕的程式碼丟給重裝貝殼執行，這樣做的好處是不會留下紀錄。<ul>
<li><code>-f</code>，下載失敗不會輸出錯誤訊息</li>
<li><code>-s</code>，Silent mode</li>
</ul>
</li>
<li><code>filebrowser config init</code>，將網站初始化<ul>
<li><code>--port 4000</code> ，網站的 port number : 4000</li>
<li><code>--address &quot;&quot;</code> ，任何 IP 位址的來源都能與我連線</li>
<li><code>--log &quot;/tmp/fbs&quot;</code>，網站 log 檔的存放檔案</li>
<li><code> --root=&quot;/srv&quot;</code> ，使用者丟檔案到網站後存放的目錄區，可自行設定</li>
</ul>
</li>
<li><code>filebrowser users add</code>，建立帳號<ul>
<li><code>admin &quot;admin&quot;</code>，帳號 : <code>admin</code>，密碼 : <code>admin</code></li>
<li><code>--perm.admin=true</code>，打開管理員的權限</li>
</ul>
</li>
</ul>
<p>build image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman build -t alp.myfbs fbs/</span><br><span class="line"></span><br><span class="line"># 檢查是否符合預期</span><br><span class="line">$ sudo podman images | grep fbs</span><br><span class="line">localhost/alp.myfbs       latest      24d1b68d43f8  About a minute ago  74.3 MB</span><br></pre></td></tr></table></figure>

<p>手動部署 alp.myfbs Image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 備份 Image </span><br><span class="line">$ sudo podman save localhost/alp.myfbs &gt; alpine.myfbs.tar</span><br><span class="line"></span><br><span class="line">$ scp alpine.myfbs.tar w1:~; scp alpine.myfbs.tar w2:~</span><br><span class="line"></span><br><span class="line">$ ssh w1 &#x27;sudo podman load &lt; alpine.myfbs.tar&#x27;; ssh w2 &#x27;sudo podman load &lt; alpine.myfbs.tar&#x27;</span><br></pre></td></tr></table></figure>

<p>建立 File Browser Server Pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 編輯 yaml 檔</span></span><br><span class="line">$ nano fbs/pod-fbs.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-fbs</span><br><span class="line">  labels:</span><br><span class="line">    name: pod-fbs</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: myfbs</span><br><span class="line">    image: localhost/alp.myfbs</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    ports:</span><br><span class="line">     - containerPort: 4000</span><br></pre></td></tr></table></figure>

<p>用 yaml 檔 建立 pod </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f fbs/pod-fbs.yaml</span><br></pre></td></tr></table></figure>

<p>檢查 pod 的 4000 port 有無開啟</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 看 pod 的 IP</span><br><span class="line">$ kg pods -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE     IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-fbs    1/1     Running   0          2m30s   10.244.1.6   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># 網貓測 4000 port</span><br><span class="line">$ nc -w 1 10.244.1.6 4000</span><br><span class="line"></span><br><span class="line">$ echo $?</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<h3 id="建立-File-Browser-Server-Service"><a href="#建立-File-Browser-Server-Service" class="headerlink" title="建立 File Browser Server Service"></a>建立 File Browser Server Service</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ nano fbs/svc-fbs.yaml</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: svc-fbs</span><br><span class="line">spec:</span><br><span class="line">  externalIPs:</span><br><span class="line">  - 192.168.61.4</span><br><span class="line">  selector:</span><br><span class="line">    name: pod-fbs</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8080</span><br><span class="line">    targetPort: 4000</span><br></pre></td></tr></table></figure>

<ul>
<li><code>selector:</code> ，選擇有貼 pod-fbs 這個標籤的 pod</li>
<li><code>externalIPs:</code> ，設定對外服務的 IP 位址</li>
<li><pre><code>ports:
- port: 8080   ---&gt; 對外的 port number
  targetPort: 4000   ---&gt; pod 開的 port number
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">建立 service/svc-fbs 服務</span><br><span class="line"></span><br></pre></td></tr></table></figure>
$ kubectl apply -f  fbs/svc-fbs.yaml
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">檢查是否符合預期</span><br><span class="line"></span><br><span class="line">```bash=</span><br><span class="line">$ kubectl get all -o wide</span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE   IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/pod-fbs    1/1     Running   0          14m   10.244.1.6   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/pod-sshd   1/1     Running   0          39m   10.244.2.4   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP    EXTERNAL-IP    PORT(S)    AGE    SELECTOR</span><br><span class="line">service/kubernetes   ClusterIP   10.98.0.1     &lt;none&gt;         443/TCP    4h5m   &lt;none&gt;</span><br><span class="line">service/svc-fbs      ClusterIP   10.98.0.230   192.168.61.4   8080/TCP   83s    name=pod-fbs</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<p>看 pod 的標籤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods --show-labels</span><br><span class="line">AME       READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">pod-fbs    1/1     Running   0          20m   name=pod-fbs</span><br><span class="line">pod-sshd   1/1     Running   0          44m   &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h3 id="FBS-架構示意圖"><a href="#FBS-架構示意圖" class="headerlink" title="FBS 架構示意圖"></a>FBS 架構示意圖</h3><p><img src="https://i.imgur.com/5G9pk3U.png"></p>
<ul>
<li>多建立 Service 這個物件的原因是因為，K8S 的 pod 很容易浴火重生，一旦重建， pod IP 會發生變動，如果這時候我們 pod 是一個網站，這個網站的 IP 位址時不時更換，會搞死人。</li>
<li>所以這時候需要透過 Service ，服務的 IP 在 K8S 中是固定的，不會因為主機重開，Service IP 就變動，所以只要讓 Service 透過 labels 綁住我們的 pod ，這樣即使 pod 浴火重生，也沒關係，我們一樣可以靠 Service 連的到我們的 pod</li>
</ul>
<h3 id="提問-如何得知檔案丟到網站後，存放在哪"><a href="#提問-如何得知檔案丟到網站後，存放在哪" class="headerlink" title="提問 : 如何得知檔案丟到網站後，存放在哪?"></a>提問 : 如何得知檔案丟到網站後，存放在哪?</h3><p>答 : pod-fbs 的 container 裡 <code>/srv</code> 目錄下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 進入 pod </span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it pod/pod-fbs -- bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 檢查是否符合預期</span></span><br><span class="line">bash-5.1<span class="comment"># ls -al srv</span></span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x 1 root root 4096 Jul 31 06:46 .</span><br><span class="line">dr-xr-xr-x 1 root root 4096 Jul 31 06:23 ..</span><br><span class="line">drwxr-xr-x 3 root root 4096 Jul 31 06:46 ALP3</span><br><span class="line"></span><br><span class="line">bash-5.1<span class="comment"># touch srv/zzz.txt</span></span><br><span class="line">bash-5.1<span class="comment"># ls -al srv/</span></span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x 1 root root 4096 Jul 31 06:51 .</span><br><span class="line">dr-xr-xr-x 1 root root 4096 Jul 31 06:23 ..</span><br><span class="line">drwxr-xr-x 3 root root 4096 Jul 31 06:46 ALP3</span><br><span class="line">-rw-r--r-- 1 root root    0 Jul 31 06:51 zzz.txt</span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/YpO3DbL.png"></p>
<h3 id="災難篇"><a href="#災難篇" class="headerlink" title="災難篇"></a>災難篇</h3><p>如果刪除 pod ，裡面存放的內容就不見了 ! ! !</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod pod-fbs</span><br><span class="line">pod &quot;pod-fbs&quot; deleted</span><br><span class="line"></span><br><span class="line">$ kubectl delete svc svc-fbs</span><br><span class="line">service &quot;svc-fbs&quot; deleted</span><br></pre></td></tr></table></figure>

<p>對於 K8s 的 Storage 怎麼處理 ?</p>
<h2 id="對-pod-的-yaml-檔新增-hostPath-PV"><a href="#對-pod-的-yaml-檔新增-hostPath-PV" class="headerlink" title="對 pod 的 yaml 檔新增 hostPath PV"></a>對 pod 的 yaml 檔新增 hostPath PV</h2><p>編輯 yaml 檔</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano fbs/pod-fbs.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-fbs</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-fbs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myfbs</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">localhost/alp.myfbs</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">4000</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/srv</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="comment"># directory location on host</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/tmp</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>volumeMounts</code>，設定 Container 的目錄要將哪個目錄掛載到 <code>volumes</code> 的目錄<ul>
<li><code>mountPath</code>，要掛載的目錄</li>
</ul>
</li>
<li><code>volumes</code>，下面可以宣告儲存體的設定<ul>
<li><code>hostPath</code>，volume 的型態<ul>
<li><code>path: /tmp</code>，這是一個在 Linux 系統的 <code>/tmp</code> 目錄，但注意 ! 這個目錄重開機裡面的內容會消失 (這是 Linux <code>/tmp</code> 目錄的規則)。</li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/volumes/">K8s 官網 hostPath 範例連結</a></li>
<li>如果刪除 pod 再重建一次， pod 可能會跑到別台 node 主機，如何解決 ?<br>答 : 針對第一次建立 pod 時，如果 pod 在 node 1 主機上，則每次重建 pod 時，就要安排在這台 node 主機上</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-fbs</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-fbs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myfbs</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">localhost/alp.myfbs</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">4000</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/srv</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="comment"># directory location on host</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/tmp</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">kubernetes.io/hostname:</span> <span class="string">w2</span></span><br></pre></td></tr></table></figure>



<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Antony Cehn</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Antony.Chen</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
