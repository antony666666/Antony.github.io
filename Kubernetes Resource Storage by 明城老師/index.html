<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"braveantony.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Kubernetes Resource Storage by 明城老師學習目標 EmptyDir （ k8s 原生 ） HostPath  （ k8s 原生 ） Local Persistent Volumes （ k8s 原生 ） Local Path Provisioner 需額外安裝    Kubernetes Volume  emptydir 讓兩個 Container 共用 HostPa">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes Resource Storage by 明城老師">
<meta property="og:url" content="https://braveantony.github.io/braveantony.github.io/Kubernetes%20Resource%20Storage%20by%20%E6%98%8E%E5%9F%8E%E8%80%81%E5%B8%AB/index.html">
<meta property="og:site_name" content="Antony 的學習筆記">
<meta property="og:description" content="Kubernetes Resource Storage by 明城老師學習目標 EmptyDir （ k8s 原生 ） HostPath  （ k8s 原生 ） Local Persistent Volumes （ k8s 原生 ） Local Path Provisioner 需額外安裝    Kubernetes Volume  emptydir 讓兩個 Container 共用 HostPa">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.imgur.com/q65JTtm.png">
<meta property="og:image" content="https://i.imgur.com/38qkXr1.png">
<meta property="og:image" content="https://i.imgur.com/ONd2sk6.png">
<meta property="article:published_time" content="2022-09-15T03:47:22.000Z">
<meta property="article:modified_time" content="2023-05-07T10:14:10.002Z">
<meta property="article:author" content="Antony Cehn">
<meta property="article:tag" content="系統工程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/q65JTtm.png">

<link rel="canonical" href="https://braveantony.github.io/braveantony.github.io/Kubernetes%20Resource%20Storage%20by%20%E6%98%8E%E5%9F%8E%E8%80%81%E5%B8%AB/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Kubernetes Resource Storage by 明城老師 | Antony 的學習筆記</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Antony 的學習筆記</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">這個網站將紀錄持續記錄我學習到各種知識的筆記</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://braveantony.github.io/braveantony.github.io/Kubernetes%20Resource%20Storage%20by%20%E6%98%8E%E5%9F%8E%E8%80%81%E5%B8%AB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kubernetes Resource Storage by 明城老師
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-15 11:47:22" itemprop="dateCreated datePublished" datetime="2022-09-15T11:47:22+08:00">2022-09-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-07 18:14:10" itemprop="dateModified" datetime="2023-05-07T18:14:10+08:00">2023-05-07</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Kubernetes-Resource-Storage-by-明城老師"><a href="#Kubernetes-Resource-Storage-by-明城老師" class="headerlink" title="Kubernetes Resource Storage by 明城老師"></a>Kubernetes Resource Storage by 明城老師</h1><h2 id="學習目標"><a href="#學習目標" class="headerlink" title="學習目標"></a>學習目標</h2><ul>
<li>EmptyDir （ k8s 原生 ）</li>
<li>HostPath  （ k8s 原生 ）</li>
<li>Local Persistent Volumes （ k8s 原生 ）</li>
<li>Local Path Provisioner<ul>
<li>需額外安裝</li>
</ul>
</li>
</ul>
<h2 id="Kubernetes-Volume"><a href="#Kubernetes-Volume" class="headerlink" title="Kubernetes Volume"></a>Kubernetes Volume</h2><p><img src="https://i.imgur.com/q65JTtm.png"></p>
<ul>
<li>emptydir 讓兩個 Container 共用</li>
<li>HostPath, Local Persistent Volumes 可以讓多個 pod 一起使用</li>
<li>當 pod 沒有宣告儲存的地方， pod 掛了 &#x3D; 資料遺失</li>
<li>Storage 在叢集裡面或外面</li>
</ul>
<hr>
<h2 id="EmptyDir-應用"><a href="#EmptyDir-應用" class="headerlink" title="EmptyDir 應用"></a>EmptyDir 應用</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: time-emptydir</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - image: quay.io/flysangel/busybox</span></span><br><span class="line"><span class="string">    name: c1</span></span><br><span class="line"><span class="string">    command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;while true; do echo $(date) &gt; /cache/time; sleep 1; done&quot;]</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      mountPath: /cache</span></span><br><span class="line"><span class="string">  - image: quay.io/flysangel/busybox</span></span><br><span class="line"><span class="string">    name: c2</span></span><br><span class="line"><span class="string">    command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;while true; do cat /cache/time; sleep 5; done&quot;]</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      mountPath: /cache</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">  - name: cache</span></span><br><span class="line"><span class="string">    emptyDir: &#123;&#125;&#x27;</span> &gt; time-pod-emptydir.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">## 建立並啟動 pod</span></span><br><span class="line">$ kubectl apply -f time-pod-emptydir.yaml</span><br><span class="line">pod/time-emptydir created</span><br><span class="line"></span><br><span class="line"><span class="comment">## 檢查 pod 的運作狀態</span></span><br><span class="line">$ kubectl get pod time-emptydir -o wide</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE   IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">time-emptydir   2/2     Running   0          12m   10.244.1.9   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 看 Container 的運作狀況</span></span><br><span class="line">$ kubectl logs time-emptydir -c c2</span><br><span class="line">...</span><br><span class="line">Sun Nov 7 01:55:49 UTC 2021</span><br><span class="line">Sun Nov 7 01:55:54 UTC 2021</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="檢視-Emptydir"><a href="#檢視-Emptydir" class="headerlink" title="檢視 Emptydir"></a>檢視 Emptydir</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ ssh w1 sudo tree /var/lib/kubelet/pods/ | grep -B 10 cache</span><br><span class="line">│               └── token -&gt; ..data/token</span><br><span class="line">├── 4795b226-d3c9-40f4-9941-d6dfe1ada41c</span><br><span class="line">│   ├── containers</span><br><span class="line">│   │   ├── c1</span><br><span class="line">│   │   │   └── c16cc904</span><br><span class="line">│   │   └── c2</span><br><span class="line">│   │       └── 4fe3441b</span><br><span class="line">│   ├── etc-hosts</span><br><span class="line">│   ├── plugins</span><br><span class="line">│   │   └── kubernetes.io~empty-dir</span><br><span class="line">│   │       ├── cache</span><br><span class="line">│   │       │   └── ready</span><br><span class="line">│   │       └── wrapped_kube-api-access-jfsdk</span><br><span class="line">│   │           └── ready</span><br><span class="line">│   └── volumes</span><br><span class="line">│       ├── kubernetes.io~empty-dir</span><br><span class="line">│       │   └── cache</span><br></pre></td></tr></table></figure>


<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 把 pod 宰了</span></span><br><span class="line">$ kubectl delete pod time-emptydir</span><br><span class="line">pod <span class="string">&quot;time-emptydir&quot;</span> deleted</span><br><span class="line"></span><br><span class="line"><span class="comment">## 再檢視一次 Emptydir</span></span><br><span class="line">$ ssh w1 sudo tree /var/lib/kubelet/pods/ | grep -B 10 cache</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="請再次產生-emptyDir-應用，判斷-emptyDir-的生命週期是否與-Pod-一致。"><a href="#請再次產生-emptyDir-應用，判斷-emptyDir-的生命週期是否與-Pod-一致。" class="headerlink" title="請再次產生 emptyDir 應用，判斷 emptyDir 的生命週期是否與 Pod 一致。"></a>請再次產生 emptyDir 應用，判斷 emptyDir 的生命週期是否與 Pod 一致。</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f time-pod-emptydir.yaml</span><br><span class="line">pod/time-emptydir created</span><br><span class="line"></span><br><span class="line">$ ssh w2 sudo tree /var/lib/kubelet/pods/ | grep -B 10 cache</span><br><span class="line">│               └── token -&gt; ..data/token</span><br><span class="line">└── dfbc42a8-6576-4f4b-b9fa-0e2553e98d04</span><br><span class="line">    ├── containers</span><br><span class="line">    │   ├── c1</span><br><span class="line">    │   │   └── a2548b80</span><br><span class="line">    │   └── c2</span><br><span class="line">    │       └── c22897a2</span><br><span class="line">    ├── etc-hosts</span><br><span class="line">    ├── plugins</span><br><span class="line">    │   └── kubernetes.io~empty-dir</span><br><span class="line">    │       ├── cache</span><br><span class="line">    │       │   └── ready</span><br><span class="line">    │       └── wrapped_kube-api-access-qtk78</span><br><span class="line">    │           └── ready</span><br><span class="line">    └── volumes</span><br><span class="line">        ├── kubernetes.io~empty-dir</span><br><span class="line">        │   └── cache</span><br><span class="line">		</span><br><span class="line">$ kubectl delete pod time-emptydir</span><br><span class="line">pod &quot;time-emptydir&quot; deleted</span><br><span class="line"></span><br><span class="line">$ ssh w2 sudo tree /var/lib/kubelet/pods/ | grep -B 10 cache</span><br></pre></td></tr></table></figure>

<p><font color=red><strong>答：一致，但是 Container 的 Overlay2 生命週期可能更短，單獨把 Container 宰了 Overlay2 就沒了。</strong></font></p>
<hr>
<h2 id="HostPath-應用"><a href="#HostPath-應用" class="headerlink" title="HostPath 應用"></a>HostPath 應用</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 宣告 pod yaml 檔</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: time-hostpath</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - image: quay.io/flysangel/busybox</span></span><br><span class="line"><span class="string">    name: c1</span></span><br><span class="line"><span class="string">    command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;while true; do echo $(date) &gt; /cache/time; sleep 1; done&quot;]</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      mountPath: /cache</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      hostPath:</span></span><br><span class="line"><span class="string">        path: /opt/pv/cache&#x27;</span> &gt; time-pod-hostpath.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">## 建立並啟動 pod</span></span><br><span class="line">$ kubectl apply -f time-pod-hostpath.yaml</span><br><span class="line">pod/time-hostpath created</span><br><span class="line"></span><br><span class="line"><span class="comment">## 檢視 pod 運作狀況</span></span><br><span class="line">bigred@m1:~/0608$ kubectl get pod time-hostpath -o wide</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">time-hostpath   1/1     Running   0          9s    10.244.1.10   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看 pod 掛載的目錄區</span></span><br><span class="line">bigred@m1:~/0608$ ssh w1 sudo tree /opt/pv/cache</span><br><span class="line">/opt/pv/cache</span><br><span class="line">└── time</span><br><span class="line"></span><br><span class="line">0 directories, 1 file</span><br><span class="line"></span><br><span class="line"><span class="comment">## 透過 cat 檢視 pod 掛載目錄區裡的檔案內容</span></span><br><span class="line">bigred@m1:~/0608$ ssh w1 sudo <span class="built_in">cat</span> /opt/pv/cache/time</span><br><span class="line">Wed Jun 8 01:56:39 UTC 2022</span><br><span class="line"></span><br><span class="line">bigred@m1:~/0608$ ssh w1 sudo <span class="built_in">cat</span> /opt/pv/cache/time</span><br><span class="line">Wed Jun 8 01:56:48 UTC 2022</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="刪除-pod-檢視-Hostpath-是否存在"><a href="#刪除-pod-檢視-Hostpath-是否存在" class="headerlink" title="刪除 pod 檢視 Hostpath 是否存在"></a>刪除 pod 檢視 Hostpath 是否存在</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete -f time-pod-hostpath.yaml</span><br><span class="line">pod <span class="string">&quot;time-hostpath&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">$ ssh w1 sudo tree /opt/pv/cache</span><br><span class="line">/opt/pv/cache</span><br><span class="line">└── time</span><br><span class="line"></span><br><span class="line">0 directories, 1 file</span><br><span class="line"></span><br><span class="line">$ ssh w1 sudo <span class="built_in">cat</span> /opt/pv/cache/time</span><br><span class="line">Wed Jun 8 02:03:39 UTC 2022</span><br></pre></td></tr></table></figure>

<p>答： 當 pod 被刪除時， Hostpath 還會存在。</p>
<h3 id="反覆建立-emptydir、hostPath-應用，判斷-hostPath-Pod-是否固定於同一個節點上。"><a href="#反覆建立-emptydir、hostPath-應用，判斷-hostPath-Pod-是否固定於同一個節點上。" class="headerlink" title="反覆建立 emptydir、hostPath 應用，判斷 hostPath Pod 是否固定於同一個節點上。"></a>反覆建立 emptydir、hostPath 應用，判斷 hostPath Pod 是否固定於同一個節點上。</h3><p>當 k8s 在建立 pod 時， Scheduler 會判斷 node 的悠閒度，來建立 pod。</p>
<p>:::success</p>
<p>在 yml 檔內宣告 pod 要在 哪台 node 上產生</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: time-hostpath</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - image: quay.io/flysangel/busybox</span></span><br><span class="line"><span class="string">    name: c1</span></span><br><span class="line"><span class="string">    command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;while true; do echo $(date) &gt; /cache/time; sleep 1; done&quot;]</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      mountPath: /cache</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      hostPath:</span></span><br><span class="line"><span class="string">        path: /opt/pv/cache</span></span><br><span class="line"><span class="string">  nodeSelector:</span></span><br><span class="line"><span class="string">    kubernetes.io/hostname: w1&#x27;</span> &gt; time-pod-hostpath.yaml</span><br></pre></td></tr></table></figure>

<p>下面這兩行可以指定 pod 要在哪一個 node 產生</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nodeSelector:</span><br><span class="line">  kubernetes.io/hostname: w1</span><br></pre></td></tr></table></figure>
<p>:::</p>
<h3 id="練習"><a href="#練習" class="headerlink" title="練習"></a>練習</h3><p>題目：建立兩個 hostPath 應用，一個 pod 名稱為 hostPath-1 固定在 w1 的 node 上，另一個 pod 名稱為 hostPath-2 固定在 w2 的 node 上。</p>
<p>答：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: hostpath1</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - image: quay.io/flysangel/busybox</span></span><br><span class="line"><span class="string">    name: c1</span></span><br><span class="line"><span class="string">    command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;while true; do echo $(date) &gt; /cache/time; sleep 1; done&quot;]</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      mountPath: /cache</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      hostPath:</span></span><br><span class="line"><span class="string">        path: /opt/pv/cache</span></span><br><span class="line"><span class="string">  nodeSelector:</span></span><br><span class="line"><span class="string">    kubernetes.io/hostname: w1&#x27;</span> &gt; pod-hostpath-1.yaml</span><br><span class="line">	</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: hostpath2</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - image: quay.io/flysangel/busybox</span></span><br><span class="line"><span class="string">    name: c1</span></span><br><span class="line"><span class="string">    command: [&quot;/bin/sh&quot;, &quot;-c&quot;, &quot;while true; do echo $(date) &gt; /cache/time; sleep 1; done&quot;]</span></span><br><span class="line"><span class="string">    volumeMounts:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      mountPath: /cache</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: cache</span></span><br><span class="line"><span class="string">      hostPath:</span></span><br><span class="line"><span class="string">        path: /opt/pv/cache</span></span><br><span class="line"><span class="string">  nodeSelector:</span></span><br><span class="line"><span class="string">    kubernetes.io/hostname: w2&#x27;</span> &gt; pod-hostpath-2.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f pod-hostpath-1.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f pod-hostpath-2.yaml</span><br><span class="line"></span><br><span class="line">$ kg pods -o wide</span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">hostpath1   1/1     Running   0          71s   10.244.1.15   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">hostpath2   1/1     Running   0          32s   10.244.2.22   w2     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="認識-Persistent-Volumes"><a href="#認識-Persistent-Volumes" class="headerlink" title="認識 Persistent Volumes"></a>認識 Persistent Volumes</h2><ul>
<li><p>PersistentVolume (PV) </p>
<ul>
<li>a piece of storage in the cluster </li>
<li><font color=red><strong>provisioned by an administrator or dynamically provisioned using Storage Classes.</strong></font> </li>
<li>It is a resource in the cluster just like a node is a cluster resource.</li>
</ul>
</li>
<li><p>PersistentVolumeClaim (PVC) </p>
<ul>
<li>request for storage by a user. </li>
<li>Pods consume node resources and PVCs consume PV resources.</li>
<li>Pods can request specific levels of resources (CPU and Memory).</li>
<li>Claims can request specific size and access modes (ReadWriteOnce, ReadOnlyMany or ReadWriteMany).</li>
</ul>
</li>
</ul>
<p>PV 與 PVC 的 Access modes</p>
<ul>
<li>ReadWriteOnce(RWO)<ul>
<li>the volume can be mounted as read-write by a single node. ReadWriteOnce access mode still can allow multiple pods to access the volume when the pods are running on the same node.</li>
<li><font color=red>在同一個主機，可以提供多個 pod 一起使用同一個 pvc</font></li>
</ul>
</li>
<li>ReadOnlyMany(ROX)<ul>
<li>the volume can be mounted as read-only by many nodes.</li>
<li>在多台主機掛載，但只能讀取</li>
</ul>
</li>
<li>ReadWriteMany(RWX)<ul>
<li>the volume can be mounted as read-write by many nodes.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>PV Persistent Volumes &amp; PVC Persistent Volume Claim<ul>
<li>PVC｜Persistent Volume Claim（PV 的取用宣告）</li>
<li>PV 與 PVC 是一對一關係，只要 PV 與 PVC 建立關係後（Access mode 也必須要符合），PV 就沒辦法被其他 PVC 取用了</li>
<li>取用 PV 只能向上擴充，不能低於 PVC 的需求（要五毛可以給一塊，但不能只給一毛，但多給就是浪費資源）</li>
<li>Persistent Volumes Access mode<ul>
<li>ReadWriteOnce（RWO）<ul>
<li>提供同一個節點的多個 pod 存取</li>
</ul>
</li>
<li>ReadOnlyMany（ROX）<ul>
<li>提供跨節點的多個 pod 存取，唯讀</li>
</ul>
</li>
<li>ReadWriteMany（RWX）<ul>
<li>提供跨節點的多個 pod 存取，可讀可寫</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://i.imgur.com/38qkXr1.png"></p>
<p><img src="https://i.imgur.com/ONd2sk6.png"></p>
<p>當 PVC 這邊</p>
<h2 id="認識-Local-Persistent-Volumes"><a href="#認識-Local-Persistent-Volumes" class="headerlink" title="認識 Local Persistent Volumes"></a><strong>認識 Local Persistent Volumes</strong></h2><ul>
<li><p>What is a Local Persistent Volume?</p>
<ul>
<li>A local persistent volume represents a local disk directly-attached to a single Kubernetes Node.</li>
</ul>
</li>
<li><p>How is it different from a HostPath Volume?</p>
<ul>
<li>To better understand the benefits of a Local Persistent Volume, it is useful to compare it to a HostPath volume. HostPath volumes mount a file or directory from the host node’s filesystem into a Pod. Similarly a Local Persistent Volume mounts a local disk or partition into a Pod.</li>
</ul>
</li>
<li><p>How is it different from a HostPath Volume?</p>
<ul>
<li><p>The biggest difference is that the Kubernetes scheduler understands which node a Local Persistent Volume belongs to. With HostPath volumes, a pod referencing a HostPath volume may be moved by the scheduler to a different node resulting in data loss. But with Local Persistent Volumes, the Kubernetes scheduler ensures that a pod using a Local Persistent Volume is always scheduled to the same node.</p>
</li>
<li><p>Local Persistent Volumes</p>
<ul>
<li>基礎與 hostpath 相同，但是可以單獨掛載硬碟來使用</li>
<li>當 PCV 與 LPV 綁定後，pod 就會被限制在 LPV 的所在節點上</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="建立-Local-Persistent-Volume"><a href="#建立-Local-Persistent-Volume" class="headerlink" title="建立 Local Persistent Volume"></a>建立 Local Persistent Volume</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;kind: PersistentVolume</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: pv-rwo-5m</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  capacity:</span></span><br><span class="line"><span class="string">    storage: 5Mi</span></span><br><span class="line"><span class="string">  accessModes:</span></span><br><span class="line"><span class="string">    - ReadWriteOnce</span></span><br><span class="line"><span class="string">  local:</span></span><br><span class="line"><span class="string">    path: &quot;/opt/pv/5m&quot;</span></span><br><span class="line"><span class="string">  nodeAffinity:</span></span><br><span class="line"><span class="string">    required:</span></span><br><span class="line"><span class="string">      nodeSelectorTerms:</span></span><br><span class="line"><span class="string">      - matchExpressions:</span></span><br><span class="line"><span class="string">        - key: kubernetes.io/hostname</span></span><br><span class="line"><span class="string">          operator: In</span></span><br><span class="line"><span class="string">          values:</span></span><br><span class="line"><span class="string">          - w1&#x27;</span> &gt; pv-rwo-5m.yaml</span><br></pre></td></tr></table></figure>

<h3 id="建立-Local-PersistentVolumeClaim"><a href="#建立-Local-PersistentVolumeClaim" class="headerlink" title="建立 Local PersistentVolumeClaim"></a>建立 Local PersistentVolumeClaim</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: nginx-1</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">    - name: nginx-1</span></span><br><span class="line"><span class="string">      image: quay.io/flysangel/nginx</span></span><br><span class="line"><span class="string">      volumeMounts:</span></span><br><span class="line"><span class="string">        - name: html-storage</span></span><br><span class="line"><span class="string">          mountPath: /usr/share/nginx/html</span></span><br><span class="line"><span class="string">  volumes:</span></span><br><span class="line"><span class="string">    - name: html-storage</span></span><br><span class="line"><span class="string">      persistentVolumeClaim:</span></span><br><span class="line"><span class="string">        claimName: pvc-rwo-3m&#x27;</span> &gt; nginx-pod-1.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f nginx-pod-1.yaml</span><br><span class="line">pod/nginx-1 created</span><br><span class="line"></span><br><span class="line">$ kubectl get pod nginx-1 -o wide </span><br><span class="line">NAME      READY   STATUS              RESTARTS   AGE   IP       NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-1   0/1     ContainerCreating   0          17s   &lt;none&gt;   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ kubectl describe pod nginx-1</span><br><span class="line">...</span><br><span class="line">Warning  FailedMount  12s (x6 over 28s)  kubelet</span><br><span class="line">MountVolume.NewMounter initialization failed <span class="keyword">for</span> volume <span class="string">&quot;pv-rwo-5m&quot;</span> : </span><br><span class="line">path <span class="string">&quot;/opt/pv/5m&quot;</span> does not exist</span><br><span class="line"></span><br><span class="line">$ ssh w1 sudo <span class="built_in">mkdir</span> –p /opt/pv/5m</span><br><span class="line"></span><br><span class="line">$ kubectl get pod -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP             NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-1   1/1     Running   0          11m   10.199.3.207   w1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p><font color=red><strong>注意！HostPath 如果給的目錄不存在，系統會自動幫你建立，但是 PV 本身在建立的時候，要自己建好目錄區，否則就算 PVC 與 PV bound 在一起，一樣會無法建立 pod</strong></font></p>
<h3 id="建立-nginx-首頁"><a href="#建立-nginx-首頁" class="headerlink" title="建立 nginx 首頁"></a>建立 nginx 首頁</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it nginx-1 -- bash</span><br><span class="line">root@nginx-1:/<span class="comment"># echo &#x27;Hello My Pvc&#x27; &gt; /usr/share/nginx/html/index.html</span></span><br><span class="line"></span><br><span class="line">root@nginx-1:/<span class="comment"># exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">bigred@m1:~/0608$ ssh w1 <span class="built_in">cat</span> /opt/pv/5m/index.html</span><br><span class="line">Hello My Pvc</span><br><span class="line"></span><br><span class="line">bigred@m1:~/0608$ curl 10.244.1.16</span><br><span class="line">Hello My Pvc</span><br></pre></td></tr></table></figure>

<h3 id="移除-Pod-與-PVC-重新建立"><a href="#移除-Pod-與-PVC-重新建立" class="headerlink" title="移除 Pod 與 PVC 重新建立"></a>移除 Pod 與 PVC 重新建立</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete -f nginx-pod-1.yaml</span><br><span class="line">pod <span class="string">&quot;nginx-1&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">$ kubectl delete -f pvc-rwo-3m.yaml</span><br><span class="line">persistentvolumeclaim <span class="string">&quot;pvc-rwo-3m&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">$ kubectl get pv pv-rwo-5m</span><br><span class="line">NAME        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM                STORAGECLASS   REASON   AGE</span><br><span class="line">pv-rwo-5m   5Mi        RWO            Retain           Released   default/pvc-rwo-3m                           18m</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f pvc-rwo-3m.yaml</span><br><span class="line">persistentvolumeclaim/pvc-rwo-3m created</span><br><span class="line"></span><br><span class="line">$ kubectl get pvc pvc-rwo-3m</span><br><span class="line">NAME         STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">pvc-rwo-3m   Pending         </span><br><span class="line">2s</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">export</span> KUBE_EDITOR=<span class="string">&quot;nano&quot;</span></span><br><span class="line"></span><br><span class="line">$ kubectl edit pv pv-rwo-5m</span><br><span class="line"><span class="comment">## 刪除以下這段</span></span><br><span class="line">  claimRef:</span><br><span class="line">    apiVersion: v1</span><br><span class="line">    kind: PersistentVolumeClaim</span><br><span class="line">    name: pvc-rwo-3m</span><br><span class="line">    namespace: default</span><br><span class="line">    resourceVersion: <span class="string">&quot;602201&quot;</span></span><br><span class="line">    uid: 79c392da-3cc3-4088-876e-e83799c22441</span><br></pre></td></tr></table></figure>

<p>當 pvc 與 pv Bound 過一次後， pv 會一直記著當前的 pvc ，當我們把 pvc 刪掉後，去檢查 pv 的狀態會顯示 Released ，於是我們建了一個一模一樣的 pvc 後發現他的狀態是 Pending ，發現 pv 其實還是記著被刪掉的 pvc ，所以如果要讓 pv 忘記舊的 pvc 要透過 <code>kubectl edit pv $pv_name</code>，進去把紀錄的 pvc 資訊都刪除。</p>
<p>注意！ pv 刪除後，pv 對應的目錄也要刪除，資料才會清空。</p>
<hr>
<h1 id="練習-1"><a href="#練習-1" class="headerlink" title="練習"></a>練習</h1><p>:::success</p>
<p>題目：<br>建立兩個 nginx Pod 掛載相同的 PVC，Access Modes 為 ReadWriteOnce，觀察兩個 Pod 是否在同一台節點上。</p>
<p>答案：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 編輯 nginx-pod-1.yaml檔</span></span><br><span class="line">$ nano nginx-pod-1.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-1</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: nginx-1</span><br><span class="line">      image: quay.io/flysangel/nginx</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - name: html-storage</span><br><span class="line">          mountPath: /usr/share/nginx/html</span><br><span class="line">  volumes:</span><br><span class="line">    - name: html-storage</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: pvc-rwo-3m</span><br><span class="line"></span><br><span class="line"><span class="comment">## 編輯 nginx-pod-2.yaml檔</span></span><br><span class="line">$ nano nginx-pod-2.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-2</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: nginx-2</span><br><span class="line">      image: quay.io/flysangel/nginx</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - name: html-storage</span><br><span class="line">          mountPath: /usr/share/nginx/html</span><br><span class="line">  volumes:</span><br><span class="line">    - name: html-storage</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: pvc-rwo-3m</span><br><span class="line"></span><br><span class="line"><span class="comment">## 編輯 pv 的 yml 檔</span></span><br><span class="line">$ nano pv-rwo-5m.yaml</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: pv-rwo-5m</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 5Mi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    path: <span class="string">&quot;/opt/pv/5m&quot;</span></span><br><span class="line">  nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">      - matchExpressions:</span><br><span class="line">        - key: kubernetes.io/hostname</span><br><span class="line">          operator: In</span><br><span class="line">          values:</span><br><span class="line">          - w1</span><br><span class="line"></span><br><span class="line"><span class="comment">## 編輯 pvc 的 yml 檔</span></span><br><span class="line">$ nano pvc-rwo-3m.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: pvc-rwo-3m</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 3Mi</span><br><span class="line"></span><br><span class="line"><span class="comment">## 建立 pv </span></span><br><span class="line">$ kubectl apply -f pv-rwo-5m.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">## 檢查 pv 狀態</span></span><br><span class="line">$ kg pv</span><br><span class="line">NAME        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   REASON   AGE</span><br><span class="line">pv-rwo-5m   5Mi        RWO            Retain           Bound    default/pvc-rwo-3m                           17s</span><br><span class="line"></span><br><span class="line"><span class="comment">## 建立 pvc</span></span><br><span class="line">$ kubectl apply -f pvc-rwo-3m.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">## 檢查 pvc 狀態</span></span><br><span class="line">$ kg pvc</span><br><span class="line">NAME         STATUS   VOLUME      CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">pvc-rwo-3m   Bound    pv-rwo-5m   5Mi        RWO                           13s</span><br><span class="line"></span><br><span class="line"><span class="comment">## 建立 nginx-pod-1</span></span><br><span class="line">$ kubectl apply -f nginx-pod-1.yaml</span><br><span class="line">pod/nginx-1 created</span><br><span class="line"></span><br><span class="line"><span class="comment">## 建立 nginx-pod-2</span></span><br><span class="line">$ kubectl apply -f nginx-pod-2.yaml</span><br><span class="line">pod/nginx-2 created</span><br><span class="line"></span><br><span class="line"><span class="comment">## 檢視結果是否符合預期</span></span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE     IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-1   1/1     Running   0          2m28s   10.244.1.17   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-2   1/1     Running   0          2m25s   10.244.1.18   w1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p><font color=red>結論：兩個 pod 會在同一個 node</font></p>
<p>:::</p>
<p>:::success</p>
<p>題目：<br>建立兩個 nginx Pod 掛載相同的 PVC，Access Modes 為 ReadWriteMany，將一個 Pod 鎖定在 W1，另一個 Pod 鎖定在 W2，觀察兩個 Pod 的狀態。</p>
<p>答案：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 清理空間</span></span><br><span class="line">$ kubectl delete -f nginx-pod-1.yaml</span><br><span class="line">$ kubectl delete -f nginx-pod-2.yaml</span><br><span class="line">$ kubectl delete -f pvc-rwo-3m.yaml</span><br><span class="line">$ kubectl delete -f pv-rwo-5m.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">## </span></span><br><span class="line"></span><br><span class="line">677  nano pv-rwo-5m.yaml</span><br><span class="line">  678  nano pvc-rwo-3m.yaml</span><br><span class="line">  679  kubectl apply -f pvc-rwo-3m.yaml</span><br><span class="line">  680  kubectl apply -f pv-rwo-5m.yaml</span><br><span class="line">  681  kg pv</span><br><span class="line">  682  kg pvc</span><br><span class="line">  683  kg pv</span><br><span class="line">  684  nano nginx-pod-1.yaml</span><br><span class="line">  685  kubectl apply -f nginx-pod-1.yaml</span><br><span class="line">  686  kubectl apply -f nginx-pod-2.yaml</span><br><span class="line">$ kg pods -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-1   1/1     Running   0          9s    10.244.1.20   w1       &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-2   0/1     Pending   0          5s    &lt;none&gt;        &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<p>:::success</p>
<p>題目：<br>建立一個 nginx pod 掛載 PVC，Access Modes 為 ReadOnlyMany，並產生一個 10MB 的檔案，觀察是否可以正常儲存。</p>
<p>答案：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">$ nano pvc-rwo-3m.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: pvc-rwo-3m</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadOnlyMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 3Mi</span><br><span class="line"></span><br><span class="line">$ nano pv-rwo-5m.yaml</span><br><span class="line">kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: pv-rwo-5m</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 5Mi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadOnlyMany</span><br><span class="line">  <span class="built_in">local</span>:</span><br><span class="line">    path: <span class="string">&quot;/opt/pv/5m&quot;</span></span><br><span class="line">  nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">      - matchExpressions:</span><br><span class="line">        - key: kubernetes.io/hostname</span><br><span class="line">          operator: In</span><br><span class="line">          values:</span><br><span class="line">          - w1</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f pv-rwo-5m.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f pvc-rwo-3m.yaml</span><br><span class="line"></span><br><span class="line">$ kg pv</span><br><span class="line">NAME        CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   REASON   AGE</span><br><span class="line">pv-rwo-5m   5Mi        ROX            Retain           Bound    default/pvc-rwo-3m                           22m</span><br><span class="line"></span><br><span class="line">$ kg pvc</span><br><span class="line">NAME         STATUS   VOLUME      CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">pvc-rwo-3m   Bound    pv-rwo-5m   5Mi        ROX                           22m</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f nginx-pod-1.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl get pod nginx-1 -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-1   1/1     Running   0          20m   10.244.1.21   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it nginx-1 -- bash</span><br><span class="line"></span><br><span class="line">root@nginx-1:/usr/share/nginx/html<span class="comment"># dd if=/dev/zero of=test bs=1M count=10</span></span><br><span class="line">10+0 records <span class="keyword">in</span></span><br><span class="line">10+0 records out</span><br><span class="line">10485760 bytes (10 MB, 10 MiB) copied, 0.00454216 s, 2.3 GB/s</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>:::</p>
<p>依序建立 3 個 ROX PV(3g, 5g, 10g)，再依序建立 3 個 PVC(4g, 8g, 5g)，觀察 PVC 與 PV 之關係。</p>
<hr>
<h1 id="Local-Path-Provisioner"><a href="#Local-Path-Provisioner" class="headerlink" title="Local Path Provisioner"></a>Local Path Provisioner</h1><p>Local Path Provisioner provides a way for the Kubernetes users to utilize the local storage in each node. Based on the user configuration, the Local Path Provisioner will create hostPath based persistent volume on the node automatically. It utilizes the features introduced by Kubernetes Local Persistent Volume feature, but make it a simpler solution than the built-in local volume feature in Kubernetes.</p>
<ul>
<li>只要 pod 宣告新增 pvc ，他會自動新增 pv<ul>
<li>單純建立 pvc 的話，不會自動新增 pv</li>
</ul>
</li>
<li>刪除 pvc ，他也會自動幫我們刪除 pv<ul>
<li>pv 的目錄也會被刪除，不會殘留</li>
<li>刪除有使用 pvc 的 pod ，pvc 還會在</li>
</ul>
</li>
<li>StorageClass “local-path”: Only support ReadWriteOnce access mode</li>
<li>capacitiy 也不會限制</li>
</ul>
<h2 id="安裝-Local-Path-Provisioner"><a href="#安裝-Local-Path-Provisioner" class="headerlink" title="安裝 Local Path Provisioner"></a>安裝 Local Path Provisioner</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.22/deploy/local-path-storage.yaml</span><br><span class="line">namespace/local-path-storage created</span><br><span class="line">serviceaccount/local-path-provisioner-service-account created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/local-path-provisioner-role created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/local-path-provisioner-bind created</span><br><span class="line">deployment.apps/local-path-provisioner created</span><br><span class="line">storageclass.storage.k8s.io/local-path created</span><br><span class="line">configmap/local-path-config created</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -n local-path-storage</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">local-path-provisioner-7fdb4745c6-njprx   1/1     Running   0          4m47s</span><br></pre></td></tr></table></figure>

<h2 id="建立-PersistentVolumeClaim"><a href="#建立-PersistentVolumeClaim" class="headerlink" title="建立 PersistentVolumeClaim"></a>建立 PersistentVolumeClaim</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: PersistentVolumeClaim</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: html-storage</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  storageClassName: local-path</span></span><br><span class="line"><span class="string">  accessModes:</span></span><br><span class="line"><span class="string">    - ReadWriteOnce</span></span><br><span class="line"><span class="string">  resources:</span></span><br><span class="line"><span class="string">    requests:</span></span><br><span class="line"><span class="string">      storage: 3Mi&#x27;</span> &gt; nginx-pvc.yaml</span><br><span class="line">	  </span><br><span class="line">$ kubectl apply -f nginx-pvc.yaml</span><br><span class="line">persistentvolumeclaim/html-storage created</span><br><span class="line"></span><br><span class="line">$ kubectl get pvc html-storage </span><br><span class="line">NAME           STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">html-storage   Pending                                      local-path     29s</span><br><span class="line"></span><br><span class="line">$ kubectl get pv</span><br><span class="line">No resources found</span><br><span class="line"></span><br><span class="line">$ kubectl get pod nginx -o wide</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE     IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx   1/1     Running   0          2m11s   10.244.1.23   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="刪除-Pod-檢查-PV-PVC"><a href="#刪除-Pod-檢查-PV-PVC" class="headerlink" title="刪除 Pod 檢查 PV PVC"></a>刪除 Pod 檢查 PV PVC</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete -f nginx-pod.yaml</span><br><span class="line">pod <span class="string">&quot;nginx&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">$ kg pvc</span><br><span class="line">NAME           STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">html-storage   Bound    pvc-4a8cd7cc-bcd9-4aec-8d6f-171877bdc51b   3Mi        RWO            local-path     15m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ kubectl delete -f nginx-pvc.yaml</span><br><span class="line">persistentvolumeclaim <span class="string">&quot;html-storage&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">$ kubectl get pvc</span><br><span class="line">No resources found <span class="keyword">in</span> default namespace.</span><br><span class="line"></span><br><span class="line">$ kubectl get pv</span><br><span class="line">No resources found</span><br><span class="line"></span><br><span class="line">$ ssh w1 <span class="built_in">ls</span> -al /opt/local-path-provisioner</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 2 root root 4096 Jun  8 14:47 .</span><br><span class="line">drwxr-xr-x 5 root root 4096 Jun  8 14:32 ..</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="練習-2"><a href="#練習-2" class="headerlink" title="練習"></a>練習</h1><p>:::success</p>
<p>題目：<br>建立兩個 nginx Pod 掛載相同的 PVC，Access Modes 為 ReadWriteOnce，觀察兩個 Pod 是否在同一台節點上。</p>
<p>答案：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$ nano nginx-pod.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-1</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: nginx</span><br><span class="line">      image: quay.io/flysangel/nginx</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - name: html-storage</span><br><span class="line">          mountPath: /usr/share/nginx/html</span><br><span class="line">  volumes:</span><br><span class="line">    - name: html-storage</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: html-storage</span><br><span class="line"></span><br><span class="line">$ nano nginx-pod2.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-2</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: nginx</span><br><span class="line">      image: quay.io/flysangel/nginx</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - name: html-storage</span><br><span class="line">          mountPath: /usr/share/nginx/html</span><br><span class="line">  volumes:</span><br><span class="line">    - name: html-storage</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        claimName: html-storage</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f nginx-pod.yaml</span><br><span class="line">pod/nginx-1 created</span><br><span class="line"></span><br><span class="line">bigred@m1:~/0608$ kubectl apply -f nginx-pod2.yaml</span><br><span class="line">pod/nginx-2 created</span><br><span class="line"></span><br><span class="line">bigred@m1:~/0608$ kg pods -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-1   1/1     Running   0          31s   10.244.1.29   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-2   1/1     Running   0          28s   10.244.1.28   w1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>:::</p>
<p>建立兩個 nginx Pod 掛載相同的 PVC，Access Modes 為 ReadWriteMany，將一個 Pod 鎖定在 W1，另一個 Pod 鎖定在 W2，觀察兩個 Pod 的狀態。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete -f nginx-pod.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl delete -f nginx-pod2.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl delete -f nginx-pvc.yaml</span><br><span class="line"></span><br><span class="line">$ nano nginx-pvc.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: html-storage</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: local-path</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteMany</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 3Mi</span><br><span class="line"></span><br><span class="line">$ </span><br></pre></td></tr></table></figure>




<p>建立一個 nginx pod 掛載 PVC，Access Modes 為 ReadOnlyMany，並產生一個 10MB 的檔案，觀察是否可以正常儲存。</p>
<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E7%B3%BB%E7%B5%B1%E5%B7%A5%E7%A8%8B/" rel="tag"># 系統工程</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/Kubernetes%20Init%20with%20Config.yaml/" rel="prev" title="Kubernetes Init with Config.yaml">
      <i class="fa fa-chevron-left"></i> Kubernetes Init with Config.yaml
    </a></div>
      <div class="post-nav-item">
    <a href="/Kubernetes%20%E5%85%AC%E5%85%B1%E5%BB%BA%E8%A8%AD/" rel="next" title="Kubernetes 公共建設">
      Kubernetes 公共建設 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Kubernetes-Resource-Storage-by-%E6%98%8E%E5%9F%8E%E8%80%81%E5%B8%AB"><span class="nav-number">1.</span> <span class="nav-text">Kubernetes Resource Storage by 明城老師</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%B8%E7%BF%92%E7%9B%AE%E6%A8%99"><span class="nav-number">1.1.</span> <span class="nav-text">學習目標</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Kubernetes-Volume"><span class="nav-number">1.2.</span> <span class="nav-text">Kubernetes Volume</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EmptyDir-%E6%87%89%E7%94%A8"><span class="nav-number">1.3.</span> <span class="nav-text">EmptyDir 應用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AA%A2%E8%A6%96-Emptydir"><span class="nav-number">1.3.1.</span> <span class="nav-text">檢視 Emptydir</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AB%8B%E5%86%8D%E6%AC%A1%E7%94%A2%E7%94%9F-emptyDir-%E6%87%89%E7%94%A8%EF%BC%8C%E5%88%A4%E6%96%B7-emptyDir-%E7%9A%84%E7%94%9F%E5%91%BD%E9%80%B1%E6%9C%9F%E6%98%AF%E5%90%A6%E8%88%87-Pod-%E4%B8%80%E8%87%B4%E3%80%82"><span class="nav-number">1.3.2.</span> <span class="nav-text">請再次產生 emptyDir 應用，判斷 emptyDir 的生命週期是否與 Pod 一致。</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HostPath-%E6%87%89%E7%94%A8"><span class="nav-number">1.4.</span> <span class="nav-text">HostPath 應用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%AA%E9%99%A4-pod-%E6%AA%A2%E8%A6%96-Hostpath-%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="nav-number">1.4.1.</span> <span class="nav-text">刪除 pod 檢視 Hostpath 是否存在</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E8%A6%86%E5%BB%BA%E7%AB%8B-emptydir%E3%80%81hostPath-%E6%87%89%E7%94%A8%EF%BC%8C%E5%88%A4%E6%96%B7-hostPath-Pod-%E6%98%AF%E5%90%A6%E5%9B%BA%E5%AE%9A%E6%96%BC%E5%90%8C%E4%B8%80%E5%80%8B%E7%AF%80%E9%BB%9E%E4%B8%8A%E3%80%82"><span class="nav-number">1.4.2.</span> <span class="nav-text">反覆建立 emptydir、hostPath 應用，判斷 hostPath Pod 是否固定於同一個節點上。</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B7%B4%E7%BF%92"><span class="nav-number">1.4.3.</span> <span class="nav-text">練習</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AA%8D%E8%AD%98-Persistent-Volumes"><span class="nav-number">1.5.</span> <span class="nav-text">認識 Persistent Volumes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AA%8D%E8%AD%98-Local-Persistent-Volumes"><span class="nav-number">1.6.</span> <span class="nav-text">認識 Local Persistent Volumes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-Local-Persistent-Volume"><span class="nav-number">1.6.1.</span> <span class="nav-text">建立 Local Persistent Volume</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-Local-PersistentVolumeClaim"><span class="nav-number">1.6.2.</span> <span class="nav-text">建立 Local PersistentVolumeClaim</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-nginx-%E9%A6%96%E9%A0%81"><span class="nav-number">1.6.3.</span> <span class="nav-text">建立 nginx 首頁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A7%BB%E9%99%A4-Pod-%E8%88%87-PVC-%E9%87%8D%E6%96%B0%E5%BB%BA%E7%AB%8B"><span class="nav-number">1.6.4.</span> <span class="nav-text">移除 Pod 與 PVC 重新建立</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%B7%B4%E7%BF%92-1"><span class="nav-number">2.</span> <span class="nav-text">練習</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Local-Path-Provisioner"><span class="nav-number">3.</span> <span class="nav-text">Local Path Provisioner</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%9D-Local-Path-Provisioner"><span class="nav-number">3.1.</span> <span class="nav-text">安裝 Local Path Provisioner</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-PersistentVolumeClaim"><span class="nav-number">3.2.</span> <span class="nav-text">建立 PersistentVolumeClaim</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%AA%E9%99%A4-Pod-%E6%AA%A2%E6%9F%A5-PV-PVC"><span class="nav-number">3.3.</span> <span class="nav-text">刪除 Pod 檢查 PV PVC</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%B7%B4%E7%BF%92-2"><span class="nav-number">4.</span> <span class="nav-text">練習</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#tags-%E7%B3%BB%E7%B5%B1%E5%B7%A5%E7%A8%8B"><span class="nav-number">4.0.0.0.0.1.</span> <span class="nav-text">tags: 系統工程</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Antony Cehn</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Antony.Chen</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
