<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.15.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Kubernetes Resource Storage (NFS):::warning :::spoiler 目錄 [TOC] ::: Kubernetes Volume Type of Storage Container Filesystem (Overlay2) Container 掛點，檔案系統掛點   Volume (emptyDir) 每個 Container 會共用 pod 的目錄 生">
<meta property="og:type" content="article">
<meta property="og:title" content="Kubernetes Resource Storage">
<meta property="og:url" content="http://example.com/Kubernetes%20Resource%20Storage.html">
<meta property="og:site_name" content="Antony 的學習筆記">
<meta property="og:description" content="Kubernetes Resource Storage (NFS):::warning :::spoiler 目錄 [TOC] ::: Kubernetes Volume Type of Storage Container Filesystem (Overlay2) Container 掛點，檔案系統掛點   Volume (emptyDir) 每個 Container 會共用 pod 的目錄 生">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.imgur.com/yfocaAI.png">
<meta property="og:image" content="https://i.imgur.com/WaCuRbV.png">
<meta property="article:published_time" content="2022-09-17T18:45:34.000Z">
<meta property="article:modified_time" content="2023-05-07T08:15:42.167Z">
<meta property="article:author" content="Antony Cehn">
<meta property="article:tag" content="系統工程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/yfocaAI.png">


<link rel="canonical" href="http://example.com/Kubernetes%20Resource%20Storage.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/Kubernetes%20Resource%20Storage.html","path":"Kubernetes Resource Storage.html","title":"Kubernetes Resource Storage"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Kubernetes Resource Storage | Antony 的學習筆記</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Antony 的學習筆記</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">這個網站將紀錄持續記錄我學習到各種知識的筆記</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Kubernetes-Resource-Storage-NFS"><span class="nav-number">1.</span> <span class="nav-text">Kubernetes Resource Storage (NFS)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kubernetes-Volume"><span class="nav-number">2.</span> <span class="nav-text">Kubernetes Volume</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#empty-dir-volume"><span class="nav-number">2.1.</span> <span class="nav-text">empty dir volume</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Shared-volumes-in-a-Kubernetes-Pod"><span class="nav-number">2.2.</span> <span class="nav-text">Shared volumes in a Kubernetes Pod</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hostPath-Volume-%E6%87%89%E7%94%A8%E7%AF%84%E4%BE%8B"><span class="nav-number">2.3.</span> <span class="nav-text">hostPath Volume 應用範例</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Persistent-Volumes-%E9%81%8B%E4%BD%9C%E6%9E%B6%E6%A7%8B"><span class="nav-number">3.</span> <span class="nav-text">Persistent Volumes 運作架構</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Local-Persistent-Volumes"><span class="nav-number">3.1.</span> <span class="nav-text">Local Persistent Volumes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-Local-PersistentVolume"><span class="nav-number">3.1.1.</span> <span class="nav-text">建立 Local PersistentVolume</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A2%E7%94%9F-PV"><span class="nav-number">3.1.2.</span> <span class="nav-text">產生 PV</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-Local-PersistentVolumeClaim"><span class="nav-number">3.1.3.</span> <span class="nav-text">建立 Local PersistentVolumeClaim</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E4%BD%BF%E7%94%A8-pvc-local-%E7%9A%84%E7%AC%AC%E4%B8%80%E5%80%8B-Pod"><span class="nav-number">3.1.4.</span> <span class="nav-text">建立使用 pvc-local 的第一個 Pod</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-NGINX-%E9%A6%96%E9%A0%81"><span class="nav-number">3.1.5.</span> <span class="nav-text">建立 NGINX 首頁</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Helm"><span class="nav-number">4.</span> <span class="nav-text">Helm</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%9D-Helm-3"><span class="nav-number">4.1.</span> <span class="nav-text">安裝 Helm 3</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#NFS-Dynamic-Volume-Provision"><span class="nav-number">5.</span> <span class="nav-text">NFS Dynamic Volume Provision</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%9D-NFS-%E5%A5%97%E4%BB%B6"><span class="nav-number">5.1.</span> <span class="nav-text">安裝 NFS 套件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A8%AD%E5%AE%9A-NFS-Server"><span class="nav-number">5.2.</span> <span class="nav-text">設定 NFS Server</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%95%9F%E5%8B%95-NFS-Server"><span class="nav-number">5.3.</span> <span class="nav-text">啟動 NFS Server</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%AC%E8%A9%A6-NFS"><span class="nav-number">5.4.</span> <span class="nav-text">測試 NFS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%9D%E8%88%87%E5%BB%BA%E7%AB%8B-NFS-Provisioner"><span class="nav-number">5.5.</span> <span class="nav-text">安裝與建立 NFS Provisioner</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AA%A2%E8%A6%96-NFS-Provisioner"><span class="nav-number">5.6.</span> <span class="nav-text">檢視 NFS Provisioner</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-PVC-%E6%B8%AC%E8%A9%A6-NFS-Client-Provisioner"><span class="nav-number">5.7.</span> <span class="nav-text">建立 PVC 測試 NFS Client Provisioner</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-Job-%E6%B8%AC%E8%A9%A6-NFS-Client-Provisioner"><span class="nav-number">5.8.</span> <span class="nav-text">建立 Job 測試 NFS Client Provisioner</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Antony Cehn</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes%20Resource%20Storage.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Kubernetes Resource Storage | Antony 的學習筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kubernetes Resource Storage
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-09-18 02:45:34" itemprop="dateCreated datePublished" datetime="2022-09-18T02:45:34+08:00">2022-09-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-05-07 16:15:42" itemprop="dateModified" datetime="2023-05-07T16:15:42+08:00">2023-05-07</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Kubernetes-Resource-Storage-NFS"><a href="#Kubernetes-Resource-Storage-NFS" class="headerlink" title="Kubernetes Resource Storage (NFS)"></a>Kubernetes Resource Storage (NFS)</h1><p>:::warning</p>
<p>:::spoiler 目錄</p>
<p>[TOC]</p>
<p>:::</p>
<h1 id="Kubernetes-Volume"><a href="#Kubernetes-Volume" class="headerlink" title="Kubernetes Volume"></a>Kubernetes Volume</h1><ul>
<li>Type of Storage<ul>
<li>Container Filesystem (Overlay2)<ul>
<li>Container 掛點，檔案系統掛點</li>
</ul>
</li>
<li>Volume (emptyDir)<ul>
<li>每個 Container 會共用 pod 的目錄</li>
<li>生命週期與 pod 一樣， pod 裡其中一個 Container 毀損，並不影響到 Volume</li>
</ul>
</li>
<li>Persistent volume. (hostPath, Local,NFS)<ul>
<li>永存的儲存體</li>
<li>生命週期與 K8S Cluster 相同</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="empty-dir-volume"><a href="#empty-dir-volume" class="headerlink" title="empty dir volume"></a>empty dir volume</h2><p><img src="https://i.imgur.com/yfocaAI.png"></p>
<ul>
<li>empty dir 的運作，等同於 Container 的 Volume</li>
<li>empty dir，這個目錄存在於 Linux 系統中，系統會自動幫我們產生這個目錄區（名字很長不是人記得）。</li>
<li>一個 pod 裡的多個 Container 共用同一個 Linux 系統的目錄區</li>
</ul>
<h2 id="Shared-volumes-in-a-Kubernetes-Pod"><a href="#Shared-volumes-in-a-Kubernetes-Pod" class="headerlink" title="Shared volumes in a Kubernetes Pod"></a>Shared volumes in a Kubernetes Pod</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano ~/wulin/yaml/sidecar.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sidecar</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">1st</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/nginx</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">2nd</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/alpine</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/html</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">while</span> <span class="literal">true</span><span class="string">;</span> <span class="string">do</span></span><br><span class="line">          <span class="string">date</span> <span class="string">&gt;&gt;</span> <span class="string">/html/index.html;</span></span><br><span class="line">          <span class="string">sleep</span> <span class="number">1</span><span class="string">;</span></span><br><span class="line">        <span class="string">done</span></span><br></pre></td></tr></table></figure>

<ul>
<li>將 <code>1st</code> 和 <code>2nd</code> 兩台 Container 的目錄</li>
<li><code>spec.volumes.emptyDir: &#123;&#125;</code>，這個目錄等下會被 mount 到 <code>spec.volumes.mountPath: /usr/share/nginx/html</code> 這個目錄</li>
</ul>
<p>建立 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ka -f ~/wulin/yaml/sidecar.yaml</span><br></pre></td></tr></table></figure>

<p>進入 sidecar pod 裡面的 1st Container 看 <code>/usr/share/nginx/html/index.html</code> 檔案的倒數 3 行的內容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec sidecar -c 1st -- /bin/cat  /usr/share/nginx/html/index.html | tail -n 3</span><br><span class="line">Thu Dec 16 13:20:14 UTC 2021</span><br><span class="line">Thu Dec 16 13:20:15 UTC 2021</span><br><span class="line">Thu Dec 16 13:20:16 UTC 2021</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kubectl exec</code>，在 pod 中的 Container 裡面執行命令</li>
<li><code>-c</code> 後面接的是 Container 的名字</li>
<li><code>--</code> 後面放在 Container 裡要執行的命令</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ kg pods -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">sidecar   2/2     Running   0          12m   10.244.0.6   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ kubectl get pod sidecar --template=&#123;&#123;.status.podIP&#125;&#125;; echo</span><br><span class="line">10.244.0.6</span><br><span class="line"></span><br><span class="line">$ podip=$(kubectl get pod sidecar --template=&#123;&#123;.status.podIP&#125;&#125;)</span><br><span class="line"></span><br><span class="line">$ curl -s http://$podip | head -n 5</span><br><span class="line">Thu Dec 16 13:06:28 UTC 2021</span><br><span class="line">Thu Dec 16 13:06:29 UTC 2021</span><br><span class="line">Thu Dec 16 13:06:30 UTC 2021</span><br><span class="line">Thu Dec 16 13:06:31 UTC 2021</span><br><span class="line">Thu Dec 16 13:06:32 UTC 2021</span><br></pre></td></tr></table></figure>

<h2 id="hostPath-Volume-應用範例"><a href="#hostPath-Volume-應用範例" class="headerlink" title="hostPath Volume 應用範例"></a>hostPath Volume 應用範例</h2><p>編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 在 m1 終端機執行</span><br><span class="line">$ nano ~/wulin/yaml/pod-hp.yaml </span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-hp</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-hp</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/nginx</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">&quot;http-server&quot;</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/usr/share/nginx/html&quot;</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">hp-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">hp-volume</span></span><br><span class="line">      <span class="attr">hostPath:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/opt/hostpath</span></span><br></pre></td></tr></table></figure>

<p>產生 pod </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f ~/wulin/yaml/pod-hp.yaml   (不會產生 PV Object)</span><br><span class="line"></span><br><span class="line"># 看 pod IP 位址</span><br><span class="line">$ kg po -o wide</span><br><span class="line">NAME     READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-hp   1/1     Running   0          65s   10.244.4.12   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># 檢查 hostpath 目錄</span><br><span class="line">$ ssh w2 &#x27;ls -l /opt&#x27;</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 3 root root 4096 Dec 25  2021 cni</span><br><span class="line">drwxr-xr-x 2 root root 4096 Sep  4 15:30 hostpath</span><br><span class="line"></span><br><span class="line"># 對照 w1 node 是不會有的</span><br><span class="line">$ ssh w1 &#x27;ls -l /opt&#x27;</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 3 root root 4096 Dec 25  2021 cni</span><br><span class="line">drwxr-xr-x 9 root root 4096 Sep  4 00:23 www</span><br><span class="line"></span><br><span class="line"># 進入 pod 產生 index.html 檔案</span><br><span class="line">$ kubectl exec -it pod-hp -- sh</span><br><span class="line"># echo &quot;&lt;h1&gt;let me go&lt;/h1&gt;&quot; &gt; /usr/share/nginx/html/index.html</span><br><span class="line"># exit</span><br><span class="line"></span><br><span class="line">$ curl http://10.244.2.20</span><br><span class="line">&lt;h1&gt;let me go&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<p>檢查剛剛產生的 index.html 是否產生在 w2 的 <code>/opt/hostpath</code> 目錄</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ssh w2 &#x27;ls -l /opt/hostpath/&#x27;</span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 19 Sep  4 15:34 index.html</span><br></pre></td></tr></table></figure>


<hr>
<h1 id="Persistent-Volumes-運作架構"><a href="#Persistent-Volumes-運作架構" class="headerlink" title="Persistent Volumes 運作架構"></a>Persistent Volumes 運作架構</h1><p><img src="https://i.imgur.com/WaCuRbV.png"></p>
<ul>
<li>管理 storage 一直都是一個不簡單的課題，為了讓 developer 可以更專注在開發上，k8s 中提出了兩個概念(resource object)，分別是 Persistent Volume(PV) &amp; Persistent Volume Claim(PVC)，透過這兩個概念將連結 storage 的過程抽象化，讓使用者不需要了解 storage 在底層是如何運作的，只要了解如何使用即可，大幅降低使用者操作 storage 的困難度。</li>
<li>Persistent Volume(PV) 由 storage 管理者負責產生，在 k8s 中就是一種可用的 storage resource，同樣也是一種 volume plugin，但有自己獨立的 lifecycle，且包含的就是實際與 storage 連結的實作細節。</li>
<li>Persistent Volume Claim(PVC) 則是來自使用者的 storage request，就跟 pod 一樣都是要消耗特定的資源，PVC 消耗 PV 資源(pod 消耗 node 資源)，PVC 指定特定 size or access mode 的 PV(pod 可以指定 CPU, memory … etc)。</li>
<li>由於 PVC 可以允許使用者自行指定所需要 PV 的相關屬性，因此除了 size, access mode 外，可能還會有 performance 的需求。而為了滿足不同的使用目的，cluster administrator 就必須要準備好不同的 PV 來處理不同 PVC 的需求；若是 PVC 數量不多且需求單純，手動產生 PV 可能還可以接受，但若是 PVC 的數量眾多且需求多變，那可能就需要 [StorageClass] 的協助了!</li>
<li><a target="_blank" rel="noopener" href="https://godleon.github.io/blog/Kubernetes/k8s-PersistentVolume-Overview/">Persistent Volume (Claim) Overview Link (必看)</a></li>
</ul>
<h2 id="Local-Persistent-Volumes"><a href="#Local-Persistent-Volumes" class="headerlink" title="Local Persistent Volumes"></a>Local Persistent Volumes</h2><ul>
<li><strong>local PV 的產生一定要用 yaml 檔產生</strong></li>
<li><strong>且一定要需告在哪一台 node</strong></li>
<li><strong>宣告的目錄區，需要事先準備</strong></li>
<li>the Kubernetes scheduler ensures that a pod using a Local Persistent Volume is always scheduled to the same node.</li>
</ul>
<h3 id="建立-Local-PersistentVolume"><a href="#建立-Local-PersistentVolume" class="headerlink" title="建立 Local PersistentVolume"></a><strong>建立 Local PersistentVolume</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;kind: PersistentVolume</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: pv-local</span><br><span class="line">spec:</span><br><span class="line">  capacity:</span><br><span class="line">    storage: 10Gi</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  local:</span><br><span class="line">    path: &quot;/opt/local&quot;</span><br><span class="line">  nodeAffinity:</span><br><span class="line">    required:</span><br><span class="line">      nodeSelectorTerms:</span><br><span class="line">      - matchExpressions:</span><br><span class="line">        - key: kubernetes.io/hostname</span><br><span class="line">          operator: In</span><br><span class="line">          values:</span><br><span class="line">          - m1 &#x27; &gt; ~/wulin/yaml/pv-local.yaml </span><br></pre></td></tr></table></figure>

<ul>
<li>以上設定的 capacity(儲存空間大小), accessModes(目錄權限) 數據都是參考用的</li>
<li>PV 會產生在 m1 的 node 上，所以以上設定的數據是由 m1 node 上 Linux 系統在管理目錄區的 Quota 做容量控管及權限設定，實際上要求有沒有做到，PV 本身是不會管的</li>
</ul>
<h3 id="產生-PV"><a href="#產生-PV" class="headerlink" title="產生 PV"></a><strong>產生 PV</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f ~/wulin/yaml/pv-local.yaml </span><br><span class="line">persistentvolume/pv-local created</span><br><span class="line"></span><br><span class="line">$ kubectl get pv pv-local</span><br><span class="line">NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class="line">pv-local   10Gi       RWO            Retain           Available                                   102s</span><br></pre></td></tr></table></figure>

<h3 id="建立-Local-PersistentVolumeClaim"><a href="#建立-Local-PersistentVolumeClaim" class="headerlink" title="建立 Local PersistentVolumeClaim"></a>建立 Local PersistentVolumeClaim</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;kind: PersistentVolumeClaim</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: pvc-local</span><br><span class="line">spec:</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  storageClassName: &quot;&quot;  </span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 3Gi &#x27; &gt; ~/wulin/yaml/pvc-local.yaml</span><br></pre></td></tr></table></figure>

<ul>
<li>注意! 在 yaml 檔中的宣告，並未指定要用哪個 PV</li>
<li>PVC 會去尋找滿足 <code>accessModes</code> 和 <code>resources.requests.storage</code> 的 PV 來 Bound 建立連接</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f ~/wulin/yaml/pvc-local.yaml</span><br></pre></td></tr></table></figure>

<p>檢查 pv 與 pvc 狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kg pv</span><br><span class="line">NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM               STORAGECLASS   REASON   AGE</span><br><span class="line">pv-local   10Gi       RWO            Retain           Bound    default/pvc-local                           32m</span><br><span class="line"></span><br><span class="line">$ kg pvc</span><br><span class="line">NAME        STATUS   VOLUME     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">pvc-local   Bound    pv-local   10Gi       RWO                           46s</span><br></pre></td></tr></table></figure>

<h3 id="建立使用-pvc-local-的第一個-Pod"><a href="#建立使用-pvc-local-的第一個-Pod" class="headerlink" title="建立使用 pvc-local 的第一個 Pod"></a>建立使用 pvc-local 的第一個 Pod</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;kind: Pod</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-pvc1</span><br><span class="line">spec:</span><br><span class="line">  volumes:</span><br><span class="line">    - name: pv-storage</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">       claimName: pvc-local</span><br><span class="line">  containers:</span><br><span class="line">    - name: pod-pvc1</span><br><span class="line">      image: quay.io/cloudwalker/nginx</span><br><span class="line">      imagePullPolicy: IfNotPresent</span><br><span class="line">      ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">          name: &quot;http-server&quot;</span><br><span class="line">      volumeMounts:</span><br><span class="line">        - mountPath: &quot;/usr/share/nginx/html&quot;</span><br><span class="line">          name: pv-storage &#x27; &gt; ~/wulin/yaml/pod-pvc1.yaml </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f ~/wulin/yaml/pod-pvc1.yaml </span><br><span class="line"></span><br><span class="line">$ kg po</span><br><span class="line">NAME       READY   STATUS              RESTARTS   AGE</span><br><span class="line">g1         1/1     Running             0          116m</span><br><span class="line">g2         1/1     Running             0          115m</span><br><span class="line">pod-pvc1   0/1     ContainerCreating   0          12m</span><br><span class="line"></span><br><span class="line">$ kubectl describe pod pod-pvc1</span><br><span class="line">...</span><br><span class="line">... path &quot;/opt/local&quot; does not exist</span><br></pre></td></tr></table></figure>

<ul>
<li>因為沒事先在指定主機 (m1) 建立 &#x2F;opt&#x2F;local 目錄</li>
</ul>
<p>解決</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir /opt/local</span><br></pre></td></tr></table></figure>

<p>檢查</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kg po pod-pvc1</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod-pvc1   1/1     Running   0          20m</span><br></pre></td></tr></table></figure>

<h3 id="建立-NGINX-首頁"><a href="#建立-NGINX-首頁" class="headerlink" title="建立 NGINX 首頁"></a>建立 NGINX 首頁</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -it pod-pvc1 -- bash</span><br><span class="line">root@pv-pod:/# echo &quot;&lt;h1&gt;POD-PVC1&lt;/h1&gt;&quot; &gt; /usr/share/nginx/html/index.html</span><br><span class="line">root@pv-pod:/# exit</span><br><span class="line"></span><br><span class="line">$ ls -l /opt/local/</span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 18 Sep  7 15:49 index.html</span><br></pre></td></tr></table></figure>

<p>刪除 pod 與 pvc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod pod-pvc1</span><br><span class="line">pod &quot;pod-pvc1&quot; deleted</span><br><span class="line"></span><br><span class="line">$ kubectl delete pvc pvc-local</span><br><span class="line">persistentvolumeclaim &quot;pvc-local&quot; deleted</span><br><span class="line"></span><br><span class="line">$ kg pvc</span><br><span class="line">No resources found in default namespace.</span><br></pre></td></tr></table></figure>

<p>檢視被刪除 pvc 後的 pv</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kg pv</span><br><span class="line">NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM               STORAGECLASS   REASON   AGE</span><br><span class="line">pv-local   10Gi       RWO            Retain           Released   default/pvc-local                           62m</span><br></pre></td></tr></table></figure>

<ul>
<li>可以看到狀態是 <code>Released</code></li>
</ul>
<p>如果再次建立一樣的 pvc 呢?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f pvc-local.yaml</span><br></pre></td></tr></table></figure>

<p>檢視 pvc 的狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kg pvc</span><br><span class="line">NAME        STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">pvc-local   Pending                                                     7s</span><br></pre></td></tr></table></figure>


<h1 id="Helm"><a href="#Helm" class="headerlink" title="Helm"></a>Helm</h1><ul>
<li>像是 Alpine Linux 的 apk ，可以在 K8S 新增套件</li>
<li>要自行安裝，原生的 K8S 沒有 Helm</li>
</ul>
<h2 id="安裝-Helm-3"><a href="#安裝-Helm-3" class="headerlink" title="安裝 Helm 3"></a>安裝 Helm 3</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash</span><br></pre></td></tr></table></figure>

<ul>
<li><code>get-helm-3</code> ，安裝 Helm 的程式</li>
<li>漿螢幕輸出透過水管直接將安裝 Helm 的程式餵給 貝殼程式</li>
</ul>
<h1 id="NFS-Dynamic-Volume-Provision"><a href="#NFS-Dynamic-Volume-Provision" class="headerlink" title="NFS Dynamic Volume Provision"></a>NFS Dynamic Volume Provision</h1><h2 id="安裝-NFS-套件"><a href="#安裝-NFS-套件" class="headerlink" title="安裝 NFS 套件"></a>安裝 NFS 套件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">K8S Master/Worker 都要安裝</span><br><span class="line">$ sudo apk update; sudo apk add nfs-utils</span><br><span class="line">.........</span><br><span class="line">(6/7) Installing nfs-utils (2.5.4-r1)</span><br><span class="line">(7/7) Installing nfs-utils-openrc (2.5.4-r1)</span><br><span class="line">Executing busybox-1.33.1-r3.trigger</span><br><span class="line">OK: 1603 MiB in 291 packages</span><br><span class="line"></span><br><span class="line">$ ssh w1 sudo apk update; ssh w1 sudo apk add nfs-utils</span><br><span class="line"></span><br><span class="line">$ ssh w2 sudo apk update; ssh w2 sudo apk add nfs-utils</span><br></pre></td></tr></table></figure>

<h2 id="設定-NFS-Server"><a href="#設定-NFS-Server" class="headerlink" title="設定 NFS Server"></a>設定 NFS Server</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rc-update add nfs</span><br><span class="line">* service nfs added to runlevel default</span><br><span class="line"></span><br><span class="line">K8s Master 建立共用資料夾</span><br><span class="line">$ sudo mkdir /opt/nfs; sudo chown -R nobody:nogroup /opt/nfs</span><br><span class="line"></span><br><span class="line">$ echo &quot;/opt/nfs $IP/24(rw,sync,no_subtree_check,no_root_squash)&quot; | sudo tee /etc/exports</span><br></pre></td></tr></table></figure>

<h2 id="啟動-NFS-Server"><a href="#啟動-NFS-Server" class="headerlink" title="啟動 NFS Server"></a>啟動 NFS Server</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rc-service rpcbind start</span><br><span class="line">$ sudo rc-service nfs start</span><br><span class="line">* Stopping NFS mountd ... [ ok ]</span><br><span class="line">* Stopping NFS daemon ... [ ok ]</span><br><span class="line">* Unexporting NFS directories ... [ ok ]</span><br><span class="line">* Exporting NFS directories ... [ ok ]</span><br><span class="line">* Starting NFS mountd ... [ ok ]</span><br><span class="line">* Starting NFS daemon ... [ ok ]</span><br><span class="line">* Starting NFS smnotify ... [ ok ]</span><br></pre></td></tr></table></figure>

<h2 id="測試-NFS"><a href="#測試-NFS" class="headerlink" title="測試 NFS"></a>測試 NFS</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># K8S Worker 測試掛載 nfs</span><br><span class="line"># 將 m1 主機的 /opt/nfs 目錄掛載到 w1 主機的 /mnt 目錄</span><br><span class="line">$ ssh w1 &quot;sudo mount -t nfs $IP:/opt/nfs /mnt&quot;</span><br><span class="line"></span><br><span class="line"># 在 /mnt 上建立一個空檔案</span><br><span class="line">$ ssh w1 &quot;sudo touch /mnt/mynfs&quot;</span><br><span class="line"></span><br><span class="line"># 卸載 nfs</span><br><span class="line">$ ssh w1 &quot;sudo umount /mnt&quot;</span><br><span class="line"></span><br><span class="line"># K8S Master 檢查</span><br><span class="line">$ ls -al /opt/nfs</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 2 nobody nogroup 4096 Oct 30 19:22 .</span><br><span class="line">drwxr-xr-x 4 root   root    4096 Oct 30 19:20 ..</span><br><span class="line">-rw-r--r-- 1 root   root       0 Oct 30 19:22 mynfs</span><br></pre></td></tr></table></figure>

<h2 id="安裝與建立-NFS-Provisioner"><a href="#安裝與建立-NFS-Provisioner" class="headerlink" title="安裝與建立 NFS Provisioner"></a>安裝與建立 NFS Provisioner</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 新增套件清單網址</span><br><span class="line">$ helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/</span><br><span class="line"></span><br><span class="line"># 更新儲存庫</span><br><span class="line">$ helm repo update</span><br><span class="line"></span><br><span class="line"># 搜尋剛剛的套件網址版本代號多少</span><br><span class="line">$ helm search repo nfs-subdir-external-provisioner</span><br><span class="line">NAME                                                    CHART VERSION   APP VERSION     DESCRIPTION            </span><br><span class="line">nfs-subdir-external-provisioner/nfs-subdir-exte...      4.0.17          4.0.2           nfs-subdir-external-provisioner is an automatic...</span><br><span class="line"></span><br><span class="line"># 安裝套件</span><br><span class="line">$ helm install nfs-subdir-external-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \</span><br><span class="line">--set storageClass.defaultClass=true \</span><br><span class="line">--set storageClass.name=mynfs \</span><br><span class="line">--set nfs.server=$IP \</span><br><span class="line">--set nfs.path=/opt/nfs</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="檢視-NFS-Provisioner"><a href="#檢視-NFS-Provisioner" class="headerlink" title="檢視 NFS Provisioner"></a>檢視 NFS Provisioner</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get storageclass</span><br><span class="line">NAME              PROVISIONER                                     RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span><br><span class="line">mynfs (default)   cluster.local/nfs-subdir-external-provisioner   Delete          Immediate           true                   17s</span><br><span class="line"></span><br><span class="line">$ kg all</span><br><span class="line">NAME                                                   READY   STATUS              RESTARTS   AGE</span><br><span class="line">pod/nfs-subdir-external-provisioner-7dc5ccf74b-lkrkj   0/1     ContainerCreating   0          22s</span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/kubernetes   ClusterIP   10.98.0.1    &lt;none&gt;        443/TCP   7d23h</span><br><span class="line"></span><br><span class="line">NAME                                              READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/nfs-subdir-external-provisioner   0/1     1            0           22s</span><br><span class="line"></span><br><span class="line">NAME                                                         DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/nfs-subdir-external-provisioner-7dc5ccf74b   1         1         0       22s</span><br></pre></td></tr></table></figure>

<h2 id="建立-PVC-測試-NFS-Client-Provisioner"><a href="#建立-PVC-測試-NFS-Client-Provisioner" class="headerlink" title="建立 PVC 測試 NFS Client Provisioner"></a>建立 PVC 測試 NFS Client Provisioner</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> $<span class="string">&#x27;kind: PersistentVolumeClaim</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: test-claim</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  accessModes: [&quot;ReadWriteOnce&quot;]</span></span><br><span class="line"><span class="string">  storageClassName: mynfs</span></span><br><span class="line"><span class="string">  resources:</span></span><br><span class="line"><span class="string">    requests:</span></span><br><span class="line"><span class="string">      storage: 1Mi &#x27;</span> &gt; pvc-nfscp.yaml </span><br></pre></td></tr></table></figure>

<ul>
<li><code>spec.resources.requests.storage</code>，設定的 <code>1Mi</code> 是參考值，真正在限制的人是底層的 NFS ，它如果沒能力，就不會真的被限制</li>
<li><code>spec.accessModes</code>，<code>ReadWriteOnce</code> 設定的是在本機才能被掛載，與 NFS 的概念完全背離，所以應該改為 <code>ReadWriteMany</code>，但其實這邊也是參考的，因為底層在運作是 NFS ，最後一樣能被其他主機來掛載</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f pvc-nfscp.yaml</span><br><span class="line">persistentvolumeclaim/test-claim created</span><br><span class="line"></span><br><span class="line">$ kg pv</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   REASON   AGE</span><br><span class="line">pvc-de200a3e-203b-4feb-ab8a-95f0be90cd3c   1Mi        RWO            Delete           Bound    default/test-claim   mynfs                   3s</span><br><span class="line"></span><br><span class="line">$ kg pvc</span><br><span class="line">NAME         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">test-claim   Bound    pvc-de200a3e-203b-4feb-ab8a-95f0be90cd3c   1Mi        RWO            mynfs          4s</span><br></pre></td></tr></table></figure>

<h2 id="建立-Job-測試-NFS-Client-Provisioner"><a href="#建立-Job-測試-NFS-Client-Provisioner" class="headerlink" title="建立 Job 測試 NFS Client Provisioner"></a>建立 Job 測試 NFS Client Provisioner</h2><p>編輯 Job YAML 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano nfs-job-test.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-job-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nfs-job-test</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">     <span class="attr">containers:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-job-test</span></span><br><span class="line">       <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/busybox</span></span><br><span class="line">       <span class="attr">command:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">&quot;/bin/sh&quot;</span></span><br><span class="line">       <span class="attr">args:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">&quot;-c&quot;</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">&quot;touch /opt/SUCCESS &amp;&amp; exit 0 || exit 1&quot;</span></span><br><span class="line">       <span class="attr">volumeMounts:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pvc</span></span><br><span class="line">           <span class="attr">mountPath:</span> <span class="string">&quot;/opt&quot;</span></span><br><span class="line">     <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br><span class="line">     <span class="attr">volumes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-pvc</span></span><br><span class="line">         <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">           <span class="attr">claimName:</span> <span class="string">test-claim</span></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ka -f nfs-job-test.yaml</span><br><span class="line"></span><br><span class="line">$ kg job</span><br><span class="line">NAME           COMPLETIONS   DURATION   AGE</span><br><span class="line">nfs-job-test   1/1           4s         10m</span><br><span class="line"></span><br><span class="line">$ dir /opt/nfs</span><br><span class="line">..........</span><br><span class="line">drwxrwxrwx 2 root   root    4.0K Oct 29 12:43 default-test-claim-pvc-788e2513-9de6-41d5-bb2d-f57e1fa5ce7c</span><br><span class="line"></span><br><span class="line">$ kubectl delete job nfs-job-test; kubectl delete pvc test-claim</span><br><span class="line"></span><br><span class="line">$ dir /opt/nfs</span><br><span class="line">total 12K</span><br><span class="line">drwxr-xr-x 3 nobody nogroup 4.0K Oct 29 13:05 .</span><br><span class="line">drwxr-xr-x 4 root   root    4.0K Oct 29 11:59 ..</span><br><span class="line">drwxrwxrwx 2 root   root    4.0K Oct 29 12:43 archived-default-test-claim-pvc-788e2513-9de6-41d5-bb2d-f57e1fa5ce7c</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E7%B3%BB%E7%B5%B1%E5%B7%A5%E7%A8%8B/" rel="tag"># 系統工程</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/Kubernetes%20Init%20with%20Config.yaml.html" rel="prev" title="Kubernetes Init with Config.yaml">
                  <i class="fa fa-chevron-left"></i> Kubernetes Init with Config.yaml
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/Kubernetes-Resource-CPU-Memory.html" rel="next" title="Kubernetes-Resource-CPU-Memory">
                  Kubernetes-Resource-CPU-Memory <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Antony Cehn</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
