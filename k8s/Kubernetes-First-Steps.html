<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css" integrity="sha256-/4UQcSmErDzPCMAiuOiWPVVsNN2s3ZY/NsmXNcj0IFc=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.15.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Kubernetes-First-Steps:::warning :::spoiler 目錄 [TOC]  ::: 建立 K8S 應用物件方式 kubectl run (命令式 Imperative) - Manage K8s object (POD, Controller, Service) using CLI 透過以上命令式建立 pod 能做到的功能是有限的。 e.g., 像要讓 pod 到指">
<meta property="og:type" content="article">
<meta property="og:title" content="Antony 的學習筆記">
<meta property="og:url" content="http://example.com/Kubernetes-First-Steps.html">
<meta property="og:site_name" content="Antony 的學習筆記">
<meta property="og:description" content="Kubernetes-First-Steps:::warning :::spoiler 目錄 [TOC]  ::: 建立 K8S 應用物件方式 kubectl run (命令式 Imperative) - Manage K8s object (POD, Controller, Service) using CLI 透過以上命令式建立 pod 能做到的功能是有限的。 e.g., 像要讓 pod 到指">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.imgur.com/tixjWdt.png">
<meta property="og:image" content="https://i.imgur.com/7fFcPeY.png">
<meta property="og:image" content="https://i.imgur.com/5G9pk3U.png">
<meta property="og:image" content="https://i.imgur.com/YpO3DbL.png">
<meta property="article:published_time" content="2022-09-03T19:30:10.000Z">
<meta property="article:modified_time" content="2023-05-07T08:15:42.280Z">
<meta property="article:author" content="Antony Cehn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/tixjWdt.png">


<link rel="canonical" href="http://example.com/Kubernetes-First-Steps.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/Kubernetes-First-Steps.html","path":"Kubernetes-First-Steps.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title> | Antony 的學習筆記</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Antony 的學習筆記</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">這個網站將紀錄持續記錄我學習到各種知識的筆記</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Kubernetes-First-Steps"><span class="nav-number">1.</span> <span class="nav-text">Kubernetes-First-Steps</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-K8S-%E6%87%89%E7%94%A8%E7%89%A9%E4%BB%B6%E6%96%B9%E5%BC%8F"><span class="nav-number">1.1.</span> <span class="nav-text">建立 K8S 應用物件方式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Using-Namespace"><span class="nav-number">2.</span> <span class="nav-text">Using Namespace</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#K8S-default-Namespace"><span class="nav-number">2.1.</span> <span class="nav-text">K8S default Namespace</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Assigning-Pods-to-Namespace"><span class="nav-number">2.2.</span> <span class="nav-text">Assigning Pods to Namespace</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%87%E6%8F%9B-Namespace"><span class="nav-number">2.2.1.</span> <span class="nav-text">切換 Namespace</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#OpenSSH-%E5%AF%A6%E5%8B%99%E6%87%89%E7%94%A8"><span class="nav-number">3.</span> <span class="nav-text">OpenSSH 實務應用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Container-Image-%E8%A8%AD%E8%A8%88%E8%88%87%E5%BB%BA%E7%AB%8B"><span class="nav-number">3.1.</span> <span class="nav-text">Container Image 設計與建立</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%8E%A5%E8%A7%B8-Kubernetes-App"><span class="nav-number">4.</span> <span class="nav-text">第一次接觸 Kubernetes App</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-Demo-App"><span class="nav-number">4.1.</span> <span class="nav-text">建立 Demo App</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-OpenSSH-Pod"><span class="nav-number">4.2.</span> <span class="nav-text">建立 OpenSSH Pod</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Access-Kubernetes-Pods-from-outside"><span class="nav-number">4.3.</span> <span class="nav-text">Access Kubernetes Pods from outside</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%93-mydb-pod-%E4%B9%9F%E7%94%A8-hostport-%E9%96%8B"><span class="nav-number">4.4.</span> <span class="nav-text">讓 mydb pod 也用 hostport 開</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AA%A2%E8%A6%96-Linux-capabilities"><span class="nav-number">4.5.</span> <span class="nav-text">檢視 Linux capabilities</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CRI-O-%E8%A6%8F%E7%AF%84-Linux-capabilities-%E7%9A%84%E6%AA%94%E6%A1%88"><span class="nav-number">4.5.1.</span> <span class="nav-text">CRI-O 規範 Linux capabilities 的檔案</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%A3%E6%8E%A5%E8%88%87%E7%A7%BB%E9%99%A4-Demo-App"><span class="nav-number">4.6.</span> <span class="nav-text">連接與移除 Demo App</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AC%A1%E6%8E%A5%E8%A7%B8-YAML-File"><span class="nav-number">5.</span> <span class="nav-text">第一次接觸 YAML File</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-OpenSSH-Pod-1"><span class="nav-number">5.1.</span> <span class="nav-text">建立 OpenSSH Pod</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%86%8D%E6%AC%A1%E4%BF%AE%E6%94%B9-yaml-%E6%AA%94"><span class="nav-number">5.2.</span> <span class="nav-text">再次修改 yaml 檔</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-File-Browser-Server"><span class="nav-number">6.</span> <span class="nav-text">建立 File Browser Server</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B-File-Browser-Server-Service"><span class="nav-number">6.0.1.</span> <span class="nav-text">建立 File Browser Server Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FBS-%E6%9E%B6%E6%A7%8B%E7%A4%BA%E6%84%8F%E5%9C%96"><span class="nav-number">6.0.2.</span> <span class="nav-text">FBS 架構示意圖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8F%90%E5%95%8F-%E5%A6%82%E4%BD%95%E5%BE%97%E7%9F%A5%E6%AA%94%E6%A1%88%E4%B8%9F%E5%88%B0%E7%B6%B2%E7%AB%99%E5%BE%8C%EF%BC%8C%E5%AD%98%E6%94%BE%E5%9C%A8%E5%93%AA"><span class="nav-number">6.0.3.</span> <span class="nav-text">提問 : 如何得知檔案丟到網站後，存放在哪?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%81%BD%E9%9B%A3%E7%AF%87"><span class="nav-number">6.0.4.</span> <span class="nav-text">災難篇</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8D-pod-%E7%9A%84-yaml-%E6%AA%94%E6%96%B0%E5%A2%9E-hostPath-PV"><span class="nav-number">6.1.</span> <span class="nav-text">對 pod 的 yaml 檔新增 hostPath PV</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#tags-%E7%B3%BB%E7%B5%B1%E5%B7%A5%E7%A8%8B"><span class="nav-number">6.1.0.0.0.1.</span> <span class="nav-text">tags: 系統工程</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Antony Cehn</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">11</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/Kubernetes-First-Steps.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Antony Cehn">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Antony 的學習筆記">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Antony 的學習筆記">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-09-04 03:30:10" itemprop="dateCreated datePublished" datetime="2022-09-04T03:30:10+08:00">2022-09-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-05-07 16:15:42" itemprop="dateModified" datetime="2023-05-07T16:15:42+08:00">2023-05-07</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Kubernetes-First-Steps"><a href="#Kubernetes-First-Steps" class="headerlink" title="Kubernetes-First-Steps"></a>Kubernetes-First-Steps</h1><p>:::warning</p>
<p>:::spoiler 目錄</p>
<p>[TOC]</p>
<hr>
<p>:::</p>
<h2 id="建立-K8S-應用物件方式"><a href="#建立-K8S-應用物件方式" class="headerlink" title="建立 K8S 應用物件方式"></a>建立 K8S 應用物件方式</h2><ul>
<li><code>kubectl run</code> (命令式 Imperative) - Manage K8s object (POD, Controller, Service) using CLI<ul>
<li>透過以上命令式建立 pod 能做到的功能是有限的。</li>
<li>e.g., 像要讓 pod 到指定 node 去 run 是做不到的; K8S 還有很多物件是無法用 <code>kubeclt run</code> 的方法產生</li>
<li><code>kubectl run</code> (Imperative) 這命令適合做概念性(物件的雛形)驗證 (Proof of Concept；POC)</li>
<li>結論 : <code>kubeclt run</code> 的方法 對於 K8S 能產生和設定多少物件是有限的</li>
</ul>
</li>
<li><code>kubectl create/apply</code> (聲明式 Declarative) - By defining K8s objects in yaml file<ul>
<li>K8S 產生物件的正規做法，但有個必要條件，須先設計 yaml 檔，才能產生對應的物件</li>
<li><code>kubectl create</code> (Declarative) 與 yaml 設定檔適合建立複雜的企業應用服務</li>
</ul>
</li>
<li>“Imperative” is a command - like “create 42 widgets”.</li>
<li>“Declarative” is a statement of the desired end result - like “I want 42 widgets to exist”.</li>
<li>For creating multiple complex object, declarative approach is preferred as it follows Infrastructure as a Code approach. However, imperative approach is also useful when we want to do quick POC and save yourself from writing yaml files. Let’s take a look at some imperative commands.</li>
</ul>
<h1 id="Using-Namespace"><a href="#Using-Namespace" class="headerlink" title="Using Namespace"></a>Using Namespace</h1><ul>
<li>在 K8S 裡的 Namespace ，可以想像成大樓裡的辦公室，裡面可以有很多人 (Container)，辦公室中還可以有很多桌子、椅子和影印機…等物件(pod, deployment, Service…等)</li>
<li><strong>Partition Cluster resources</strong>.</li>
<li>Kubernetes Namespaces can be used to divide a cluster into logical partitions allowing a single large Kubernetes cluster to be used by multiple users and teams, or a single user with multiple applications. Each user, team, or application running in a Namespace, is isolated from every other user, team, or application in other Namespaces and they operate as if they are the sole user of the cluster (note that Namespaces do not provide network segmentation).</li>
<li>Namespaces 有以下幾個特點<ul>
<li>在同一個 Kubernetes Cluster 中，每個 Namespaces 的名稱都是要獨特的</li>
<li>當一個 Namespaces 被刪除時，在該 Namespace 裡的所有物件也會被刪除<ul>
<li>注意!只會刪除 K8S 產生的物件，如果 K8S 的物件有產生檔案或目錄是不會被刪除的。</li>
</ul>
</li>
<li>可以透過 Resource Quotas 限制一個 Namespaces 所可以存取的資源<ul>
<li>不只限制可用的運算資源，還能限制 K8S 的物件</li>
<li>有防火牆的機制，可以允許或禁止 pod 連到另一個 Namespace 的 pod ，或是讓一個 pod 可以上網</li>
</ul>
</li>
</ul>
</li>
<li>結論 : K8S 的物件一定要指定一個 Namespace 給它 run。開發應用系統必定會建立專案目錄, 設計 K8S Application 需在 Namespace, 來運作</li>
</ul>
<p><strong>檢視 K8S 當前所有 Namespace 的資訊</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get ns</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   10d</span><br><span class="line">kube-flannel      Active   10d</span><br><span class="line">kube-node-lease   Active   10d</span><br><span class="line">kube-public       Active   10d</span><br><span class="line">kube-system       Active   10d</span><br></pre></td></tr></table></figure>

<ul>
<li><code>default</code>，預設的 Namespaces 名稱為 default，過去我們產生的物件像是， Deployment， Services 等若沒特別指定 Namespace 都是存放在名稱為 default 的 namespaces 中。</li>
<li><code>kube-public</code>，是個特殊的 namespace，存放在裡面的物件可被所有的使用者讀取。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-6d4b75cb6d-tslq8     1/1     Running   5          10d</span><br><span class="line">coredns-6d4b75cb6d-vqz9h     1/1     Running   5          10d</span><br><span class="line">etcd-m1                      1/1     Running   5          10d</span><br><span class="line">kube-apiserver-m1            1/1     Running   5          10d</span><br><span class="line">kube-controller-manager-m1   1/1     Running   5          10d</span><br><span class="line">kube-proxy-274g9             1/1     Running   4          10d</span><br><span class="line">kube-proxy-kqlrm             1/1     Running   4          10d</span><br><span class="line">kube-proxy-zw6sb             1/1     Running   5          10d</span><br><span class="line">kube-scheduler-m1            1/1     Running   5          10d</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kube-system</code>，在 Kubernetes 中，較特別的資源都會存放在 kube-system 這個 namespace。若是用 <code>kubectl get all -n kube-system</code> 查看，可以發現 kube-dns 或是 kube-apiserver…等維運系統的 pod 都是存放在該 namepsace 中。</li>
<li>Namespace 參考文章連結 : <a target="_blank" rel="noopener" href="https://ithelp.ithome.com.tw/m/articles/10197186">https://ithelp.ithome.com.tw/m/articles/10197186</a></li>
</ul>
<h2 id="K8S-default-Namespace"><a href="#K8S-default-Namespace" class="headerlink" title="K8S default Namespace"></a>K8S default Namespace</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create deployment --image quay.io/cloudwalker/nginx demo-nginx</span><br><span class="line">deployment.apps/demo-nginx created</span><br><span class="line"></span><br><span class="line">$ kubectl describe deployment demo-nginx | grep Namespace</span><br><span class="line">Namespace:              default</span><br><span class="line"></span><br><span class="line">$ kubectl create deployment --image quay.io/cloudwalker/nginx demo-nginx</span><br><span class="line">Error from server (AlreadyExists): deployments.apps &quot;demo-nginx&quot; already exists</span><br><span class="line"></span><br><span class="line">$ kubectl create deployment --image quay.io/cloudwalker/nginx demo-nginx -n kube-public</span><br></pre></td></tr></table></figure>



<h2 id="Assigning-Pods-to-Namespace"><a href="#Assigning-Pods-to-Namespace" class="headerlink" title="Assigning Pods to Namespace"></a>Assigning Pods to Namespace</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 建立工作目錄</span><br><span class="line">$ mkdir -p ~/wulin/yaml; cd ~/wulin</span><br><span class="line"></span><br><span class="line"># 建立新的 namespace</span><br><span class="line">$ kubectl create namespace myoffice</span><br><span class="line">namespace/myoffice created</span><br><span class="line"></span><br><span class="line"># 檢查有無建立成功</span><br><span class="line">$ kubectl get namespace</span><br><span class="line">NAME              STATUS   AGE</span><br><span class="line">default           Active   10d</span><br><span class="line">kube-flannel      Active   10d</span><br><span class="line">kube-node-lease   Active   10d</span><br><span class="line">kube-public       Active   10d</span><br><span class="line">kube-system       Active   10d</span><br><span class="line">myoffice          Active   2s</span><br><span class="line"></span><br><span class="line"># 刪除 myoffice namespace</span><br><span class="line">$ kubectl delete namespace myoffice</span><br><span class="line"></span><br><span class="line"># 再次建立 myoffice namespace</span><br><span class="line">$ kubeclt create namespace myoffice</span><br><span class="line"></span><br><span class="line"># 檢查</span><br><span class="line">$ kubectl get namespace</span><br></pre></td></tr></table></figure>


<p>建立 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run n1 --image=quay.io/cloudwalker/alpine -n myoffice -- sleep infinity</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kubectl run</code>，用指定 image 產生 pod</li>
<li><code>n1</code>，pod 的名字</li>
<li><code>-n myoffice</code>，指定等等的 pod 會建在 myoffice 這個 namespace</li>
<li><code>-- sleep infinity</code>，<code>--</code>後面放的是 Container 要執行的程式 ，這裡是 <code>sleep infinity</code><ul>
<li>forever sleeping ( never awake until escape )</li>
</ul>
</li>
</ul>
<p>檢視 pod 的狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kg pods</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">gocgi   1/1     Running   1          20h</span><br><span class="line">mydb    1/1     Running   1          21h</span><br><span class="line">pod1    1/1     Running   1          16h</span><br></pre></td></tr></table></figure>

<ul>
<li>這裡看到的是在 default namespace 的 pod 資訊</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kg pods -n myoffice</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE</span><br><span class="line">n1     1/1     Running   0          22m</span><br></pre></td></tr></table></figure>

<ul>
<li>這裡看到的是 myoffice 這個 namespace 裡面 pod 資訊</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -it n1 sh</span><br><span class="line">kubectl exec [POD] [COMMAND] is DEPRECATED and will be removed in a future version. Use kubectl exec [POD] -- [COMMAND] instead.</span><br><span class="line">Error from server (NotFound): pods &quot;n1&quot; not found</span><br></pre></td></tr></table></figure>
<ul>
<li>錯誤訊息翻譯:<ul>
<li><code>kubectl exec [POD] [COMMAND]</code> ，這個用法以被棄用，且即將在未來的版本被刪除</li>
<li>要使用 <code>kubectl exec [POD] -- [COMMAND]</code>，Command 前面要加 <code>--</code></li>
<li><code>Error from server (NotFound): pods &quot;n1&quot; not found</code>，找不到 n1 這台 pod，因未指定 Namespace 的話，預設會到 default 這個 namespace 裡面找有沒有 n1 這個 pod</li>
</ul>
</li>
<li>用法須更正為:<ul>
<li><code>kubectl exec -it n1 -n myoffice -- sh</code></li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -it -n myoffice n1 -- sh</span><br><span class="line">/ # ping -c 1 www.hinet.net</span><br><span class="line">PING www.hinet.net (163.28.83.113): 56 data bytes</span><br><span class="line">ping: permission denied (are you root?)</span><br><span class="line"></span><br><span class="line"># 檢視 NameServer 是誰</span><br><span class="line">/ # cat /etc/resolv.conf</span><br><span class="line">search myoffice.svc.k8s.org svc.k8s.org k8s.org localdomain</span><br><span class="line">nameserver 10.98.0.10</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line">/ # exit</span><br></pre></td></tr></table></figure>

<ul>
<li><code>nameserver 10.98.0.10</code>，這是 K8S 的 DNS Server</li>
<li>它會幫我們把 <code>www.hinet.net</code> 這個名稱丟到網路去問，最後解析出 <code>163.28.83.113</code> 這個 IP 位址</li>
<li><code>ping: permission denied (are you root?)</code>，權限不足，Linux Capaibility 不給權限</li>
</ul>
<p>用 yaml 檔建立 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano ~/wulin/yaml/pod-n2.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">n2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">myoffice</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">n2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">n2</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/busybox</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">&quot;60&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">n2</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>kind</code> ，指定要建立 pod 這個物件</li>
<li><code>metadata</code>，設定重要資訊<ul>
<li><code>name: n2</code>，pod 名字 : n2</li>
<li><code>namespace</code>，設定 pod 所在的 namespace : myoffice</li>
<li><code>labels</code>，pod 上貼一個標籤</li>
</ul>
</li>
<li><code>spec</code>，設定 pod 內部的結構<ul>
<li><code>hostname: n2</code>，設定 Container 的 hostname，多個 Container 也會共用同一個 hostname</li>
<li><code>contaienrs</code>，設定 Container 的資訊</li>
<li><code>command</code>，container 要先執行的命令<ul>
<li>yaml 檔中的 <code>command:</code> 這個宣告, 會覆蓋掉 image 的內定命令, 包括 entrypoint 指定的命令</li>
</ul>
</li>
<li><code>name</code>，設定 Container 在系統上的名稱</li>
</ul>
</li>
</ul>
<p>apply 它</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f ~/wulin/yaml/pod-n2.yaml</span><br></pre></td></tr></table></figure>

<p>檢查是否符合預期</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n myoffice</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE</span><br><span class="line">n1     1/1     Running   0          61m</span><br><span class="line">n2     1/1     Running   0          14s</span><br></pre></td></tr></table></figure>

<h3 id="切換-Namespace"><a href="#切換-Namespace" class="headerlink" title="切換 Namespace"></a>切換 Namespace</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config set-context --current --namespace=myoffice</span><br></pre></td></tr></table></figure>

<ul>
<li><code>set-context</code>，進入 K8S 的路口</li>
<li><code>set-context</code> ，入口的意思，進入商業辦公大樓的大門</li>
<li><code>--current</code> ，入口指定預設的入口，因為進入的方法有很多種，我們就走預設的入口</li>
<li><code>--namespace=myoffice</code> ，進到 myoffice 這個 namespace</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME   READY   STATUS    RESTARTS       AGE</span><br><span class="line">n1     1/1     Running   0              25m</span><br><span class="line">n2     1/1     Running   5 (105s ago)   8m32s</span><br><span class="line"></span><br><span class="line">$ cat ~/.kube/config | grep -A 6 contexts:</span><br><span class="line">contexts:</span><br><span class="line">- context:</span><br><span class="line">    cluster: kubernetes</span><br><span class="line">    namespace: myoffice</span><br><span class="line">    user: kubernetes-admin</span><br><span class="line">  name: kubernetes-admin@kubernetes</span><br><span class="line">current-context: kubernetes-admin@kubernetes</span><br></pre></td></tr></table></figure>

<ul>
<li><code>~/.kube/config</code>，進入 K8S 這棟大樓的磁卡 (裡面記錄著使用者在 K8S 的名字和識別代號，及擁有多大的權限可以對 K8S 的物件進行訪問…等資訊)</li>
<li><code>contexts</code>，大樓的入口，後面加 <code>s</code> 是因為可能會有很多入口<ul>
<li><code>context</code>，大樓的入口</li>
<li><code>cluster: kubernetes</code>，大樓的名字 : <code>kubernetes</code></li>
<li><code>namespace: myoffice</code>，大樓裡的辦公室名字: <code>myoffice</code></li>
<li><code>user: kubernetes-admin</code>，使用者進入大樓辦公室用的身分名稱</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cat ~/.kube/config | grep users -A1</span><br><span class="line">users:</span><br><span class="line">- name: kubernetes-admin</span><br></pre></td></tr></table></figure>

<ul>
<li>在 K8S 系統中，我們 bigred 的帳號，是 kubernetes-admin (由 <code>~/.kube/config</code> 這個檔案得知)</li>
</ul>
<h1 id="OpenSSH-實務應用"><a href="#OpenSSH-實務應用" class="headerlink" title="OpenSSH 實務應用"></a>OpenSSH 實務應用</h1><h2 id="Container-Image-設計與建立"><a href="#Container-Image-設計與建立" class="headerlink" title="Container Image 設計與建立"></a>Container Image 設計與建立</h2><p>在 m1 終端機, 執行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p ~/wulin/&#123;sshd,fbs&#125;</span><br><span class="line"></span><br><span class="line">$ echo $&#x27;FROM quay.io/cloudwalker/alpine</span><br><span class="line">RUN apk update &amp;&amp; apk upgrade &amp;&amp; apk add --no-cache nano sudo wget curl \</span><br><span class="line">    tree elinks bash shadow procps util-linux git coreutils binutils \</span><br><span class="line">    findutils grep openssh-server tzdata &amp;&amp; \</span><br><span class="line">    # 設定時區</span><br><span class="line">    cp /usr/share/zoneinfo/Asia/Taipei /etc/localtime &amp;&amp; \</span><br><span class="line">    ssh-keygen -t rsa -P &quot;&quot; -f /etc/ssh/ssh_host_rsa_key &amp;&amp; \</span><br><span class="line">    echo -e \&#x27;Welcome to ALP sshd 6000\\n\&#x27; &gt; /etc/motd &amp;&amp; \</span><br><span class="line">    # 建立管理者帳號 bigred</span><br><span class="line">    adduser -s /bin/bash -h /home/bigred -G wheel -D bigred &amp;&amp; \</span><br><span class="line">    echo &quot;%wheel   ALL=(ALL) NOPASSWD: ALL&quot; &gt;&gt; /etc/sudoers &amp;&amp; \</span><br><span class="line">    echo -e \&#x27;bigred\\nbigred\\n\&#x27; | passwd bigred &amp;&gt;/dev/null &amp;&amp; \</span><br><span class="line">    rm /sbin/reboot &amp;&amp; rm /usr/bin/killall</span><br><span class="line"></span><br><span class="line">EXPOSE 22</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [&quot;/usr/sbin/sshd&quot;]</span><br><span class="line">CMD [&quot;-D&quot;]&#x27; &gt; ~/wulin/sshd/Dockerfile</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ENTRYPOINT [&quot;/usr/sbin/sshd&quot;]</code> ，強制宣告等下 run 的 Container 等等只能跑 <code>/usr/sbin/sshd</code> 這個命令</li>
<li><code>CMD [&quot;-D&quot;]</code> ，上面命令的參數</li>
</ul>
<p>Container Image 建立與測試  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman build -t alp.sshd ~/wulin/sshd/</span><br><span class="line"></span><br><span class="line">$ sudo podman images | grep alp.sshd</span><br><span class="line">localhost/alp.sshd   latest  01424a71e3d6  3 minutes ago  67.6 MB</span><br><span class="line"></span><br><span class="line">$ sudo podman run --name a1 -h a1 -d -p 22100:22 alp.sshd</span><br><span class="line">220ce94e636ce9270604bd31a7dd5d515be6008ab6351295cd10a66da5d978d1</span><br><span class="line"></span><br><span class="line">$ ssh bigred@<span class="variable">$IP</span> -p 22100</span><br><span class="line">bigred@192.168.61.4 s password: bigred</span><br><span class="line">Welcome to ALP sshd 6000</span><br><span class="line"></span><br><span class="line">a1:~$ git version</span><br><span class="line">git version 2.30.2</span><br><span class="line"></span><br><span class="line">a1:~$ <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">$ sudo podman <span class="built_in">rm</span> -f a1</span><br></pre></td></tr></table></figure>

<h1 id="第一次接觸-Kubernetes-App"><a href="#第一次接觸-Kubernetes-App" class="headerlink" title="第一次接觸 Kubernetes App"></a>第一次接觸 Kubernetes App</h1><p>建立 K8S 應用物件方式</p>
<ol>
<li><code>kubectl run</code> (命令式 Imperative) - Manage K8s object (POD, Controller, Service) using CLI</li>
<li><code>kubectl create/apply</code> (聲明式 Declarative) - By defining K8s objects in yaml file<ul>
<li>yaml ，全名 : Yet Another Markup Language ( 因為不用再看到 xml 檔了 )</li>
</ul>
</li>
</ol>
<p>For creating multiple complex object, declarative approach is preferred as it follows Infrastructure as a Code approach. However, imperative approach is also useful when we want to do quick POC and save yourself from writing yaml files. Let’s take a look at some imperative commands.</p>
<blockquote>
<p>kubectl run (Imperative) 這命令適合做概念性驗證 (Proof of Concept；POC), kubectl create (Declarative) 與 yaml 設定檔適合建立複雜的企業應用服務</p>
</blockquote>
<h2 id="建立-Demo-App"><a href="#建立-Demo-App" class="headerlink" title="建立 Demo App"></a>建立 Demo App</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># 建立一個 pod ，image 用的是 alp.sshd</span><br><span class="line">$ kubectl run demo --image=alp.sshd</span><br><span class="line"></span><br><span class="line">[註] 從 1.18 這個版本開始, 上面命令只會產生 pod, 不再會產生 deployment object 及 replicaset controller. </span><br><span class="line"></span><br><span class="line"># 為何 pod 會建立失敗 ? ErrImagePull ?</span><br><span class="line">$ kg pods -o wide</span><br><span class="line">NAME    READY   STATUS         RESTARTS   AGE   IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">demo    0/1     ErrImagePull   0          13s   10.244.2.5   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># 因為在我們的工作主機上，沒有這片 image，所以先刪除 pod</span><br><span class="line"># --force ，強制刪除</span><br><span class="line">$ kubectl delete pods demo --force</span><br><span class="line">warning: Immediate deletion does not wait for confirmation that the running resource has been terminated. The resource may continue to run on the cluster indefinitely.</span><br><span class="line">pod &quot;demo&quot; force deleted</span><br><span class="line"></span><br><span class="line"># 打包 alp.sshd 這個 image</span><br><span class="line">$ sudo podman save alp.sshd &gt; alp.sshd.tar</span><br><span class="line"></span><br><span class="line"># 將打包檔拷貝到 w1 和 w2 主機</span><br><span class="line">$ scp alp.sshd.tar w1:alp.sshd.tar; scp alp.sshd.tar w2:alp.sshd.tar</span><br><span class="line"></span><br><span class="line"># 在 w1 和 w2 主機，將打包檔的 image 還原</span><br><span class="line">$ ssh w1 &#x27;sudo podman load &lt; alp.sshd.tar&#x27;</span><br><span class="line">$ ssh w2 &#x27;sudo podman load &lt; alp.sshd.tar&#x27;</span><br><span class="line"></span><br><span class="line"># 再 run 一次 pod</span><br><span class="line"># --image-pull-policy IfNotPresent ，如果本地端有 image 就不用上網下載了</span><br><span class="line">$ kubectl run demo --image-pull-policy IfNotPresent --image=localhost/alp.sshd</span><br><span class="line">pod/demo created</span><br><span class="line"></span><br><span class="line"># 以下命令會失敗的原因是因為， image 前面不加 localhost ，就會上網飆到 docker.io/library 抓 image</span><br><span class="line">$ kubectl run demo --image=alp.sshd</span><br><span class="line"></span><br><span class="line"># 其實不加 --image-pull-policy IfNotPresent 也會過</span><br><span class="line">$ kubectl run demo --image=localhost/alp.sshd</span><br><span class="line"></span><br><span class="line"># 檢查是否符合預期</span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE     IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">demo   1/1     Running   0    3m12s   10.244.2.2   w2     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h2 id="建立-OpenSSH-Pod"><a href="#建立-OpenSSH-Pod" class="headerlink" title="建立 OpenSSH Pod"></a>建立 OpenSSH Pod</h2><p>編輯 sshd yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano ~/wulin/sshd/pod-sshd.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-sshd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mysshd</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">localhost/alp.sshd</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/bin/bash</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line"><span class="string">        adduser -s /bin/bash -h /home/rbean rbean</span></span><br><span class="line"><span class="string">        echo -e &#x27;rbean\nrbean\n&#x27; | passwd rbean</span></span><br><span class="line"><span class="string">        /usr/sbin/sshd -D</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在 K8S yaml 檔的 <code>command</code> 能破格 Dockerfile 設定的 <code>ENTRYPOINT</code>，讓 Container 跑 <code>command</code> 宣告的命令</li>
<li>但是 Container run 的程式還是要在前景執行</li>
<li>所以 <code>command</code> 最後還是要宣告 <code>/usr/sbin/sshd -D</code>，讓 Container 有個 <code>SSH Server</code> 一直在前景執行的命令</li>
<li><code>/bin/bash -c</code>，<code>c</code> 的意思是 command，合起來就是讓 bash 貝殼程式跑下面的命令</li>
<li><code>|</code>，這裡的 pipe 意思是會保留以下宣告命令的格式，有空格就空格，有換行就換行，通通保留，如果沒有宣告，貝殼程式會把下面 3 行命令當成一行</li>
</ul>
<p>用 apply 產生 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f ~/wulin/sshd/pod-sshd.yaml</span><br></pre></td></tr></table></figure>

<p>檢查 pod 狀態</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kg po pod-sshd -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-sshd   1/1     Running   0          2m    10.244.1.37   w1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>SSH 連線測試 pod 功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ssh rbean@10.244.1.37</span><br><span class="line">rbean@10.244.1.37s password:</span><br><span class="line">Welcome to ALP sshd 6000</span><br><span class="line"></span><br><span class="line"># 建立 zzz 目錄</span><br><span class="line">pod-sshd:~$ mkdir zzz</span><br><span class="line">pod-sshd:~$ ls -ld zzz</span><br><span class="line">drwxr-sr-x 2 rbean rbean 4096 Sep  1 09:49 zzz</span><br><span class="line">pod-sshd:~$ exit</span><br><span class="line">logout</span><br><span class="line">Connection to 10.244.1.37 closed.</span><br></pre></td></tr></table></figure>

<p>刪除 pod </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod pod-sshd</span><br><span class="line">pod &quot;pod-sshd&quot; deleted</span><br></pre></td></tr></table></figure>

<p>再次建立 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f ~/wulin/sshd/pod-sshd.yaml</span><br><span class="line">pod/pod-sshd created</span><br></pre></td></tr></table></figure>

<p>連進 pod 檢視 zzz 目錄是否還在 ?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod pod-sshd -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-sshd   1/1     Running   0          73s   10.244.1.38   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># 用 rbean 帳號連進 pod</span><br><span class="line">$ ssh rbean@10.244.1.38</span><br><span class="line">Warning: Permanently added &#x27;10.244.1.38&#x27; (RSA) to the list of known hosts.</span><br><span class="line">rbean@10.244.1.38s password:</span><br><span class="line">Welcome to ALP sshd 6000</span><br><span class="line"></span><br><span class="line"># 檢視剛剛建立的目錄</span><br><span class="line">pod-sshd:~$ ls -l</span><br><span class="line">total 0</span><br></pre></td></tr></table></figure>

<ul>
<li>結論 : pod 只要沒有動用 volume ，當 pod 被刪除時，資料通通消失</li>
</ul>
<p>將 pod 所在的 w1 這台機器重開機</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ssh w1 &#x27;sudo reboot&#x27;</span><br></pre></td></tr></table></figure>

<p>再次檢視 pod 狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods pod-sshd -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-sshd   1/1     Running   1          20m   10.244.1.39   w1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>發現 pod 重新建立，Pod_IP 變了，資料也沒啦 !</li>
<li><strong>在 K8S 的系統中，只要 node 主機重開，它上面 run 的 pod 都會浴火重生(重建)，pod 沒有 volume 的話，資料通通再見 !</strong></li>
</ul>
<h2 id="Access-Kubernetes-Pods-from-outside"><a href="#Access-Kubernetes-Pods-from-outside" class="headerlink" title="Access Kubernetes Pods from outside"></a>Access Kubernetes Pods from outside</h2><p>編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano ~/wulin/yaml/podhostport.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">podhostport</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">wk01</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/alpine.sshd</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">22</span></span><br><span class="line">       <span class="attr">hostPort:</span> <span class="number">22101</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">add:</span> [<span class="string">&quot;AUDIT_WRITE&quot;</span>, <span class="string">&quot;SYS_CHROOT&quot;</span>, <span class="string">&quot;CAP_NET_RAW&quot;</span>]</span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/usr/sbin/sshd&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;-D&quot;</span>]</span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">kubernetes.io/hostname:</span> <span class="string">w1</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>image:</code> ，Container 的 image 可以換裝成 <code>localhost/alp.sshd</code></li>
<li><code>hostport: 22101</code>，<code>kube-proxy</code> 會在 pod 所在主機開一個 22101 的 port，對應到 pod 裡 Container 開的 22 port，效能優於 <code>kubectl port-forward</code> </li>
<li>:::spoiler hostport 示意圖<br><img src="https://i.imgur.com/tixjWdt.png"><br>:::</li>
<li><code>nodeselector</code>，透過 node 上的 labels 來決定 pod 要建在哪台 node 上</li>
</ul>
<h2 id="讓-mydb-pod-也用-hostport-開"><a href="#讓-mydb-pod-也用-hostport-開" class="headerlink" title="讓 mydb pod 也用 hostport 開"></a>讓 mydb pod 也用 hostport 開</h2><p>先建立工作目錄</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p ~/wulin/mydb/</span><br></pre></td></tr></table></figure>

<p>編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano wulin/mydb/pod-mydb.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">mydb</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mydb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">localhost/mydb</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mydb</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3306</span></span><br><span class="line">      <span class="attr">hostPort:</span> <span class="number">3306</span></span><br><span class="line">    <span class="attr">resources:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirst</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">status:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>產生 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ka -f wulin/mydb/pod-mydb.yaml</span><br><span class="line">pod/mydb created</span><br></pre></td></tr></table></figure>

<h2 id="檢視-Linux-capabilities"><a href="#檢視-Linux-capabilities" class="headerlink" title="檢視 Linux capabilities"></a>檢視 Linux capabilities</h2><ul>
<li><strong>Linux capabilities ，規範 Container 可以做什麼事，而規範 Container 等同於規範 pod</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ crio-status config</span><br><span class="line"></span><br><span class="line">output : </span><br><span class="line">...</span><br><span class="line">default_capabilities = [&quot;CHOWN&quot;, &quot;DAC_OVERRIDE&quot;, &quot;FSETID&quot;, &quot;FOWNER&quot;, &quot;SETGID&quot;, &quot;SETUID&quot;, &quot;SETPCAP&quot;, &quot;NET_BIND_SERVICE&quot;, &quot;AUDIT_WRITE&quot;, &quot;SYS_CHROOT&quot;, &quot;KILL&quot;]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li><code>NET_BIND_SERVICE</code> ，如果 Container 要開的 port number 小於 1024 ，會需要有這個 Capabilities</li>
<li><code>SSH</code> 通訊協定一定會需要 “<code>AUDIT_WRITE</code>“, “<code>SYS_CHROOT</code>“ 這兩個 Capabilities，才能讓 CRI-O 做出來的 Container run openssh 的時候，能夠讓 openssh Server 與外部連接，給別人從外面連進來，如果沒有以上兩個 Capabilities ，即使要用 root 去登入也沒用。設定後要記得重新開機。</li>
</ul>
<h3 id="CRI-O-規範-Linux-capabilities-的檔案"><a href="#CRI-O-規範-Linux-capabilities-的檔案" class="headerlink" title="CRI-O 規範 Linux capabilities 的檔案"></a>CRI-O 規範 Linux capabilities 的檔案</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nano /etc/crio/crio.conf</span><br><span class="line"></span><br><span class="line">output : </span><br><span class="line"></span><br><span class="line">[crio.runtime]</span><br><span class="line">.......</span><br><span class="line">default_capabilities = [</span><br><span class="line">  &quot;CHOWN&quot;,</span><br><span class="line">  &quot;DAC_OVERRIDE&quot;,</span><br><span class="line">  &quot;FSETID&quot;,</span><br><span class="line">  &quot;FOWNER&quot;,</span><br><span class="line">  &quot;SETGID&quot;,</span><br><span class="line">  &quot;SETUID&quot;,</span><br><span class="line">  &quot;SETPCAP&quot;,</span><br><span class="line">  &quot;NET_BIND_SERVICE&quot;,</span><br><span class="line">  &quot;AUDIT_WRITE&quot;,</span><br><span class="line">  &quot;SYS_CHROOT&quot;,</span><br><span class="line">  &quot;KILL&quot;</span><br><span class="line">]</span><br><span class="line">.......</span><br></pre></td></tr></table></figure>

<p>++讓 demo 這個 pod 安裝 libcap 套件++</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> demo -- sudo apk add libcap</span><br></pre></td></tr></table></figure>

<ul>
<li><code>--</code>，兩個 <code>-</code> 後面接的命令就是要給 pod 執行</li>
</ul>
<blockquote>
<p>如果這行安裝失敗，可以進入 pod 的 Container 將 nameserver 的設定檔 ( <code>/etc/resolv.conf</code> )，新增一行 <code>nameserver 8.8.8.8</code></p>
</blockquote>
<p>++查看 demo 這個 pod 裡面的 Container 裡面有哪些 Linux capabilities++</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec demo -- sudo capsh --print</span><br><span class="line"></span><br><span class="line">output :</span><br><span class="line"></span><br><span class="line">Current: cap_chown,cap_dac_override,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_net_bind_service,cap_sys_chroot,cap_audit_write=ep</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="連接與移除-Demo-App"><a href="#連接與移除-Demo-App" class="headerlink" title="連接與移除 Demo App"></a>連接與移除 Demo App</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># K8S 叢集內連接 demo app，k8s 叢集內部的網路連線全程都會加密</span><br><span class="line"># -it ，給一個虛擬終端機</span><br><span class="line"># -- bash ，跑 bash 貝殼程式</span><br><span class="line">$ kubectl exec -it pods/demo -- bash</span><br><span class="line">bash-5.1# exit</span><br><span class="line"></span><br><span class="line"># 檢視 demo 這個 pod 的 IP 位址</span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE   IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">demo   1/1     Running   0          26m   10.244.2.2   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># ssh 連進 demo 這個 pod</span><br><span class="line">bigred@m1:~$ ssh bigred@10.244.2.2</span><br><span class="line">Warning: Permanently added &#x27;10.244.2.2&#x27; (RSA) to the list of known hosts.</span><br><span class="line">bigred@10.244.2.2 s password:</span><br><span class="line">Welcome to ALP sshd 6000</span><br><span class="line"></span><br><span class="line"># 離開 pod</span><br><span class="line">demo:~$ exit</span><br><span class="line"></span><br><span class="line"># K8S 叢集外連接 demo app</span><br><span class="line"># --address 只能指定 Master 的 IP 位址</span><br><span class="line">$ kubectl port-forward --address $IP pods/demo 22100:22 &amp;</span><br><span class="line">[1] 27780</span><br><span class="line"></span><br><span class="line"># 在 Windows 系統的 cmd 視窗, 執行以下命令</span><br><span class="line">$ ssh bigred@&lt;alp.m1 IP&gt; -p 22100</span><br><span class="line">Handling connection for 22100</span><br><span class="line">bigred@192.168.61.4 s password: bigred</span><br><span class="line">Welcome to ALP sshd 6000</span><br><span class="line"></span><br><span class="line"># 離開 pod</span><br><span class="line">demo:~$ exit</span><br><span class="line"></span><br><span class="line"># 移除 pod</span><br><span class="line">$ kubectl delete pod  demo</span><br></pre></td></tr></table></figure>

<p>以上動作運作架構圖</p>
<p><img src="https://i.imgur.com/7fFcPeY.png"></p>
<h1 id="第一次接觸-YAML-File"><a href="#第一次接觸-YAML-File" class="headerlink" title="第一次接觸 YAML File"></a>第一次接觸 YAML File</h1><h2 id="建立-OpenSSH-Pod-1"><a href="#建立-OpenSSH-Pod-1" class="headerlink" title="建立 OpenSSH Pod"></a>建立 OpenSSH Pod</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 建立專案目錄，編輯 yaml 檔</span><br><span class="line">$ cd ~/wulin; nano sshd/pod-sshd.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-sshd</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: mysshd</span><br><span class="line">    image: localhost/alp.sshd</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>apiVersion: v1</code> ，這行是跟 API Server 說，我們的 yaml 檔是 v1 ，這行的設定由 K8s 的版本來決定</p>
</li>
<li><p><code>kind: Pod</code> ， 設定 K8s 的物件</p>
</li>
<li><pre><code class="!">metadata:
name: pod-sshd ---&gt; 設定 pod 的名字
spec:
containers:
- name: mysshd ---&gt; 設定 Container 的名稱
  image: localhost/alp.sshd ---&gt; 設定 Container 用哪片 image 
  imagePullPolicy: IfNotPresent ---&gt; 如果本地端有這片 image，不用上網下載
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- `imagePullPolicy: Never` ，不要上網下載 image </span><br><span class="line"></span><br><span class="line">```bash!</span><br><span class="line"># apply yaml 檔，建立 pod</span><br><span class="line">$ kubectl apply -f sshd/pod-sshd.yaml</span><br><span class="line"></span><br><span class="line"># 檢查是否符合預期</span><br><span class="line">$ kubectl get pods -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE    IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">demo       1/1     Running   0          126m   10.244.2.2   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod-sshd   1/1     Running   0          13s    10.244.1.3   w1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p><code>10.244.1.3</code>，看到這個 IP 位址 ，就知道 Flannel 網路套件在做事，將我們的 pod 分配到第一台工作機</p>
</li>
</ul>
<h2 id="再次修改-yaml-檔"><a href="#再次修改-yaml-檔" class="headerlink" title="再次修改 yaml 檔"></a>再次修改 yaml 檔</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ nano sshd/pod-sshd.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-sshd</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: mysshd</span><br><span class="line">    image: localhost/alp.sshd</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    <span class="built_in">command</span>:</span><br><span class="line">      - /bin/bash</span><br><span class="line">      - -c</span><br><span class="line">      - |</span><br><span class="line">        adduser -s /bin/bash -h /home/rbean rbean</span><br><span class="line">        <span class="built_in">echo</span> -e <span class="string">&#x27;rbean\nrbean\n&#x27;</span> | passwd rbean</span><br><span class="line">        /usr/sbin/sshd -D</span><br></pre></td></tr></table></figure>

<ul>
<li><code>command:</code>，在 K8s 的 yaml 檔中宣告一段等下 Container 要跑的 shell script ，即使 Container 的 image 本身有 <code>ENTRYPOINT [&quot;/usr/sbin/sshd&quot;]</code> ，一樣會被破格，強制要跑命令</li>
</ul>
<hr>
<h1 id="建立-File-Browser-Server"><a href="#建立-File-Browser-Server" class="headerlink" title="建立 File Browser Server"></a>建立 File Browser Server</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ cd ~/wulin/</span><br><span class="line"></span><br><span class="line">$ nano fbs/Dockerfile</span><br><span class="line">FROM quay.io/cloudwalker/alpine</span><br><span class="line">RUN apk update &amp;&amp; apk upgrade &amp;&amp; apk add --no-cache nano sudo wget curl \</span><br><span class="line">    tree elinks bash shadow procps util-linux coreutils binutils findutils grep &amp;&amp; \</span><br><span class="line">    curl -fsSL https://raw.githubusercontent.com/filebrowser/get/master/get.sh | bash &amp;&amp; \</span><br><span class="line">    # 設定 filebrowser</span><br><span class="line">    filebrowser config init --port 4000 --address &quot;&quot; --log &quot;/tmp/fbs&quot; --root=&quot;/srv&quot; &amp;&amp; \</span><br><span class="line">    # 建立管理者帳號</span><br><span class="line">    filebrowser users add admin &quot;admin&quot; --perm.admin=true</span><br><span class="line"></span><br><span class="line">CMD [&quot;filebrowser&quot;]</span><br></pre></td></tr></table></figure>

<ul>
<li><code>curl -fsSL &#39;URL/get.sh&#39; | bash</code>，利用 curl 命令將網站上的程式輸出在螢幕，但是 <code>| bash</code>，會將輸出在螢幕的程式碼丟給重裝貝殼執行，這樣做的好處是不會留下紀錄。<ul>
<li><code>-f</code>，下載失敗不會輸出錯誤訊息</li>
<li><code>-s</code>，Silent mode</li>
</ul>
</li>
<li><code>filebrowser config init</code>，將網站初始化<ul>
<li><code>--port 4000</code> ，網站的 port number : 4000</li>
<li><code>--address &quot;&quot;</code> ，任何 IP 位址的來源都能與我連線</li>
<li><code>--log &quot;/tmp/fbs&quot;</code>，網站 log 檔的存放檔案</li>
<li><code> --root=&quot;/srv&quot;</code> ，使用者丟檔案到網站後存放的目錄區，可自行設定</li>
</ul>
</li>
<li><code>filebrowser users add</code>，建立帳號<ul>
<li><code>admin &quot;admin&quot;</code>，帳號 : <code>admin</code>，密碼 : <code>admin</code></li>
<li><code>--perm.admin=true</code>，打開管理員的權限</li>
</ul>
</li>
</ul>
<p>build image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman build -t alp.myfbs fbs/</span><br><span class="line"></span><br><span class="line"># 檢查是否符合預期</span><br><span class="line">$ sudo podman images | grep fbs</span><br><span class="line">localhost/alp.myfbs       latest      24d1b68d43f8  About a minute ago  74.3 MB</span><br></pre></td></tr></table></figure>

<p>手動部署 alp.myfbs Image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 備份 Image </span><br><span class="line">$ sudo podman save localhost/alp.myfbs &gt; alpine.myfbs.tar</span><br><span class="line"></span><br><span class="line">$ scp alpine.myfbs.tar w1:~; scp alpine.myfbs.tar w2:~</span><br><span class="line"></span><br><span class="line">$ ssh w1 &#x27;sudo podman load &lt; alpine.myfbs.tar&#x27;; ssh w2 &#x27;sudo podman load &lt; alpine.myfbs.tar&#x27;</span><br></pre></td></tr></table></figure>

<p>建立 File Browser Server Pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 編輯 yaml 檔</span></span><br><span class="line">$ nano fbs/pod-fbs.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: pod-fbs</span><br><span class="line">  labels:</span><br><span class="line">    name: pod-fbs</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: myfbs</span><br><span class="line">    image: localhost/alp.myfbs</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    ports:</span><br><span class="line">     - containerPort: 4000</span><br></pre></td></tr></table></figure>

<p>用 yaml 檔 建立 pod </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f fbs/pod-fbs.yaml</span><br></pre></td></tr></table></figure>

<p>檢查 pod 的 4000 port 有無開啟</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 看 pod 的 IP</span><br><span class="line">$ kg pods -o wide</span><br><span class="line">NAME       READY   STATUS    RESTARTS   AGE     IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod-fbs    1/1     Running   0          2m30s   10.244.1.6   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># 網貓測 4000 port</span><br><span class="line">$ nc -w 1 10.244.1.6 4000</span><br><span class="line"></span><br><span class="line">$ echo $?</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<h3 id="建立-File-Browser-Server-Service"><a href="#建立-File-Browser-Server-Service" class="headerlink" title="建立 File Browser Server Service"></a>建立 File Browser Server Service</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ nano fbs/svc-fbs.yaml</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: svc-fbs</span><br><span class="line">spec:</span><br><span class="line">  externalIPs:</span><br><span class="line">  - 192.168.61.4</span><br><span class="line">  selector:</span><br><span class="line">    name: pod-fbs</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8080</span><br><span class="line">    targetPort: 4000</span><br></pre></td></tr></table></figure>

<ul>
<li><code>selector:</code> ，選擇有貼 pod-fbs 這個標籤的 pod</li>
<li><code>externalIPs:</code> ，設定對外服務的 IP 位址</li>
<li><pre><code>ports:
- port: 8080   ---&gt; 對外的 port number
  targetPort: 4000   ---&gt; pod 開的 port number
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">建立 service/svc-fbs 服務</span><br><span class="line"></span><br></pre></td></tr></table></figure>
$ kubectl apply -f  fbs/svc-fbs.yaml
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">檢查是否符合預期</span><br><span class="line"></span><br><span class="line">```bash=</span><br><span class="line">$ kubectl get all -o wide</span><br><span class="line">NAME           READY   STATUS    RESTARTS   AGE   IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">pod/pod-fbs    1/1     Running   0          14m   10.244.1.6   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">pod/pod-sshd   1/1     Running   0          39m   10.244.2.4   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAME                 TYPE        CLUSTER-IP    EXTERNAL-IP    PORT(S)    AGE    SELECTOR</span><br><span class="line">service/kubernetes   ClusterIP   10.98.0.1     &lt;none&gt;         443/TCP    4h5m   &lt;none&gt;</span><br><span class="line">service/svc-fbs      ClusterIP   10.98.0.230   192.168.61.4   8080/TCP   83s    name=pod-fbs</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<p>看 pod 的標籤</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods --show-labels</span><br><span class="line">AME       READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class="line">pod-fbs    1/1     Running   0          20m   name=pod-fbs</span><br><span class="line">pod-sshd   1/1     Running   0          44m   &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h3 id="FBS-架構示意圖"><a href="#FBS-架構示意圖" class="headerlink" title="FBS 架構示意圖"></a>FBS 架構示意圖</h3><p><img src="https://i.imgur.com/5G9pk3U.png"></p>
<ul>
<li>多建立 Service 這個物件的原因是因為，K8S 的 pod 很容易浴火重生，一旦重建， pod IP 會發生變動，如果這時候我們 pod 是一個網站，這個網站的 IP 位址時不時更換，會搞死人。</li>
<li>所以這時候需要透過 Service ，服務的 IP 在 K8S 中是固定的，不會因為主機重開，Service IP 就變動，所以只要讓 Service 透過 labels 綁住我們的 pod ，這樣即使 pod 浴火重生，也沒關係，我們一樣可以靠 Service 連的到我們的 pod</li>
</ul>
<h3 id="提問-如何得知檔案丟到網站後，存放在哪"><a href="#提問-如何得知檔案丟到網站後，存放在哪" class="headerlink" title="提問 : 如何得知檔案丟到網站後，存放在哪?"></a>提問 : 如何得知檔案丟到網站後，存放在哪?</h3><p>答 : pod-fbs 的 container 裡 <code>/srv</code> 目錄下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 進入 pod </span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it pod/pod-fbs -- bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 檢查是否符合預期</span></span><br><span class="line">bash-5.1<span class="comment"># ls -al srv</span></span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x 1 root root 4096 Jul 31 06:46 .</span><br><span class="line">dr-xr-xr-x 1 root root 4096 Jul 31 06:23 ..</span><br><span class="line">drwxr-xr-x 3 root root 4096 Jul 31 06:46 ALP3</span><br><span class="line"></span><br><span class="line">bash-5.1<span class="comment"># touch srv/zzz.txt</span></span><br><span class="line">bash-5.1<span class="comment"># ls -al srv/</span></span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x 1 root root 4096 Jul 31 06:51 .</span><br><span class="line">dr-xr-xr-x 1 root root 4096 Jul 31 06:23 ..</span><br><span class="line">drwxr-xr-x 3 root root 4096 Jul 31 06:46 ALP3</span><br><span class="line">-rw-r--r-- 1 root root    0 Jul 31 06:51 zzz.txt</span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/YpO3DbL.png"></p>
<h3 id="災難篇"><a href="#災難篇" class="headerlink" title="災難篇"></a>災難篇</h3><p>如果刪除 pod ，裡面存放的內容就不見了 ! ! !</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod pod-fbs</span><br><span class="line">pod &quot;pod-fbs&quot; deleted</span><br><span class="line"></span><br><span class="line">$ kubectl delete svc svc-fbs</span><br><span class="line">service &quot;svc-fbs&quot; deleted</span><br></pre></td></tr></table></figure>

<p>對於 K8s 的 Storage 怎麼處理 ?</p>
<h2 id="對-pod-的-yaml-檔新增-hostPath-PV"><a href="#對-pod-的-yaml-檔新增-hostPath-PV" class="headerlink" title="對 pod 的 yaml 檔新增 hostPath PV"></a>對 pod 的 yaml 檔新增 hostPath PV</h2><p>編輯 yaml 檔</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano fbs/pod-fbs.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-fbs</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-fbs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myfbs</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">localhost/alp.myfbs</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">4000</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/srv</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="comment"># directory location on host</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/tmp</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>volumeMounts</code>，設定 Container 的目錄要將哪個目錄掛載到 <code>volumes</code> 的目錄<ul>
<li><code>mountPath</code>，要掛載的目錄</li>
</ul>
</li>
<li><code>volumes</code>，下面可以宣告儲存體的設定<ul>
<li><code>hostPath</code>，volume 的型態<ul>
<li><code>path: /tmp</code>，這是一個在 Linux 系統的 <code>/tmp</code> 目錄，但注意 ! 這個目錄重開機裡面的內容會消失 (這是 Linux <code>/tmp</code> 目錄的規則)。</li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/storage/volumes/">K8s 官網 hostPath 範例連結</a></li>
<li>如果刪除 pod 再重建一次， pod 可能會跑到別台 node 主機，如何解決 ?<br>答 : 針對第一次建立 pod 時，如果 pod 在 node 1 主機上，則每次重建 pod 時，就要安排在這台 node 主機上</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-fbs</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">pod-fbs</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myfbs</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">localhost/alp.myfbs</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">4000</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/srv</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-volume</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="comment"># directory location on host</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/tmp</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">kubernetes.io/hostname:</span> <span class="string">w2</span></span><br></pre></td></tr></table></figure>



<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/Kubernetes%20CRI%20%E5%9F%BA%E7%A4%8E%E9%81%8B%E4%BD%9C.html" rel="prev" title="">
                  <i class="fa fa-chevron-left"></i> 
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/Kubernetes-Cluster-build.html" rel="next" title="">
                   <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Antony Cehn</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
