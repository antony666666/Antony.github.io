<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-Kubernetes CRI 基礎運作" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/08/30/Kubernetes%20CRI%20%E5%9F%BA%E7%A4%8E%E9%81%8B%E4%BD%9C/" class="article-date">
  <time class="dt-published" datetime="2022-08-29T22:54:16.000Z" itemprop="datePublished">2022-08-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/08/30/Kubernetes%20CRI%20%E5%9F%BA%E7%A4%8E%E9%81%8B%E4%BD%9C/">Kubernetes CRI 基礎運作</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Kubernetes-CRI-基礎運作"><a href="#Kubernetes-CRI-基礎運作" class="headerlink" title="Kubernetes CRI 基礎運作"></a>Kubernetes CRI 基礎運作</h1><p>:::success<br>檢查 node 主機的運作情形</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br></pre></td></tr></table></figure>

<p>:::spoiler 命令結果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NAME   STATUS   ROLES           AGE   VERSION</span><br><span class="line">m1     Ready    control-plane   16h   v1.24.0</span><br><span class="line">w1     Ready    worker          16h   v1.24.0</span><br><span class="line">w2     Ready    worker          16h   v1.24.0</span><br></pre></td></tr></table></figure>
<p>:::</p>
<p>:::success<br>檢視pod 的運作情況</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system -o wide</span><br></pre></td></tr></table></figure>

<p>:::spoiler 命令結果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">NAME                         READY   STATUS    RESTARTS   AGE   IP             NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-6d4b75cb6d-58jvb     1/1     Running   2          16h   10.244.0.6     m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-6d4b75cb6d-z2sjv     1/1     Running   2          16h   10.244.0.7     m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">etcd-m1                      1/1     Running   3          16h   192.168.61.4   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-apiserver-m1            1/1     Running   3          16h   192.168.61.4   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-controller-manager-m1   1/1     Running   3          16h   192.168.61.4   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-jpqmz        1/1     Running   2          16h   192.168.61.7   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-qcsfc        1/1     Running   2          16h   192.168.61.6   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-rwmjm        1/1     Running   7          16h   192.168.61.4   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-proxy-cx78m             1/1     Running   2          16h   192.168.61.6   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-proxy-fcb8s             1/1     Running   3          16h   192.168.61.4   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-proxy-tgmbm             1/1     Running   2          16h   192.168.61.7   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-scheduler-m1            1/1     Running   3          16h   192.168.61.4   m1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>後面加<code>-o wide</code> 可以看到pod 的 ip 位址 和所在的主機<br>:::</p>
</blockquote>
<p>:::success<br>檢視 CRI-O 的版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ crio -version</span><br></pre></td></tr></table></figure>

<p>CRI-O 的版本一定跟著 K8S 的版本在運作</p>
<p>:::spoiler 命令結果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">crio version 1.24.1</span><br><span class="line">Version:          1.24.1</span><br><span class="line">GitCommit:        edda4988043086ee714c0b651ff91e68fa70adf9</span><br><span class="line">GitTreeState:     clean</span><br><span class="line">BuildDate:        2022-07-21T14:19:25Z</span><br><span class="line">GoVersion:        go1.18.4</span><br><span class="line">Compiler:         gc</span><br><span class="line">Platform:         linux/amd64</span><br><span class="line">Linkmode:         dynamic</span><br><span class="line">BuildTags:        containers_image_openpgp, containers_image_ostree_stub, seccomp, selinux</span><br><span class="line">SeccompEnabled:   true</span><br><span class="line">AppArmorEnabled:  false</span><br></pre></td></tr></table></figure>
<p>:::</p>
<p>:::success<br>crictl 的簡易手冊</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ crictl --help | grep -A 20 COMMANDS:</span><br></pre></td></tr></table></figure>

<p>:::spoiler 命令結果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">COMMANDS:</span><br><span class="line">   attach              Attach to a running container</span><br><span class="line">   create              Create a new container</span><br><span class="line">   exec                Run a command in a running container</span><br><span class="line">   version             Display runtime version information</span><br><span class="line">   images, image, img  List images</span><br><span class="line">   inspect             Display the status of one or more containers</span><br><span class="line">   inspecti            Return the status of one or more images</span><br><span class="line">   imagefsinfo         Return image filesystem info</span><br><span class="line">   inspectp            Display the status of one or more pods</span><br><span class="line">   logs                Fetch the logs of a container</span><br><span class="line">   port-forward        Forward local port to a pod</span><br><span class="line">   ps                  List containers</span><br><span class="line">   pull                Pull an image from a registry</span><br><span class="line">   run                 Run a new container inside a sandbox</span><br><span class="line">   runp                Run a new pod</span><br><span class="line">   rm                  Remove one or more containers</span><br><span class="line">   rmi                 Remove one or more images</span><br><span class="line">   rmp                 Remove one or more pods</span><br><span class="line">   pods                List pods</span><br><span class="line">   start               Start one or more created containers</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>run</code> ，可以透過 cri-o 建立 container<br>:::</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ crictl</span><br><span class="line">NAME:</span><br><span class="line">   crictl - client for CRI</span><br></pre></td></tr></table></figure>

<ul>
<li>crictl 這個套件，專門管理 CRI 的套件</li>
<li>crictl + crio 約略等於 Podman</li>
<li>如果一個系統的 deamon 太多，會很容易被人攻陷，且資源運算上會吃很兇，所以docker 被淘汰</li>
<li>podman 出生 全名： pod manager ，他可以做到docker 90%可以做的事情，且不需要依靠deamon</li>
</ul>
<p>:::success</p>
<p>檢視 podman 處理 image 的功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman --help</span><br><span class="line">  load        Load image(s) from a tar archive</span><br><span class="line">  save        Save image(s) to an archive</span><br><span class="line">  export      Export container&#x27;s filesystem contents as a tar archive</span><br><span class="line">  import      Import a tarball to create a filesystem image</span><br></pre></td></tr></table></figure>

<p><font color=red><strong><code>CRI-O</code> 並沒有以上 <code>load</code> ( 還原 image )、 <code>save</code> ( 備份 image ) 、<code>build</code>、 <code>export</code> 和 <code>import</code> 的命令</strong></font></p>
<p>因為 cri-o 只有下載 image 的能力，所以需要 podman 來支援 image 的管理<br>在老師的系統中使用 CRI-O + podman 來維運 K8s</p>
<p>podman 和 cri-o 上網抓 image 後儲存的位置相同，怎麼證明？<br>:::</p>
<h2 id="Podman-與-CRI-O-Image-存儲目錄"><a href="#Podman-與-CRI-O-Image-存儲目錄" class="headerlink" title="Podman 與 CRI-O Image 存儲目錄"></a>Podman 與 CRI-O Image 存儲目錄</h2><p>檢視 podman 儲存 image 的目錄</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> /etc/containers/storage.conf | grep -A 15 <span class="string">&#x27;\[storage\]&#x27;</span></span><br><span class="line">[storage]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Default Storage Driver, Must be set for proper operation.</span></span><br><span class="line">driver = <span class="string">&quot;overlay&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Temporary storage location</span></span><br><span class="line">runroot = <span class="string">&quot;/run/containers/storage&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Primary Read/Write location of container storage</span></span><br><span class="line"><span class="comment"># When changing the graphroot location on an SELINUX system, you must</span></span><br><span class="line"><span class="comment"># ensure  the labeling matches the default locations labels with the</span></span><br><span class="line"><span class="comment"># following commands:</span></span><br><span class="line"><span class="comment"># semanage fcontext -a -e /var/lib/containers/storage /NEWSTORAGEPATH</span></span><br><span class="line"><span class="comment"># restorecon -R -v /NEWSTORAGEPATH</span></span><br><span class="line">graphroot = <span class="string">&quot;/var/lib/containers/storage&quot;</span></span><br></pre></td></tr></table></figure>

<p>檢視 cri-o 儲存 image 的目錄</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ crio-status config</span><br><span class="line">[crio]</span><br><span class="line">  root = &quot;/var/lib/containers/storage&quot;</span><br></pre></td></tr></table></figure>


<p>透過 crictl 的命令來看 image 的資訊</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ crictl images</span><br><span class="line">IMAGE                                                      TAG                 IMAGE ID            SIZE</span><br><span class="line">docker.io/rancher/mirrored-flannelcni-flannel-cni-plugin   v1.1.0              fcecffc7ad4af       8.37MB</span><br><span class="line">docker.io/rancher/mirrored-flannelcni-flannel              v0.18.0             744246d629cff       63.3MB</span><br><span class="line">k8s.gcr.io/coredns/coredns                                 v1.8.6              a4ca41631cc7a       47MB</span><br><span class="line">k8s.gcr.io/etcd                                            3.5.3-0             aebe758cef4cd       301MB</span><br><span class="line">k8s.gcr.io/kube-apiserver                                  v1.24.1             e9f4b425f9192       131MB</span><br><span class="line">k8s.gcr.io/kube-controller-manager                         v1.24.1             b4ea7e648530d       121MB</span><br><span class="line">k8s.gcr.io/kube-proxy                                      v1.24.1             beb86f5d8e6cd       112MB</span><br><span class="line">k8s.gcr.io/kube-scheduler                                  v1.24.1             18688a72645c5       52.3MB</span><br><span class="line">k8s.gcr.io/pause                                           3.6                 6270bb605e12e       690kB</span><br><span class="line">k8s.gcr.io/pause                                           3.7                 221177c6082a8       718kB</span><br></pre></td></tr></table></figure>

<p>透過 sudo podman 的命令來看 image 的資訊</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman images</span><br><span class="line">REPOSITORY                                                TAG         IMAGE ID      CREATED       SIZE</span><br><span class="line">docker.io/rancher/mirrored-flannelcni-flannel             v0.18.0     744246d629cf  4 days ago    63.3 MB</span><br><span class="line">k8s.gcr.io/kube-apiserver                                 v1.24.1     e9f4b425f919  6 days ago    131 MB</span><br><span class="line">k8s.gcr.io/kube-controller-manager                        v1.24.1     b4ea7e648530  6 days ago    121 MB</span><br><span class="line">k8s.gcr.io/kube-scheduler                                 v1.24.1     18688a72645c  6 days ago    52.3 MB</span><br><span class="line">k8s.gcr.io/kube-proxy                                     v1.24.1     beb86f5d8e6c  6 days ago    112 MB</span><br><span class="line">docker.io/rancher/mirrored-flannelcni-flannel-cni-plugin  v1.1.0      fcecffc7ad4a  10 days ago   8.37 MB</span><br><span class="line">k8s.gcr.io/etcd                                           3.5.3-0     aebe758cef4c  6 weeks ago   301 MB</span><br><span class="line">k8s.gcr.io/pause                                          3.7         221177c6082a  2 months ago  718 kB</span><br><span class="line">k8s.gcr.io/coredns/coredns                                v1.8.6      a4ca41631cc7  7 months ago  47 MB</span><br><span class="line">k8s.gcr.io/pause                                          3.6         6270bb605e12  9 months ago  690 kB</span><br></pre></td></tr></table></figure>


<p>可以發現 Podman 和 CRI-O 儲存 image 的資訊</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">備份 image </span><br><span class="line">$ sudo podman save docker.io/rancher/mirrored-flannelcni-flannel-cni-plugin:v1.1.0 &gt; flannel-plugin.tar</span><br><span class="line"></span><br><span class="line">備份 image </span><br><span class="line">$ sudo podman save docker.io/rancher/mirrored-flannelcni-flannel:v0.18.1 &gt; flannel.tar</span><br><span class="line"></span><br><span class="line">還原 image</span><br><span class="line">$ sudo podman load &lt; flannel-plugin.tar</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Crun-與-runC-大小比較"><a href="#Crun-與-runC-大小比較" class="headerlink" title="Crun 與 runC 大小比較"></a>Crun 與 runC 大小比較</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ls -lh `which runc`</span><br><span class="line">-rwxr-xr-x 1 root root 9.1M Aug  2 18:39 /usr/bin/runc</span><br><span class="line"></span><br><span class="line">$ ls -lh `which crun`</span><br><span class="line">-rwxr-xr-x 1 root root 383K Apr 28 06:20 /usr/bin/crun</span><br></pre></td></tr></table></figure>

<h2 id="crun-與-runc-效能比較"><a href="#crun-與-runc-效能比較" class="headerlink" title="crun 與 runc 效能比較"></a>crun 與 runc 效能比較</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">## 建立 Container 所需的rootfs</span><br><span class="line">$ mkdir -p ~/wulin/rt/rootfs; cd ~/wulin/rt/rootfs; curl -o alpine.tar.gz http://dl-cdn.alpinelinux.org/alpine/v3.14/releases/x86_64/alpine-minirootfs-3.14.2-x86_64.tar.gz; tar xvf alpine.tar.gz ;rm alpine.tar.gz; cd ..</span><br><span class="line"></span><br><span class="line">## 更改權限</span><br><span class="line">$ sudo chown root:root -R rootfs/</span><br><span class="line"></span><br><span class="line">## 產生 config.json</span><br><span class="line">$ runc spec</span><br></pre></td></tr></table></figure>


<p>實測 run<font color=red>c</font></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ time for i in &#123;1..100&#125;; do echo &quot;exit&quot; | sudo runc run b1 &amp;&gt;/dev/null; done</span><br></pre></td></tr></table></figure>

<p>output : </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">real    0m3.238s</span><br><span class="line">user    0m1.386s</span><br><span class="line">sys     0m1.392s</span><br></pre></td></tr></table></figure>


<p>實測 <font color=red>c</font>run</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ time for i in &#123;1..100&#125;; do echo &quot;exit&quot; | sudo crun run b1 &amp;&gt;/dev/null; done</span><br></pre></td></tr></table></figure>

<p>output : </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">real    0m1.081s</span><br><span class="line">user    0m0.545s</span><br><span class="line">sys     0m0.418s</span><br></pre></td></tr></table></figure>




<h2 id="設定-CRI-O-執行-crun"><a href="#設定-CRI-O-執行-crun" class="headerlink" title="設定 CRI-O 執行 crun"></a>設定 CRI-O 執行 crun</h2><p>3 台主機： m1 w1 w2 都要設定</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ sudo nano /etc/crio/crio.conf</span><br><span class="line">[crio.runtime]</span><br><span class="line"><span class="comment"># Overide defaults to not use systemd cgroups.</span></span><br><span class="line">conmon_cgroup = <span class="string">&quot;pod&quot;</span></span><br><span class="line">cgroup_manager = <span class="string">&quot;cgroupfs&quot;</span></span><br><span class="line">default_runtime = <span class="string">&quot;crun&quot;</span></span><br><span class="line"></span><br><span class="line">[crio.runtime.runtimes.crun]</span><br><span class="line">runtime_path = <span class="string">&quot;/usr/bin/crun&quot;</span></span><br><span class="line">runtime_type = <span class="string">&quot;oci&quot;</span></span><br><span class="line">runtime_root = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">[crio.network]</span><br><span class="line">network_dir = <span class="string">&quot;/etc/cni/net.d/&quot;</span></span><br><span class="line">plugin_dir = <span class="string">&quot;/opt/cni/bin&quot;</span></span><br></pre></td></tr></table></figure>


<ul>
<li><code>default_runtime = &quot;crun&quot;</code>，設定 CRI-O 用 crun 來建 Cotainer</li>
<li><code>[crio.runtime.runtimes.crun]</code>，下面放 crun 的設定項目</li>
<li><code>runtime_path</code>，設定 crun 放在哪</li>
<li><code>runtime_type</code>，crun 用的標準</li>
<li>CRI-O 內定使用 runc 建 Container，但 crun 比較快，所以修改 CRI-O 設定檔來使用 crun，代表最底層 container 的執行從 runc 改成 crun。</li>
<li>為什麼有 crun 可以用？因為有安裝 podman，podman 內定使用 crun 建 Container。</li>
</ul>
<p>都設定好後，要重啟 node</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ssh w1 sudo reboot</span><br><span class="line">$ ssh w2 sudo reboot</span><br><span class="line">$ sudo reboot</span><br></pre></td></tr></table></figure>

<p>好了後，確定 nodes 是否正常運作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kg nodes</span><br></pre></td></tr></table></figure>

<p>再確定主機內的 pods 是否都有 running</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ks</span><br></pre></td></tr></table></figure>

<p>補充 : </p>
<ul>
<li><code>crun</code> ，由安裝 podman 附帶安裝。</li>
</ul>
<h2 id="Kubernetes-檢測"><a href="#Kubernetes-檢測" class="headerlink" title="Kubernetes 檢測"></a>Kubernetes 檢測</h2><p>透過 kubectl 產生一個 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run nginx --image=quay.io/cloudwalker/nginx</span><br></pre></td></tr></table></figure>

<blockquote>
<p>因為只有指定一個 image 所以 只會這個 pod 只會產生一台 container</p>
</blockquote>
<p>檢查 pod 運作資訊</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME    READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx   1/1     Running   0          22s</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>READY 1/1</code> ，後面的 1 是 pod 裡有幾台Container，前面的 1 是 pod 的裡面的 Container 是否有 running ，如果有 running 就會顯示 1</p>
</blockquote>
<p>curl pod 的 ip 看網站有沒有順利啟動</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://10.244.1.2</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">...以下省略</span><br></pre></td></tr></table></figure>

<h3 id="檢視-K8s-Cluster-的網路運作"><a href="#檢視-K8s-Cluster-的網路運作" class="headerlink" title="檢視 K8s Cluster 的網路運作"></a>檢視 K8s Cluster 的網路運作</h3><p><img src="https://i.imgur.com/qYLBPUu.png"></p>
<p>當我們建立了一個 pod ，裡面的 Container 起了一個網站，這台 pod  會得到一個 Virtul IP ，這個虛擬 IP 是透過 iptables 做出來的，我們可以在 m1 、 w1 和 w2 都能用 curl 指令連到 pod 所建立的網站。</p>
<hr>
<p>建立和執行我們的 pod </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run a1 -it --image=quay.io/cloudwalker/alpine -- sh</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>-it</code> ， 給一個虛擬終端機<br><code>--</code> ，分割符號，後面是針對 pod 所要下達的命令</p>
</blockquote>
<p>進 pod ， 安裝 curl 指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ apk add curl</span><br></pre></td></tr></table></figure>

<p>連線到剛剛建立 nginx 的那台 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://10.244.1.2</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">...以下省略</span><br></pre></td></tr></table></figure>

<p>更新網路示意圖</p>
<p><img src="https://i.imgur.com/u840Vz0.png"></p>
<p>小總結</p>
<ul>
<li>VM m1、w1、w2 皆使用 NAT 模式，由這三臺 VM 組成 Keubernetes Cluster</li>
<li>pod 是由 Keubernetes 部署的，具備 IP Address（Virtual IP）<ul>
<li>Virtual IP｜沒有設定在網路卡上，是透過 iptables 實作出來的 IP Address</li>
</ul>
</li>
<li>因為上述架構的關係 pod、node 之間能實現網路通訊</li>
</ul>
<p>by 第三組</p>
<p>刪除剛剛建立的兩台 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pods a1</span><br><span class="line">$ kubectl delete pods nginx</span><br></pre></td></tr></table></figure>


<hr>
<h1 id="Kubernetes-CNI-基礎運作"><a href="#Kubernetes-CNI-基礎運作" class="headerlink" title="Kubernetes CNI 基礎運作"></a>Kubernetes CNI 基礎運作</h1><h2 id="Flannel-CNI-單一節點運作架構"><a href="#Flannel-CNI-單一節點運作架構" class="headerlink" title="Flannel CNI 單一節點運作架構"></a>Flannel CNI 單一節點運作架構</h2><p><img src="https://i.imgur.com/p5RRYhy.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">m1:~$ ifconfig</span><br><span class="line">cni0      Link encap:Ethernet  HWaddr 0E:31:89:91:11:C2</span><br><span class="line">          inet addr:10.244.0.1  Bcast:10.244.0.255  Mask:255.255.255.0</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ ssh w1 <span class="string">&#x27;ifconfig&#x27;</span></span><br><span class="line">cni0      Link encap:Ethernet  HWaddr 82:58:F3:07:50:67</span><br><span class="line">          inet addr:10.244.1.1  Bcast:10.244.1.255  Mask:255.255.255.0</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ ssh w2 <span class="string">&#x27;ifconfig&#x27;</span></span><br><span class="line">cni0      Link encap:Ethernet  HWaddr 06:B1:21:B1:1F:8B</span><br><span class="line">          inet addr:10.244.2.1  Bcast:10.244.2.255  Mask:255.255.255.0</span><br><span class="line"></span><br><span class="line">m1:~$ brctl show</span><br><span class="line">bridge name     bridge <span class="built_in">id</span>               STP enabled     interfaces</span><br><span class="line">cni0            8000.0e31899111c2       no              vethbb0b5903</span><br><span class="line">                                                        vethfc422baa</span><br><span class="line">                                            </span><br><span class="line">$ ssh w1 <span class="string">&#x27;brctl show&#x27;</span></span><br><span class="line">bridge name     bridge <span class="built_in">id</span>               STP enabled     interfaces</span><br><span class="line">cni0            8000.8258f3075067       no</span><br><span class="line"></span><br><span class="line">$ ssh w2 <span class="string">&#x27;brctl show&#x27;</span></span><br><span class="line">bridge name     bridge <span class="built_in">id</span>               STP enabled     interfaces</span><br><span class="line">cni0            8000.06b121b11f8b       no              vethfff77f1d</span><br><span class="line"></span><br><span class="line">$ ps aux | grep -v grep | grep flanneld</span><br><span class="line">root       4406  0.1  0.6 1335180 37392 ?       Ssl  14:52   0:09 /opt/bin/flanneld --ip-masq --kube-subnet-mgr</span><br></pre></td></tr></table></figure>


<ul>
<li>因 w1 及 w2 沒有建立過 POD, 所以沒有建立 cni0 橋接器, 一但有建立 POD, cni0 橋接器便會建立</li>
</ul>
<h2 id="插播"><a href="#插播" class="headerlink" title="插播"></a>插播</h2><h3 id="建立-mysql-Contianer"><a href="#建立-mysql-Contianer" class="headerlink" title="建立 mysql Contianer"></a>建立 mysql Contianer</h3><p>準備和進入工作目錄、編輯 Dockerfile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir mydb; cd mydb</span><br><span class="line"></span><br><span class="line">$ nano Dockerfile</span><br></pre></td></tr></table></figure>

<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> quay.io/cloudwalker/mysql-server</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> MYSQL_ROOT_PASSWORD bigred</span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> myuser.sql /docker-entrypoint-initdb.d</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">3306</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>FROM</code>，指定要用哪一片 image 建立新的 image ，這裡指定的是 <code>quay.io/cloudwalker/mysql-server</code></li>
<li><code>ENV</code>，等等在 build image 的時候，宣告 變數 <code>MYSQL_ROOT_PASSWORD</code> 的值等於 <code>bigred</code></li>
<li><code>ADD</code>，image 做出來後，將 myuser.sql 這個檔案複製到 image 的 <code>/docker-entrypoint-initdb.d</code> 目錄<ul>
<li>要 <code>ADD</code> 的檔案，需要和 Dockerfile 放在同一層目錄</li>
</ul>
</li>
<li><code>EXPOSE 3306</code>，在 Container 上開一個對外的 3306 port</li>
</ul>
<p>編輯 <code>muser.sql</code> </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ nano myuser.sql</span><br><span class="line">CREATE USER <span class="string">&#x27;bigred&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;bigred&#x27;</span>;</span><br><span class="line">GRANT ALL PRIVILEGES ON *.* TO <span class="string">&#x27;bigred&#x27;</span>@<span class="string">&#x27;%&#x27;</span> WITH GRANT OPTION;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<p>build image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman build --no-cache -t mydb .</span><br></pre></td></tr></table></figure>

<p>output : </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">STEP 1/4: FROM quay.io/cloudwalker/mysql-server</span><br><span class="line">STEP 2/4: ENV MYSQL_ROOT_PASSWORD bigred</span><br><span class="line">WARN[0000] HEALTHCHECK is not supported for OCI image format and will be ignored. Must use `docker` format</span><br><span class="line">--&gt; c0485a22f11</span><br><span class="line">STEP 3/4: ADD myuser.sql /docker-entrypoint-initdb.d</span><br><span class="line">WARN[0000] HEALTHCHECK is not supported for OCI image format and will be ignored. Must use `docker` format</span><br><span class="line">--&gt; c0a9de19856</span><br><span class="line">STEP 4/4: EXPOSE 3306</span><br><span class="line">COMMIT mydb</span><br><span class="line">WARN[0000] HEALTHCHECK is not supported for OCI image format and will be ignored. Must use `docker` format</span><br><span class="line">--&gt; 11a146f48e4</span><br><span class="line">Successfully tagged localhost/mydb:latest</span><br><span class="line">11a146f48e4c2b108f161d7ea8224ce1317594152399ad592ace997f90a148cc</span><br></pre></td></tr></table></figure>

<ul>
<li>出現 Warning 的原因是因為，image 的格式有分 OCI 和 Docker 。</li>
<li>Docker 的格式有健康檢查，如果由 image 建出來的 Container 不健康，例如 Container 在 running 時，沒有開 3306 port ，他就會提醒。</li>
<li>OCI 的格式沒有健康檢查的服務。</li>
</ul>
<p>檢查 image 有沒有建出來</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman images</span><br><span class="line">REPOSITORY             TAG         IMAGE ID      CREATED        SIZE</span><br><span class="line">localhost/mydb         latest      11a146f48e4c  5 minutes ago  439 MB</span><br></pre></td></tr></table></figure>

<p>run Container</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman run --rm --name bobo -d -p 3306:3306 localhost/mydb</span><br></pre></td></tr></table></figure>

<p>檢查 Container 的狀態</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman ps -a</span><br><span class="line">CONTAINER ID  IMAGE                  COMMAND     CREATED         STATUS            PORTS                   NAMES</span><br><span class="line">13b1733d3975  localhost/mydb:latest  mysqld      10 seconds ago  Up 9 seconds ago  0.0.0.0:3306-&gt;3306/tcp  bobo</span><br></pre></td></tr></table></figure>

<p>登入 mysql</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ mysql -ubigred -p -h $IP</span><br><span class="line">Enter password:bigred</span><br><span class="line"></span><br><span class="line">MySQL [(none)]&gt; select user,host from mysql.user;</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| user             | host      |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">| bigred           | %         |</span><br><span class="line">| healthchecker    | localhost |</span><br><span class="line">| mysql.infoschema | localhost |</span><br><span class="line">| mysql.session    | localhost |</span><br><span class="line">| mysql.sys        | localhost |</span><br><span class="line">| root             | localhost |</span><br><span class="line">+------------------+-----------+</span><br><span class="line">6 rows in set (0.001 sec)</span><br></pre></td></tr></table></figure>


<h3 id="建立-gocgi-Container"><a href="#建立-gocgi-Container" class="headerlink" title="建立 gocgi Container"></a>建立 gocgi Container</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://www.oc99.org/zip/gocgi.zip</span><br><span class="line"></span><br><span class="line">$ unzip gocgi.zip</span><br><span class="line"></span><br><span class="line">$ tree gocgi</span><br><span class="line">gocgi</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── go.mod</span><br><span class="line">├── gocgi</span><br><span class="line">├── main</span><br><span class="line">├── main.go</span><br><span class="line">└── www</span><br><span class="line">    ├── cgi</span><br><span class="line">    │   ├── cgidb.sh</span><br><span class="line">    │   ├── cgitbl.sh</span><br><span class="line">    │   ├── hs2.sh</span><br><span class="line">    │   └── mysql.sh</span><br><span class="line">    ├── css</span><br><span class="line">    │   └── styles.css</span><br><span class="line">    ├── html</span><br><span class="line">    │   ├── db.html</span><br><span class="line">    │   ├── hs2.html</span><br><span class="line">    │   ├── index.html</span><br><span class="line">    │   ├── mysql.html</span><br><span class="line">    │   └── tbl.html</span><br><span class="line">    ├── img</span><br><span class="line">    │   └── 2085263.png</span><br><span class="line">    ├── index.html</span><br><span class="line">    └── js</span><br><span class="line"></span><br><span class="line">6 directories, 17 files</span><br></pre></td></tr></table></figure>

<p>檢視 main.go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;net/http&quot;</span></span><br><span class="line">  <span class="string">&quot;net/http/cgi&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cgiMySQL</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">handler := cgi.Handler&#123;Path: <span class="string">&quot;./www/cgi/mysql.sh&quot;</span>&#125;</span><br><span class="line">handler.ServeHTTP(w, r)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">cgiHS2</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">handler := cgi.Handler&#123;Path: <span class="string">&quot;./www/cgi/hs2.sh&quot;</span>&#125;</span><br><span class="line">handler.ServeHTTP(w, r)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  static := http.FileServer(http.Dir(<span class="string">&quot;./www/&quot;</span>))</span><br><span class="line">  http.Handle(<span class="string">&quot;/&quot;</span>,static)</span><br><span class="line"></span><br><span class="line">  http.HandleFunc(<span class="string">&quot;/mysql&quot;</span>, cgiMySQL)</span><br><span class="line">  http.HandleFunc(<span class="string">&quot;/hs2&quot;</span>, cgiHS2)</span><br><span class="line"></span><br><span class="line">  http.ListenAndServe(<span class="string">&quot;:8080&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>檢視 Dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> quay.io/cloudwalker/alpine</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk update &amp;&amp; apk upgrade &amp;&amp; <span class="built_in">mkdir</span> /www</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> gocgi /</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> www /www/</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/gocgi&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>FROM quay.io/cloudwalker/alpine</code>，指定 <code>quay.io/cloudwalker/alpine</code> 這片 image 建立新的 image</li>
<li><code>RUN</code>，在建立 image 時，執行 <code>apk update &amp;&amp; apk upgrade &amp;&amp; mkdir /www</code>，系統更新和在 image 的根目錄下建立 www 目錄</li>
<li><code>ADD gocgi /</code>，將 gocgi 這支程式拷貝到 image 的根目錄</li>
<li><code>ADD www /www/</code>，將 <code>www</code> 目錄下的所有子目錄和檔案拷貝到 image 的 <code>/www</code> 目錄下</li>
<li><code>CMD [&quot;/gocgi&quot;]</code>，等等 run Container 時，內定執行的命令是 gocgi 這支程式</li>
</ul>
<p>build image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman build -t localhost/gocgi .</span><br></pre></td></tr></table></figure>

<p>檢查 image 有無 build 成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman images</span><br><span class="line">REPOSITORY          TAG         IMAGE ID      CREATED            SIZE</span><br><span class="line">localhost/gocgi     latest      99424c6c5514  31 seconds ago     20.1 MB</span><br></pre></td></tr></table></figure>

<p>用 <code>localhost/gocgi</code> 這片 image 建 Container</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman run  --name mybobo -d -p 80:8080 localhost/mycgi</span><br></pre></td></tr></table></figure>

<p>檢查 Container 的狀態</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo podman ps -a</span><br><span class="line">CONTAINER ID  IMAGE                   COMMAND     CREATED            STATUS                PORTS                   NAMES</span><br><span class="line">13b1733d3975  localhost/mydb:latest   mysqld      About an hour ago  Up About an hour ago  0.0.0.0:3306-&gt;3306/tcp  bobo</span><br><span class="line">c6194081d78b  localhost/gocgi:latest  /gocgi      4 seconds ago      Up 4 seconds ago      0.0.0.0:80-&gt;8080/tcp    mybobo</span><br></pre></td></tr></table></figure>


<p>檢測服務</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://192.168.179.4</span><br><span class="line">&lt;h1&gt;HaHa&lt;/h1&gt;</span><br></pre></td></tr></table></figure>




<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/30/Kubernetes%20CRI%20%E5%9F%BA%E7%A4%8E%E9%81%8B%E4%BD%9C/" data-id="clhda4wao0001j0w715xyfs3o" data-title="Kubernetes CRI 基礎運作" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%B3%BB%E7%B5%B1%E5%B7%A5%E7%A8%8B/" rel="tag">系統工程</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Kubernetes-Objects" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/08/28/Kubernetes-Objects/" class="article-date">
  <time class="dt-published" datetime="2022-08-27T22:51:02.000Z" itemprop="datePublished">2022-08-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/08/28/Kubernetes-Objects/">Kubernetes-Objects</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Kubernetes-Objects"><a href="#Kubernetes-Objects" class="headerlink" title="Kubernetes-Objects"></a>Kubernetes-Objects</h1><h2 id="認識-K8S-叢集物件"><a href="#認識-K8S-叢集物件" class="headerlink" title="認識 K8S 叢集物件"></a>認識 K8S 叢集物件</h2><p><img src="https://i.imgur.com/vVVHNS6.png"></p>
<ul>
<li><code>CustomResourceDefinitions</code> ，自定義 K8s 的物件</li>
</ul>
<h2 id="K8S-Object-Short-names"><a href="#K8S-Object-Short-names" class="headerlink" title="K8S Object Short-names"></a>K8S Object Short-names</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Short name       Full name</span><br><span class="line">csr      	  certificatesigningrequests</span><br><span class="line">cm	          configmaps</span><br><span class="line">ds	          daemonsets</span><br><span class="line">deploy	          deployments</span><br><span class="line">ep	          endpoints</span><br><span class="line">ev	          events</span><br><span class="line">hpa      	  horizontalpodautoscalers</span><br><span class="line">ing	          ingresses</span><br><span class="line">ns	          namespaces</span><br><span class="line">pvc	          persistentvolumeclaims</span><br><span class="line">svc	          services</span><br><span class="line">pv	          persistentvolumes</span><br><span class="line">po	          pods</span><br><span class="line">pdb	          poddisruptionbudgets</span><br><span class="line">psp	          podsecuritypolicies</span><br><span class="line">rs	          replicasets</span><br><span class="line">rc	          replicationcontrollers</span><br><span class="line">quota	          resourcequotas</span><br><span class="line">sa	          serviceaccounts</span><br></pre></td></tr></table></figure>

<h1 id="建立-Kubernetes-POD"><a href="#建立-Kubernetes-POD" class="headerlink" title="建立 Kubernetes POD"></a>建立 Kubernetes POD</h1><p>:::spoiler Node &amp; POD 示意圖</p>
<p><img src="https://i.imgur.com/ji3dIzS.png"></p>
<p>:::</p>
<ul>
<li>volime 儲存體 ，供 pod 使用</li>
<li>一個 pod 可以跑很多台 Container ，代表可以 run 很多 企業要用的 Application</li>
</ul>
<h2 id="認識-Kubernetes-Pod"><a href="#認識-Kubernetes-Pod" class="headerlink" title="認識 Kubernetes Pod"></a>認識 Kubernetes Pod</h2><ul>
<li><font color=red><strong>Pods are not intended to live long.</strong></font><ul>
<li>pod 很容易領便當</li>
<li>K8s 內定，node 主機重開，裡面的 pod 會浴火重生</li>
</ul>
</li>
<li>This group of containers would share storage, Linux namespaces, cgroups, IP addresses.<ul>
<li>pod 中的 Container 會共享 volume , Linux Namespaces, cgroups, IP 位址</li>
</ul>
</li>
</ul>
<h2 id="Single-Container-Pod-建立與連接"><a href="#Single-Container-Pod-建立與連接" class="headerlink" title="Single Container Pod 建立與連接"></a>Single Container Pod 建立與連接</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 Windows 系統的 cmd 視窗, 執行以下命令</span></span><br><span class="line">$ ssh bigred@&lt;alp.m1 IP&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 從 1.18 這個版本開始, 下面命令只會產生 pod, </span></span><br><span class="line"><span class="comment"># 不再會產生 deployment object 及 replicaset controller.</span></span><br><span class="line"><span class="comment"># --image= ，等號右邊的格式為 image 網站/帳號/image 名稱</span></span><br><span class="line">$ kubectl run a1 --image-pull-policy IfNotPresent --image=quay.io/cloudwalker/alpine.derby</span><br><span class="line">pod/a1 created</span><br><span class="line"></span><br><span class="line"><span class="comment"># STATUS 的 ContainerCreating，</span></span><br><span class="line"><span class="comment"># 代表 Container 正在被 CRI-O 透過 pull 命令到網路上下載 Container 需要的 image</span></span><br><span class="line">$ kg pods -o wide</span><br><span class="line">NAME   READY   STATUS              RESTARTS   AGE   IP       NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">a1     0/1     ContainerCreating   0          64s   &lt;none&gt;   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把 pod 的 IP 位址丟到一個變數</span></span><br><span class="line">$ podip=$(kg pods -o wide | grep -e <span class="string">&quot;^a1 &quot;</span> | <span class="built_in">tr</span> -s <span class="string">&#x27; &#x27;</span> | <span class="built_in">cut</span> -d <span class="string">&#x27; &#x27;</span> -f6)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 檢查是否符合預期</span></span><br><span class="line">$ curl http://<span class="variable">$podip</span>:8888</span><br><span class="line">&lt;h1&gt;Welcome to Spring Boot&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">$ curl http://<span class="variable">$podip</span>:8888/hostname</span><br><span class="line">Hostname : a1</span><br></pre></td></tr></table></figure>


<p>進入a1 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -it a1 -- bash</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>--</code>分隔符號，後面放的是 pod 要執行的程式<br>連線的動作會經過加密，安全等級不輸 SSH</p>
</blockquote>
<p>檢查有無啟動pid 的 namespace</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># ps aux</span><br><span class="line">USER        PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</span><br><span class="line">root          1  0.0  0.0   2180  1672 ?        Ss   06:29   0:00 bash -c /derby/app/startup</span><br><span class="line">root          2  1.5  2.5 3496804 207136 ?      Sl   06:29   0:11 java -jar -Dderby.system.home=/derby/db /derby/app/dt-0.0.1-SNAPSHOT.war</span><br><span class="line">root         44  0.0  0.0   2312  1696 pts/0    Ss   06:40   0:00 bash</span><br><span class="line">root         45  0.0  0.0   1624   520 pts/0    R+   06:41   0:00 ps aux</span><br></pre></td></tr></table></figure>
<p>有！</p>
<p>在 pod a1 裡搞破壞</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rm -r /bin/*</span><br><span class="line">bash-4.4# ls -al /bin/</span><br><span class="line">bash: ls: command not found</span><br><span class="line">bash-4.4# exit</span><br><span class="line">exit</span><br><span class="line">command terminated with exit code 127</span><br><span class="line"></span><br><span class="line">bigred@m1:~$ kubectl exec -it a1 -- bash</span><br><span class="line">2022-05-31T06:44:14.000679204Z: 2022-05-31T06:44:14.000679086Z: executable file `bash` not found in $PATH: No such file or directory</span><br></pre></td></tr></table></figure>

<p>檢查 node 本機的 &#x2F;bin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bigred@m1:~$ ls -al /bin/</span><br></pre></td></tr></table></figure>

<p>可以發現沒被破壞</p>
<p>刪除pod a1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod a1</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="Single-Container-Pod-自動重新建立"><a href="#Single-Container-Pod-自動重新建立" class="headerlink" title="Single Container Pod 自動重新建立"></a>Single Container Pod 自動重新建立</h2><p>重新建立並執行 a1 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run a1 --image=quay.io/cloudwalker/alpine -- sleep 15</span><br></pre></td></tr></table></figure>

<p>當 pod 的狀態呈現 Compelted 時， K8s 會將 pod 浴火重生，讓 pod 再次 runnning</p>
<p>:::success<br>監控 pod a1 的狀態</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods a1 --watch</span><br></pre></td></tr></table></figure>

<p>:::spoiler 結果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NAME   READY   STATUS             RESTARTS      AGE</span><br><span class="line">a1     0/1     CrashLoopBackOff   4 (31s ago)   3m24s</span><br><span class="line">a1     1/1     Running            5 (86s ago)   4m19s</span><br><span class="line">a1     0/1     Completed          5 (101s ago)   4m34s</span><br><span class="line">a1     0/1     CrashLoopBackOff   5 (16s ago)    4m49s</span><br><span class="line">...以下省略</span><br></pre></td></tr></table></figure>
<p><font color=red>當STATUS 出現<code>CrashLoopBackOff</code> ，代表 pod 正在不斷被重啟。<br>    重啟 6 次後, 會將重啟時間拉長, 繼續重啟</font><br>:::</p>
<p>刪除 pod a1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete pod  a1</span><br></pre></td></tr></table></figure>


<hr>
<h2 id="K8S-Node-系統重新啟動"><a href="#K8S-Node-系統重新啟動" class="headerlink" title="K8S Node 系統重新啟動"></a>K8S Node 系統重新啟動</h2><p>:::success</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 建立並執行 pod a1</span></span><br><span class="line">$ kubectl run a1 --image=quay.io/ict39/alpine.derby </span><br><span class="line">pod/a1 created</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看 pod a1 的 ip 位址和所在主機</span></span><br><span class="line">$ kubectl get pod a1 -o wide | grep a1</span><br><span class="line">a1     1/1     Running   0          36s   10.244.2.10   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 將 pod a1 所在主機重新開機</span></span><br><span class="line">$ ssh w2 sudo reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># 檢查 pod a1 的狀態</span></span><br><span class="line">$ kubectl get pod a1 -o wide | grep a1</span><br><span class="line">a1     0/1     ContainerCreating   1          2m23s   &lt;none&gt;   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次檢查 pod a1 的狀態</span></span><br><span class="line">$ kubectl get pod a1 -o wide | grep a1</span><br><span class="line">a1     1/1     Running   1          2m35s   10.244.2.11   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刪除 pod a1</span></span><br><span class="line">$ kubectl delete pod  a1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><font color=red><strong>結論： pod a1 的 IP 位址會改變, 這是因爲 node 重啟時會產生一個新 Pod</strong></font><br>:::</p>
<hr>
<h2 id="Single-Container-Pod-永不重啟"><a href="#Single-Container-Pod-永不重啟" class="headerlink" title="Single Container Pod 永不重啟"></a>Single Container Pod 永不重啟</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run a1 --restart=<span class="string">&#x27;Never&#x27;</span>  --image=quay.io/cloudwalker/alpine -- <span class="built_in">sleep</span> 15</span><br><span class="line">pod/a1 created</span><br><span class="line"></span><br><span class="line">$ kubectl get pods </span><br><span class="line">NAME   READY   STATUS    RESTARTS   AGE</span><br><span class="line">a1        1/1        Running   0                 10s</span><br><span class="line"></span><br><span class="line">$ kubectl get pods </span><br><span class="line">NAME   READY   STATUS       RESTARTS   AGE</span><br><span class="line">a1        0/1       Completed   0                32s</span><br><span class="line"></span><br><span class="line">$ kubectl delete pod a1</span><br><span class="line">pod <span class="string">&quot;a1&quot;</span> deleted</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<hr>
<h2 id="建立-Share-PID-Namespace-Pod"><a href="#建立-Share-PID-Namespace-Pod" class="headerlink" title="建立 Share PID Namespace Pod"></a>建立 Share PID Namespace Pod</h2><p>先建立 wulin 工作目錄</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p ~/wulin/yaml; cd ~/wulin</span><br></pre></td></tr></table></figure>

<p>:::success<br>宣告 yaml&#x2F;yml 檔<br><font color=red><strong>超級注意！縮編格式一定要對！不然絕對噴 Error 給你看!</strong></font></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: sharepid</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  shareProcessNamespace: true</span></span><br><span class="line"><span class="string">  hostname: xyz </span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: derby</span></span><br><span class="line"><span class="string">    image: quay.io/cloudwalker/alpine.derby</span></span><br><span class="line"><span class="string">    imagePullPolicy: Always</span></span><br><span class="line"><span class="string">  - name: shell</span></span><br><span class="line"><span class="string">    image: quay.io/cloudwalker/alpine</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    tty: true  &#x27;</span> &gt; yaml/sharepid.yml</span><br></pre></td></tr></table></figure>
<ul>
<li><code>kind</code> ， 宣告要產生什麼</li>
<li><code>metadata</code> ，會宣告 pod 的名稱</li>
<li><code>spec</code> ， pod 的結構說明<ul>
<li>有兩個 image 代表有兩台 Container ， 名字分別是：derby 和 shell ，他們共用 hostname: xyz</li>
<li><code>shareProcessNamespace: true</code> ，兩台 Container 用同一個 pid 的 Namespace</li>
<li><code>tty: true</code> ，給一個虛擬終端機，因為 <code>quay.io/cloudwalker/alpine</code> 這個 image 內定執行的命令是 sh ，所以一定要有一台虛擬終端機</li>
<li><code>imagePullPolicy: Always</code> ，代表每次都要下載 image</li>
<li><code>imagePullPolicy: IfNotPresent</code> ， 代表沒有 image 再下載</li>
<li><font color=red>如果企業無法上網，就要宣告<code>imagePullPolicy: Never</code></font></li>
</ul>
</li>
<li>最後要輸出的檔名可以<code>*.yaml</code> 或是 <code>*.yml</code> 都可以。<br>:::</li>
</ul>
<p>k8s 標準的運作，透過 yaml 檔作業</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f yaml/sharepid.yml </span><br></pre></td></tr></table></figure>



<hr>
<h2 id="檢視-Pod-內部資訊"><a href="#檢視-Pod-內部資訊" class="headerlink" title="檢視 Pod 內部資訊"></a>檢視 Pod 內部資訊</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod/sharepid -o jsonpath=&#x27;&#123;.spec.containers[*].name&#125;&#x27;;echo &quot;&quot;</span><br><span class="line">derby shell</span><br></pre></td></tr></table></figure>


<p>相同電腦名稱</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec sharepid  -c shell -- hostname; kubectl exec sharepid  -c derby -- hostname</span><br><span class="line">xyz</span><br><span class="line">xyz</span><br></pre></td></tr></table></figure>
<blockquote>
<p>-c 指定Container</p>
</blockquote>
<p>共用 IP 位址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec sharepid  -c shell -- hostname -i; kubectl exec sharepid  -c derby -- hostname -i</span><br><span class="line">10.244.1.4</span><br><span class="line">10.244.1.4</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="檢測-Pod-內部-Process"><a href="#檢測-Pod-內部-Process" class="headerlink" title="檢測 Pod 內部 Process"></a>檢測 Pod 內部 Process</h2><p>登入 sharepid 中的 shell container</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -it sharepid  -c shell -- sh</span><br><span class="line">/ # whoami</span><br><span class="line">root</span><br><span class="line">/ # apk add curl</span><br><span class="line">.......</span><br><span class="line">/ # curl http://localhost:8888/hostname</span><br><span class="line">Hostname : xyz</span><br></pre></td></tr></table></figure>
<blockquote>
<p>當我們透過localhost來連接不同的 Container 時，會更有效率，速度接近記憶體的速度。</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/ # ps aux</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 /pause</span><br><span class="line">    6 root      0:00 bash -c /derby/app/startup</span><br><span class="line">   11 root      0:18 java -jar -Dderby.system.home=/derby/db /derby/app/dt-0.0.1-SNAPSHOT.war</span><br><span class="line">   53 root      0:00 /bin/sh</span><br><span class="line">   ...........</span><br><span class="line"></span><br><span class="line">/ # kill -9 1          無法 強制關閉 PID 1</span><br><span class="line">/ # kill -15 1        可以 正常關閉 PID 1</span><br><span class="line">/ # command terminated with exit code 137</span><br></pre></td></tr></table></figure>

<blockquote>
<p>K8s 中所有的 pod 一啟動一定會產生 &#x2F;pause 這台 Container ，裡面跑的程式是 sleep （睡一輩子）站在資安的角度：全球最安全的命令，老師翻成中文：睡夢羅漢</p>
</blockquote>
<h2 id="更多-POD-設定"><a href="#更多-POD-設定" class="headerlink" title="更多 POD 設定"></a>更多 POD 設定</h2><p>:::success</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: twoc</span></span><br><span class="line"><span class="string">  annotations:</span></span><br><span class="line"><span class="string">    kubectl.kubernetes.io/default-container: &quot;shell&quot;</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  shareProcessNamespace: false</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: derby</span></span><br><span class="line"><span class="string">    image: quay.io/cloudwalker/alpine.derby</span></span><br><span class="line"><span class="string">    imagePullPolicy: Never</span></span><br><span class="line"><span class="string">  - name: shell</span></span><br><span class="line"><span class="string">    image: quay.io/cloudwalker/busybox</span></span><br><span class="line"><span class="string">    command:</span></span><br><span class="line"><span class="string">      - sleep</span></span><br><span class="line"><span class="string">      - &quot;60&quot;</span></span><br><span class="line"><span class="string">  restartPolicy: Never&#x27;</span>&gt; yaml/twoc.yml</span><br></pre></td></tr></table></figure>
<ul>
<li>shareProcessNamespace: false ，如果不宣告，內定是 false。</li>
<li>restartPolicy: Never ，設定 pod 永不重啟。<br>:::</li>
</ul>
<p>建立 pod </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f yaml/twoc.yml</span><br><span class="line">pod/twoc created</span><br></pre></td></tr></table></figure>

<p>檢查</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kg pods -o wide</span><br><span class="line">NAME       READY   STATUS              RESTARTS       AGE   IP           NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">sharepid   2/2     Running             2 (6m4s ago)   32m   10.244.1.5   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">twoc       1/2     ErrImageNeverPull   0              59s   10.244.2.6   w2     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>發現 w2 的 node 沒有 derby Container 的 image</p>
<p>修改yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ nano yaml/twoc.yml</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="DNS-for-Service"><a href="#DNS-for-Service" class="headerlink" title="DNS for Service"></a>DNS for Service</h1><p>取得 K8S 叢集的 DNS IP 位址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl -n kube-system get svc</span><br><span class="line">NAME       TYPE        CLUSTER-IP  EXTERNAL-IP   PORT(S)                          AGE</span><br><span class="line">kube-dns   ClusterIP  10.98.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP  24h</span><br><span class="line"></span><br><span class="line">$ kubectl describe service kube-dns -n kube-system</span><br><span class="line">.........</span><br><span class="line">IP:                10.98.0.10</span><br><span class="line">IPs:               10.98.0.10</span><br><span class="line">Port:              dns  53/UDP</span><br><span class="line">TargetPort:        53/UDP</span><br><span class="line">Endpoints:         10.244.0.6:53,10.244.0.7:53</span><br><span class="line">Port:              dns-tcp  53/TCP</span><br><span class="line">TargetPort:        53/TCP</span><br><span class="line">Endpoints:         10.244.0.6:53,10.244.0.7:53</span><br><span class="line">Port:              metrics  9153/TCP</span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line">$ kubectl get pods -n kube-system -o wide | grep coredns</span><br><span class="line">coredns-78fcd69978-5v6cd     1/1     Running   2          5d3h   10.244.0.6      m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-78fcd69978-j4z9r     1/1     Running   2          5d3h   10.244.0.7      m1     &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>kube-dns</code> ，它的 IP 位址會固定在 <code>&lt;network_id&gt;.10</code> ，只有 network_id 可以自己設，預設尾數是 10 ，開的 port : 53</li>
<li>透過 <code>kubectl describe</code> 看 <code>kube-dns</code> 詳細的資訊，可以看到 <code>Endpoints:</code> 有兩個 IP 位址，代表後面有兩個 pod 在運作</li>
<li>因 pod 浴火重生 IP 位址可能會發生變化，只有 K8S 的服務會鎖在一個 IP 位址，透過 <code>Selector</code> 來抓到對應的 pod<ul>
<li>服務不會浴火重生，它只是一個儲存在 etcd 裡面的資料區塊，記錄著自己的 IP 位址，及自己真正在運作的 pod 是誰，還有紀錄整個 K8S pod 的 IP 位址及它們的 domain name</li>
</ul>
</li>
</ul>
<p><img src="https://i.imgur.com/ud14Cy4.png"></p>
<ul>
<li>當 K8S 內部的 pod 要上網時， <code>kube-dns</code> 會提供 <strong>名稱解析的服務</strong>，讓我們的 pod 得到要上網的 IP 位址。</li>
<li>當我們建立一個 mysrv 的 service ，這時候他會去和 <code>kube-dns</code> 註冊自己的網址和對應的 IP 位址 ( A record )</li>
</ul>
<p><img src="https://i.imgur.com/PK4jp46.png"></p>
<ul>
<li>無頭服務 ( <code>headless</code> ) 的特性 : service 本身不會有 IP 位址，他一樣會去跟 <code>kube-dns</code> 註冊，不過註冊的資訊會有 pod 的名字及 pod 的 IP 位址 (以上是老師的小秘笈)<ul>
<li>標準的作法是 ，他一樣會去跟 <code>kube-dns</code> 註冊，註冊的資訊是自己 service 本身的名字及對應 pod 的 IP 位址</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run d1 -it --image=quay.io/cloudwalker/alpine</span><br><span class="line">If you dont see a command prompt, try pressing enter.</span><br><span class="line">/ # cat /etc/resolv.conf</span><br><span class="line">search default.svc.k8s.io svc.k8s.io k8s.io localdomain</span><br><span class="line">nameserver 10.98.0.10</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line">/ # ping www.hinet.net</span><br><span class="line">PING www.hinet.net (203.66.32.110): 56 data bytes</span><br><span class="line"></span><br><span class="line">/ # exit</span><br></pre></td></tr></table></figure>

<p><strong>DNS for Service</strong></p>
<p>編輯 yaml 檔</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ nano yaml/service-dns.yaml</span><br></pre></td></tr></table></figure>


<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">k8s-nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">k8s-nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">k8s-nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-cluster</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">k8s-nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">svc-headless</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">k8s-nginx</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure>

<p><strong>透過 <code>kubectl create</code> 產生 yaml 檔中的物件(包含 : deployment, svc-cluster, svc-headless)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f yaml/service-dns.yaml</span><br></pre></td></tr></table></figure>

<p>檢查</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kg all</span><br><span class="line">NAME                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/k8s-nginx-56975f8f86-f49nr   1/1     Running   0          4m40s</span><br><span class="line">pod/k8s-nginx-56975f8f86-hf4zh   1/1     Running   0          4m40s</span><br><span class="line">pod/k8s-nginx-56975f8f86-qk727   1/1     Running   0          4m40s</span><br><span class="line"></span><br><span class="line">NAME                   TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/kubernetes     ClusterIP   10.98.0.1     &lt;none&gt;        443/TCP   17d</span><br><span class="line">service/svc-cluster    ClusterIP   10.98.0.179   &lt;none&gt;        80/TCP    4m40s</span><br><span class="line">service/svc-headless   ClusterIP   None          &lt;none&gt;        80/TCP    4m40s</span><br><span class="line"></span><br><span class="line">NAME                        READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/k8s-nginx   3/3     3            3           4m40s</span><br><span class="line"></span><br><span class="line">NAME                                   DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/k8s-nginx-56975f8f86   3         3         3       4m40s</span><br></pre></td></tr></table></figure>

<p>檢視 Service endpoints，當前的服務用的是相同的 pod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get endpoints svc-cluster</span><br><span class="line">NAME          ENDPOINTS                                      AGE</span><br><span class="line">svc-cluster   10.244.1.35:80,10.244.2.35:80,10.244.2.36:80   8m25s</span><br><span class="line"></span><br><span class="line">$ kubectl get endpoints svc-headless</span><br><span class="line">NAME           ENDPOINTS                                      AGE</span><br><span class="line">svc-headless   10.244.1.35:80,10.244.2.35:80,10.244.2.36:80   8m31s</span><br></pre></td></tr></table></figure>

<p><strong>查詢 Service IP</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ nslookup</span><br><span class="line">&gt; server 10.98.0.10</span><br><span class="line">Default server: 10.98.0.10</span><br><span class="line">Address: 10.98.0.10#53</span><br><span class="line">&gt; svc-headless.default.svc.k8s.org</span><br><span class="line">Server:         10.98.0.10</span><br><span class="line">Address:        10.98.0.10#53</span><br><span class="line"></span><br><span class="line">Name:   svc-headless.default.svc.k8s.org</span><br><span class="line">Address: 10.244.1.35</span><br><span class="line">Name:   svc-headless.default.svc.k8s.org</span><br><span class="line">Address: 10.244.2.35</span><br><span class="line">Name:   svc-headless.default.svc.k8s.org</span><br><span class="line">Address: 10.244.2.36</span><br><span class="line"></span><br><span class="line">&gt; svc-cluster.default.svc.k8s.org</span><br><span class="line">Server:		10.96.0.10</span><br><span class="line">Address:	10.96.0.10#53</span><br><span class="line"></span><br><span class="line">Name:   svc-cluster.default.svc.k8s.org</span><br><span class="line">Address: 10.98.0.3</span><br><span class="line">&gt; exit</span><br></pre></td></tr></table></figure>

<ul>
<li>透過 <code>nslookup</code> ，設定 <code>DNS server</code> 是 <code>10.98.0.10</code> (Kube-dns) 後，來檢視我們建立的服務 dns 資訊</li>
<li><code>svc-headless.default.svc.k8s.org</code> <ul>
<li>名字的組成 : <code>服務名稱.服務所在的namespace.svc.k8s.org</code></li>
<li><code>svc</code> ，代表是 service 的紀錄</li>
<li><code>k8s.org</code> ，是我們在 init K8S 的時候設定的</li>
</ul>
</li>
<li><code>A record</code>，由一個 <code>Name</code> + 一個 <code>IP Address</code> 組成</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; kube-dns.kube-system.svc.k8s.org</span><br><span class="line">Server:         10.98.0.10</span><br><span class="line">Address:        10.98.0.10#53</span><br><span class="line"></span><br><span class="line">Name:   kube-dns.kube-system.svc.k8s.org</span><br><span class="line">Address: 10.98.0.10</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run d1 --rm -it --image=quay.io/cloudwalker/alpine</span><br><span class="line">/ # ping svc-cluster</span><br><span class="line">PING svc-cluster (10.98.0.174): 56 data bytes</span><br><span class="line">ping: permission denied (are you root?)</span><br><span class="line"></span><br><span class="line">/ # ping svc-headless</span><br><span class="line">PING svc-headless (10.244.1.6): 56 data bytes</span><br><span class="line">ping: permission denied (are you root?)</span><br><span class="line"></span><br><span class="line">/ # ping svc-headless</span><br><span class="line">PING svc-headless (10.244.2.10): 56 data bytes</span><br><span class="line">ping: permission denied (are you root?)</span><br><span class="line"></span><br><span class="line">/ # ping svc-headless</span><br><span class="line">PING svc-headless (10.244.1.6): 56 data bytes</span><br><span class="line">ping: permission denied (are you root?)</span><br><span class="line">/ # exit</span><br></pre></td></tr></table></figure>

<ul>
<li>為何只打 <code>ping svc-cluster</code> 名稱就能解析出 IP 位址 ?</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl run d1 --rm -it --image=quay.io/cloudwalker/alpine</span><br><span class="line">If you don&#x27;t see a command prompt, try pressing enter.</span><br><span class="line">/ # cat /etc/resolv.conf</span><br><span class="line">search default.svc.k8s.org svc.k8s.org k8s.org mcu.edu.tw</span><br><span class="line">nameserver 10.98.0.10</span><br><span class="line">options ndots:5</span><br></pre></td></tr></table></figure>

<ul>
<li>因為 <code>search default.svc.k8s.org svc.k8s.org k8s.org mcu.edu.tw</code> <ul>
<li>這行表示我們在 <code>ping svc-cluster</code> 時，會自動幫我們在名稱後面加上 search 後面的字串做收尋，如 : <code>ping svc-cluster.default.svc.k8s.org</code> 找不到時，會在換後面的字串 <code>ping svc-cluster.svc.k8s.org</code> 做收尋，依此類推，一直到最後一個字串，如果都沒有就表示無法解析</li>
</ul>
</li>
</ul>
<p><strong>建立 POD 之間的 DNS 名稱解析</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ nano ~/wulin/yaml/svcfqdn.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: dt</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    name: busybox</span><br><span class="line">  clusterIP: None</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f  ~/wulin/yaml/svcfqdn.yaml </span><br><span class="line">service/dt created</span><br><span class="line"></span><br><span class="line">$ kubectl get svc dt</span><br><span class="line">NAME   TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">dt        ClusterIP   None           &lt;none&gt;          &lt;none&gt;    23s</span><br></pre></td></tr></table></figure>

<p><strong>新增 Pod 的搜尋網域名</strong></p>
<p>透過 <code>nano ~/wulin/yaml/podfqdn.yaml</code> 來編輯 yaml 檔</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">b1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">b1</span></span><br><span class="line">  <span class="attr">subdomain:</span> <span class="string">dt</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/alpine</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">add:</span> [<span class="string">&quot;CAP_NET_RAW&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">b2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">b2</span></span><br><span class="line">  <span class="attr">subdomain:</span> <span class="string">dt</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/alpine</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">securityContext:</span></span><br><span class="line">      <span class="attr">capabilities:</span></span><br><span class="line">        <span class="attr">add:</span> [<span class="string">&quot;CAP_NET_RAW&quot;</span>]</span><br></pre></td></tr></table></figure>

<ul>
<li><pre><code>spec:
hostname: b1
subdomain: dt
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">    - subdomain ，可以讓我們在 ping 的時候，在 pod 的名字後面 + `dt` ，就能被解析</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">```bash!</span><br><span class="line">$ kubectl apply -f ~/wulin/yaml/podfqdn.yaml </span><br><span class="line"></span><br><span class="line">$ kubectl exec -it b2 -- sh</span><br><span class="line">/ # ping -c 1 b1.dt.default.svc.k8s.org</span><br><span class="line">PING b1.dt.default.svc.k8s.org (10.244.2.8): 56 data bytes</span><br><span class="line">.........</span><br><span class="line"></span><br><span class="line"># 可解析簡易名稱</span><br><span class="line">/ # ping -c 1 b1.dt</span><br><span class="line">PING b1.dt (10.244.2.8): 56 data bytes</span><br><span class="line">.........</span><br><span class="line"></span><br><span class="line">/ # apk add nano; nano /etc/resolv.conf</span><br><span class="line">search  dt.default.svc.k8s.org default.svc.k8s.org svc.k8s.org localdomain</span><br><span class="line">nameserver 10.98.0.10</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line">/ # ping -c 1 b1</span><br><span class="line">PING b1 (10.244.2.8): 56 data bytes</span><br><span class="line">.........</span><br><span class="line">/ # exit</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<h3 id="新增-Pod-的搜尋網域名"><a href="#新增-Pod-的搜尋網域名" class="headerlink" title="新增 Pod 的搜尋網域名"></a>新增 Pod 的搜尋網域名</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete -f ~/wulin/yaml/podfqdn.yaml</span><br><span class="line"></span><br><span class="line">$ nano ~/wulin/yaml/podfqdn.yaml</span><br><span class="line">..............</span><br><span class="line">spec:</span><br><span class="line">  hostname: b2</span><br><span class="line">  subdomain: dt</span><br><span class="line">  containers:</span><br><span class="line">  - image: quay.io/cloudwalker/alpine</span><br><span class="line">    imagePullPolicy: Always</span><br><span class="line">    command:</span><br><span class="line">      - sleep</span><br><span class="line">      - &quot;3600&quot;</span><br><span class="line">    name: busybox</span><br><span class="line">    securityContext:</span><br><span class="line">      capabilities:</span><br><span class="line">        add: [&quot;CAP_NET_RAW&quot;]</span><br><span class="line">  dnsConfig:</span><br><span class="line">    searches:</span><br><span class="line">    - dt.default.svc.k8s.org</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f ~/wulin/yaml/podfqdn.yaml </span><br><span class="line"></span><br><span class="line">$ kubectl exec -it b2 -- sh</span><br><span class="line">/ # cat /etc/resolv.conf</span><br><span class="line">search default.svc.k8s.org svc.k8s.org k8s.org localdomain dt.default.svc.k8s.org</span><br><span class="line">nameserver 10.98.0.10</span><br><span class="line">options ndots:5</span><br><span class="line"></span><br><span class="line">/ # ping -c 1 b1</span><br><span class="line">PING b1 (10.244.2.3): 56 data bytes</span><br><span class="line">64 bytes from 10.244.2.3: seq=0 ttl=62 time=0.590 ms</span><br><span class="line"></span><br><span class="line">--- b1 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 packets received, 0% packet loss</span><br><span class="line">round-trip min/avg/max = 0.590/0.590/0.590 ms</span><br><span class="line"></span><br><span class="line">/ # exit</span><br></pre></td></tr></table></figure>



<h2 id="佈署-Kubernetes-Job-Controller"><a href="#佈署-Kubernetes-Job-Controller" class="headerlink" title="佈署 Kubernetes Job Controller"></a>佈署 Kubernetes Job Controller</h2><p>建立 Kubernetes Job Controller</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  name: job1</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: job</span><br><span class="line">          image: quay.io/cloudwalker/busybox</span><br><span class="line">          args:</span><br><span class="line">            - /bin/sh</span><br><span class="line">            - -c</span><br><span class="line">            - date; echo sleeping....; sleep 30s; echo exiting...; date</span><br><span class="line">      restartPolicy: Never &#x27; &gt;  ~/wulin/yaml/job01.yaml</span><br><span class="line"></span><br><span class="line">$ ka -f yaml/job01.yaml</span><br><span class="line"></span><br><span class="line">$ kg job</span><br><span class="line">NAME   COMPLETIONS   DURATION   AGE</span><br><span class="line">job1   1/1           44s        5m26s</span><br><span class="line"></span><br><span class="line">$ kubectl get pod -l=job-name=job1</span><br><span class="line">NAME         READY   STATUS      RESTARTS   AGE</span><br><span class="line">job1-9b8xz   0/1     Completed   0          119m</span><br></pre></td></tr></table></figure>


<p>修改 yaml 檔</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">batch/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Job</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">job1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">job</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/cloudwalker/busybox</span></span><br><span class="line">          <span class="attr">args:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">date;</span> <span class="string">echo</span> <span class="string">sleeping....;</span> <span class="string">sleep</span> <span class="string">30s;</span> <span class="string">echo</span> <span class="string">exiting...;</span> <span class="string">date</span></span><br><span class="line">      <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure>

<p>apply 它</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ka -f yaml/job01.yaml</span><br><span class="line">The Job &quot;job1&quot; is invalid: spec.template.spec.restartPolicy: Required value: valid values: &quot;OnFailure&quot;, &quot;Never&quot;</span><br></pre></td></tr></table></figure>

<p>檢視 Kubernetes Job Controller</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ echo &#x27;apiVersion: batch/v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  name: job2</span><br><span class="line">spec:</span><br><span class="line">  activeDeadlineSeconds: 5</span><br><span class="line">  template:</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: job2</span><br><span class="line">          image: busybox</span><br><span class="line">          args:</span><br><span class="line">            - /bin/sh</span><br><span class="line">            - -c</span><br><span class="line">            - date; echo sleeping....; sleep 30s; echo exiting...; date</span><br><span class="line">      restartPolicy: Never &#x27; &gt;  ~/wulin/yaml/job02.yaml</span><br><span class="line"></span><br><span class="line">$ ka -f yaml/job02.yaml</span><br></pre></td></tr></table></figure>

<ul>
<li><code>activeDeadlineSeconds: 5</code> ，設定 Job 只能跑 5  秒，時間到會停止</li>
</ul>
<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/08/28/Kubernetes-Objects/" data-id="clhda4way000rj0w7e3726tte" data-title="Kubernetes-Objects" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%B3%BB%E7%B5%B1%E5%B7%A5%E7%A8%8B/" rel="tag">系統工程</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Kubernetes yaml 檔輔助器" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/15/Kubernetes%20yaml%20%E6%AA%94%E8%BC%94%E5%8A%A9%E5%99%A8/" class="article-date">
  <time class="dt-published" datetime="2022-06-14T21:30:26.000Z" itemprop="datePublished">2022-06-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/06/15/Kubernetes%20yaml%20%E6%AA%94%E8%BC%94%E5%8A%A9%E5%99%A8/">Kubernetes yaml 檔輔助器</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Kubernetes-yaml-檔輔助器"><a href="#Kubernetes-yaml-檔輔助器" class="headerlink" title="Kubernetes yaml 檔輔助器"></a>Kubernetes yaml 檔輔助器</h1><ul>
<li><p>安裝 vscode</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/stackrox/kube-linter">cli 的輔助器</a></p>
</li>
</ul>
<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/15/Kubernetes%20yaml%20%E6%AA%94%E8%BC%94%E5%8A%A9%E5%99%A8/" data-id="clhda4waw000jj0w7d8d46gfi" data-title="Kubernetes yaml 檔輔助器" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%B3%BB%E7%B5%B1%E5%B7%A5%E7%A8%8B/" rel="tag">系統工程</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Kubernetes Grafana" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/15/Kubernetes%20Grafana/" class="article-date">
  <time class="dt-published" datetime="2022-06-14T16:56:34.000Z" itemprop="datePublished">2022-06-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/06/15/Kubernetes%20Grafana/">Kubernetes Grafana</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Kubernetes-Grafana"><a href="#Kubernetes-Grafana" class="headerlink" title="Kubernetes Grafana"></a>Kubernetes Grafana</h1><h2 id="部署-Grafana-on-K8S"><a href="#部署-Grafana-on-K8S" class="headerlink" title="部署 Grafana on K8S"></a>部署 Grafana on K8S</h2><p>環境準備<br>CNT.2022.v4 K8S 叢集建置完成<br>以下 K8S 公設完成部署</p>
<ul>
<li>MetalLB</li>
<li>Ingress NGINX Controller</li>
<li>Local Path Provisioner</li>
</ul>
<p>在 Windows 系統的 cmd 視窗登入 m1 主機</p>
<h2 id="部署-Grafana"><a href="#部署-Grafana" class="headerlink" title="部署 Grafana"></a>部署 Grafana</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create ns gf</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f https://web.flymks.com/grafana/v1/grafana.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">## 確認部署狀態</span></span><br><span class="line">$ kubectl get all -n gf</span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod/grafana-84ff489848-lrqr4   1/1     Running   0          6m18s</span><br><span class="line">pod/mariadb-7fc4547b95-krc9c   1/1     Running   0          6m18s</span><br><span class="line"></span><br><span class="line">NAME              TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">service/grafana   ClusterIP   10.98.0.180   &lt;none&gt;        3000/TCP   6m18s</span><br><span class="line">service/mariadb   ClusterIP   None          &lt;none&gt;        &lt;none&gt;     6m18s</span><br><span class="line"></span><br><span class="line">NAME                      READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps/grafana   1/1     1            1           6m18s</span><br><span class="line">deployment.apps/mariadb   1/1     1            1           6m18s</span><br><span class="line"></span><br><span class="line">NAME                                 DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps/grafana-84ff489848   1         1         1       6m18s</span><br><span class="line">replicaset.apps/mariadb-7fc4547b95   1         1         1       6m18s</span><br></pre></td></tr></table></figure>

<h2 id="登入-Grafana"><a href="#登入-Grafana" class="headerlink" title="登入 Grafana"></a>登入 Grafana</h2><p>打開瀏覽器，網址 <code>http://gf.k8s.org</code></p>
<p>帳號：grafana<br>密碼：Grafana12345</p>
<h2 id="新增-Data-Sources"><a href="#新增-Data-Sources" class="headerlink" title="新增 Data Sources"></a>新增 Data Sources</h2><p>點 ‘Configuration’ (左側齒輪)<br>點 ‘Add data source’ (中間藍色框)<br>點 ‘Mysql’<br>MySQL Connection</p>
<ul>
<li>Host: mariadb.landlord.svc:3306<ul>
<li>Database: landlord</li>
<li>User: landlord</li>
<li>Password: mymariadblandlord</li>
</ul>
</li>
</ul>
<h2 id="新增-Dashboard"><a href="#新增-Dashboard" class="headerlink" title="新增 Dashboard"></a>新增 Dashboard</h2><p>點 ‘Create’ (左側 +)<br>點 ‘Refresh dashboard’ (右上倒三角)<br>點 ‘5s’<br>點 ‘Save dashboard’<br>取名為 Building</p>
<h2 id="新增-Panel"><a href="#新增-Panel" class="headerlink" title="新增 Panel"></a>新增 Panel</h2><p><img src="https://i.imgur.com/TE9izsN.png"></p>
<h2 id="版面說明"><a href="#版面說明" class="headerlink" title="版面說明"></a>版面說明</h2><p><img src="https://i.imgur.com/PRoqmNY.png"></p>
<h2 id="設定時鐘"><a href="#設定時鐘" class="headerlink" title="設定時鐘"></a>設定時鐘</h2><p>Panel 選單選取 ‘Clock’<br>Panel 設定</p>
<ul>
<li>Panel options<ul>
<li>Title: Time</li>
<li>Time Format</li>
</ul>
</li>
<li>Clock Type: 24 Hour<ul>
<li>Font size: 20px</li>
<li>Font size: Bold</li>
</ul>
</li>
<li>Date Options<ul>
<li>Font size: 16px</li>
</ul>
</li>
</ul>
<h2 id="設計-History-表格"><a href="#設計-History-表格" class="headerlink" title="設計 History 表格"></a>設計 History 表格</h2><p>Panel 選單選 ‘Table’<br>Panel 設定<br>Panel options<br>Title: History<br>Database Query<br>Edit SQL<br>SELECT * FROM history<br>Format as: Table</p>
<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/15/Kubernetes%20Grafana/" data-id="clhda4war0004j0w73p3r99z5" data-title="Kubernetes Grafana" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%B3%BB%E7%B5%B1%E5%B7%A5%E7%A8%8B/" rel="tag">系統工程</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Kubernetes Multi Tenancy" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/13/Kubernetes%20Multi%20Tenancy/" class="article-date">
  <time class="dt-published" datetime="2022-06-13T00:43:54.000Z" itemprop="datePublished">2022-06-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/06/13/Kubernetes%20Multi%20Tenancy/">Kubernetes Multi Tenancy</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Kubernetes-Multi-Tenancy"><a href="#Kubernetes-Multi-Tenancy" class="headerlink" title="Kubernetes Multi Tenancy"></a>Kubernetes Multi Tenancy</h1><h2 id="認識-Kubernetes-AA"><a href="#認識-Kubernetes-AA" class="headerlink" title="認識 Kubernetes AA"></a>認識 Kubernetes AA</h2><p>AuthN abbreviates AuthenticatioN: this is the process of verifying the user’s identity and decide whether she is legitimated to access your system.</p>
<ul>
<li>認證你是誰</li>
</ul>
<p>AuthZ abbreviates AuthoriZation: this is the process of verifying what an authenticated user can do within your system.</p>
<ul>
<li>認證你可以做什麼事情</li>
</ul>
<h3 id="確認環境乾淨"><a href="#確認環境乾淨" class="headerlink" title="確認環境乾淨"></a>確認環境乾淨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get all</span><br><span class="line">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">service/kubernetes   ClusterIP   10.98.0.1    &lt;none&gt;        443/TCP   13d</span><br><span class="line">bigred@m1:~/0613$ kubectl get pvc</span><br><span class="line">No resources found <span class="keyword">in</span> default namespace.</span><br></pre></td></tr></table></figure>

<h3 id="建立使用者憑證"><a href="#建立使用者憑證" class="headerlink" title="建立使用者憑證"></a>建立使用者憑證</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> kuser; <span class="built_in">cd</span> kuser</span><br><span class="line">$ <span class="built_in">mkdir</span> user01; <span class="built_in">cd</span> user01</span><br><span class="line"></span><br><span class="line"><span class="comment">## 產生私鑰</span></span><br><span class="line">$ openssl genrsa -out private.key 2048</span><br><span class="line">Generating RSA private key, 2048 bit long modulus (2 primes)</span><br><span class="line">..............................+++++</span><br><span class="line">.......................+++++</span><br><span class="line">e is 65537 (0x010001)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 檢視 CSR 內容</span></span><br><span class="line"><span class="comment">## 產生請求檔</span></span><br><span class="line"><span class="comment">## CN 使用者帳號</span></span><br><span class="line"><span class="comment">## O 使用者群組</span></span><br><span class="line">$ openssl req -new -key private.key -out CSR.csr -subj <span class="string">&quot;/CN=user01/O=user01&quot;</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> -l</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r-- 1 bigred bigred  911 Jun 13 13:22 CSR.csr</span><br><span class="line">-rw------- 1 bigred bigred 1675 Jun 13 13:22 private.key</span><br><span class="line"></span><br><span class="line">$ openssl req -noout -subject -<span class="keyword">in</span> CSR.csr</span><br><span class="line">subject=CN = user01, O = user01</span><br><span class="line"></span><br><span class="line"><span class="comment">## Base64 格式的 CSR</span></span><br><span class="line">$ <span class="built_in">cat</span> CSR.csr | <span class="built_in">base64</span> | <span class="built_in">tr</span> -d <span class="string">&#x27;\n&#x27;</span>; <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line">LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ1p6Q0NBVThDQVFBd0lqRVBNQTBHQTFVRUF3d0dkWE5sY2pBeE1ROHdEUVlEVlFRS0RBWjFjMlZ5TURFdwpnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFEQ0c2ZEd0RDE2VDNIWGh4d0pqQUcxCkFuUkVjYVNXWm1Zc3kvSStBZmNSVWdFM2hMRzd3SjhjWGhIWURFcWZqcHhGWGw0bFJCaVYvNWJLSUloVVo3RW8KS2dSMEZTVHQ3WWU3cDFSVzhNTVA2QkdUUXR4d0Fub1M3T2dIOGp4WWRmV2tNK3ZHVVgrbjd2Zjg4UTlsZ0Frago2NHJGNTlJSUFRVzdWMHdXTVlpbW1VUHhqK085Z2o5WEVtYTU0U1dHZ0thb0xvWDJrVkl4V2d3b1dzWnBCUUdSCkdieEZhVnFGSUQyNEh2aFVVbFIrL0RBTEFJb1VkN3htNzJ0ejk2cWVseUFKelpYU0RjN0pDSHRMMWN4SndGZFkKYm55V2pubUx4RW5JYUdqL0lDL0E3c3pMazlNUHZVbVVtQkZJdlFuMm9OeXU2WDdNU3ZwZGJOdlhtdkFBaHdaSApBZ01CQUFHZ0FEQU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFRTEhqNktQVzNIbjdiQ240Wm9BYmVzdnVWbDR1CkRvMURsNGpWY2Y0OUs2L20zb1p1RU5yZDlBeTFoYmR0eFI5MGpJb2IyWFhjcUFKV25EaFJtenpoQkdsczU5QW0KbStmNjBVN3FKS1I4V2RadnNqWkR3a0RoSGxDQjNJSjRNTVpQS3hVWU5tM1JKL1RoNVg3KzJnMytUQnpoUWI3LwplK3Q5MDhtM1lBeTN0Z2VzZDZFcDg1NVBPT3dFSCt2THZRY3k4djhwdDhwVWxkeXBYVk9hN2lzUHJQdzczT2t2CkhocStNTXFDeGEvaE12MFVFUVdNaWZ4THFJMUNrSnZFZVF3U09iM3gzdDR2Wm1vcDhZUVRSYTQyclJpemJYWTUKczRiWVNWdUh5ZitsYVFNQkdZNEdkVDE5Tml2Q1VOaWFZOGZ4VnlidDdEdER0ODUxY0hmTnVML2pYUT09Ci0tLS0tRU5EIENFUlRJRklDQVRFIFJFUVVFU1QtLS0tLQo=</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">export</span> BASE64_CSR=$(<span class="built_in">base64</span> &lt; CSR.csr | <span class="built_in">tr</span> -d <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 上傳 CSR 至 K8S</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: certificates.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: CertificateSigningRequest</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: user01-csr</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  groups:</span></span><br><span class="line"><span class="string">    - system:authenticated</span></span><br><span class="line"><span class="string">  request: $&#123;BASE64_CSR&#125;</span></span><br><span class="line"><span class="string">  signerName: kubernetes.io/kube-apiserver-client</span></span><br><span class="line"><span class="string">  expirationSeconds: 1800 # 30 Min</span></span><br><span class="line"><span class="string">  usages:</span></span><br><span class="line"><span class="string">    - client auth&#x27;</span> &gt; csr.yaml</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> csr.yaml | envsubst | kubectl apply -f -</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/user01-csr created</span><br><span class="line"></span><br><span class="line"><span class="comment">## 許可憑證</span></span><br><span class="line">$ kubectl get csr</span><br><span class="line">NAME         AGE   SIGNERNAME                            REQUESTOR          REQUESTEDDURATION   CONDITION</span><br><span class="line">user01-csr   41s   kubernetes.io/kube-apiserver-client   kubernetes-admin   30m                 Pending</span><br><span class="line"></span><br><span class="line">$ kubectl certificate approve user01-csr</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/user01-csr approved</span><br><span class="line"></span><br><span class="line">$ kubectl get csr</span><br><span class="line">NAME         AGE   SIGNERNAME                            REQUESTOR          REQUESTEDDURATION   CONDITION</span><br><span class="line">user01-csr   55s   kubernetes.io/kube-apiserver-client   kubernetes-admin   30m                 Approved,Issued</span><br><span class="line"></span><br><span class="line"><span class="comment">## 下載許可憑證</span></span><br><span class="line">$ kubectl get csr user01-csr -o jsonpath=<span class="string">&#x27;&#123;.status.certificate&#125;&#x27;</span> | <span class="built_in">base64</span> -d &gt; k8s-signed.crt</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> k8s-signed.crt</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIDCDCCAfCgAwIBAgIRAKEA0ts5MHzGleKU1MOrPAswDQYJKoZIhvcNAQELBQAw</span><br><span class="line">FTETMBEGA1UEAxMKa3ViZXJuZXRlczAeFw0yMjA2MTMwNTIwMTBaFw0yMjA2MTMw</span><br><span class="line">NTU1MTBaMCIxDzANBgNVBAoTBnVzZXIwMTEPMA0GA1UEAxMGdXNlcjAxMIIBIjAN</span><br><span class="line">BgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwhunRrQ9ek9x14ccCYwBtQJ0RHGk</span><br><span class="line">lmZmLMvyPgH3EVIBN4Sxu8CfHF4R2AxKn46cRV5eJUQYlf+WyiCIVGexKCoEdBUk</span><br><span class="line">7e2Hu6dUVvDDD+gRk0LccAJ6EuzoB/I8WHX1pDPrxlF/p+73/PEPZYAJI+uKxefS</span><br><span class="line">CAEFu1dMFjGIpplD8Y/jvYI/VxJmueElhoCmqC6F9pFSMVoMKFrGaQUBkRm8RWla</span><br><span class="line">hSA9uB74VFJUfvwwCwCKFHe8Zu9rc/eqnpcgCc2V0g3OyQh7S9XMScBXWG58lo55</span><br><span class="line">i8RJyGho/yAvwO7My5PTD71JlJgRSL0J9qDcrul+zEr6XWzb15rwAIcGRwIDAQAB</span><br><span class="line">o0YwRDATBgNVHSUEDDAKBggrBgEFBQcDAjAMBgNVHRMBAf8EAjAAMB8GA1UdIwQY</span><br><span class="line">MBaAFLVzbcvg3zKcW7sqsazkDmMpdrRgMA0GCSqGSIb3DQEBCwUAA4IBAQA/dTMI</span><br><span class="line">xV8K7WmN93nVCrhdhO49PB+E8/IV/Sl0sR8/9ZH/ue1Z8+mYM+lK3eGncNnCBulm</span><br><span class="line">Uj5mFkoGxSgq+HIMlANTLz29wvZptU+GlnjFwqgejVF2srZOX1SZqGTj6GQEFMiG</span><br><span class="line">QWKSixRq8VA9umacx9e/9WJ2pEANO8eqsSnWqS8i6mcW98tuE1MSuSxe0Ld/3GK7</span><br><span class="line">5ijM9AyrLkOMZPs4qTHbIZnkpMKhAGLggwl/cWUQ8iRrAZUI+ywvMatVGch9X41x</span><br><span class="line">60upWoReRY8ofvfE+PbNeaZRY8bDMq6fdw91rZHvniSyRTXOVcFuGMQbzlLDJ54j</span><br><span class="line">JhVHdp7rI37uqYpK</span><br><span class="line">-----END CERTIFICATE-----</span><br><span class="line"></span><br><span class="line">$ openssl x509 -noout -subject -<span class="keyword">in</span> k8s-signed.crt</span><br><span class="line">subject=O = user01, CN = user01</span><br></pre></td></tr></table></figure>

<p>注意，不管請求檔狀態如何，過了一定的時間以後， K8s 會自動刪除</p>
<hr>
<h3 id="產生使用者的-kubeconfig"><a href="#產生使用者的-kubeconfig" class="headerlink" title="產生使用者的 kubeconfig"></a>產生使用者的 kubeconfig</h3><p><code>$ kubectl config view --flatten=true</code>得到的結果與<code>$ cat ~/.kube/config</code> 相同</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl config view --flatten=<span class="literal">true</span> | <span class="built_in">head</span> -n 6 &gt; config.tmp</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;contexts:</span></span><br><span class="line"><span class="string">&gt;   - context:</span></span><br><span class="line"><span class="string">&gt;       cluster: kubernetes</span></span><br><span class="line"><span class="string">&gt;       user: user01</span></span><br><span class="line"><span class="string">&gt;     name: user01-context</span></span><br><span class="line"><span class="string">&gt; current-context: user01-context</span></span><br><span class="line"><span class="string">&gt; kind: Config</span></span><br><span class="line"><span class="string">&gt; preferences: &#123;&#125;</span></span><br><span class="line"><span class="string">&gt; users:</span></span><br><span class="line"><span class="string">&gt;   - name: user01</span></span><br><span class="line"><span class="string">&gt;     user:</span></span><br><span class="line"><span class="string">&gt;       client-certificate-data: $&#123;K8S_CRT&#125;</span></span><br><span class="line"><span class="string">&gt;       client-key-data: $&#123;K8S_KEY&#125;&#x27;</span> &gt;&gt; config.tmp</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">export</span> K8S_CRT=$(<span class="built_in">base64</span> &lt; k8s-signed.crt | <span class="built_in">tr</span> -d <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">export</span> K8S_KEY=$(<span class="built_in">base64</span> &lt; private.key | <span class="built_in">tr</span> -d <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> config.tmp | envsubst &gt; config</span><br><span class="line"></span><br><span class="line">$ sudo podman run -it --<span class="built_in">rm</span> --name k1 -d quay.io/flysangel/image:landlord.kubectl bash</span><br><span class="line">Trying to pull quay.io/flysangel/image:landlord.kubectl...</span><br><span class="line">Getting image <span class="built_in">source</span> signatures</span><br><span class="line">Copying blob ce67b7059232 <span class="keyword">done</span></span><br><span class="line">Copying blob df9b9388f04a skipped: already exists</span><br><span class="line">Copying blob 6a897ff1da73 <span class="keyword">done</span></span><br><span class="line">Copying blob 4e828f1a37ea <span class="keyword">done</span></span><br><span class="line">Copying config 47ef1553bd <span class="keyword">done</span></span><br><span class="line">Writing manifest to image destination</span><br><span class="line">Storing signatures</span><br><span class="line">a153d0c3fcb2b1ccb77ed403661a512d4f6a007c8a8bd57f67c620cdff302674</span><br><span class="line"></span><br><span class="line">bigred@m1:~/0613/kuser/user01$ sudo podman <span class="built_in">cp</span> config k1:/home/bigred/.kube/config</span><br><span class="line"></span><br><span class="line">bigred@m1:~/0613/kuser/user01$ sudo podman <span class="built_in">exec</span> -it k1 bash</span><br><span class="line"></span><br><span class="line"><span class="comment">## 認證失效，時間超過 30 分鐘</span></span><br><span class="line">bash-5.1$ kubectl get pod</span><br><span class="line">error: You must be logged <span class="keyword">in</span> to the server (Unauthorized)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 如未超過時間限制，錯誤訊息應如下</span></span><br><span class="line">Bash-5.1$ kubectl get pod</span><br><span class="line">Error from server (Forbidden): pods is forbidden: User <span class="string">&quot;user01&quot;</span> cannot list resource <span class="string">&quot;pods&quot;</span> <span class="keyword">in</span> API group <span class="string">&quot;&quot;</span> <span class="keyword">in</span> the namespace <span class="string">&quot;default&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="練習"><a href="#練習" class="headerlink" title="練習"></a>練習</h3><p>請問 K8S etcd 是否存有使用者資訊。<br>請重新建立 K8S user01 帳號<br>使用效期為 1 年<br>將設定檔複製到 podman 測試</p>
<p>[注意] 請確認 csr 是否存留舊資料</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get csr</span><br><span class="line">NAME         AGE   SIGNERNAME                            REQUESTOR          REQUESTEDDURATION   CONDITION</span><br><span class="line">user01-csr   48m   kubernetes.io/kube-apiserver-client   kubernetes-admin   365d                Approved,Issued</span><br><span class="line"></span><br><span class="line">$ kubectl delete csr user01-csr</span><br><span class="line">certificatesigningrequest.certificates.k8s.io <span class="string">&quot;user01-csr&quot;</span> deleted</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">$ openssl genrsa -out private.key 2048</span><br><span class="line">Generating RSA private key, 2048 bit long modulus (2 primes)</span><br><span class="line">.......+++++</span><br><span class="line">....+++++</span><br><span class="line">e is 65537 (0x010001)</span><br><span class="line"></span><br><span class="line">$ openssl req -new -key private.key -out CSR.csr -subj <span class="string">&quot;/CN=user01/O=user01&quot;</span></span><br><span class="line"></span><br><span class="line">1$ openssl req -noout -subject -<span class="keyword">in</span> CSR.csr</span><br><span class="line">subject=CN = user01, O = user01</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">export</span> BASE64_CSR=$(<span class="built_in">base64</span> &lt; CSR.csr | <span class="built_in">tr</span> -d <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: certificates.k8s.io/v1</span></span><br><span class="line"><span class="string">&gt; kind: CertificateSigningRequest</span></span><br><span class="line"><span class="string">&gt; metadata:</span></span><br><span class="line"><span class="string">&gt;   name: user01-csr</span></span><br><span class="line"><span class="string">&gt; spec:</span></span><br><span class="line"><span class="string">&gt;   groups:</span></span><br><span class="line"><span class="string">&gt;     - system:authenticated</span></span><br><span class="line"><span class="string">&gt;   request: $&#123;BASE64_CSR&#125;</span></span><br><span class="line"><span class="string">&gt;   signerName: kubernetes.io/kube-apiserver-client</span></span><br><span class="line"><span class="string">&gt;   expirationSeconds: 31536000 # 365 day</span></span><br><span class="line"><span class="string">&gt;   usages:</span></span><br><span class="line"><span class="string">&gt;     - client auth&#x27;</span> &gt; csr.yaml</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> -l</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 bigred bigred  911 Jun 13 14:28 CSR.csr</span><br><span class="line">-rw-r--r-- 1 bigred bigred  282 Jun 13 14:29 csr.yaml</span><br><span class="line">-rw------- 1 bigred bigred 1675 Jun 13 14:28 private.key</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> csr.yaml | envsubst | kubectl apply -f -</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/user01-csr created</span><br><span class="line"></span><br><span class="line">$ kubectl certificate approve user01-csr</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/user01-csr approved</span><br><span class="line"></span><br><span class="line">$ kg csr</span><br><span class="line">NAME         AGE   SIGNERNAME                            REQUESTOR          REQUESTEDDURATION   CONDITION</span><br><span class="line">user01-csr   18s   kubernetes.io/kube-apiserver-client   kubernetes-admin   365d                Approved,Issued</span><br><span class="line"></span><br><span class="line">$ kubectl get csr user01-csr -o jsonpath=<span class="string">&#x27;&#123;.status.certificate&#125;&#x27;</span> | <span class="built_in">base64</span> -d &gt; k8s-signed.crt</span><br><span class="line"></span><br><span class="line">$ openssl x509 -noout -subject -<span class="keyword">in</span> k8s-signed.crt</span><br><span class="line">subject=O = user01, CN = user01</span><br><span class="line"></span><br><span class="line">$ kubectl config view --flatten=<span class="literal">true</span> | <span class="built_in">head</span> -n 6 &gt; config.tmp</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;contexts:</span></span><br><span class="line"><span class="string">&gt;   - context:</span></span><br><span class="line"><span class="string">&gt;       cluster: kubernetes</span></span><br><span class="line"><span class="string">&gt;       user: user01</span></span><br><span class="line"><span class="string">&gt;     name: user01-context</span></span><br><span class="line"><span class="string">&gt; current-context: user01-context</span></span><br><span class="line"><span class="string">&gt; kind: Config</span></span><br><span class="line"><span class="string">&gt; preferences: &#123;&#125;</span></span><br><span class="line"><span class="string">&gt; users:</span></span><br><span class="line"><span class="string">&gt;   - name: user01</span></span><br><span class="line"><span class="string">&gt;     user:</span></span><br><span class="line"><span class="string">&gt;       client-certificate-data: $&#123;K8S_CRT&#125;</span></span><br><span class="line"><span class="string">&gt;       client-key-data: $&#123;K8S_KEY&#125;&#x27;</span> &gt;&gt; config.tmp</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">export</span> K8S_CRT=$(<span class="built_in">base64</span> &lt; k8s-signed.crt | <span class="built_in">tr</span> -d <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">export</span> K8S_KEY=$(<span class="built_in">base64</span> &lt; private.key | <span class="built_in">tr</span> -d <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> config.tmp | envsubst &gt; config</span><br><span class="line"></span><br><span class="line">$ sudo podman ps -a</span><br><span class="line">CONTAINER ID  IMAGE                                     COMMAND     CREATED         STATUS                   PORTS                                                                 NAMES</span><br><span class="line">b18077d221fd  localhost/podman-pause:4.1.0-1652313655               12 days ago     Exited (0) 4 days ago    0.0.0.0:80-&gt;8080/tcp, 0.0.0.0:5432-&gt;5432/tcp, 0.0.0.0:6379-&gt;6379/tcp  943dc009d7bb-infra</span><br><span class="line">b78deed44826  quay.io/flysangel/quay-rhel8:v3.6.6       registry    12 days ago     Exited (137) 4 days ago  0.0.0.0:80-&gt;8080/tcp, 0.0.0.0:5432-&gt;5432/tcp, 0.0.0.0:6379-&gt;6379/tcp  quay-quay-app</span><br><span class="line">d45e257168cc  quay.io/flysangel/postgres:9.6.24-alpine  postgres    12 days ago     Exited (0) 4 days ago    0.0.0.0:80-&gt;8080/tcp, 0.0.0.0:5432-&gt;5432/tcp, 0.0.0.0:6379-&gt;6379/tcp  quay-postgresql</span><br><span class="line">2992e6a01ba6  quay.io/flysangel/redis-5:1-169           run-redis   12 days ago     Exited (0) 4 days ago    0.0.0.0:80-&gt;8080/tcp, 0.0.0.0:5432-&gt;5432/tcp, 0.0.0.0:6379-&gt;6379/tcp  quay-redis</span><br><span class="line">a153d0c3fcb2  quay.io/flysangel/image:landlord.kubectl  bash        33 minutes ago  Up 33 minutes ago                                                                              k1</span><br><span class="line">$ sudo podman run -it --<span class="built_in">rm</span> --name k1 -d quay.io/flysangel/image:landlord.kubectl bash</span><br><span class="line">Error: error creating container storage: the container name <span class="string">&quot;k1&quot;</span> is already <span class="keyword">in</span> use by <span class="string">&quot;a153d0c3fcb2b1ccb77ed403661a512d4f6a007c8a8bd57f67c620cdff302674&quot;</span>. You have to remove that container to be able to reuse that name.: that name is already <span class="keyword">in</span> use</span><br><span class="line"></span><br><span class="line">$ sudo podman <span class="built_in">rm</span> k1</span><br><span class="line">Error: cannot remove container a153d0c3fcb2b1ccb77ed403661a512d4f6a007c8a8bd57f67c620cdff302674 as it is running - running or paused containers cannot be removed without force: container state improper</span><br><span class="line"></span><br><span class="line">$ sudo podman <span class="built_in">rm</span> -f k1</span><br><span class="line">WARN[0010] StopSignal SIGTERM failed to stop container k1 <span class="keyword">in</span> 10 seconds, resorting to SIGKILL</span><br><span class="line">a153d0c3fcb2b1ccb77ed403661a512d4f6a007c8a8bd57f67c620cdff302674</span><br><span class="line"></span><br><span class="line">$ sudo podman run -it --<span class="built_in">rm</span> --name k1 -d quay.io/flysangel/image:landlord.kubectl bash</span><br><span class="line">f6d7b99e4e39059d62113c4d641ff766a378d1976d9dc1c3b49e90f99db9d494</span><br><span class="line"></span><br><span class="line">$ sudo podman <span class="built_in">cp</span> config k1:/home/bigred/.kube/config</span><br><span class="line"></span><br><span class="line">$ sudo podman <span class="built_in">exec</span> -it k1 bash</span><br><span class="line">bash-5.1$ kubectl get pod</span><br><span class="line">Error from server (Forbidden): pods is forbidden: User <span class="string">&quot;user01&quot;</span> cannot list resource <span class="string">&quot;pods&quot;</span> <span class="keyword">in</span> API group <span class="string">&quot;&quot;</span> <span class="keyword">in</span> the namespace <span class="string">&quot;default&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>檢查憑證指令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ openssl x509 -noout -text -<span class="keyword">in</span> k8s-signed.crt</span><br></pre></td></tr></table></figure>

<h2 id="認識-Role-Based-Access-Control"><a href="#認識-Role-Based-Access-Control" class="headerlink" title="認識 Role Based Access Control"></a>認識 Role Based Access Control</h2><p>Subjects: The set of users and processes that want to access the Kubernetes API.</p>
<p>Resources: The set of Kubernetes API Objects available in the cluster. Examples include Pods, Deployments, Services, Nodes, and PersistentVolumes, among others.</p>
<p>Verbs: The set of operations that can be executed to the resources above. Different verbs are available (examples: get, watch, create, delete, etc.), but ultimately all of them are Create, Read, Update or Delete (CRUD) operations.</p>
<p><img src="https://i.imgur.com/fZmPcRw.png"></p>
<h3 id="Role-Based-Access-Control-RBAC"><a href="#Role-Based-Access-Control-RBAC" class="headerlink" title="Role Based Access Control (RBAC)"></a>Role Based Access Control (RBAC)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create ns user01</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: Role</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: user01-role</span></span><br><span class="line"><span class="string">  namespace: user01</span></span><br><span class="line"><span class="string">rules:</span></span><br><span class="line"><span class="string">- apiGroups: [&quot;&quot;] # &quot;&quot; indicates the core API group</span></span><br><span class="line"><span class="string">  resources: [&quot;pods&quot;, &quot;services&quot;]</span></span><br><span class="line"><span class="string">  verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;]&#x27;</span> &gt; role.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f role.yaml</span><br><span class="line">role.rbac.authorization.k8s.io/user01-role created</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: RoleBinding</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: user01-rbind</span></span><br><span class="line"><span class="string">  namespace: user01</span></span><br><span class="line"><span class="string">subjects:</span></span><br><span class="line"><span class="string">- kind: User</span></span><br><span class="line"><span class="string">  name: user01</span></span><br><span class="line"><span class="string">  apiGroup: rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">roleRef:</span></span><br><span class="line"><span class="string">  kind: Role #this must be Role or ClusterRole</span></span><br><span class="line"><span class="string">  name: user01-role </span></span><br><span class="line"><span class="string">  apiGroup: rbac.authorization.k8s.io&#x27;</span> &gt; rolebind.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f rolebind.yaml</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/user01-rbind created</span><br><span class="line"></span><br><span class="line">$ kubectl get role -n user01</span><br><span class="line">NAME          CREATED AT</span><br><span class="line">user01-role   2022-06-13T06:49:41Z</span><br><span class="line"></span><br><span class="line">$ kubectl get rolebinding -n user01</span><br><span class="line">NAME           ROLE               AGE</span><br><span class="line">user01-rbind   Role/user01-role   50s</span><br></pre></td></tr></table></figure>

<h3 id="練習-1"><a href="#練習-1" class="headerlink" title="練習"></a>練習</h3><p>參考投影片 10、14 兩頁。<br>請重新建立 K8S user02 帳號<br>使用效期為 1 年<br>預設使用 user02 namespace<br>權限具備完全控制<br>將設定檔複製到 podman 測試</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> user02</span><br><span class="line">$ <span class="built_in">cd</span> user02</span><br><span class="line"></span><br><span class="line">$ openssl genrsa -out private.key 2048</span><br><span class="line">$ openssl req -new -key private.key -out CSR2.csr -subj <span class="string">&quot;/CN=user02/O=user02&quot;</span></span><br><span class="line"></span><br><span class="line">$ openssl req -noout -subject -<span class="keyword">in</span> CSR2.csr</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">export</span> BASE64_CSR2=$(<span class="built_in">base64</span> &lt; CSR2.csr | <span class="built_in">tr</span> -d <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: certificates.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: CertificateSigningRequest</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: user02-csr2</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  groups:</span></span><br><span class="line"><span class="string">    - system:authenticated</span></span><br><span class="line"><span class="string">  request: $&#123;BASE64_CSR2&#125;</span></span><br><span class="line"><span class="string">  signerName: kubernetes.io/kube-apiserver-client</span></span><br><span class="line"><span class="string">  expirationSeconds: 31536000 # 365 day</span></span><br><span class="line"><span class="string">  usages:</span></span><br><span class="line"><span class="string">    - client auth&#x27;</span> &gt; csr2.yaml</span><br><span class="line">	</span><br><span class="line">$ <span class="built_in">cat</span> csr2.yaml | envsubst | kubectl apply -f -</span><br><span class="line"></span><br><span class="line">$ kubectl get csr</span><br><span class="line">$ kubectl certificate approve user02-csr2</span><br><span class="line">$ kubectl get csr</span><br><span class="line">$ kubectl get csr user02-csr2 -o jsonpath=<span class="string">&#x27;&#123;.status.certificate&#125;&#x27;</span> | <span class="built_in">base64</span> -d &gt; k8s-signed.crt</span><br><span class="line">$ openssl x509 -noout -subject -<span class="keyword">in</span> k8s-signed.crt</span><br><span class="line">$ kubectl config view --flatten=<span class="literal">true</span> | <span class="built_in">head</span> -n 6 &gt; config.tmp</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;contexts:</span></span><br><span class="line"><span class="string">  - context:</span></span><br><span class="line"><span class="string">      cluster: kubernetes</span></span><br><span class="line"><span class="string">      namespace: user02</span></span><br><span class="line"><span class="string">      user: user02</span></span><br><span class="line"><span class="string">    name: user02-context</span></span><br><span class="line"><span class="string">current-context: user02-context</span></span><br><span class="line"><span class="string">kind: Config</span></span><br><span class="line"><span class="string">preferences: &#123;&#125;</span></span><br><span class="line"><span class="string">users:</span></span><br><span class="line"><span class="string">  - name: user02</span></span><br><span class="line"><span class="string">    user:</span></span><br><span class="line"><span class="string">      client-certificate-data: $&#123;K8S_CRT&#125;</span></span><br><span class="line"><span class="string">      client-key-data: $&#123;K8S_KEY&#125;&#x27;</span> &gt;&gt; config.tmp</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> config.tmp</span><br><span class="line">$ <span class="built_in">export</span> K8S_CRT=$(<span class="built_in">base64</span> &lt; k8s-signed.crt | <span class="built_in">tr</span> -d <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">$ <span class="built_in">export</span> K8S_KEY=$(<span class="built_in">base64</span> &lt; private.key | <span class="built_in">tr</span> -d <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">$ <span class="built_in">cat</span> config.tmp | envsubst &gt; config</span><br><span class="line">$ sudo podman run -it --<span class="built_in">rm</span> --name k2 -d quay.io/flysangel/image:landlord.kubectl bash</span><br><span class="line">$ sudo podman <span class="built_in">cp</span> config k2:/home/bigred/.kube/config</span><br><span class="line">$ sudo podman <span class="built_in">exec</span> -it k2 bash</span><br><span class="line">kubectl create ns user02</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: Role</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: user02-role</span></span><br><span class="line"><span class="string">  namespace: user02</span></span><br><span class="line"><span class="string">rules:</span></span><br><span class="line"><span class="string">- apiGroups: [&quot;&quot;] # &quot;&quot; indicates the core API group</span></span><br><span class="line"><span class="string">  resources: [&quot;*&quot;]</span></span><br><span class="line"><span class="string">  verbs: [&quot;*&quot;]&#x27;</span> &gt; role.yaml</span><br><span class="line">  </span><br><span class="line">$ kubectl apply -f role.yaml</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="string">kind: RoleBinding</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: user02-rbind</span></span><br><span class="line"><span class="string">  namespace: user02</span></span><br><span class="line"><span class="string">subjects:</span></span><br><span class="line"><span class="string">- kind: User</span></span><br><span class="line"><span class="string">  name: user02</span></span><br><span class="line"><span class="string">  apiGroup: rbac.authorization.k8s.io</span></span><br><span class="line"><span class="string">roleRef:</span></span><br><span class="line"><span class="string">  kind: Role #this must be Role or ClusterRole</span></span><br><span class="line"><span class="string">  name: user02-role</span></span><br><span class="line"><span class="string">  apiGroup: rbac.authorization.k8s.io&#x27;</span> &gt; rolebind.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f rolebind.yaml</span><br><span class="line">$ kubectl get roles -n user02</span><br><span class="line">$ kubectl get rolebinding -n user01</span><br><span class="line">$ kubectl get rolebinding -n user02</span><br><span class="line">$ sudo podman <span class="built_in">exec</span> -it k2 bash</span><br></pre></td></tr></table></figure>



<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/13/Kubernetes%20Multi%20Tenancy/" data-id="clhda4wau000aj0w73kfg9e2d" data-title="Kubernetes Multi Tenancy" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%B3%BB%E7%B5%B1%E5%B7%A5%E7%A8%8B/" rel="tag">系統工程</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Kubernetes StatefulSet" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/13/Kubernetes%20StatefulSet/" class="article-date">
  <time class="dt-published" datetime="2022-06-12T19:56:46.000Z" itemprop="datePublished">2022-06-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/06/13/Kubernetes%20StatefulSet/">Kubernetes StatefulSet</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Kubernetes-StatefulSet"><a href="#Kubernetes-StatefulSet" class="headerlink" title="Kubernetes StatefulSet"></a>Kubernetes StatefulSet</h1><h2 id="認識-StatefulSet"><a href="#認識-StatefulSet" class="headerlink" title="認識 StatefulSet"></a>認識 StatefulSet</h2><p><img src="https://i.imgur.com/2lY7OHu.png"></p>
<ul>
<li>StatefulSet 中所有 Pod 的名字都會以遞增整數作為結尾(以0為起點), 因此 Pod DNS 變得容易訪問, ReplicaSet 則隨機生成 Pod 名字 。</li>
</ul>
<p><img src="https://i.imgur.com/UeO9NoL.png"></p>
<ul>
<li>當 Pod 所在的 worker node 損毀, StatefulSet 會在其他 worker node 上創建該 Pod, 且保持 Pod 的名字和 hostname, ReplicaSet 則會重新分配 Pod 的名字和 hostname 。</li>
</ul>
<p><img src="https://i.imgur.com/UMfVubC.png"></p>
<ul>
<li>當減小 StatefulSet 的 replica count 時, 會按照 Pod 的名字倒序移除 Pod, 一次只能移除一個 Pod, 序號最大的先被移除, ReplicaSet 則會隨機移除一個 Pod</li>
</ul>
<p><img src="https://i.imgur.com/TMw8Jdq.png"></p>
<ul>
<li>由於 Pod 移轉時必須保證新建的 Pod 依然綁定原 Volume, StatefulSet 需要維持 Pod 與 PersistentVolumeClaim 之間的對應關係, 所以 PVC 不再由用戶管理</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;apiVersion: apps/v1</span></span><br><span class="line"><span class="string">kind: StatefulSet</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: nginx</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    matchLabels:</span></span><br><span class="line"><span class="string">      app: nginx</span></span><br><span class="line"><span class="string">  serviceName: nginx</span></span><br><span class="line"><span class="string">  replicas: 3</span></span><br><span class="line"><span class="string">  template:</span></span><br><span class="line"><span class="string">    metadata:</span></span><br><span class="line"><span class="string">      labels:</span></span><br><span class="line"><span class="string">        app: nginx</span></span><br><span class="line"><span class="string">    spec:</span></span><br><span class="line"><span class="string">      containers:</span></span><br><span class="line"><span class="string">        - name: nginx</span></span><br><span class="line"><span class="string">          image: quay.io/flysangel/nginx</span></span><br><span class="line"><span class="string">          volumeMounts:</span></span><br><span class="line"><span class="string">            - name: html-storage</span></span><br><span class="line"><span class="string">              mountPath: /usr/share/nginx/html</span></span><br><span class="line"><span class="string">  volumeClaimTemplates:</span></span><br><span class="line"><span class="string">    - metadata:</span></span><br><span class="line"><span class="string">        name: html-storage</span></span><br><span class="line"><span class="string">      spec:</span></span><br><span class="line"><span class="string">        storageClassName: local-path</span></span><br><span class="line"><span class="string">        accessModes: [&quot;ReadWriteOnce&quot;]</span></span><br><span class="line"><span class="string">        resources:</span></span><br><span class="line"><span class="string">          requests:</span></span><br><span class="line"><span class="string">            storage: 1Gi&#x27;</span> &gt; statefulset-nginx.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it nginx-0 -- bash -c <span class="string">&quot;echo &#x27;My nginx-0&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span></span><br><span class="line"></span><br><span class="line">$ kubectl get pod -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE     IP            NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-0                  1/1     Running   0          4m53s   10.244.2.55   w2       &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-1                  1/1     Running   0          4m27s   10.244.0.26   m1       &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-2                  1/1     Running   0          58s     10.244.2.57   w2       &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-6f47499ff9-2dfcp   0/1     Pending   0          37m     &lt;none&gt;        &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-6f47499ff9-5q6q8   0/1     Pending   0          37m     &lt;none&gt;        &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-6f47499ff9-f5lh5   0/1     Pending   0          37m     &lt;none&gt;        &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ curl 10.244.2.55</span><br><span class="line">My nginx-0</span><br><span class="line"></span><br><span class="line">$ curl 10.244.2.57</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.21.6&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">$ curl 10.244.0.26</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.21.6&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it nginx-1 -- bash -c <span class="string">&quot;echo &#x27;My nginx-1&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span></span><br><span class="line"></span><br><span class="line">$ curl 10.244.2.57</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;<span class="built_in">head</span>&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.21.6&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">$ curl 10.244.0.26</span><br><span class="line">My nginx-1</span><br><span class="line"></span><br><span class="line">$ curl 10.244.2.55</span><br><span class="line">My nginx-0</span><br></pre></td></tr></table></figure>


<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> -it nginx-2 -- bash -c <span class="string">&quot;echo &#x27;My nginx-2&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span></span><br><span class="line"></span><br><span class="line">bigred@m1:~/0613$ curl 10.244.2.57</span><br><span class="line">My nginx-2</span><br><span class="line"></span><br><span class="line">bigred@m1:~/0613$ curl 10.244.0.26</span><br><span class="line">My nginx-1</span><br><span class="line"></span><br><span class="line">bigred@m1:~/0613$ curl 10.244.2.55</span><br><span class="line">My nginx-0</span><br></pre></td></tr></table></figure>


<h2 id="認識-StatefulSet-Service"><a href="#認識-StatefulSet-Service" class="headerlink" title="認識 StatefulSet Service"></a>認識 StatefulSet Service</h2><p><img src="https://i.imgur.com/5kHPENo.png"></p>
<ul>
<li>對於指向 StatefulSet 的 Service, 其他服務訪問可透過該 Service 取得每個 Pod 的 DNS 名稱, 以 Pod A-0 為例, 透過 a-0.A.default.svc.cluster.local 即可訪問服務</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;apiVersion: v1</span></span><br><span class="line"><span class="string">&gt; kind: Service</span></span><br><span class="line"><span class="string">&gt; metadata:</span></span><br><span class="line"><span class="string">&gt;   name: nginx</span></span><br><span class="line"><span class="string">&gt; spec:</span></span><br><span class="line"><span class="string">&gt;   clusterIP: None</span></span><br><span class="line"><span class="string">&gt;   selector:</span></span><br><span class="line"><span class="string">&gt;     app: nginx&#x27;</span> &gt; svc-nginx.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f svc-nginx.yaml</span><br><span class="line">service/nginx unchanged</span><br><span class="line"></span><br><span class="line">$ kubectl get service</span><br><span class="line">NAME         TYPE        CLUSTER-IP    EXTERNAL-IP    PORT(S)    AGE</span><br><span class="line">app1         ClusterIP   10.98.0.2     &lt;none&gt;         8080/TCP   4d18h</span><br><span class="line">app2         ClusterIP   10.98.0.200   &lt;none&gt;         8080/TCP   4d18h</span><br><span class="line">kubernetes   ClusterIP   10.98.0.1     &lt;none&gt;         443/TCP    13d</span><br><span class="line">nginx        ClusterIP   None          &lt;none&gt;         &lt;none&gt;     58m</span><br><span class="line">svc-fbs      ClusterIP   10.98.0.136   192.168.61.4   8080/TCP   11d</span><br><span class="line"></span><br><span class="line">$ kg pods -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE   IP            NODE     NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-0                  1/1     Running   0          20m   10.244.2.55   w2       &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-1                  1/1     Running   0          19m   10.244.0.26   m1       &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-2                  1/1     Running   0          16m   10.244.2.57   w2       &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-6f47499ff9-2dfcp   0/1     Pending   0          52m   &lt;none&gt;        &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-6f47499ff9-5q6q8   0/1     Pending   0          52m   &lt;none&gt;        &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-6f47499ff9-f5lh5   0/1     Pending   0          52m   &lt;none&gt;        &lt;none&gt;   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ nslookup</span><br><span class="line">&gt; server 10.98.0.10</span><br><span class="line">Default server: 10.98.0.10</span><br><span class="line">Address: 10.98.0.10<span class="comment">#53</span></span><br><span class="line">&gt; 10.244.2.55</span><br><span class="line">55.2.244.10.in-addr.arpa        name = nginx-0.nginx.default.svc.k8s.org.</span><br><span class="line"></span><br><span class="line">&gt; 10.244.0.26</span><br><span class="line">26.0.244.10.in-addr.arpa        name = nginx-1.nginx.default.svc.k8s.org.</span><br><span class="line"></span><br><span class="line">&gt; 10.244.2.57</span><br><span class="line">57.2.244.10.in-addr.arpa        name = nginx-2.nginx.default.svc.k8s.org.</span><br><span class="line"></span><br><span class="line">&gt; nginx.default.svc.k8s.org</span><br><span class="line">Server:         10.98.0.10</span><br><span class="line">Address:        10.98.0.10<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">Name:   nginx.default.svc.k8s.org</span><br><span class="line">Address: 10.244.2.55</span><br><span class="line">Name:   nginx.default.svc.k8s.org</span><br><span class="line">Address: 10.244.0.26</span><br><span class="line">Name:   nginx.default.svc.k8s.org</span><br><span class="line">Address: 10.244.2.57</span><br></pre></td></tr></table></figure>

<h2 id="刪除-StatefulSet"><a href="#刪除-StatefulSet" class="headerlink" title="刪除 StatefulSet"></a>刪除 StatefulSet</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete -f svc-nginx.yaml</span><br><span class="line">service <span class="string">&quot;nginx&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">$ kubectl delete -f statefulset-nginx.yaml</span><br><span class="line">statefulset.apps <span class="string">&quot;nginx&quot;</span> deleted</span><br><span class="line"></span><br><span class="line">$ kubectl delete pvc html-storage-nginx-0 html-storage-nginx-1 html-storage-nginx-2</span><br><span class="line">persistentvolumeclaim <span class="string">&quot;html-storage-nginx-0&quot;</span> deleted</span><br><span class="line">persistentvolumeclaim <span class="string">&quot;html-storage-nginx-1&quot;</span> deleted</span><br><span class="line">persistentvolumeclaim <span class="string">&quot;html-storage-nginx-2&quot;</span> deleted</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>由 StatefulSet 生成的 pvc ，他的生命週期會跟著 Namespace 活著，直到 Namespace 被刪除</strong></p>
<h2 id="練習"><a href="#練習" class="headerlink" title="練習"></a>練習</h2><p>請問如何擴展 StatefulSet。<br>請觀察擴展 StatefulSet 時，pod 或 container 狀態為何。<br>請建立 StatefulSet replicas 為 3，並逐一新增 nginx 網頁，當 replicas 由 3 轉為 2 再恢復至 3 時，請問資料是否都還保存完整。</p>
<p>練習完後請刪除練習環境<br>Pod -&gt; PVC</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f svc-nginx.yaml</span><br><span class="line"></span><br><span class="line">$ kubectl apply -f statefulset-nginx.yaml</span><br><span class="line"></span><br><span class="line">$ kg pods -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-0   1/1     Running   0          86s   10.244.2.61   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-1   1/1     Running   0          76s   10.244.0.29   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-2   1/1     Running   0          66s   10.244.2.63   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ $ kubectl scale  statefulset/nginx --replicas=6</span><br><span class="line">statefulset.apps/nginx scale</span><br><span class="line"></span><br><span class="line">$ kg pods -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE     IP             NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-0   1/1     Running   0          2m55s   10.244.2.61    w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-1   1/1     Running   0          2m45s   10.244.0.29    m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-2   1/1     Running   0          2m35s   10.244.2.63    w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-3   1/1     Running   0          45s     10.244.1.126   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-4   1/1     Running   0          37s     10.244.1.128   w1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-5   1/1     Running   0          28s     10.244.0.31    m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ kubectl scale  statefulset/nginx --replicas=3</span><br><span class="line">statefulset.apps/nginx scaled</span><br><span class="line"></span><br><span class="line">bigred@m1:~/0613$ kg pods -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE     IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-0   1/1     Running   0          3m38s   10.244.2.61   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-1   1/1     Running   0          3m28s   10.244.0.29   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-2   1/1     Running   0          3m18s   10.244.2.63   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ kubectl <span class="built_in">exec</span> -it nginx-2 -- bash -c <span class="string">&quot;echo &#x27;My nginx-2&#x27; &gt; /usr/share/nginx/html/index.html&quot;</span></span><br><span class="line"></span><br><span class="line">bigred@m1:~/0613$ curl 10.244.2.63</span><br><span class="line">My nginx-2</span><br><span class="line"></span><br><span class="line">$ kubectl scale  statefulset/nginx --replicas=2</span><br><span class="line">statefulset.apps/nginx scaled</span><br><span class="line"></span><br><span class="line">bigred@m1:~/0613$ kg pods -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE     IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-0   1/1     Running   0          5m13s   10.244.2.61   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-1   1/1     Running   0          5m3s    10.244.0.29   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ kubectl scale  statefulset/nginx --replicas=3</span><br><span class="line">statefulset.apps/nginx scaled</span><br><span class="line"></span><br><span class="line">bigred@m1:~/0613$ kg pods -o wide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE     IP            NODE   NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-0   1/1     Running   0          5m54s   10.244.2.61   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-1   1/1     Running   0          5m44s   10.244.0.29   m1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-2   1/1     Running   0          12s     10.244.2.64   w2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">$ curl 10.244.2.64</span><br><span class="line">My nginx-2</span><br></pre></td></tr></table></figure>


<p>答：<strong>資料有保存</strong></p>
<h6 id="tags-系統工程"><a href="#tags-系統工程" class="headerlink" title="tags: 系統工程"></a>tags: <code>系統工程</code></h6>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/06/13/Kubernetes%20StatefulSet/" data-id="clhda4waw000hj0w7gdvbhphe" data-title="Kubernetes StatefulSet" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%B3%BB%E7%B5%B1%E5%B7%A5%E7%A8%8B/" rel="tag">系統工程</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Kubernetes (有舵手的意思)" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/10/26/Kubernetes%20(%E6%9C%89%E8%88%B5%E6%89%8B%E7%9A%84%E6%84%8F%E6%80%9D)/" class="article-date">
  <time class="dt-published" datetime="2021-10-25T21:43:50.000Z" itemprop="datePublished">2021-10-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/10/26/Kubernetes%20(%E6%9C%89%E8%88%B5%E6%89%8B%E7%9A%84%E6%84%8F%E6%80%9D)/">Kubernetes Overview</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Kubernetes-有舵手的意思"><a href="#Kubernetes-有舵手的意思" class="headerlink" title="Kubernetes (有舵手的意思)"></a>Kubernetes (有舵手的意思)</h1><ul>
<li>由google公司主導與設計。<img src="https://i.imgur.com/8xiT67F.png"><br>這個logo”船舵”，代表這是一個航運系統，管理很大的一群船隊，而他管的船就是”Moby(application container)”。</li>
<li>用來維運管理application container。</li>
<li>這些application container是分散在一堆實體電腦上面。</li>
<li>又稱K8s，因”K”~”S”裡面有8個英文字母。<blockquote>
<p><img src="https://i.imgur.com/6hcKXSG.png"><br>問題: 在m1、w1和W2這3台實體電腦中，全部裝linux，裡面啟動container技術，公司說就是你管的，現在要啟動一台裡面裝nginx的container，請問要在哪一台機器啟動?<br>答: 今天有3台實體電腦，啟動container技術，實務上如果由人決定在哪台run，你是辛苦的、痛苦的，甚至會傷害到器官，因為當管理的機器數量的規模越來越大，人將無法適當管理，所以這時候就需要Kubernetes來幫忙管理。</p>
</blockquote>
</li>
</ul>
<hr>
<ul>
<li><p>Replication of components</p>
<ul>
<li>叢集，創建&#x2F;複製相同application。</li>
<li>叢集，同一個服務開好幾個pods來提供服務，避免單點損毀的情況以提高可用性。</li>
</ul>
</li>
<li><p>Auto-scaling</p>
<ul>
<li>當偵測到connection大量衝入時，自動平行擴充應用系統，大型服務系統都會用，例如: Goole、FB。</li>
<li>橫向擴充，可以依照暴漲的流量擴充機器。</li>
<li>需要強的硬體設備才能做得到。</li>
</ul>
</li>
<li><p>Load balancing</p>
<ul>
<li>擴充後要分流，負載平衡機制。</li>
</ul>
</li>
<li><p>Rolling updates</p>
<ul>
<li>專門給程式設計使用，系統修改完，會有新的版本，每當程式修改一次，就要再做一次測試，先從原碼掃描開始，就是看</li>
</ul>
</li>
<li><p>Logging across components</p>
</li>
<li><p>Monitoring and health checking</p>
</li>
</ul>
<hr>
<h2 id="world-computer"><a href="#world-computer" class="headerlink" title="world computer"></a>world computer</h2><p>錄製_2021_10_13_11_12_25_773</p>
<h2 id="autopilot"><a href="#autopilot" class="headerlink" title="autopilot"></a>autopilot</h2><hr>
<h2 id="K8S-雲端服務"><a href="#K8S-雲端服務" class="headerlink" title="K8S 雲端服務"></a>K8S 雲端服務</h2><ul>
<li>Google GKE</li>
<li>Amazon EKS</li>
<li>Azure AKS</li>
</ul>
<p>以上這3種雲都有各自改過K8S的原生系統，</p>
<hr>
<h2 id="K8S-自建"><a href="#K8S-自建" class="headerlink" title="K8S 自建"></a>K8S 自建</h2><ul>
<li>RedHat OpenShift</li>
<li>VMware Tanzu </li>
<li>Rancher<ul>
<li><img src="https://i.imgur.com/h6pqHv4.png"><br>這套商業軟體，就是靠上面這個類似儀表板的介面，來管理K8S，也就是WEB UI</li>
</ul>
</li>
</ul>
<p>以上這3家公司都有各自改過K8S的原生系統</p>
<hr>
<h2 id="K8s環境介紹"><a href="#K8s環境介紹" class="headerlink" title="K8s環境介紹"></a>K8s環境介紹</h2><p><img src="https://i.imgur.com/Mwjwh88.png"></p>
<ul>
<li>API Server接收到前端(User interface)的命令:K8S幫我產生一個nginx網站的Pod出來，API Server就會把訊息傳給Scheduler，Scheduler就會往後看W1( Worker node 1 )跟( Worker node 2 )誰比較閒</li>
<li>pod 是 k8s 的運作最小單元，裡面可以跑多個 container</li>
</ul>
<p>Master 裡面一定會有4個 pod</p>
<ul>
<li>API Server ：此 pod 中含1個 container，專門用來接收命令(從 WEB UI 或 CLI(kubectl) 來的)</li>
<li>Scheduler ： 接受從 API Server 來的創建 pod 指令，去看哪一個 Node 比較適合開新的 pod 並且進行排程 (決定 pod 要在哪開)</li>
<li>Controller-Manager ： 照顧 pod ，若 node 掛掉會把 pod 移去其他點。若 pod 工作負荷太大，也會再開啟新的 pod 來分散流量 (auto-scaling + Load-balancing)</li>
<li>etcd ： 最重要的區塊，存放整個 k8s 系統運作的重要資訊</li>
</ul>
<p>Worker node :</p>
<ul>
<li>kubelet ：呼叫 docker 產生 container ，接收由 Scheduler 傳送來的指令<ul>
<li>會負責存放一些 pod 的 metadata</li>
<li>pod正常運行結束後，pod會被刪除後會再重新建一個新的一樣的pod</li>
<li>他是一個Deamon。</li>
</ul>
</li>
<li>kube-proxy ：提供兩邊 node 間的 pod 可以互通網路<ul>
<li>他是一個pod。</li>
</ul>
</li>
</ul>
<h6 id="tags-Kubernetes"><a href="#tags-Kubernetes" class="headerlink" title="tags: Kubernetes"></a>tags: <code>Kubernetes</code></h6>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/10/26/Kubernetes%20(%E6%9C%89%E8%88%B5%E6%89%8B%E7%9A%84%E6%84%8F%E6%80%9D)/" data-id="clhda4waj0000j0w7grbgf9md" data-title="Kubernetes Overview" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%B3%BB%E7%B5%B1%E5%B7%A5%E7%A8%8B/" rel="tag">系統工程</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%B3%BB%E7%B5%B1%E5%B7%A5%E7%A8%8B/" rel="tag">系統工程</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/%E7%B3%BB%E7%B5%B1%E5%B7%A5%E7%A8%8B/" style="font-size: 10px;">系統工程</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/01/">January 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/09/">September 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/08/">August 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/02/08/Kubernetes%20Deployment/">Kubernetes Deployment</a>
          </li>
        
          <li>
            <a href="/2023/01/07/Kubernetes%20Landlord/">Kubernetes Landlord</a>
          </li>
        
          <li>
            <a href="/2022/09/18/Kubernetes-RBAC-Context/">Kubernetes-RBAC-Context</a>
          </li>
        
          <li>
            <a href="/2022/09/18/Kubernetes-Resource-CPU-Memory/">Kubernetes-Resource-CPU-Memory</a>
          </li>
        
          <li>
            <a href="/2022/09/18/Kubernetes%20Resource%20Storage/">Kubernetes Resource Storage (NFS)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>